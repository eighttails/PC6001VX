			  Z80 ASSEMBLER - ZASM VER 1.6
                      	;Compatible BASIC for PC-6601
                      	; by AKIKAWA, Hisashi  2017-2019
                      	
                      	;This software is redistributable under the LGPLv2.1 or any later version.
                      	
                      	
                      	;subroutine entry address
  0000                	BOOT	equ	0000h
  0008                	CHKPAR	equ	0008h
  0010                	ANADAT	equ	0010h
  0018                	JPHK1	equ	0018h
  0020                	CPHLDE	equ	0020h
  0028                	CHKSGN	equ	0028h
  0038                	JPHK2	equ	0038h
  0384                	ERRSTR	equ	0384h
  038B                	ERRIN	equ	038bh
  0390                	OK	equ	0390h
  0442                	EDIT	equ	0442h
  06EA                	CMDEND	equ	06eah
  0709                	INTPRT2	equ	0709h
  0741                	FTOI2	equ	0741h
  0D16                	ABTOF	equ	0d16h
  0DE3                	INT1INC	equ	0de3h
  0DE4                	INT1ARG	equ	0de4h
  0E78                	IN90H	equ	0e78h
  0E8F                	OUT90H	equ	0e8fh
  0EB0                	INTGRP	equ	0eb0h
  0EB5                	INTKEY	equ	0eb5h
  0EF6                	IKBF	equ	0ef6h
  0F2B                	IKPOP	equ	0f2bh
  0F74                	INTTIM	equ	0f74h
  0FBC                	GETCH	equ	0fbch
  0FC4                	GETC	equ	0fc4h
  103A                	GETKBF	equ	103ah
  1058                	CLRKBF	equ	1058h
  1061                	STICK	equ	1061h
  1075                	PUTC	equ	1075h
  10AA                	PUTCHR	equ	10aah
  10EA                	PATCH1	equ	10eah
  116D                	SETCSR	equ	116dh
  1179                	CSRON	equ	1179h
  1181                	CSROFF	equ	1181h
  11B8                	Y2AD	equ	11b8h
  11CD                	XY2AD	equ	11cdh
  11DA                	DELLIN	equ	11dah
  1257                	PUTCH	equ	1257h
  1260                	SCRLU60	equ	1260h
  12A9                	SCRLD60	equ	12a9h
  1390                	CHGMOD	equ	1390h
  13ED                	CHGDSP	equ	13edh
  140C                	CHGACT	equ	140ch
  1478                	AD2GAD	equ	1478h
  14A0                	CGROM	equ	14a0h
  14AF                	PUTCH2	equ	14afh
  15C0                	SETATT	equ	15c0h
  1A1C                	PUTPRT	equ	1a1ch
  1A4F                	CNVKANA	equ	1a4fh
  1A61                	ROPEN	equ	1a61h
  1A70                	GETCMT	equ	1a70h
  1AAA                	RCLOSE	equ	1aaah
  1AB8                	WOPEN	equ	1ab8h
  1ACC                	PUTCMT	equ	1acch
  1AED                	CHK90H	equ	1aedh
  1B06                	WCLOSE	equ	1b06h
  1B2A                	BLNKAST	equ	1b2ah
  1B49                	RLOFF	equ	1b49h
  1B4B                	RLON	equ	1b4bh
  1B54                	OUTB0H	equ	1b54h
  1B60                	PLSTPS	equ	1b60h
  1BB3                	PLSTOP	equ	1bb3h
  1BBE                	SOUND2	equ	1bbeh
  1BC5                	SOUND	equ	1bc5h
  1BCD                	BELL	equ	1bcdh
  1CA6                	JOYSTK	equ	1ca6h
  1CB4                	PATCH2	equ	1cb4h
  1DBB                	SETC3	equ	1dbbh
  1DFB                	CLS	equ	1dfbh
  1EB3                	PLAY	equ	1eb3h
  204B                	SCALE	equ	204bh
  2539                	GETFN	equ	2539h
  254E                	CMTSKP	equ	254eh
  2576                	FOUND	equ	2576h
  2583                	PRTFN	equ	2583h
  259A                	INPOPN	equ	259ah
  25A8                	PRTOPN	equ	25a8h
  25E5                	WAIT	equ	25e5h
  26C7                	PUTDEV	equ	26c7h
  2739                	PUTNL	equ	2739h
  274D                	STOPESC	equ	274dh
  28F9                	INPT1	equ	28f9h
  2D13                	SETGXY	equ	2d13h
  2D47                	PSET	equ	2d47h
  2DE4                	LINEBF	equ	2de4h
  2E1F                	LINE	equ	2e1fh
  2E35                	LINEB	equ	2e35h
  2EF1                	PAINT2	equ	2ef1h
  2EFA                	PAINT	equ	2efah
  30CE                	PUTSINC	equ	30ceh
  30CF                	PUTS	equ	30cfh
  310F                	GC	equ	310fh
  34F9                	RESSTK	equ	34f9h
  3995                	CHKMOD	equ	3995h
  3A99                	INLNUM	equ	3a99h
  3AA1                	PUTI2	equ	3aa1h
  3AA5                	I2TOA	equ	3aa5h
  3AAC                	FTOA	equ	3aach
  3BAF                	RNDPLS	equ	3bafh
                      	
                      	;BASIC command
  0781                	C_RUN	equ	0781h		;RUN
  07E0                	C_DATA	equ	07e0h		;DATA
  07E2                	C_REM	equ	07e2h		;REM
  087A                	C_LPRT	equ	087ah		;LPRINT
  087E                	C_PRT	equ	087eh		;PRINT
  1D9B                	C_COLR	equ	1d9bh		;COLOR
  1E04                	C_SCRN	equ	1e04h		;SCREEN
  4A72                	C_CRCL	equ	4a72h		;CIRCLE
  70C9                	C_LIN66	equ	70c9h		;LINE
                      	
                      	;work area
  FA18                	STOPFLG	equ	0fa18h		;03h=STOP,1bh=ESC
  FA19                	CMTSTAT	equ	0fa19h		;bit1=data received, bit4=error
  FA1A                	INPDEV	equ	0fa1ah		;input device
  FA1D                	CMTBUF	equ	0fa1dh		;CMT data
  FA1E                	ASTSTAT	equ	0fa1eh		;cload asterisk status
  FA1F                	BAUD	equ	0fa1fh		;baud rate (00=600baud, ff=1200baud)
  FA20                	HEIGHT	equ	0fa20h		;Y max+1
                      	
  FA27                	PORTB0H	equ	0fa27h		;port b0h
  FA28                	TMCNT	equ	0fa28h		;time count, fa28-fa2b
  FA2D                	CONSOL4	equ	0fa2dh		;console 4th parameter
  FA2E                	CSRBLNK	equ	0fa2eh		;0=cursor blink off, 1=on
  FA2F                	CSRSTAT	equ	0fa2fh		;0=normal, ff=reversed
  FA30                	GRPWRK	equ	0fa30h		;input graphic character work
  FA31                	GRPFLG	equ	0fa31h		;print graphic character flag
  FA32                	FKEYCNT	equ	0fa32h		;function key counter
  FA51                	RSEED	equ	0fa51h		;random seed, fa51-fa55
  FA57                	PRTPOS	equ	0fa57h		;printer head position
  FA58                	DEVICE	equ	0fa58h		;output device
  FA5A                	KEYFLG	equ	0fa5ah		;special key flags
  FA5B                	STACK	equ	0fa5bh		;initial stack pointer
  FA5D                	LINENUM	equ	0fa5dh		;current line number
  FA5F                	STARTAD	equ	0fa5fh		;basic program start address
  FA61                	CMDTBL	equ	0fa61h		;command jump table
  FAE5                	FNCTBL	equ	0fae5h		;function jump table
  FB3D                	FKEYTBL	equ	0fb3dh		;function key data
  FB8D                	FKEYAD	equ	0fb8dh		;function key address
  FB8F                	KYBFIN	equ	0fb8fh		;key buffer pointer for input
  FB90                	KYBFOUT	equ	0fb90h		;key buffer pointer for output
  FB92                	KYBFSZ	equ	0fb92h		;key buffer size
  FB93                	KYBFAD	equ	0fb93h		;key buffer address
  FB95                	RSBFIN	equ	0fb95h		;RS-232C buffer in
  FB96                	RSBFOUT	equ	0fb96h		;RS-232C buffer out
  FB98                	RSBFSZ	equ	0fb98h		;RS-232C buffer size
  FB99                	RSBFAD	equ	0fb99h		;RS-232C buffer address
                      	
                      	;PLAY command
  FBA1                	BUFAIN	equ	0fba1h		;channelA buffer pointer for input
  FBA2                	BUFAOUT	equ	0fba2h		;channelA buffer pointer for output
  FBA4                	BUFASZ	equ	0fba4h		;channelA buffer size
  FBA5                	BUFAAD	equ	0fba5h		;channelA buffer address
  FBA7                	BUFBIN	equ	0fba7h		;channelB buffer in
  FBAD                	BUFCIN	equ	0fbadh		;channelC buffer in
                      	
  FBB9                	KEYBUF	equ	0fbb9h		;key buffer, fbb9-fbf8
  FBF9                	RSBUF	equ	0fbf9h		;RS-232C buffer, fbf9-fc38
                      	
                      	;PLAY command
  FC39                	BUFA	equ	0fc39h		;channelA buffer, fc39-fc78
  FC79                	BUFB	equ	0fc79h		;channelB buffer, fc79-fcb8
  FCB9                	BUFC	equ	0fcb9h		;channelC buffer, fcb9-fcf8
  FD14                	CHANNEL	equ	0fd14h		;channel (0-2)
  FD15                	SVBCK	equ	0fd15h		;backup of S/V-value
  FD17                	PLAYLEN	equ	0fd17h		;length
  FD18                	PLAYSTR	equ	0fd18h		;string address
  FD1B                	PLAYST	equ	0fd1bh		;PLAY status
  FD1D                	PLWKA	equ	0fd1dh		;PLAY work for channelA
  0000                	REMAIN	equ	0fd1dh-PLWKA	;remaining time
  0002                	PLLEN	equ	0fd1fh-PLWKA	;string length
  0003                	PLADR	equ	0fd20h-PLWKA	;string address
  000F                	OCTAVE	equ	0fd2ch-PLWKA	;O-value
  0010                	LENGTH	equ	0fd2dh-PLWKA	;L-value
  0011                	TEMPO	equ	0fd2eh-PLWKA	;T-value
  0012                	VOLUME	equ	0fd2fh-PLWKA	;V-value
  0013                	PERIOD	equ	0fd30h-PLWKA	;M-value
  FD42                	PLWKB	equ	0fd42h		;PLAY work for channelB
  FD67                	PLWKC	equ	0fd67h		;PLAY work for channelC
                      	
  FD8C                	PAGES	equ	0fd8ch		;How many pages?
  FD8D                	USREND	equ	0fd8dh		;user area end, fd8d-fd8e
  FD8F                	SCREEN2	equ	0fd8fh		;screen 2nd parameter-1
  FD90                	SCREEN3	equ	0fd90h		;screen 3rd parameter-1
                      	
  FD91                	VRAM	equ	0fd91h		;VRAM address (high)
  FD92                	SCREEN1	equ	0fd92h		;screen 1st parameter-1
  FD93                	COLOR1	equ	0fd93h		;color 1st parameter
  FD94                	COLOR2	equ	0fd94h		;color 2nd parameter
  FD95                	COLOR3	equ	0fd95h		;color 3rd parameter (1,2 -> 0,2)
  FD96                	M1COLOR	equ	0fd96h		;screen mode 1 color parameters, fd96-fd98
  FD99                	M2COLOR	equ	0fd99h		;screen mode 2 color parameters, fd99-fd9b
  FD9C                	M3COLOR	equ	0fd9ch		;screen mode 3 color parameters, fd9c-fd9e
  FD9F                	M4COLOR	equ	0fd9fh		;screen mode 4 color parameters, fd9f-fda1
  FDA2                	CONSOL1	equ	0fda2h		;console 1st line number+1
  FDA3                	CONSOL2	equ	0fda3h		;console last line number+1
  FDA5                	LASTLIN	equ	0fda5h		;sc12:(CONSOL2)-(CONSOL3) sc34:(CONSOLE2)
  FDA6                	CONSOL3	equ	0fda6h		;console 3rd parameter
  FDA7                	FKEYSFT	equ	0fda7h		;shift key status for function key display
  FDA8                	CSRY	equ	0fda8h		;cursor Y+1
  FDA9                	CSRX	equ	0fda9h		;cursor X+1
  FDAA                	CSRAD	equ	0fdaah		;cursor address
  FDAC                	WIDTH	equ	0fdach		;X max+1
  FDAE                	GRPX1	equ	0fdaeh		;graphic X, fdae-fdaf
  FDB0                	GRPY1	equ	0fdb0h		;graphic Y, fdb0-fdb1
  FDB5                	LINEST	equ	0fdb5h		;line connection status, (0=connect) fdb5-fdb7
  FDB9                	PAGE1	equ	0fdb9h		;page1 data, fdb9-fde0
  FDE1                	PAGE2	equ	0fde1h		;page2 data, fde1-fe08
  FE09                	PAGE3	equ	0fe09h		;page3 data, fe09-fe30
  FE31                	PAGE4	equ	0fe31h		;page4 data, fe31-fe58
                      	
  FE59                	INPTXY	equ	0fe59h		;INPUT command initial position
  FE5B                	INPTX	equ	0fe5bh		;INPUT command end position
  FE5C                	INPTPAG	equ	0fe5ch		;INPUT command page
  FE5D                	INSMODE	equ	0fe5dh		;0=not insert mode, ff=insert mode
  FE5E                	STOPSC2	equ	0fe5eh		;screen 2nd parameter -1 in stop
  FE5F                	STOPSC3	equ	0fe5fh		;screen 3rd parameter -1 in stop
  FEAC                	ATTDAT	equ	0feach		;color attribute data
  FEAD                	GRPX2	equ	0feadh		;graphic X, fead-feae
  FEAF                	GRPY2	equ	0feafh		;graphic Y, feaf-feb0
  FEB1                	GRPX3	equ	0feb1h		;graphic work, feb1-feb2
  FEB3                	GRPY3	equ	0feb3h		;graphic work, feb3-feb4
  FEB5                	PAWRK	equ	0feb5h		;paint work, feb5-feb6
  FEB7                	PACNT	equ	0feb7h		;paint work
  FEC5                	BORDERA	equ	0fec5h		;paint border color attribute
  FEC6                	BORDERC	equ	0fec6h		;paint border color code
  FECA                	GMKYBUF	equ	0fecah		;reply to game key query
                      	;TARGET	equ	0fecbh		;target file name, fecb-fed0
  FED1                	FNAME	equ	0fed1h		;loading file name, fed1-fed6
  FED8                	VERIFY	equ	0fed8h		;load/verify flag 00h=load ffh=verify
  FEDA                	INPBUF	equ	0fedah		;input buffer, feda-ff21, (ff22)-(ff23)=00h
  FF25                	ARGTYP	equ	0ff25h		;0=value 1=string
  FF27                	STREND	equ	0ff27h		;strings area end
  FF29                	BASICAD	equ	0ff29h		;basic area start
  FF2D                	STRDSC1	equ	0ff2dh		;temporary string descriptor, ff2d-ff30
  FF31                	STRDSC2	equ	0ff31h		;ff31-ff34
  FF35                	STRDSC3	equ	0ff35h		;ff35-ff38
  FF39                	STRDSC4	equ	0ff39h		;ff39-ff3c
  FF3D                	STRAD	equ	0ff3dh		;string area start address - 1
  FF41                	GCWRK	equ	0ff41h		;garbage collection work
  FF45                	DATALN	equ	0ff45h		;data line number
  FF4E                	PROGAD	equ	0ff4eh		;program address in interpreting
  FF50                	TMP	equ	0ff50h		;temporary
  FF52                	STOPLN	equ	0ff52h		;line number at stop
  FF54                	STOPAD	equ	0ff54h		;stop address
  FF56                	VARAD	equ	0ff56h		;variable area start address
  FF58                	ARRAD	equ	0ff58h		;array area start address
  FF5A                	FREEAD	equ	0ff5ah		;free area start address
  FF5C                	DATAAD	equ	0ff5ch		;data command address
  FF5E                	FNPAR	equ	0ff5eh		;FN() parameter name
  FF60                	FNARG	equ	0ff60h		;FN() argument value, ff60-ff64
  FF65                	OPRTR	equ	0ff65h		;operator, FAC1-1
  FF66                	FAC1	equ	0ff66h		;floating accumlator 1, ff66-ff6a
  FF6D                	FAC2	equ	0ff6dh		;floating accumlator 2, ff6d-ff71
  FF72                	FAC3	equ	0ff72h		;floating accumlator 3 (string conversion)
  FF8A                	HOOK	equ	0ff8ah		;hook area, ff8a-ffe3
  FF99                	HOOKCLP	equ	0ff99h		;hook for changing link pointer
  FFD8                	HOOKSTP	equ	0ffd8h		;hook for stop key
  FFDB                	HOOK18H	equ	0ffdbh		;hook for 0018h
  FFE1                	HOOK38H	equ	0ffe1h		;hook for 0038h
  FFE6                	ASPECT	equ	0ffe6h		;aspect ratio for CIRCLE command
                      	
                      	
  0020                	COLUMNS	equ	32
  0010                	ROWS	equ	16
                      	
  0081                	FOR	equ	081h
  0083                	DATA	equ	083h
  0088                	GOTO	equ	088h
  0089                	RUN	equ	089h
  008C                	GOSUB	equ	08ch
  008E                	REM	equ	08eh
  0093                	DEF	equ	093h
  0095                	PRINT	equ	095h
  009B                	PSET_	equ	09bh
  009F                	SCREEN	equ	09fh
  00AA                	CMDLAST	equ	0aah
  00C2                	TAB	equ	0c2h
  00C3                	TO	equ	0c3h
  00C4                	FN	equ	0c4h
  00C5                	SPC	equ	0c5h
  00C6                	INKEY	equ	0c6h
  00C7                	THEN	equ	0c7h
  00C8                	NOT_	equ	0c8h
  00C9                	STEP	equ	0c9h
  00CA                	PLUS	equ	0cah
  00CB                	MINUS	equ	0cbh
  00CF                	AND_	equ	0cfh
  00D0                	OR_	equ	0d0h
  00CC                	ASTRSK	equ	0cch
  00D1                	GT_	equ	0d1h
  00D2                	EQ_	equ	0d2h
  00D3                	LT_	equ	0d3h
  00D4                	FNC1ST	equ	0d4h
  00D7                	USR	equ	0d7h
  00EA                	LEFT_	equ	0eah
  00EC                	MID_	equ	0ech
  00F1                	FNCLAST	equ	0f1h
                      	
                      	
                      	;extended basic subroutine entry address
  4274                	DISK	equ	4274h
  42B9                	INIDSK	equ	42b9h
  51F2                	SETFATP	equ	51f2h
  5CFD                	DISK2	equ	5cfdh
                      	
                      	;6601 subroutine entry address
  016B                	CHGRAM	equ	016bh
  2030                	SCALE2	equ	2030h
  397A                	PUTI1	equ	397ah
  4000                	TALK	equ	4000h
  601C                	CALLINI	equ	601ch
  63E2                	SCRLU66	equ	63e2h
  642F                	SCRLD66	equ	642fh
  65CC                	AD2GAD2	equ	65cch
  69F3                	SETBO66	equ	69f3h
  6B7A                	SETC366	equ	6b7ah
  6B9E                	SCRN66	equ	6b9eh
  70E7                	LINBF66	equ	70e7h
  7122                	LINEB66	equ	7122h
  716A                	PAINT66	equ	716ah
  7AF9                	LOADHEX	equ	7af9h
                      	
                      	;6601 work area
  FCF9                	REGF	equ	0fcf9h
  FCFA                	REGA	equ	0fcfah
  FCFB                	REGC	equ	0fcfbh
  FCFC                	REGB	equ	0fcfch
  FCFD                	REGE	equ	0fcfdh
  FCFE                	REGD	equ	0fcfeh
  FCFF                	REGL	equ	0fcffh
  FD00                	REGH	equ	0fd00h
  FD02                	REGPC	equ	0fd02h
  FD04                	REGSP	equ	0fd04h
  FD06                	BRKADR1	equ	0fd06h
  FD08                	BRKSAV1	equ	0fd08h
  FD09                	BRKADR2	equ	0fd09h
  FD0B                	BRKSAV2	equ	0fd0bh
  FD0E                	MONFLG	equ	0fd0eh		;b6=RAM/ROM, b5=printer, b4=echo, b3=CMT/RS-232C, b0=CRT
                      	
  FE60                	ATTDAT2	equ	0fe60h
  FE61                	BORDERA2	equ	0fe61h
  FE64                	PORTF0H	equ	0fe64h		;port f0h
  FE65                	MODE	equ	0fe65h		;mode-1
  FE8D                	READRAM	equ	0fe8dh		;subroutine: read RAM data for PC-6601
  FEA1                	OUTF0H	equ	0fea1h		;subroutine: output port f0h
  FE93                	LDIRRAM	equ	0fe93h		;subroutine: LDIR in RAM for PC-6601
  FE98                	CHGROM	equ	0fe98h		;subroutine: change 0000-7fff to BASIC ROM
  FEA5                	LDDRRAM	equ	0fea5h		;subroutine: LDDR in RAM for PC-6601
  FEB8                	PAWRK2	equ	0feb8h		;paint work, feb8-feb9
  FEC7                	FKEYLEN	equ	0fec7h
                      	
                      	;work area for FDD
  FB31                	FILES	equ	0fb31h
  FB3B                	DRIVES	equ	0fb3bh
  FE70                	RDWRCHK	equ	0fe70h		;read or write or check FD
  FE71                	RMSECT	equ	0fe71h		;remaining sector
  FE72                	TRACK	equ	0fe72h
  FE73                	DRIVE	equ	0fe73h
  FE74                	SECTOR	equ	0fe74h
  FE75                	DRVBIT	equ	0fe75h		;bit4=drvieA,bit5=drvieB
  FE77                	RETRY	equ	0fe77h
  FE78                	NSECT	equ	0fe78h		;1-4
  FE79                	STATBF	equ	0fe79h		;FDC status, fe79-fe7f
  FFE8                	ERRAD	equ	0ffe8h		;jump address in error of 10 counts
                      	
                      	;6601 constant
  0028                	CLMN66	equ	40
  0014                	ROWS66	equ	20
  00C1                	CLAST66	equ	0c1h
  00F9                	FLAST66	equ	0f9h
                      	
                      	;FD I/O port
  00B1                	FDCNTL	equ	0b1h		;FD control
  00B2                	FDCINT	equ	0b2h		;FDC interrupt
  00B3                	B2CNTL	equ	0b3h		;port b2 control?
  00D0                	FDBUF	equ	0d0h		;d0-d3
  00D4                	MOTORST	equ	0d4h		;FDD motor status
  00D6                	MOTOR	equ	0d6h		;FDD motor on/off
  00DA                	BUFSIZ	equ	0dah		;0e=use port d0, 0d=d0-d1, 0c=d0-d2, 0b=d0-d3
  00DC                	FDCSTAT	equ	0dch		;FDC status register
  00DD                	FDCDATA	equ	0ddh		;FDC data register
  00DE                	ADJUST	equ	0deh		;?
                      	
                      	
                      	;;;;;;;;;;;;;;;;;;;;;;;;;
                      	
                      	;boot
  0000                		org	BOOT
  0000  F3            		di
  0001  C36F16        		jp	COLD
                      	
                      	
                      	;check parameter
                      	; compare (hl) and data at (sp)
                      	;input: sp,hl
                      	;output: a=data, hl=data address, z-flag(a=00h or 3ah), c-flag(a=30h-39h)
  0004                	_CHKPAR:ds	CHKPAR-_CHKPAR
  0008                		org	CHKPAR
                      	
  0008  E3            		ex	(sp),hl
  0009  7E            		ld	a,(hl)
  000A  23            		inc	hl
  000B  E3            		ex	(sp),hl
  000C  BE            		cp	(hl)
  000D  C2E403        		jp	nz,SNERR
                      	
                      	
                      	;skip space and analyze a byte
                      	;input: hl=address-1
                      	;output: a=data, hl=data address, z-flag(a=00h or 3ah), c-flag(a=30h-39h)
                      	;destroy: f
  0010                	_ANADAT:ds	ANADAT-_ANADAT
  0010                		org	ANADAT
                      	
  0010  CD593F        		call	SKIPSPINC
  0013  C3C60B        		jp	CHKFIG
                      	
                      	
                      	;jump hook
  0016                	_JPHK1	:ds	JPHK1-_JPHK1
  0018                		org	JPHK1
                      	
  0018  C3DBFF        		jp	HOOK18H
                      	
                      	
                      	;compare hl and de
                      	;input: hl,de
                      	;output: f
                      	;destroy: af
  001B                	_CPHLDE:ds	CPHLDE-_CPHLDE
  0020                		org	CPHLDE
                      	
  0020  7C            		ld	a,h
  0021  92            		sub	d
  0022  C0            		ret	nz
  0023  7D            		ld	a,l
  0024  93            		sub	e
  0025  C9            		ret
                      	
                      	
                      	;check sign of FAC1
                      	;input: FAC1
                      	;output: a(0:FAC1=0 1:FAC1>0 ff:FAC1<0), z(1:FAC1=0)
                      	;destroy: af
  0026                	_CHKSGN:ds	CHKSGN-_CHKSGN
  0028                		org	CHKSGN
  0028  3A6AFF        		ld	a,(FAC1+4)
  002B  B7            		or	a
  002C  C8            		ret	z
  002D  C30239        		jp	CHKSGN2
                      	
                      	
                      	;jump hook
  0030                	_JPHK2:	ds	JPHK2-_JPHK2
  0038                		org	JPHK2
                      	
  0038  C3E1FF        		jp	HOOK38H
                      	
                      	
                      	;hot start
  003B                	HOT:
                      	;initialize function key
  003B  217201        		ld	hl,FKEYLST
  003E  113DFB        		ld	de,FKEYTBL
  0041  0E0A          		ld	c,0ah
  0043                	SETFKLP1:
  0043  7E            		ld	a,(hl)
  0044  23            		inc	hl
  0045  E5            		push	hl		;
  0046  CDB525        		call	CNVASC
                      	
  0049  0608          		ld	b,08h
  004B                	SETFKLP2:
  004B  FE41          		cp	'A'
  004D  3806          		jr	c,SETFKC
  004F  FE5B          		cp	'Z'+1
  0051  3002          		jr	nc,SETFKC
  0053  C620          		add	a,'a'-'A'
  0055                	SETFKC:
  0055  05            		dec	b
  0056  12            		ld	(de),a
  0057  13            		inc	de
  0058  23            		inc	hl
  0059  7E            		ld	a,(hl)
  005A  B7            		or	a
  005B  F24B00        		jp	p,SETFKLP2
                      	
  005E  E1            		pop	hl		;
  005F  7E            		ld	a,(hl)
  0060  23            		inc	hl
                      	
  0061                	SETFKLP3:
  0061  12            		ld	(de),a
  0062  13            		inc	de
  0063  AF            		xor	a
  0064  10FB          		djnz	SETFKLP3
                      	
  0066  0D            		dec	c
  0067  20DA          		jr	nz,SETFKLP1
  0069  CDAE12        		call	PRTFKEY
                      	
                      	;check external ROM
  006C  210340        		ld	hl,4003h
  006F  CDE33F        		call	CHKEXTAB
  0072  200A          		jr	nz,SKIPMENU	;if (4000h)='A' and (4001h)='B'
  0074  CDE03F        		call	CHKEXTCD
  0077  3EA1          		ld	a,0a1h		;0000-5fff:BASIC ROM, 6000-7fff:external ROM
  0079  D3F0          		out	(0f0h),a
  007B  CD1F40        		call	CHKEXT6000	;check 6000h and select mode
  007E                	SKIPMENU:
  007E  F5            		push	af		;a=mode, z=mode 5?
                      	
                      	;How Many Pages?
  007F                	PAGELP:
  007F  212401        		ld	hl,HOWMANY
  0082  CDCF30        		call	PUTS
  0085  CDF928        		call	INPT1
  0088  D7            		rst	ANADAT
  0089  3807          		jr	c,PAGEOK
  008B  218CFD        		ld	hl,PAGES
  008E  5E            		ld	e,(hl)
  008F  57            		ld	d,a		;if return, a=0
  0090  1805          		jr	CHKPAGE
                      	
  0092                	PAGEOK:
  0092  0600          		ld	b,00h
  0094  CDD127        		call	ATOI2
  0097                	CHKPAGE:
  0097  7A            		ld	a,d
  0098  B7            		or	a
  0099  20E4          		jr	nz,PAGELP
                      	
  009B  7B            		ld	a,e
  009C  3D            		dec	a
  009D  218CFD        		ld	hl,PAGES
  00A0  BE            		cp	(hl)
  00A1  30DC          		jr	nc,PAGELP
  00A3  73            		ld	(hl),e
                      	
  00A4  F1            		pop	af		;a=mode, z=mode 5?
  00A5  CAF060        		jp	z,MODE5
  00A8  FE02          		cp	02h
  00AA  3809          		jr	c,MODE12
  00AC                	MODE34:
  00AC  3EA1          		ld	a,0a1h		;0000-5fff:BASIC ROM, 6000-7fff:external ROM
  00AE  D3F0          		out	(0f0h),a
  00B0  D5            		push	de
  00B1  CD7F40        		call	SETTBL
  00B4  D1            		pop	de
  00B5                	MODE12:
  00B5  CDDC34        		call	NEW
  00B8  211F01        		ld	hl,ENDTBL-1
  00BB  19            		add	hl,de		;d=0
  00BC  66            		ld	h,(hl)
  00BD  2EFF          		ld	l,0ffh
  00BF  228DFD        		ld	(USREND),hl
  00C2  013200        		ld	bc,50
  00C5  CDBE35        		call	CLRMAIN
                      	
                      	;print start message
  00C8  213501        		ld	hl,SYSNAME
  00CB                	START:
  00CB  CDCF30        		call	PUTS
  00CE  CDEA34        		call	CHKFRE
  00D1  212F00        		ld	hl,002fh
  00D4  19            		add	hl,de
  00D5  CDA13A        		call	PUTI2
  00D8  211401        		ld	hl,BFREE
  00DB                	PUTSEDIT:
  00DB  CDCF30        		call	PUTS
  00DE  C34204        		jp	EDIT
                      	
                      	
                      	;initialize table
  00E1                	IOTBL93:
  00E1  C0            		db	0c0h		;8255 portA=mode2 portB=mode0
  00E2  0D            		db	0dh		;enable 8255 INT for writing
  00E3  09            		db	09h		;enable 8255 INT for reading
  00E4  05            		db	05h		;CGROM off
  00E5  03            		db	03h		;CRTC
  00E6  0F            		db	0fh		;nobf=1 (for emulator?)
                      	
  00E7                	IOTBL81:
  00E7  12            		db	12h		;reset error, DTR=1, RxE/TxEN=0
  00E8  12            		db	12h		; set twice for synchronous mode
  00E9  52            		db	52h		;reset, reset error, DTR=1, RxE/TxEN=0
  00EA  4F            		db	4fh		;stop bits=1, parity disable,
                      					; character length=8bits, baud rate factor=64
  00EB  37            		db	37h		;reset error, RTS/DTR/RxE/TxEN=1
                      	
  00EC                	IOTBLF0:
  00EC  11            	F0:	db	11h		;0000-7fff:BASIC ROM
                      	;F0:	db	71h		;0000-3fff:BASIC ROM, 4000-7fff:external ROM
  00ED  DD            	F1:	db	0ddh		;8000-ffff:internal RAM for reading
  00EE  55            	F2:	db	55h		;0000-ffff:internal RAM for writing
  00EF  C2            	F3:	db	0c2h		;wait & int control
  00F0  00            	F4:	db	00h		;INT1 address
  00F1  00            	F5:	db	00h		;INT2 address
  00F2  03            	F6:	db	03h		;timer count up
  00F3  06            	F7:	db	06h		;timer interrupt address
  00F4  C3            	F8:	db	0c3h		;CG rom access control
                      	
                      	;interrupt
  00F5                	INTTBL:
  00F5  B50E          		dw	INTKEY		;fa02 normal key
  00F7  590F          		dw	INT232		;fa04 RS-232C
  00F9  740F          		dw	INTTIM		;fa06 2ms timer
  00FB  9A0F          		dw	INTCMT		;fa08 CMT read
  00FD  A70F          		dw	EIRET		;fa0a ?
  00FF  A70F          		dw	EIRET		;fa0c ?
  0101  A90F          		dw	INTWSTP		;fa0e CMT write stop
  0103  A90F          		dw	INTRSTP		;fa10 CMT read stop
  0105  B10F          		dw	INTERR		;fa12 CMT error
  0107  B00E          		dw	INTGRP		;fa14 GRAPH key etc.
  0109  D10E          		dw	INTGAM		;fa16 reply to game key query
                      	
                      	
  010B  00            		db	00h		;STOPFLG
  010C  00            		db	00h		;CMTSTAT
  010D  000000        		db	00h, 00h, 00h
  0110  00            		db	00h		;CMTBUF
  0111  20            		db	' '		;ASTSTAT
  0112  FF            		db	0ffh		;BAUD
  0113  10            		db	ROWS		;HEIGHT
                      	
                      	
  0114                	BFREE:
  0114  20427974657320		db	" Bytes free", 00h
  0120                	ENDTBL:
  0120  F9DFBF9F      		db	0f9h, 0dfh, 0bfh, 9fh
  0124                	HOWMANY:
  0124  486F77204D616E		db	"How Many Pages"
  0132                	QMARK:
  0132  3F2000        		db	"? ", 00h
  0135                	SYSNAME:
  0135  36309ADE96FD42		db	"60", 9ah, 0deh, 96h, 0fdh, "BASIC", 0dh, 0ah, 00h
                      	
  0143                	PAGEDATA:
  0143  80            		db	80h		;fd91	VRAM address
  0144  00            		db	00h		;fd92	screen 1st parameter-1
  0145  01            		db	01h		;fd93	color 1st parameter
  0146  00            		db	00h		;fd94	color 2nd parameter
  0147  00            		db	00h		;fd95	color 3rd parameter (1,2 -> 0,2)
  0148  010000        		db	01h, 00h, 00h	;fd96	screen mode 1 color parameters
  014B  010000        		db	01h, 00h, 00h	;fd99	screen mode 2 color parameters
  014E  020000        		db	02h, 00h, 00h	;fd9c	screen mode 3 color parameters
  0151  030000        		db	03h, 00h, 00h	;fd9f	screen mode 4 color parameters
  0154  01            		db	01h		;fda2	console 1st line number+1
  0155  10            		db	10h		;fda3	console last line number+1
  0156  00            		db	00h		;fda4
  0157  0F            		db	0fh		;fda5	sc12:(fda3)-(fda6) sc34:(fda3)
  0158  01            		db	01h		;fda6	console 3rd parameter
  0159  00            		db	00h		;fda7	shift key status for function key disp
  015A  01            		db	01h		;fda8	cursor Y+1
  015B  01            		db	01h		;fda9	cursor X+1
  015C  00C2          		dw	0c200h		;fdaa	cursor address
  015E  20            		db	COLUMNS		;fdac	X max+1
  015F  00            		db	00h		;fdad
  0160  0000          		dw	0000h		;fdae	graphic X
  0162  0000          		dw	0000h		;fdb0	graphic Y
  0164  00            		db	00h		;fdb2
  0165  00            		db	00h		;fdb3
  0166  FF            		db	0ffh		;fdb4	LINEST-1
  0167  FF            		db	0ffh		;fdb5	LINEST
  0168  FF            		db	0ffh		;fdb6
  0169  FF            		db	0ffh		;fdb7
                      	
                      	
                      	;change 0000-7fffh to RAM
                      	;destroy: none
  016A                	_CHGRAM:ds	CHGRAM-_CHGRAM
  016B                		org	CHGRAM
                      	
  016B  F5            		push	af
  016C  3EDD          		ld	a,0ddh		;0000-7fff:internal RAM for reading
  016E  F3            		di
  016F  C3A1FE        		jp	OUTF0H
                      	
                      	
  0172                	FKEYLST:
  0172  9A20          		db	9ah, ' '	;COLOR
  0174  A322          		db	0a3h, 22h	;CLOAD"
  0176  8820          		db	88h, ' '	;GOTO
  0178  9720          		db	97h, ' '	;LIST
  017A  890D          		db	89h, 0dh	;RUN
  017C  9F20          		db	9fh, ' '	;SCREEN
  017E  A422          		db	0a4h, 22h	;CSAVE"
  0180  9520          		db	95h, ' '	;PRINT
  0182  A720          		db	0a7h, ' '	;PLAY
  0184  960D          		db	96h, 0dh	;CONT
                      	
                      	
  0186                	OPRTBL:
                      	;c4-c7
                      	;	dw					F_FN,	F_SPC,	F_INKY,	C_THEN
                      	;c8-cf
  0186  470CE4036F3685		dw	O_NOT,	C_STEP,	O_PLS,	O_MNS,	O_MUL,	O_DIV,	O_POW,	O_AND
                      	;d0-d3
  0196  CF0BE70B      		dw	O_OR,	O_GTEQLT
                      	
  019A                	CMDLST:
                      	;80-8f
  019A  65356A06DC35E0		dw	C_END,	C_FOR,	C_NEXT,	C_DATA,	C_INPT,	C_DIM,	C_READ,	C_LET
  01AA  A6078107250816		dw	C_GOTO,	C_RUN,	C_IF,	C_RSTR,	C_GSUB,	C_RET,	C_REM,	C_STOP
                      	;90-9f
  01BA  B60DFF077A0857		dw	C_OUT,	C_ON,	C_LPRT,	C_DEF,	C_POKE,	C_PRT,	C_CONT,	C_LIST
  01CA  C50593359B1D38		dw	C_LLST,	C_CLR,	C_COLR,	C_PSET,	C_PRST,	C_LINE,	C_PAIN,	C_SCRN
                      	;a0-aa
  01DA  FB1DD31CED1C5A		dw	C_CLS,	C_LOCA,	C_CNSL,	C_CLD,	C_CSV,	C_EXEC,	C_SOUN,	C_PLAY
  01EA  E6224E22D434  		dw	C_KEY,	C_LCPY,	C_NEW
                      	
  01F0                	FNCLST:
                      	;d4-df
  01F0  0A3980391639ED		dw					F_SGN,	F_INT,	F_ABS,	F_USR
  01F8  1332A80D330D41		dw	F_FRE,	F_INP,	F_LPOS,	F_POS,	F_SQR,	F_RND,	F_LOG,	F_EXP
                      	;e0-ef
  0208  753D883D533EEE		dw	F_COS,	F_SIN,	F_TAN,	F_PEEK,	F_LEN,	SNERR,	F_STR,	F_VAL
  0218  AC31B631C031C7		dw	F_ASC,	F_CHR,	F_LEFT,	F_RHT,	F_MID,	F_POIN,	F_CSRL,	F_STCK
                      	;f0-f1
  0228  2E226F1E      		dw	F_STRG,	F_TIME
                      	
                      	
  022C                	CMDNAME:
  022C  C54E44C64F52CE		db	'E'+80h,"ND",	'F'+80h,"OR",	'N'+80h,"EXT",	'D'+80h,"ATA"
  023A  C94E505554C449		db	'I'+80h,"NPUT",	'D'+80h,"IM",	'R'+80h,"EAD",	'L'+80h,"ET"
  0249  C74F544FD2554E		db	'G'+80h,"OTO",	'R'+80h,"UN",	'I'+80h,"F",	'R'+80h,"ESTORE"
  0259  C74F535542D245		db	'G'+80h,"OSUB",	'R'+80h,"ETURN",'R'+80h,"EM",	'S'+80h,"TOP"
                      	
  026B  CF5554CF4ECC50		db	'O'+80h,"UT",	'O'+80h,"N",	'L'+80h,"PRINT",'D'+80h,"EF"
  0279  D04F4B45D05249		db	'P'+80h,"OKE",	'P'+80h,"RINT",	'C'+80h,"ONT",	'L'+80h,"IST"
  028A  CC4C495354C34C		db	'L'+80h,"LIST",	'C'+80h,"LEAR",	'C'+80h,"OLOR",	'P'+80h,"SET"
  029D  D05245534554CC		db	'P'+80h,"RESET",'L'+80h,"INE",	'P'+80h,"AINT",	'S'+80h,"CREEN"
                      	
  02B2  C34C53CC4F4341		db	'C'+80h,"LS",	'L'+80h,"OCATE",'C'+80h,"ONSOLE",'C'+80h,"LOAD"
  02C7  C353415645C558		db	'C'+80h,"SAVE",	'E'+80h,"XEC",	'S'+80h,"OUND",	'P'+80h,"LAY"
  02D9  CB4559CC434F50		db	'K'+80h,"EY",	'L'+80h,"COPY",	'N'+80h,"EW"
                      	
  02E4                	FNCNAME:
  02E4  D4414228D44F  		db					'T'+80h,"AB(",	'T'+80h,"O"
  02EA  C64ED3504328C9		db	'F'+80h,"N",	'S'+80h,"PC(",	'I'+80h,"NKEY$",'T'+80h,"HEN"
  02FA  CE4F54D3544550		db	'N'+80h,"OT",	'S'+80h,"TEP",	'+'+80h,	'-'+80h
  0303  AAAFDEC14E44  		db	'*'+80h,	'/'+80h,	'^'+80h,	'A'+80h,"ND"
                      	
  0309  CF52BEBDBC    		db	'O'+80h,"R",	'>'+80h,	'='+80h,	'<'+80h
  030E  D3474EC94E54C1		db	'S'+80h,"GN",	'I'+80h,"NT",	'A'+80h,"BS",	'U'+80h,"SR"
  031A  C65245C94E50CC		db	'F'+80h,"RE",	'I'+80h,"NP",	'L'+80h,"POS",	'P'+80h,"OS"
  0327  D35152D24E44CC		db	'S'+80h,"QR",	'R'+80h,"ND",	'L'+80h,"OG",	'E'+80h,"XP"
                      	
  0333  C34F53D3494ED4		db	'C'+80h,"OS",	'S'+80h,"IN",	'T'+80h,"AN",	'P'+80h,"EEK"
  0340  CC454EC8455824		db	'L'+80h,"EN",	'H'+80h,"EX$",	'S'+80h,"TR$",	'V'+80h,"AL"
  034E  C15343C3485224		db	'A'+80h,"SC",	'C'+80h,"HR$",	'L'+80h,"EFT$",	'R'+80h,"IGHT$"
  0360  CD494424D04F49		db	'M'+80h,"ID$",	'P'+80h,"OINT",	'C'+80h,"SRLIN",'S'+80h,"TICK"
                      	
  0374  D354524947D449		db	'S'+80h,"TRIG",	'T'+80h,"IME",	80h
                      	
                      	
  037E                	_ERRBELL:ds	ERRSTR-1-_ERRBELL
  0383                		org	ERRSTR-1
  0383                	ERRBELL:
  0383  07            		db	07h
                      	
  0384                	_ERRSTR:ds	ERRSTR-_ERRSTR
  0384                		org	ERRSTR
  0384  204572726F7200		db	" Error", 00h
                      	
  038B                	_ERRIN:	ds	ERRIN-_ERRIN
  038B                		org	ERRIN
  038B  20696E2000    		db	" in ", 00h
                      	
  0390                	_OK:
  0390                		ds	OK-_OK
  0390                		org	OK
  0390  4F6B0D0A00    		db	"Ok", 0dh, 0ah, 00h
                      	
  0395                	ERRID:
  0395  4E46534E52474F		db	"NF", "SN", "RG", "OD", "FC", "OV", "OM", "UL"
  03A5  425344442F3049		db	"BS", "DD", "/0", "ID", "TM", "OS", "LS", "ST"
  03B5  434E554654524D		db	"CN", "UF", "TR", "MO", "FD"
                      	
                      	
                      	;print error message
                      	;input: e=error number
                      	;destroys: af,bc,de,hl
  03BF                	PRTERR:
  03BF  3E3F          		ld	a,'?'
  03C1  CD7510        		call	PUTC
  03C4  219503        		ld	hl,ERRID
  03C7  7B            		ld	a,e
  03C8  FE30          		cp	30h
  03CA  3803          		jr	c,PRTERRC
  03CC  21BF41        		ld	hl,ERRIDEX
  03CF                	PRTERRC:
  03CF  1600          		ld	d,00h
  03D1  19            		add	hl,de
  03D2  7E            		ld	a,(hl)
  03D3  CD7510        		call	PUTC
  03D6  23            		inc	hl
  03D7  7E            		ld	a,(hl)
  03D8  CD7510        		call	PUTC
  03DB  218303        		ld	hl,ERRBELL
  03DE  C3CF30        		jp	PUTS
                      	
                      	
  03E1                	NFERR:
  03E1  1E00          		ld	e,00h
  03E3  01            		db	01h		;ld bc,****
  03E4                	C_TO:
  03E4                	C_TAB:
  03E4                	F_SPC:
  03E4                	C_THEN:
  03E4                	C_STEP:
                      	
                      	;mode 5 (unimplemnted)
  03E4                	C_RENM:
  03E4                	C_BLD:
  03E4                	C_BSAV:
  03E4                	C_FLS:
  03E4                	C_LFLS:
  03E4                	C_LOAD:
  03E4                	C_MRG:
  03E4                	C_NAME:
  03E4                	C_SAVE:
  03E4                	C_FLD:
  03E4                	C_LSET:
  03E4                	C_RSET:
  03E4                	C_OPEN:
  03E4                	C_CLOS:
  03E4                	C_DSKO:
  03E4                	C_KILL:
  03E4                	F_PAD:
  03E4                	F_DSKI:
  03E4                	F_LOF:
  03E4                	F_LOC:
  03E4                	F_EOF:
  03E4                	F_DSKF:
  03E4                	F_CVS:
  03E4                	F_MKS:
                      	
                      	
  03E4                	SNERR:
  03E4  1E02          		ld	e,02h
  03E6  01            		db	01h		;ld bc,****
  03E7                	RGERR:
  03E7  1E04          		ld	e,04h
  03E9  01            		db	01h		;ld bc,****
  03EA                	ODERR:
  03EA  1E06          		ld	e,06h
  03EC  01            		db	01h		;ld bc,****
  03ED                	FCERR:
  03ED                	F_USR:
  03ED  1E08          		ld	e,08h
  03EF  01            		db	01h		;ld bc,****
  03F0                	OVERR:
  03F0  1E0A          		ld	e,0ah
  03F2  01            		db	01h		;ld bc,****
  03F3                	OMERR:
  03F3  1E0C          		ld	e,0ch
  03F5  01            		db	01h		;ld bc,****
  03F6                	ULERR:
  03F6  1E0E          		ld	e,0eh
  03F8  01            		db	01h		;ld bc,****
  03F9                	BSERR:
  03F9  1E10          		ld	e,10h
  03FB  01            		db	01h		;ld bc,****
  03FC                	DDERR:
  03FC  1E12          		ld	e,12h
  03FE  01            		db	01h		;ld bc,****
  03FF                	DIV0ERR:
  03FF  1E14          		ld	e,14h
  0401  01            		db	01h		;ld bc,****
  0402                	IDERR:
  0402  1E16          		ld	e,16h
  0404  01            		db	01h		;ld bc,****
  0405                	TMERR:
  0405  1E18          		ld	e,18h
  0407  01            		db	01h		;ld bc,****
  0408                	OSERR:
  0408  1E1A          		ld	e,1ah
  040A  01            		db	01h		;ld bc,****
  040B                	LSERR:
  040B  1E1C          		ld	e,1ch
  040D  01            		db	01h		;ld bc,****
  040E                	STERR:
  040E  1E1E          		ld	e,1eh
  0410  01            		db	01h		;ld bc,****
  0411                	CNERR:
  0411  1E20          		ld	e,20h
  0413  01            		db	01h		;ld bc,****
  0414                	UFERR:
  0414  1E22          		ld	e,22h
  0416  01            		db	01h		;ld bc,****
  0417                	TRERR:
  0417  1E24          		ld	e,24h
  0419  01            		db	01h		;ld bc,****
  041A                	MOERR:
  041A  1E26          		ld	e,26h
  041C  01            		db	01h		;ld bc,****
  041D                	FDERR:
  041D  1E28          		ld	e,28h
                      	
  041F                	ERROR:
  041F  ED7B5BFA      		ld	sp,(STACK)
                      	
                      	;	xor	a
                      	;	ld	(STRDSC2),a
                      	;	ld	(STRDSC3),a
                      	;	ld	(STRDSC4),a
                      	;	dec	a
                      	;	ld	(STOPAD+1),a	;(STOPAD)>=fa00h
                      	
  0423  2131FF        		ld	hl,STRDSC2
  0426  01000C        		ld	bc,0c00h
  0429                	ERRORLP:
  0429  71            		ld	(hl),c
  042A  23            		inc	hl
  042B  10FC          		djnz	ERRORLP
  042D  2254FF        		ld	(STOPAD),hl	;>=fa00h
                      	
  0430  CD5409        		call	PRTNLXTXT
  0433  CDBF03        		call	PRTERR
                      	
  0436                	PRTLNUM:
  0436  CDB31B        		call	PLSTOP
                      	
  0439  2A5DFA        		ld	hl,(LINENUM)
  043C  7C            		ld	a,h
  043D  A5            		and	l
  043E  3C            		inc	a
  043F  C4993A        		call	nz,INLNUM	;if (LINENUM)<>0ffffh
                      	;	jp	EDIT
                      	
                      	
                      	;program edit and direct command mode
  0442                	_EDIT:	ds	EDIT-_EDIT
  0442                		org	EDIT
                      	
  0442  CD5810        		call	CLRKBF
  0445                	EDIT2:
  0445  3E01          		ld	a,01h
  0447  3258FA        		ld	(DEVICE),a
  044A  3A57FA        		ld	a,(PRTPOS)
  044D  B7            		or	a
  044E  C43927        		call	nz,PUTNL
  0451  CD5109        		call	PRTNLXALL
  0454  219003        		ld	hl,OK
  0457  CDCF30        		call	PUTS
                      	
  045A  21FFFF        		ld	hl,0ffffh
  045D  225DFA        		ld	(LINENUM),hl
                      	
  0460                	EDITLP:
  0460  CDF928        		call	INPT1
  0463  DCB31B        		call	c,PLSTOP
  0466  CD2705        		call	CNVIL
  0469  21D9FE        		ld	hl,INPBUF-1
  046C  D7            		rst	ANADAT		;
  046D  3C            		inc	a
  046E  3D            		dec	a
  046F  28EF          		jr	z,EDITLP
  0471  D20A07        		jp	nc,INTPRT	;
                      	
                      	
                      	;change program
  0474                	CHGPRG:
  0474  CD5F07        		call	GETLN
  0477  E5            		push	hl		;buffer address
  0478  D5            		push	de		;line number
  0479  E5            		push	hl		;buffer address
  047A  CDF304        		call	SRCHLN
  047D  DCC204        		call	c,DELPRG	;c-flag=1
  0480  E1            		pop	hl		;buffer address
  0481  34            		inc	(hl)
  0482  35            		dec	(hl)
  0483  2005          		jr	nz,INSPRG
  0485  3833          		jr	c,PRGEND	;
  0487  C3F603        		jp	ULERR
                      	
  048A                	INSPRG:
  048A  AF            		xor	a
  048B  110500        		ld	de,0005h
  048E                	PRGLP:
  048E  1C            		inc	e
  048F  3C            		inc	a
  0490  23            		inc	hl
  0491  34            		inc	(hl)
  0492  35            		dec	(hl)
  0493  20F9          		jr	nz,PRGLP
                      	
  0495  2A56FF        		ld	hl,(VARAD)
  0498  E5            		push	hl
                      	;	or	a
  0499  ED42          		sbc	hl,bc
  049B  E5            		push	hl		;slide size
  049C  09            		add	hl,bc		;old (VARAD)
  049D  19            		add	hl,de		;old (VARAD)+size
  049E  2256FF        		ld	(VARAD),hl
  04A1  EB            		ex	de,hl
  04A2  C1            		pop	bc		;slide size
  04A3  E1            		pop	hl		;old (VARAD)
  04A4  2B            		dec	hl
  04A5  1B            		dec	de
  04A6  EDB8          		lddr
                      	
  04A8                	COPYPRG:
  04A8  23            		inc	hl		;address to be inserted in
  04A9  23            		inc	hl
  04AA  13            		inc	de
  04AB  13            		inc	de
  04AC  73            		ld	(hl),e
  04AD  23            		inc	hl
  04AE  72            		ld	(hl),d
  04AF  23            		inc	hl
  04B0  D1            		pop	de		;line number
  04B1  73            		ld	(hl),e
  04B2  23            		inc	hl
  04B3  72            		ld	(hl),d
  04B4  23            		inc	hl
  04B5  EB            		ex	de,hl
  04B6  E1            		pop	hl		;buffer address
                      	
  04B7  4F            		ld	c,a		;b=0
  04B8  EDB0          		ldir
                      	
  04BA                	PRGEND:
  04BA  CDF934        		call	RESSTK
  04BD  CDD804        		call	CHGLKP
  04C0  189E          		jr	EDITLP
                      	
                      	
                      	;input: bc=address to be deleted, hl=next line address
                      	;output: c-flag=1
                      	;destroy: af,de,hl
  04C2                	DELPRG:
  04C2  C5            		push	bc		;address to be deleted
  04C3  EB            		ex	de,hl		;de <- next line address
  04C4  2A56FF        		ld	hl,(VARAD)
  04C7  B7            		or	a
  04C8  ED52          		sbc	hl,de
  04CA  44            		ld	b,h
  04CB  4D            		ld	c,l
  04CC  EB            		ex	de,hl		;hl <- next line address
  04CD  D1            		pop	de		;address to be deleted
  04CE  D5            		push	de
  04CF  EDB0          		ldir
  04D1  ED5356FF      		ld	(VARAD),de
  04D5  C1            		pop	bc		;address to be deleted
  04D6  37            		scf
  04D7  C9            		ret
                      	
                      	
                      	;change link pointer
                      	;destroy: af,bc,de,hl
  04D8                	CHGLKP:
  04D8  CD99FF        		call	HOOKCLP
  04DB  ED5B5FFA      		ld	de,(STARTAD)
                      	;skip address and line number
  04DF                	CHGLKPLP:
  04DF  62            		ld	h,d
  04E0  6B            		ld	l,e
  04E1  7E            		ld	a,(hl)
  04E2  23            		inc	hl
  04E3  B6            		or	(hl)
  04E4  C8            		ret	z
                      	
  04E5  010300        		ld	bc,0003h
  04E8  09            		add	hl,bc
                      	
                      	;search for next line
  04E9  AF            		xor	a
  04EA  4F            		ld	c,a		;b=0
  04EB  EDB1          		cpir
                      	
                      	;next line address
  04ED  EB            		ex	de,hl
  04EE  73            		ld	(hl),e
  04EF  23            		inc	hl
  04F0  72            		ld	(hl),d
  04F1  18EC          		jr	CHGLKPLP
                      	
                      	
                      	;search for line number
                      	;input: de=line number
                      	;output: z=1,c=1) bc=address, hl=next line address
                      	;	 z=0,c=0) bc=next line address, hl=next next line address
                      	;	 z=1,c=0) bc=hl=end address
                      	;destroy: af
  04F3                	SRCHLN:
  04F3  2A5DFA        		ld	hl,(LINENUM)
  04F6  E7            		rst	CPHLDE
  04F7  300C          		jr	nc,SRCHSTART	;less than or equal to current line number
  04F9  2A4EFF        		ld	hl,(PROGAD)
  04FC                	SRCHLP1:
  04FC  7E            		ld	a,(hl)
  04FD  23            		inc	hl
  04FE  B7            		or	a
  04FF  20FB          		jr	nz,SRCHLP1
                      	
                      	;for PORTOPIA (mk2)
                      	;	jr	SRCHLP2
  0501  CD0805        		call	SRCHLP2
  0504  D8            		ret	c
                      	
  0505                	SRCHSTART:
  0505  2A5FFA        		ld	hl,(STARTAD)	;search from program start address
                      	
  0508                	SRCHLP2:
  0508  44            		ld	b,h
  0509  4D            		ld	c,l
  050A  7E            		ld	a,(hl)
  050B  23            		inc	hl
  050C  B6            		or	(hl)
  050D  2815          		jr	z,SRCHEND2	;program end
  050F  23            		inc	hl
  0510  23            		inc	hl
  0511  7E            		ld	a,(hl)
  0512  2B            		dec	hl
  0513  BA            		cp	d
  0514  2002          		jr	nz,SRCHNZ
  0516  7E            		ld	a,(hl)
  0517  BB            		cp	e
  0518                	SRCHNZ:
  0518  0A            		ld	a,(bc)
  0519  2B            		dec	hl
  051A  66            		ld	h,(hl)
  051B  6F            		ld	l,a
  051C  38EA          		jr	c,SRCHLP2	;(hl,hl-1)-de
  051E  2001          		jr	nz,SRCHEND	;(hl,hl-1)-de
  0520  37            		scf
  0521                	SRCHEND:
  0521  0B            		dec	bc
  0522  2B            		dec	hl
  0523  C9            		ret
                      	
  0524                	SRCHEND2:
  0524  2B            		dec	hl
  0525  18FA          		jr	SRCHEND
                      	
                      	
                      	;convert to intermediate language
                      	;input: hl=INPBUF-1
  0527                	CNVIL:
  0527  54            		ld	d,h
  0528  5D            		ld	e,l
                      	
  0529                	ILLP1:
  0529  13            		inc	de
  052A  1A            		ld	a,(de)
  052B  B7            		or	a
  052C  FA2905        		jp	m,ILLP1		;kana
  052F  23            		inc	hl
  0530  CABF05        		jp	z,ILEND
  0533  FE22          		cp	22h		;double quotation mark
  0535  2851          		jr	z,ILDQ
  0537  FE3F          		cp	'?'
  0539  2866          		jr	z,ILQ
  053B  FE14          		cp	14h
  053D  2866          		jr	z,ILGRP
                      	
  053F  E5            		push	hl
  0540  CDAC0B        		call	TOUPPER
  0543  F680          		or	80h
  0545  12            		ld	(de),a
                      	
  0546  0680          		ld	b,80h
  0548  212C02        		ld	hl,CMDNAME
                      	
  054B                	ILLP2:
  054B  D5            		push	de
  054C  1A            		ld	a,(de)
  054D  BE            		cp	(hl)
  054E  2016          		jr	nz,ILLP5
                      	
                      	;1st character matched
  0550                	ILLP3:
  0550  23            		inc	hl
  0551  7E            		ld	a,(hl)
  0552  07            		rlca
  0553  3858          		jr	c,ILFOUND
                      	
  0555  78            		ld	a,b
  0556  FE88          		cp	GOTO
  0558                	ILLP4:
  0558  13            		inc	de
  0559  1A            		ld	a,(de)
  055A  2004          		jr	nz,NOGOTO
  055C  FE20          		cp	' '
  055E  28F8          		jr	z,ILLP4
  0560                	NOGOTO:
  0560  CDAC0B        		call	TOUPPER
  0563  BE            		cp	(hl)
  0564  28EA          		jr	z,ILLP3
                      	
  0566                	ILLP5:
  0566  23            		inc	hl
  0567  7E            		ld	a,(hl)
  0568  07            		rlca
  0569  30FB          		jr	nc,ILLP5
  056B  D1            		pop	de
  056C  04            		inc	b
                      	
  056D  3A65FE        		ld	a,(MODE)
  0570  FE02          		cp	02h
  0572  D2D340        		jp	nc,CNVIL66
                      	
  0575  78            		ld	a,b
  0576  FEF2          		cp	FNCLAST+1
  0578  3008          		jr	nc,ILNC
  057A  FEAB          		cp	CMDLAST+1
  057C  20CD          		jr	nz,ILLP2
  057E  06C2          		ld	b,TAB
  0580  18C9          		jr	ILLP2
                      	
                      	;not found
  0582                	ILNC:
  0582  1A            		ld	a,(de)
  0583  E67F          		and	7fh
  0585  47            		ld	b,a
  0586  1826          		jr	ILPUT
                      	
  0588                	ILDQ:
  0588  77            		ld	(hl),a
                      	
  0589                	ILREM:
  0589  4F            		ld	c,a		;double quotation mark or 0(REM)
  058A  0601          		ld	b,01h		;double quotation counter
                      	
                      	;REM,DATA,""
                      	;loop until (de)=0 or (de)=c
  058C                	ILLP6:
  058C  13            		inc	de
  058D  23            		inc	hl
  058E  1A            		ld	a,(de)
  058F  77            		ld	(hl),a
  0590  B7            		or	a
  0591  282D          		jr	z,ILEND2
  0593  FE22          		cp	22h
  0595  2001          		jr	nz,ILNZ
  0597  04            		inc	b
  0598                	ILNZ:
  0598  CB40          		bit	0,b
  059A  20F0          		jr	nz,ILLP6
  059C  B9            		cp	c
  059D  20ED          		jr	nz,ILLP6
  059F  1888          		jr	ILLP1
                      	
  05A1                	ILQ:
  05A1  3695          		ld	(hl),PRINT	;95h
  05A3  1884          		jr	ILLP1
                      	
  05A5                	ILGRP:
  05A5  77            		ld	(hl),a
  05A6  13            		inc	de
  05A7  23            		inc	hl
  05A8  1A            		ld	a,(de)
  05A9  77            		ld	(hl),a
  05AA  C32905        		jp	ILLP1
                      	
                      	;found
  05AD                	ILFOUND:
  05AD  F1            		pop	af		;cancel
  05AE                	ILPUT:
  05AE  E1            		pop	hl
  05AF  70            		ld	(hl),b
  05B0  78            		ld	a,b
  05B1  D68E          		sub	REM
  05B3  28D4          		jr	z,ILREM
  05B5  FEF5          		cp	DATA-REM
  05B7  C22905        		jp	nz,ILLP1
                      	
  05BA                	ILDAT:
  05BA  013A00        		ld	bc,003ah	;b=0,c=':'
  05BD  18CD          		jr	ILLP6
                      	
  05BF                	ILEND:
  05BF  77            		ld	(hl),a		;a=0
  05C0                	ILEND2:
  05C0  23            		inc	hl
  05C1  77            		ld	(hl),a		;a=0
  05C2  23            		inc	hl
  05C3  77            		ld	(hl),a		;a=0
  05C4  C9            		ret
                      	
                      	
                      	;LLIST command
  05C5                	C_LLST:
  05C5  3E01          		ld	a,01h
  05C7  3258FA        		ld	(DEVICE),a
                      	;	jp	C_LIST
                      	
                      	
                      	;LIST command
  05CA                	C_LIST:
  05CA  F1            		pop	af		;cancel return address
  05CB  110000        		ld	de,0000h
  05CE  CD613F        		call	CHKCLN
  05D1  2814          		jr	z,LISTTOEND
                      	
  05D3  CD5F07        		call	GETLN
  05D6  D5            		push	de		;start line number
  05D7  CD613F        		call	CHKCLN
  05DA  281D          		jr	z,LISTSTRT
                      	
  05DC  FECB          		cp	MINUS
  05DE  C2E403        		jp	nz,SNERR
  05E1  CD603F        		call	CHKCLNINC
  05E4  2007          		jr	nz,LISTNZ
  05E6  D1            		pop	de
  05E7                	LISTTOEND:
  05E7  01FAFF        		ld	bc,65530
  05EA  C5            		push	bc
  05EB  180C          		jr	LISTSTRT
                      	
  05ED                	LISTNZ:
  05ED  CD5F07        		call	GETLN
  05F0  CD613F        		call	CHKCLN
  05F3  C2E403        		jp	nz,SNERR
                      	
  05F6  E1            		pop	hl
  05F7  D5            		push	de		;push end line number
  05F8  EB            		ex	de,hl		;de <- start line number
                      	
                      	
                      	;de=start line number, (sp)=end line number
  05F9                	LISTSTRT:
  05F9  CDF304        		call	SRCHLN
  05FC  60            		ld	h,b
  05FD  69            		ld	l,c
                      	
  05FE                	LISTLP1:
  05FE  CD4D27        		call	STOPESC
                      	
  0601  23            		inc	hl
  0602  7E            		ld	a,(hl)
  0603  23            		inc	hl
  0604  B6            		or	(hl)
  0605  2843          		jr	z,LISTEND2
                      	
  0607  CD3927        		call	PUTNL
                      	
  060A  D1            		pop	de		;end line number
  060B  D5            		push	de
                      	
  060C  23            		inc	hl
  060D  7E            		ld	a,(hl)
  060E  23            		inc	hl
  060F  E5            		push	hl
  0610  66            		ld	h,(hl)
  0611  6F            		ld	l,a
                      	
  0612  13            		inc	de
  0613  E7            		rst	CPHLDE
  0614  3033          		jr	nc,LISTEND
                      	
  0616  CDA13A        		call	PUTI2
  0619  3E20          		ld	a,' '
  061B  CDC726        		call	PUTDEV
                      	
  061E  E1            		pop	hl
                      	
  061F  010000        		ld	bc,0000h	;double quotation mark and DATA counter
  0622  50            		ld	d,b		;REM counter
  0623                	LISTLP3:
  0623  23            		inc	hl
  0624  7E            		ld	a,(hl)
  0625  B7            		or	a
  0626  28D6          		jr	z,LISTLP1
                      	
  0628  FE22          		cp	22h
  062A  2822          		jr	z,LISTDQ
                      	
  062C  CB40          		bit	0,b
  062E  2014          		jr	nz,LISTPUT
                      	
  0630  0C            		inc	c
  0631  0D            		dec	c
  0632  201D          		jr	nz,LISTCHKCLN
                      	
  0634  14            		inc	d
  0635  15            		dec	d
  0636  200C          		jr	nz,LISTPUT
                      	
  0638  FE8E          		cp	REM
  063A  281C          		jr	z,LISTREM
  063C  FE83          		cp	DATA
  063E  2819          		jr	z,LISTDATA
  0640  B7            		or	a
  0641  FA5A06        		jp	m,LISTCMD
  0644                	LISTPUT:
  0644  CDC726        		call	PUTDEV
  0647  18DA          		jr	LISTLP3
                      	
  0649                	LISTEND:
  0649  F1            		pop	af		;cancel stack
  064A                	LISTEND2:
  064A  F1            		pop	af		;cancel stack
  064B  C34204        		jp	EDIT
                      	
  064E                	LISTDQ:
  064E  04            		inc	b
  064F  18F3          		jr	LISTPUT
                      	
  0651                	LISTCHKCLN:
  0651  FE3A          		cp	':'
  0653  20EF          		jr	nz,LISTPUT
  0655  0D            		dec	c
  0656  18EC          		jr	LISTPUT
                      	
  0658                	LISTREM:
  0658  14            		inc	d
  0659                	LISTDATA:
  0659  0C            		inc	c
  065A                	LISTCMD:
  065A  E5            		push	hl
  065B  CDB525        		call	CNVASC
                      	
  065E                	LISTLP4:
  065E  CDC726        		call	PUTDEV
  0661  23            		inc	hl
  0662  7E            		ld	a,(hl)
  0663  B7            		or	a
  0664  F25E06        		jp	p,LISTLP4
  0667  E1            		pop	hl
  0668  18B9          		jr	LISTLP3
                      	
                      	
                      	;FOR command
  066A                	C_FOR:
  066A  F1            		pop	af		;cancel return address
  066B  CD8433        		call	CHKVAR
  066E  7E            		ld	a,(hl)
  066F  FE28          		cp	'('
  0671  CAE403        		jp	z,SNERR
                      	
  0674  CD9832        		call	GETVAR
  0677  2A4EFF        		ld	hl,(PROGAD)
                      	
  067A  D5            		push	de		;variable address
                      	
  067B  CDA234        		call	VARIN
  067E  CD780B        		call	CHKNUM
  0681  7E            		ld	a,(hl)
  0682  FEC3          		cp	TO
  0684  C2E403        		jp	nz,SNERR
  0687  23            		inc	hl
  0688  CD6F0B        		call	NUMARGMO
  068B  EB            		ex	de,hl
  068C  CD1F39        		call	PUSHF1		;TO value
  068F  EB            		ex	de,hl
  0690  CD613F        		call	CHKCLN		;a=(hl)
  0693  224EFF        		ld	(PROGAD),hl
  0696  CC4122        		call	z,SETPLS1	;no change in z-flag
  0699  2809          		jr	z,STEP1
  069B  FEC9          		cp	STEP
  069D  C2E403        		jp	nz,SNERR
  06A0  23            		inc	hl
  06A1  CD6F0B        		call	NUMARGMO
  06A4                	STEP1:
  06A4  CD4C39        		call	POPF2		;TO value
  06A7  C1            		pop	bc		;variable address
                      	
  06A8  2A4EFF        		ld	hl,(PROGAD)
  06AB  E5            		push	hl		;program address
  06AC  210200        		ld	hl,0002h
  06AF  39            		add	hl,sp
  06B0                	FORLP:
  06B0  CDD507        		call	SRCHSTK2
  06B3  280F          		jr	z,FOROK		;not found or gosub identifier found
                      	
                      	;check program address
  06B5  111100        		ld	de,0011h
  06B8  19            		add	hl,de
  06B9  5E            		ld	e,(hl)
  06BA  23            		inc	hl
  06BB  56            		ld	d,(hl)
  06BC  23            		inc	hl
  06BD  E3            		ex	(sp),hl
  06BE  E7            		rst	CPHLDE
  06BF  E3            		ex	(sp),hl
  06C0  20EE          		jr	nz,FORLP
                      	
  06C2  F9            		ld	sp,hl
  06C3  D5            		push	de		;program address
                      	
  06C4                	FOROK:
  06C4  2A5DFA        		ld	hl,(LINENUM)
  06C7  E5            		push	hl		;line number
  06C8  CD2E39        		call	PUSHF2		;TO value
  06CB  CD1F39        		call	PUSHF1		;STEP value
  06CE  C5            		push	bc		;variable address
  06CF  3E81          		ld	a,FOR		;identifier
  06D1  F5            		push	af
  06D2  33            		inc	sp
  06D3  1812          		jr	INTPEND
                      	
                      	
                      	;
                      	;
                      	;
                      	;
  06D5                	_COMMAND:ds	CMDEND-14-_COMMAND
  06DC                		org	CMDEND-14
                      	
                      	;execute command
  06DC                	COMMAND:
  06DC  FEC2          		cp	CLAST66+1
  06DE  D2E403        		jp	nc,SNERR
  06E1  1161FA        		ld	de,CMDTBL
  06E4  CD4B3F        		call	JPTBL
                      	
                      	;intepretation end
  06E7                	INTPEND:
  06E7  2A4EFF        		ld	hl,(PROGAD)
                      	
                      	;command end
  06EA                	_CMDEND:ds	CMDEND-_CMDEND
  06EA                		org	CMDEND
                      	
  06EA  2B            		dec	hl
  06EB  D7            		rst	ANADAT
                      	
                      	;	call	CHKCLN
                      	
  06EC  CA0A07        		jp	z,INTPRT
  06EF  C3E403        		jp	SNERR
                      	
                      	
                      	;continued from C_RUN
                      	;input: hl(=(STARTAD)), z(1=colon or 00h)
  06F2                	RUN2:
  06F2  2807          		jr	z,RUNLP
  06F4  EB            		ex	de,hl
  06F5  CDA607        		call	C_GOTO
  06F8  60            		ld	h,b
  06F9  69            		ld	l,c
  06FA  23            		inc	hl
                      	
  06FB                	RUNLP:
  06FB  7E            		ld	a,(hl)
  06FC  23            		inc	hl
  06FD  B6            		or	(hl)
  06FE  CA4204        		jp	z,EDIT
  0701  23            		inc	hl
  0702  5E            		ld	e,(hl)
  0703  23            		inc	hl
  0704  56            		ld	d,(hl)
  0705  ED535DFA      		ld	(LINENUM),de
                      	
                      	
                      	;0709h: used by PORTOPIA
  0709                	_INTPRT2:ds	INTPRT2-_INTPRT2
  0709                		org	INTPRT2
                      	
  0709  23            		inc	hl
                      	
  070A                	INTPRT:
  070A  CD5B27        		call	CHKSTOP
  070D  CA3635        		jp	z,STOP1
  0710  7E            		ld	a,(hl)
  0711  23            		inc	hl
  0712  224EFF        		ld	(PROGAD),hl
  0715  B7            		or	a
  0716  FADC06        		jp	m,COMMAND
  0719  28E0          		jr	z,RUNLP
  071B  FE3A          		cp	':'
  071D  28EB          		jr	z,INTPRT
  071F  FE20          		cp	' '
  0721  28E7          		jr	z,INTPRT
  0723  2B            		dec	hl
                      	
  0724                	VAR:
  0724  CD8433        		call	CHKVAR
  0727  CD9832        		call	GETVAR
  072A  2A4EFF        		ld	hl,(PROGAD)
  072D  CDA234        		call	VARIN
  0730  18B5          		jr	INTPEND
                      	
                      	
                      	;get a 1-byte integer for function
                      	;input: hl=program address
                      	;output: FAC1,e, hl=next address, a(0=ok)
                      	;destroy: FAC2,f,bc
  0732                	FNCI1:
  0732  CD640B        		call	FNCNUM
                      	;	jp	FTOI1
                      	
                      	
                      	;convert float to 1-byte integer
                      	;input: FAC1
                      	;output: e, a(0=ok)
                      	;destroy: f,bc,de,hl
  0735                	FTOI1:
  0735  CD4107        		call	FTOI2
  0738  7A            		ld	a,d
  0739  B7            		or	a
  073A  C8            		ret	z
  073B  C3ED03        		jp	FCERR
                      	
                      	
                      	;convert float to 2-byte integer for USR() (-32768~32767)
                      	;input: FAC1
                      	;output: de
                      	;destroy: af,bc,hl
  073E                	_FTOI2:	ds	FTOI2-_FTOI2
  0741                		org	FTOI2
                      	
  0741  CDB10C        		call	FTOI
  0744  3A69FF        		ld	a,(FAC1+3)
  0747  AA            		xor	d
  0748  F0            		ret	p
  0749  C3ED03        		jp	FCERR
                      	
                      	
                      	;convert FAC1 and FAC2 to 2-byte integer
                      	;input: FAC1, FAC2
                      	;output: hl, de
                      	;destroy: af,bc,FAC1,FAC2
  074C                	F12TOI2:
  074C  3A25FF        		ld	a,(ARGTYP)
  074F  B7            		or	a
  0750  C20504        		jp	nz,TMERR
  0753  CD4107        		call	FTOI2
  0756  D5            		push	de		;
  0757  CD6E39        		call	EXFAC
  075A  CD4107        		call	FTOI2
  075D  E1            		pop	hl		;
  075E  C9            		ret
                      	
                      	
                      	;get line number from string (0-65529)
                      	;input: hl=program address
                      	;output: de=integer, hl=next address
                      	;destroy: af,bc
  075F                	GETLN:
  075F  0600          		ld	b,00h
  0761  CDD127        		call	ATOI2
  0764  E5            		push	hl
  0765  21F9FF        		ld	hl,65529
  0768  E7            		rst	CPHLDE
  0769  E1            		pop	hl
  076A  D0            		ret	nc
  076B  119919        		ld	de,6553
  076E                	GETLNLP:
  076E  2B            		dec	hl
  076F  7E            		ld	a,(hl)
  0770  FE20          		cp	' '
  0772  C0            		ret	nz
  0773  18F9          		jr	GETLNLP
                      	
                      	
                      	;run command
  0775                	_C_RUN:	ds	C_RUN-_C_RUN
  0781                		org	C_RUN
                      	
  0781  CDF934        		call	RESSTK
  0784  CD613F        		call	CHKCLN
  0787  EB            		ex	de,hl
  0788  2A5FFA        		ld	hl,(STARTAD)
  078B  C3F206        		jp	RUN2
                      	
                      	
                      	;GOSUB command
  078E                	C_GSUB:
  078E  CDA607        		call	C_GOTO
  0791  2B            		dec	hl
  0792                	GSUBLP:
  0792  CD603F        		call	CHKCLNINC
  0795  20FB          		jr	nz,GSUBLP
                      	
  0797  44            		ld	b,h
  0798  4D            		ld	c,l
                      	
  0799  CDEA34        		call	CHKFRE
  079C  2A5DFA        		ld	hl,(LINENUM)
  079F  E3            		ex	(sp),hl
  07A0  C5            		push	bc		;program address
  07A1  3E8C          		ld	a,GOSUB
  07A3  F5            		push	af		;gosub identifier
  07A4  33            		inc	sp
  07A5                	JPHL:
  07A5  E9            		jp	(hl)
                      	
                      	
                      	;GOTO command
  07A6                	C_GOTO:
  07A6  CD5F07        		call	GETLN
  07A9  E5            		push	hl
  07AA  CDF304        		call	SRCHLN
  07AD  E1            		pop	hl
  07AE  D2F603        		jp	nc,ULERR
  07B1  ED434EFF      		ld	(PROGAD),bc
  07B5  C9            		ret
                      	
                      	
                      	;RETURN command
  07B6                	C_RET:
  07B6  C1            		pop	bc		;return address
  07B7                	RETLP:
  07B7  CDD107        		call	SRCHSTK
  07BA  D2E703        		jp	nc,RGERR	;not found
  07BD  2807          		jr	z,RETOK		;gosub identifier found
  07BF  211300        		ld	hl,0013h
  07C2  39            		add	hl,sp
  07C3  F9            		ld	sp,hl
  07C4  18F1          		jr	RETLP
                      	
  07C6                	RETOK:
  07C6  33            		inc	sp
  07C7  E1            		pop	hl
  07C8  224EFF        		ld	(PROGAD),hl
  07CB  E1            		pop	hl
  07CC  225DFA        		ld	(LINENUM),hl
  07CF  C5            		push	bc		;return address
  07D0  C9            		ret
                      	
                      	
                      	;search stack for for/gosub identifier
                      	;output: c-flag(1=found), z-flag(0=for/1=gosub if found)
                      	;destroy: af,de,hl
  07D1                	SRCHSTK:
  07D1  210200        		ld	hl,0002h
  07D4  39            		add	hl,sp
                      	
                      	;search (hl)
                      	;destroy: af,de
  07D5                	SRCHSTK2:
  07D5  ED5B5BFA      		ld	de,(STACK)
  07D9  E7            		rst	CPHLDE
  07DA  D0            		ret	nc		;(z-flag=1)
  07DB  7E            		ld	a,(hl)
  07DC  FE8C          		cp	GOSUB
  07DE  37            		scf
  07DF  C9            		ret
                      	
                      	
                      	;DATA command
  07E0                	_C_DATA:ds	C_DATA-_C_DATA
  07E0                		org	C_DATA
                      	
  07E0  013A          		db	01h, ':'	;ld bc,0e3ah/nop
                      	
                      	
                      	;REM command
  07E2                	_C_REM:	ds	C_REM-_C_REM
  07E2                		org	C_REM
                      	
  07E2  0E00          		ld	c,00h
                      	
                      	;input: c
  07E4                	DATREM:
  07E4  0600          		ld	b,00h
  07E6                	DATALP:
  07E6  7E            		ld	a,(hl)
  07E7  B7            		or	a
  07E8  CAA80B        		jp	z,SETPRGAD
                      	
  07EB  CB40          		bit	0,b
  07ED  2004          		jr	nz,DATANZ
  07EF  B9            		cp	c
  07F0  CAA80B        		jp	z,SETPRGAD
  07F3                	DATANZ:
  07F3  23            		inc	hl
  07F4  FE22          		cp	22h		;double quotation mark
  07F6  20EE          		jr	nz,DATALP
  07F8  04            		inc	b
  07F9  18EB          		jr	DATALP
                      	
                      	
                      	;LET command
  07FB                	C_LET:
  07FB  F1            		pop	af		;cancel return address
  07FC  C32407        		jp	VAR
                      	
                      	
                      	;ON command
  07FF                	C_ON:
  07FF  CDE40D        		call	INT1ARG
  0802  7E            		ld	a,(hl)
  0803  57            		ld	d,a		;
  0804  F604          		or	04h
  0806  FE8C          		cp	GOSUB		;88h(GOTO) or 8ch(GOSUB)
  0808  C2E403        		jp	nz,SNERR
                      	
  080B                	ONLP:
  080B  23            		inc	hl
  080C  1D            		dec	e
  080D  280E          		jr	z,ONZ
  080F  D5            		push	de
  0810  CD5F07        		call	GETLN
  0813  224EFF        		ld	(PROGAD),hl
  0816  D1            		pop	de
  0817  7E            		ld	a,(hl)
  0818  FE2C          		cp	','
  081A  28EF          		jr	z,ONLP
  081C  C9            		ret
                      	
  081D                	ONZ:
  081D  7A            		ld	a,d		;
  081E  FE88          		cp	GOTO
  0820  2884          		jr	z,C_GOTO
  0822  C38E07        		jp	C_GSUB
                      	
                      	
                      	;IF command
  0825                	C_IF:
  0825  CD6F0B        		call	NUMARGMO
  0828  7E            		ld	a,(hl)
  0829  FEC7          		cp	THEN
  082B  2805          		jr	z,IFOK
  082D  FE88          		cp	GOTO
  082F  C2E403        		jp	nz,SNERR
  0832                	IFOK:
  0832  3A6AFF        		ld	a,(FAC1+4)
  0835  B7            		or	a
  0836  28AA          		jr	z,C_REM
                      	;	call	SKIPSPINC
                      	;	sub	'0'
                      	;	cp	'9'-'0'+1
                      	
  0838  D7            		rst	ANADAT
                      	
  0839  DAA607        		jp	c,C_GOTO
  083C                	IFEND:
  083C  224EFF        		ld	(PROGAD),hl
  083F  F1            		pop	af		;cancel return address
  0840  C30A07        		jp	INTPRT		;skip colon check
                      	
                      	
                      	;LPRINT command
  0843                	_C_LPRT:ds	C_LPRT-_C_LPRT
  087A                		org	C_LPRT
                      	
  087A  3E01          		ld	a,01h
  087C  1803          		jr	PRTDEV
                      	
                      	
                      	;PRINT command
  087E                	_C_PRT:	ds	C_PRT-_C_PRT
  087E                		org	C_PRT
                      	
  087E  CD7327        		call	DEVNUM
  0881                	PRTDEV:
  0881  3258FA        		ld	(DEVICE),a
  0884  07            		rlca
  0885  DCA825        		call	c,PRTOPN
                      	
  0888                	PRTLP1:
  0888  CD613F        		call	CHKCLN		;a=(hl)
  088B  284B          		jr	z,PRTEOL
  088D                	PRTLP2:
  088D  FE3B          		cp	';'
  088F  284F          		jr	z,PRTNEXT
  0891  FE2C          		cp	','
  0893  2848          		jr	z,PRTCMM
  0895  FEC5          		cp	SPC
  0897  CA1F09        		jp	z,PRTSPC
  089A  FEC2          		cp	TAB
  089C  CA2F09        		jp	z,PRTTAB
                      	
  089F  CD6617        		call	ARG
  08A2  3A25FF        		ld	a,(ARGTYP)
  08A5  B7            		or	a
  08A6  2813          		jr	z,PRTNUM
                      	
                      	;string
  08A8  CD9226        		call	STRARG2
  08AB  2A4EFF        		ld	hl,(PROGAD)
  08AE  B7            		or	a
  08AF  28D7          		jr	z,PRTLP1
  08B1  47            		ld	b,a
  08B2                	PRTSLP:
  08B2  1A            		ld	a,(de)
  08B3  13            		inc	de
  08B4  CDC726        		call	PUTDEV
  08B7  10F9          		djnz	PRTSLP
  08B9  18CD          		jr	PRTLP1
                      	
  08BB                	PRTNUM:
  08BB  E5            		push	hl
  08BC  CDAC3A        		call	FTOA
                      	
  08BF  3AACFD        		ld	a,(WIDTH)
  08C2  C603          		add	a,03h
  08C4  4F            		ld	c,a
  08C5  AF            		xor	a
  08C6  EDB1          		cpir
  08C8  3AA9FD        		ld	a,(CSRX)
  08CB  B9            		cp	c
  08CC  D43927        		call	nc,PUTNL
  08CF  2172FF        		ld	hl,FAC3
  08D2  CDCF30        		call	PUTS
  08D5  E1            		pop	hl
  08D6  18B0          		jr	PRTLP1
                      	
  08D8                	PRTEOL:
                      	;	xor	a
                      	;	ld	(GRPFLG),a
  08D8  CD3927        		call	PUTNL
  08DB  1809          		jr	PRTEND
                      	
  08DD                	PRTCMM:
  08DD  CDF108        		call	CMMMAIN
  08E0                	PRTNEXT:
  08E0  23            		inc	hl
  08E1                	PRTNEXT2:
  08E1  CD613F        		call	CHKCLN
  08E4  20A7          		jr	nz,PRTLP2
  08E6                	PRTEND:
  08E6  224EFF        		ld	(PROGAD),hl
  08E9  3A58FA        		ld	a,(DEVICE)
  08EC  07            		rlca
  08ED  D0            		ret	nc
  08EE  C3061B        		jp	WCLOSE
                      	
  08F1                	CMMMAIN:
  08F1  3A58FA        		ld	a,(DEVICE)
  08F4  B7            		or	a
  08F5  2807          		jr	z,CMM0	;CRT
  08F7  3D            		dec	a
  08F8  2817          		jr	z,CMM1	;printer
                      	
                      	;RS-232C,CMT
  08FA  060E          		ld	b,0eh
  08FC  180B          		jr	PUTSPLP
                      	
                      	;CRT
  08FE                	CMM0:
  08FE  3AA9FD        		ld	a,(CSRX)
  0901  D60F          		sub	0fh
  0903  D23927        		jp	nc,PUTNL
  0906                	CMMSP:
  0906  ED44          		neg
                      	;	call	PUTSP
                      	;	ret
                      	
                      	;a>0
  0908                	PUTSP:
  0908  47            		ld	b,a
  0909                	PUTSPLP:
  0909  3E20          		ld	a,' '
  090B  CDC726        		call	PUTDEV
  090E  10F9          		djnz	PUTSPLP
  0910  C9            		ret
                      	
                      	;printer
  0911                	CMM1:
  0911  3A57FA        		ld	a,(PRTPOS)
  0914  0608          		ld	b,08h
  0916                	CMM1LP:
  0916  D60E          		sub	0eh
  0918  38EC          		jr	c,CMMSP
  091A  10FA          		djnz	CMM1LP
  091C  C33927        		jp	PUTNL
                      	
  091F                	PRTSPC:
  091F  23            		inc	hl
  0920  CD670B        		call	FNCNUMR
  0923  E5            		push	hl
  0924  CD3507        		call	FTOI1
  0927  E1            		pop	hl
  0928                	PRTSPC2:
  0928  7B            		ld	a,e
  0929                	PRTSPC3:
  0929  B7            		or	a
  092A  C40809        		call	nz,PUTSP
  092D  18B2          		jr	PRTNEXT2
                      	
  092F                	PRTTAB:
  092F  23            		inc	hl
  0930  CD670B        		call	FNCNUMR
  0933  E5            		push	hl
  0934  CD3507        		call	FTOI1
  0937  E1            		pop	hl
                      	
  0938  3A58FA        		ld	a,(DEVICE)
  093B  B7            		or	a
  093C  2808          		jr	z,PRTTAB0	;0=CRT
  093E  3D            		dec	a
  093F  20E7          		jr	nz,PRTSPC2	;2,80-ff=RS-232C,CMT
                      	
                      	;printer
  0941                	PRTTAB1:
  0941  3A57FA        		ld	a,(PRTPOS)
  0944  1804          		jr	TABCOMMON
                      	
                      	;CRT
  0946                	PRTTAB0:
  0946  3AA9FD        		ld	a,(CSRX)
  0949  3D            		dec	a
  094A                	TABCOMMON:
  094A  93            		sub	e
  094B  3094          		jr	nc,PRTNEXT2
  094D  ED44          		neg
  094F  18D8          		jr	PRTSPC3
                      	
                      	
                      	;print new line in CRT (graphic and text screen)
  0951                	PRTNLXALL:
  0951  CD5709        		call	PRTNLX
                      	
                      	;change to text screen and print new line in CRT
                      	;if (CSRX)>1 then print new line
  0954                	PRTNLXTXT:
  0954  CD6D13        		call	CHGTXT
  0957                	PRTNLX:
  0957  AF            		xor	a
  0958  3258FA        		ld	(DEVICE),a
  095B  3AA9FD        		ld	a,(CSRX)
  095E  3D            		dec	a
  095F  C8            		ret	z
  0960  C33927        		jp	PUTNL
                      	
                      	
                      	;INPUT command
  0963                	C_INPT:
  0963  7C            		ld	a,h
  0964  FEFA          		cp	0fah
  0966  D20204        		jp	nc,IDERR
  0969  2B            		dec	hl
  096A  2254FF        		ld	(STOPAD),hl
  096D  23            		inc	hl
                      	
  096E  CD7327        		call	DEVNUM
  0971  321AFA        		ld	(INPDEV),a
  0974  47            		ld	b,a		;
  0975  B7            		or	a
  0976  CC6D13        		call	z,CHGTXT
  0979  E5            		push	hl		;program address
  097A  7E            		ld	a,(hl)
  097B  FE22          		cp	22h		;double quotation mark
  097D  2022          		jr	nz,INPTMAIN
                      	
  097F  78            		ld	a,b		;
  0980  B7            		or	a
  0981  C2E403        		jp	nz,SNERR
  0984  F1            		pop	af		;cancel program address
  0985                	PROMPT:
  0985  23            		inc	hl
  0986  7E            		ld	a,(hl)
  0987  B7            		or	a
  0988  CAE403        		jp	z,SNERR
  098B  FE22          		cp	22h		;double quotation mark
  098D  2805          		jr	z,PROMPTEND
  098F  CD7510        		call	PUTC
  0992  18F1          		jr	PROMPT
  0994                	PROMPTEND:
  0994  CD593F        		call	SKIPSPINC
  0997  FE3B          		cp	';'
  0999  C2E403        		jp	nz,SNERR
  099C  23            		inc	hl
  099D  224EFF        		ld	(PROGAD),hl
  09A0  E5            		push	hl		;program address
                      	
  09A1                	INPTMAIN:
  09A1  3A1AFA        		ld	a,(INPDEV)
  09A4  B7            		or	a
  09A5  C2FD23        		jp	nz,INPTEXT
                      	
  09A8  CD7D15        		call	CUTLINE
                      	
  09AB  213201        		ld	hl,QMARK
  09AE  CDCF30        		call	PUTS
  09B1  CDF928        		call	INPT1
  09B4  D1            		pop	de		;program address
  09B5  C1            		pop	bc		;return address
  09B6  DA3E35        		jp	c,STOP3
  09B9  C5            		push	bc		;return address
  09BA  D5            		push	de		;program address
                      	
  09BB  3EFF          		ld	a,0ffh
  09BD  3255FF        		ld	(STOPAD+1),a
                      	
  09C0  23            		inc	hl		;INPBUF
  09C1  3A5BFE        		ld	a,(INPTX)
  09C4  47            		ld	b,a
  09C5  B7            		or	a
  09C6  2809          		jr	z,INPTLP2
  09C8  3E14          		ld	a,14h
  09CA                	INPTLP1:
  09CA  BE            		cp	(hl)
  09CB  2001          		jr	nz,INPTNZ
  09CD  23            		inc	hl
  09CE                	INPTNZ:
  09CE  23            		inc	hl
  09CF  10F9          		djnz	INPTLP1
                      	
  09D1                	INPTLP2:
  09D1  70            		ld	(hl),b		;b=0
  09D2  2B            		dec	hl
  09D3  7E            		ld	a,(hl)
  09D4  FE20          		cp	' '
  09D6  28F9          		jr	z,INPTLP2
                      	
                      	;analyze input buffer
  09D8                	INPTANA:
  09D8  11DAFE        		ld	de,INPBUF
  09DB                	INPTLP3:
  09DB  2A4EFF        		ld	hl,(PROGAD)
  09DE  CD8433        		call	CHKVAR
  09E1  D5            		push	de		;input buffer
  09E2  CD9832        		call	GETVAR
  09E5  E1            		pop	hl		;input buffer
                      	
  09E6  CB79          		bit	7,c
  09E8  2066          		jr	nz,INPTSTR
                      	
  09EA                	INPTNUM:
  09EA  D5            		push	de		;variable address
  09EB  3EFF          		ld	a,0ffh
  09ED  CD9B39        		call	ATOF
  09F0  D1            		pop	de		;variable address
  09F1  3ADAFE        		ld	a,(INPBUF)
  09F4  B7            		or	a
  09F5  2824          		jr	z,INPTNEXT
  09F7  E5            		push	hl		;input buffer
  09F8  2166FF        		ld	hl,FAC1
  09FB  CD0D0C        		call	SETF
  09FE  E1            		pop	hl		;input buffer
  09FF  7E            		ld	a,(hl)
  0A00  B7            		or	a
  0A01  2818          		jr	z,INPTNEXT
  0A03  FE2C          		cp	','
  0A05  2814          		jr	z,INPTNEXT
  0A07  3A1AFA        		ld	a,(INPDEV)
  0A0A  B7            		or	a
  0A0B  C21D04        		jp	nz,FDERR
  0A0E  214B24        		ld	hl,REDO
  0A11  CDCF30        		call	PUTS
  0A14  E1            		pop	hl		;program address
  0A15  224EFF        		ld	(PROGAD),hl
  0A18  E5            		push	hl		;program address
  0A19  1886          		jr	INPTMAIN
                      	
  0A1B                	INPTNEXT:
  0A1B  EB            		ex	de,hl
  0A1C  2A4EFF        		ld	hl,(PROGAD)
  0A1F  2B            		dec	hl
  0A20  D7            		rst	ANADAT
  0A21  FE2C          		cp	','
  0A23  201F          		jr	nz,INPTEND
  0A25  23            		inc	hl
  0A26  224EFF        		ld	(PROGAD),hl
                      	
  0A29  3ADAFE        		ld	a,(INPBUF)
  0A2C  B7            		or	a
  0A2D  28AC          		jr	z,INPTLP3
  0A2F  1A            		ld	a,(de)
  0A30  13            		inc	de
  0A31  FE2C          		cp	','
  0A33  28A6          		jr	z,INPTLP3
  0A35  3A1AFA        		ld	a,(INPDEV)
  0A38  B7            		or	a
  0A39  C2EA03        		jp	nz,ODERR
  0A3C  3E3F          		ld	a,'?'
  0A3E  CD7510        		call	PUTC
  0A41  C3A109        		jp	INPTMAIN
                      	
  0A44                	INPTEND:
  0A44  F1            		pop	af		;cancel program address
  0A45  1A            		ld	a,(de)
  0A46  FE2C          		cp	','
  0A48  C0            		ret	nz
  0A49  213A24        		ld	hl,EXTRA
  0A4C  C3CF30        		jp	PUTS
                      	
                      	
  0A4F                	INPTSLP1:
  0A4F  23            		inc	hl
  0A50                	INPTSTR:
  0A50  7E            		ld	a,(hl)
  0A51  FE20          		cp	' '
  0A53  28FA          		jr	z,INPTSLP1
  0A55  0E00          		ld	c,00h		;double quotation mark count
  0A57  FE22          		cp	22h		;double quotation mark
  0A59  2002          		jr	nz,INPTSNZ
  0A5B  23            		inc	hl
  0A5C  0C            		inc	c
  0A5D                	INPTSNZ:
  0A5D  E5            		push	hl
  0A5E  0600          		ld	b,00h
                      	
  0A60                	INPTSLP2:
  0A60  79            		ld	a,c
  0A61  B7            		or	a
  0A62  7E            		ld	a,(hl)
  0A63  200B          		jr	nz,INPTCHKDQ
  0A65  FE2C          		cp	','
  0A67  280F          		jr	z,INPTSZ
  0A69                	INPTCHKZ:
  0A69  B7            		or	a
  0A6A  280C          		jr	z,INPTSZ
  0A6C  23            		inc	hl
  0A6D  04            		inc	b
  0A6E  18F0          		jr	INPTSLP2
                      	
  0A70                	INPTCHKDQ:
  0A70  FE22          		cp	22h		;double quotation mark
  0A72  20F5          		jr	nz,INPTCHKZ
  0A74  0D            		dec	c
  0A75  23            		inc	hl
  0A76  18E8          		jr	INPTSLP2
                      	
  0A78                	INPTSZ:
  0A78  E3            		ex	(sp),hl		;push input buffer
  0A79  78            		ld	a,b
  0A7A  D5            		push	de		;variable address
  0A7B  CD2226        		call	MAKESTR
  0A7E  D1            		pop	de		;variable address
  0A7F  212DFF        		ld	hl,STRDSC1
  0A82  010400        		ld	bc,0004h
  0A85  EDB0          		ldir
  0A87  E1            		pop	hl		;input buffer
  0A88  1891          		jr	INPTNEXT
                      	
                      	
                      	;READ command
  0A8A                	C_READ:
  0A8A  CD8433        		call	CHKVAR
  0A8D  CD9832        		call	GETVAR
  0A90  C5            		push	bc		;variable name
  0A91  D5            		push	de		;variable address
                      	
  0A92  2A5CFF        		ld	hl,(DATAAD)
  0A95  ED5B45FF      		ld	de,(DATALN)
  0A99  7E            		ld	a,(hl)
  0A9A  FE2C          		cp	','
  0A9C  2847          		jr	z,READDATA
  0A9E  FE3A          		cp	':'
  0AA0  2810          		jr	z,READLP3
  0AA2  B7            		or	a
  0AA3  C2EA03        		jp	nz,ODERR
                      	
  0AA6                	READLP1:
  0AA6  23            		inc	hl
  0AA7                	READLP2:
  0AA7  4F            		ld	c,a		;always a=0, double quation mark counter
  0AA8  7E            		ld	a,(hl)
  0AA9  23            		inc	hl
  0AAA  B6            		or	(hl)
  0AAB  CAEA03        		jp	z,ODERR
  0AAE  23            		inc	hl
  0AAF  5E            		ld	e,(hl)
  0AB0  23            		inc	hl
  0AB1  56            		ld	d,(hl)
                      	
  0AB2                	READLP3:
  0AB2  23            		inc	hl
  0AB3  7E            		ld	a,(hl)
  0AB4  B7            		or	a
  0AB5  28EF          		jr	z,READLP1
  0AB7  FE83          		cp	DATA
  0AB9  282A          		jr	z,READDATA
  0ABB  FE22          		cp	22h		;double quotation mark
  0ABD  281D          		jr	z,READDQ
  0ABF  FE3A          		cp	':'
  0AC1  28EF          		jr	z,READLP3
  0AC3  FE20          		cp	' '
  0AC5  28EB          		jr	z,READLP3
  0AC7  D68E          		sub	REM
  0AC9  2814          		jr	z,READREM
                      	
  0ACB                	READLP4:
  0ACB  23            		inc	hl
  0ACC  7E            		ld	a,(hl)
  0ACD  B7            		or	a
  0ACE  28D6          		jr	z,READLP1
  0AD0  CB41          		bit	0,c
  0AD2  2004          		jr	nz,SKIPCLN
  0AD4  FE3A          		cp	':'
  0AD6  28DA          		jr	z,READLP3
  0AD8                	SKIPCLN:
  0AD8  FE22          		cp	22h		;double quotation mark
  0ADA  20EF          		jr	nz,READLP4
  0ADC                	READDQ:
  0ADC  0C            		inc	c
  0ADD  18EC          		jr	READLP4
                      	
                      	;a=0
  0ADF                	READREM:
                      	;	xor	a
  0ADF  47            		ld	b,a
  0AE0  4F            		ld	c,a
  0AE1  EDB1          		cpir
  0AE3  18C2          		jr	READLP2
                      	
  0AE5                	READDATA:
  0AE5  ED5345FF      		ld	(DATALN),de
  0AE9  CD593F        		call	SKIPSPINC
                      	
  0AEC  D1            		pop	de		;variable address
  0AED  C1            		pop	bc		;variable name
  0AEE  CB79          		bit	7,c
  0AF0  2022          		jr	nz,READSTR
                      	
  0AF2  B7            		or	a
  0AF3  280E          		jr	z,READNUM
  0AF5  FE26          		cp	'&'
  0AF7  280A          		jr	z,READNUM
  0AF9  FE2F          		cp	'/'
  0AFB  283F          		jr	z,READERR
  0AFD  D62B          		sub	'+'
  0AFF  FE0F          		cp	'9'-'+'+1	;+,-.0123456789
  0B01  3039          		jr	nc,READERR
  0B03                	READNUM:
  0B03  D5            		push	de		;variable address
  0B04  3EFF          		ld	a,0ffh
  0B06  CD9B39        		call	ATOF
  0B09  E3            		ex	(sp),hl		;push data address, pop variable address
  0B0A  EB            		ex	de,hl
  0B0B  2166FF        		ld	hl,FAC1
  0B0E  CD0D0C        		call	SETF
  0B11  E1            		pop	hl		;data address
  0B12  1842          		jr	READEND
                      	
  0B14                	READSTR:
  0B14  010000        		ld	bc,0000h	;b=double quotation mark?, c=length
  0B17  FE22          		cp	22h		;double quotation mark
  0B19  2002          		jr	nz,RDSNDQ
  0B1B  04            		inc	b
  0B1C  23            		inc	hl
  0B1D                	RDSNDQ:
  0B1D  13            		inc	de
  0B1E  13            		inc	de
  0B1F  7D            		ld	a,l
  0B20  12            		ld	(de),a
  0B21  13            		inc	de
  0B22  7C            		ld	a,h
  0B23  12            		ld	(de),a
  0B24  1B            		dec	de
  0B25  1B            		dec	de
  0B26  1B            		dec	de
                      	
  0B27                	RDSLP2:
  0B27  7E            		ld	a,(hl)
  0B28  B7            		or	a
  0B29  2829          		jr	z,RDSEND
  0B2B  CB40          		bit	0,b
  0B2D  2816          		jr	z,RDSCHK
  0B2F  FE22          		cp	22h		;double quotation mark
  0B31  201A          		jr	nz,RDSNEXT
  0B33  CD603F        		call	CHKCLNINC
  0B36  281C          		jr	z,RDSEND
  0B38  FE2C          		cp	','
  0B3A  2818          		jr	z,RDSEND
                      	
  0B3C                	READERR:
  0B3C  2A45FF        		ld	hl,(DATALN)
  0B3F  225DFA        		ld	(LINENUM),hl
  0B42  C3E403        		jp	SNERR
                      	
  0B45                	RDSCHK:
  0B45  FE2C          		cp	','
  0B47  280B          		jr	z,RDSEND
  0B49  FE3A          		cp	':'
  0B4B  2807          		jr	z,RDSEND
                      	
  0B4D                	RDSNEXT:
  0B4D  23            		inc	hl
  0B4E  0C            		inc	c
  0B4F  20D6          		jr	nz,RDSLP2
  0B51  C30B04        		jp	LSERR
                      	
  0B54                	RDSEND:
  0B54  79            		ld	a,c
  0B55  12            		ld	(de),a
                      	
  0B56                	READEND:
  0B56  225CFF        		ld	(DATAAD),hl
  0B59  2A4EFF        		ld	hl,(PROGAD)
  0B5C  7E            		ld	a,(hl)
  0B5D  FE2C          		cp	','
  0B5F  C0            		ret	nz
  0B60  23            		inc	hl
  0B61  C38A0A        		jp	C_READ
                      	
                      	
                      	;get a numerical argument for function
                      	;input: hl=program address
                      	;output: FAC1
                      	;destroy: FAC2,af,bc,de,hl
  0B64                	FNCNUM:
  0B64  CD920B        		call	CHKLPAR
  0B67                	FNCNUMR:
  0B67  CD6617        		call	ARG
  0B6A  CDA10B        		call	CHKRPAR
  0B6D  1809          		jr	CHKNUM
                      	
                      	
                      	;get a numerical argument and check result (?MO Error)
                      	;input: hl=program address
                      	;output: FAC1, hl=next address
                      	;destroy: af,bc,de,FAC2
  0B6F                	NUMARGMO:
  0B6F  CD613F        		call	CHKCLN
  0B72  CA1A04        		jp	z,MOERR
                      	;	call	NUMARG
                      	;	ret
                      	
                      	
                      	;get a numerical argument and check result
                      	;input: hl=program address
                      	;output: FAC1, hl=next address
                      	;destroy: af,bc,de,FAC2
  0B75                	NUMARG:
  0B75  CD6617        		call	ARG
                      	;	call	CHKNUM
                      	;	ret
                      	
                      	
                      	;check numeric or not
                      	;output: z-flag (1=ok)
                      	;destroy: af
  0B78                	CHKNUM:
  0B78  3A25FF        		ld	a,(ARGTYP)
  0B7B  B7            		or	a
  0B7C  C8            		ret	z
  0B7D  3D            		dec	a
  0B7E                	CHKNERR:
  0B7E  CA0504        		jp	z,TMERR
  0B81  C3E403        		jp	SNERR
                      	
                      	
                      	;check string argument or not
                      	;output: a=length, hl=string descriptor address, z-flag(1=ok)
                      	;destroy: f
  0B84                	CHKSTR:
  0B84  3A25FF        		ld	a,(ARGTYP)
  0B87  3D            		dec	a
  0B88  2005          		jr	nz,CHKSERR
  0B8A  2A67FF        		ld	hl,(FAC1+1)
  0B8D  7E            		ld	a,(hl)
  0B8E  C9            		ret
                      	
  0B8F                	CHKSERR:
  0B8F  3C            		inc	a
  0B90  18EC          		jr	CHKNERR
                      	
                      	
                      	;check (
                      	;input: hl=program address
                      	;output: hl=next address
                      	;destroy: af
  0B92                	CHKLPAR:
  0B92  CD5A3F        		call	SKIPSP
  0B95  FE28          		cp	'('
  0B97  C2E403        		jp	nz,SNERR
  0B9A  CD603F        		call	CHKCLNINC
  0B9D  C0            		ret	nz
  0B9E  C31A04        		jp	MOERR
                      	
                      	
                      	;check )
                      	;input: hl=program address
                      	;output: hl=next address
                      	;destroy: af
  0BA1                	CHKRPAR:
  0BA1  7E            		ld	a,(hl)
  0BA2  FE29          		cp	')'
  0BA4  C2E403        		jp	nz,SNERR
  0BA7  23            		inc	hl
  0BA8                	SETPRGAD:
  0BA8  224EFF        		ld	(PROGAD),hl
  0BAB  C9            		ret
                      	
                      	
                      	;convert lowercase letter to uppercase letter
                      	;input: a
                      	;output: a
                      	;destroy: f
  0BAC                	TOUPPER:
  0BAC  FE7B          		cp	'z'+1
  0BAE  D0            		ret	nc
  0BAF                	TOUPPER2:
  0BAF  FE61          		cp	'a'
  0BB1  D8            		ret	c
  0BB2  D620          		sub	'a'-'A'
  0BB4  C9            		ret
                      	
                      	
                      	;alphabet, numeral, or katakana? (case ignored)
  0BB5                	ALPNUM2:
  0BB5  FEE0          		cp	0e0h
  0BB7  3F            		ccf
  0BB8  D8            		ret	c
  0BB9  FEA1          		cp	0a1h
  0BBB  D0            		ret	nc
  0BBC  CDAC0B        		call	TOUPPER
                      	;	call	ALPNUM
                      	;	ret
                      	
                      	
                      	;alphabet (capital) or numeral?
                      	;input: a
                      	;output: c-flag(1=yes,0=no)
                      	;destroy: f
  0BBF                	ALPNUM:
  0BBF  FE5B          		cp	'Z'+1
  0BC1  D0            		ret	nc
  0BC2  FE41          		cp	'A'
  0BC4  3F            		ccf
  0BC5  D8            		ret	c
                      	;	jp	CHKFIG
                      	
                      	
                      	;analyze for 0010h
                      	;input: a
                      	;output: z-flag(1=00h or 3ah), c-flag(1=30h-39h)
                      	;destroy: f
  0BC6                	CHKFIG:
  0BC6  B7            		or	a
  0BC7  C8            		ret	z
  0BC8  FE30          		cp	'0'
  0BCA  3F            		ccf
  0BCB  D0            		ret	nc
  0BCC  FE3A          		cp	':'
                      	;	ret	z
                      	;	cp	'9'+1
  0BCE  C9            		ret
                      	
                      	
                      	;OR operator
  0BCF                	O_OR:
  0BCF  CD4C07        		call	F12TOI2
  0BD2  7C            		ld	a,h
  0BD3  B2            		or	d
  0BD4  67            		ld	h,a
  0BD5  7D            		ld	a,l
  0BD6  B3            		or	e
  0BD7  6F            		ld	l,a
  0BD8  C3180D        		jp	S2TOF
                      	
                      	
                      	;AND operator
  0BDB                	O_AND:
  0BDB  CD4C07        		call	F12TOI2
  0BDE  7C            		ld	a,h
  0BDF  A2            		and	d
  0BE0  67            		ld	h,a
  0BE1  7D            		ld	a,l
  0BE2  A3            		and	e
  0BE3  6F            		ld	l,a
  0BE4  C3180D        		jp	S2TOF
                      	
                      	
                      	;>,=,< operator
                      	;bit0: >
                      	;bit1: =
                      	;bit2: <
  0BE7                	O_GTEQLT:
  0BE7  3A25FF        		ld	a,(ARGTYP)
  0BEA  B7            		or	a
  0BEB  280D          		jr	z,GTEQLTZ
  0BED  D603          		sub	03h		;string and string
  0BEF  C20504        		jp	nz,TMERR
  0BF2  3225FF        		ld	(ARGTYP),a	;a=0
  0BF5  CD220C        		call	CMPSTR
  0BF8  1803          		jr	GTEQLTEND
  0BFA                	GTEQLTZ:
  0BFA  CD1D3F        		call	CMPF
  0BFD                	GTEQLTEND:
  0BFD  79            		ld	a,c		;operator
  0BFE  2803          		jr	z,EQ
  0C00  3002          		jr	nc,GT
  0C02                	LT:
  0C02  0F            		rrca
  0C03                	EQ:
  0C03  0F            		rrca
  0C04                	GT:
  0C04  0F            		rrca
  0C05  3816          		jr	c,SETTRUE
                      	;	jr	SETFALSE
                      	
  0C07                	SETFALSE:
  0C07                	SETZERO:
  0C07  21AB0E        		ld	hl,ZERO
  0C0A                	SETF1:
  0C0A  1166FF        		ld	de,FAC1
  0C0D                	SETF:
  0C0D  EDA0          		ldi
  0C0F  EDA0          		ldi
  0C11  EDA0          		ldi
  0C13  EDA0          		ldi
  0C15  EDA0          		ldi
  0C17  C9            		ret
                      	
  0C18                	SETF2:
  0C18  116DFF        		ld	de,FAC2
  0C1B  18F0          		jr	SETF
                      	
  0C1D                	SETTRUE:
  0C1D                	SETMNS1:
  0C1D  21A60E        		ld	hl,MNSONE
  0C20  18E8          		jr	SETF1
                      	
                      	
  0C22                	CMPSTR:
  0C22  2139FF        		ld	hl,STRDSC4
  0C25  46            		ld	b,(hl)
  0C26  3600          		ld	(hl),00h
  0C28  3A2DFF        		ld	a,(STRDSC1)
  0C2B  B8            		cp	b
  0C2C  F5            		push	af		;flag
  0C2D  3801          		jr	c,CMPSNC
  0C2F  78            		ld	a,b
  0C30                	CMPSNC:
  0C30  B7            		or	a
  0C31  2810          		jr	z,CMPSZ
                      	
  0C33  ED5B2FFF      		ld	de,(STRDSC1+2)
  0C37  2A3BFF        		ld	hl,(STRDSC4+2)
  0C3A  47            		ld	b,a
  0C3B                	CMPSLP:
  0C3B  1A            		ld	a,(de)
  0C3C  BE            		cp	(hl)
  0C3D  2006          		jr	nz,CMPSNZ
  0C3F  13            		inc	de
  0C40  23            		inc	hl
  0C41  10F8          		djnz	CMPSLP
  0C43                	CMPSZ:
  0C43  F1            		pop	af		;flag
  0C44  C9            		ret
                      	
  0C45                	CMPSNZ:
  0C45  E1            		pop	hl		;cancel stack
  0C46  C9            		ret
                      	
                      	
                      	;NOT operator
  0C47                	O_NOT:
  0C47  CD780B        		call	CHKNUM
  0C4A  CD6E39        		call	EXFAC
  0C4D  CD4107        		call	FTOI2
  0C50  7A            		ld	a,d
  0C51  2F            		cpl
  0C52  67            		ld	h,a
  0C53  7B            		ld	a,e
  0C54  2F            		cpl
  0C55  6F            		ld	l,a
  0C56  C3180D        		jp	S2TOF
                      	
                      	
                      	;input: a=integer (unsigned)
  0C59                	I1TOFA:
  0C59  6F            		ld	l,a
                      	
                      	;convert 1- or 2-byte integer to float
                      	;input: hl=integer (unsigned)
                      	;output: FAC1
                      	;destroy: af,b,hl
  0C5A                	I1TOF:
  0C5A  2600          		ld	h,00h
  0C5C                	I2TOF:
  0C5C  D5            		push	de
  0C5D  110000        		ld	de,0000h
  0C60  7C            		ld	a,h
  0C61  B5            		or	l
  0C62  280F          		jr	z,I2TOFZERO
  0C64  0610          		ld	b,10h
  0C66                	I2TOFLP:
  0C66  29            		add	hl,hl
  0C67  3802          		jr	c,I2TOFEND
  0C69  10FB          		djnz	I2TOFLP
                      	
  0C6B                	I2TOFEND:
  0C6B  CB3C          		srl	h
  0C6D  CB1D          		rr	l
  0C6F  EB            		ex	de,hl
  0C70                	I2TOFEND2:
  0C70  78            		ld	a,b
  0C71  C680          		add	a,80h
  0C73                	I2TOFZERO:
                      	;	ld	(FAC1),hl
                      	;	ld	(FAC1+2),de
  0C73  326AFF        		ld	(FAC1+4),a
  0C76  CD8837        		call	SETI4
  0C79  D1            		pop	de
  0C7A  C9            		ret
                      	
                      	
                      	;convert float to 4-byte integer (>=0)
                      	;(round toward zero)
                      	;input: FAC1
                      	;output: FAC1 (integer)
                      	;destroy: af,b,de,hl
  0C7B                	FTOI4:
  0C7B  3EA0          		ld	a,81h+1fh
  0C7D  216AFF        		ld	hl,FAC1+4
  0C80  96            		sub	(hl)		;
  0C81  47            		ld	b,a
  0C82  2A66FF        		ld	hl,(FAC1)
  0C85  ED5B68FF      		ld	de,(FAC1+2)
  0C89  CBFA          		set	7,d
  0C8B  280A          		jr	z,FTOI4END	;
  0C8D                	FTOI4LP:
  0C8D  CB3A          		srl	d
  0C8F  CB1B          		rr	e
  0C91  CB1C          		rr	h
  0C93  CB1D          		rr	l
  0C95  10F6          		djnz	FTOI4LP
  0C97                	FTOI4END:
                      	;	ld	(FAC1),hl
                      	;	ld	(FAC1+2),de
                      	;	ret
  0C97  C38837        		jp	SETI4
                      	
                      	
                      	;convert 4-byte integer to float (unsigned)
                      	;input: de-hl
                      	;output: FAC1
                      	;destroy: af,b,hl
  0C9A                	I4TOF:
  0C9A  D5            		push	de
  0C9B  7A            		ld	a,d
  0C9C  B3            		or	e
  0C9D  B4            		or	h
  0C9E  B5            		or	l
  0C9F  28D2          		jr	z,I2TOFZERO
                      	
  0CA1  7A            		ld	a,d
  0CA2  0620          		ld	b,20h
  0CA4                	I4TOFLP:
  0CA4  C680          		add	a,80h
  0CA6  3806          		jr	c,I4TOFEND
  0CA8  29            		add	hl,hl
  0CA9  CB13          		rl	e
  0CAB  17            		rla
  0CAC  10F6          		djnz	I4TOFLP
                      	
  0CAE                	I4TOFEND:
  0CAE  57            		ld	d,a
  0CAF  18BF          		jr	I2TOFEND2
                      	
                      	
                      	;convert float to 2-byte integer (-65535~65535)
                      	;(round toward minus infinity)
                      	;input: FAC1
                      	;output: de
                      	;destroy: af,bc,hl
  0CB1                	FTOI:
  0CB1  110000        		ld	de,0000h
  0CB4  3A6AFF        		ld	a,(FAC1+4)
  0CB7  B7            		or	a
  0CB8  C8            		ret	z
  0CB9  D691          		sub	91h
  0CBB  D2ED03        		jp	nc,FCERR
  0CBE  ED44          		neg
  0CC0  47            		ld	b,a
                      	
  0CC1  2A66FF        		ld	hl,(FAC1)
  0CC4  7C            		ld	a,h
  0CC5  B5            		or	l		;fraction
                      	
  0CC6  2A68FF        		ld	hl,(FAC1+2)
  0CC9  4C            		ld	c,h		;sign
  0CCA  CBFC          		set	7,h
  0CCC  05            		dec	b
  0CCD  2809          		jr	z,FTOIZ
  0CCF                	FTOILP:
  0CCF  CB3C          		srl	h
  0CD1  CB1D          		rr	l
  0CD3  3001          		jr	nc,FTOINC
  0CD5  07            		rlca			;a>0
  0CD6                	FTOINC:
  0CD6  10F7          		djnz	FTOILP
                      	
  0CD8                	FTOIZ:
  0CD8  EB            		ex	de,hl
  0CD9  CB79          		bit	7,c		;sign
  0CDB  C8            		ret	z
                      	
  0CDC  ED44          		neg			;set c-flag if a>0
  0CDE  ED52          		sbc	hl,de
  0CE0  EB            		ex	de,hl
  0CE1  C9            		ret
                      	
                      	
                      	;get integer part from float
                      	;(round toward zero)
                      	;input: FAC1
                      	;output: FAC1
                      	;destroy: af,b,hl
  0CE2                	GETINT:
  0CE2  3A6AFF        		ld	a,(FAC1+4)
  0CE5  FE81          		cp	81h
  0CE7  DA070C        		jp	c,SETZERO
  0CEA  D6A0          		sub	0a0h
  0CEC  D0            		ret	nc
  0CED  2166FF        		ld	hl,FAC1
  0CF0                	GETILP1:
  0CF0  C608          		add	a,08h		;
  0CF2  3805          		jr	c,GETIC
  0CF4  3600          		ld	(hl),0
  0CF6  23            		inc	hl
  0CF7  18F7          		jr	GETILP1
  0CF9                	GETIC:
  0CF9  47            		ld	b,a
  0CFA  04            		inc	b
  0CFB  AF            		xor	a
  0CFC                	GETILP2:
  0CFC  1F            		rra
  0CFD  37            		scf
  0CFE  10FC          		djnz	GETILP2
  0D00  A6            		and	(hl)
  0D01  77            		ld	(hl),a
  0D02  C9            		ret
                      	
                      	
                      	;convert 1-byte signed integer to float
                      	;input: b=integer (signed)
                      	;output: FAC1
                      	;destroy: af,bc,hl
  0D03                	_S1TOF:	ds	ABTOF-5-_S1TOF
  0D11                		org	ABTOF-5
  0D11                	S1TOF:
  0D11  78            		ld	a,b
  0D12  07            		rlca
  0D13  9F            		sbc	a,a		;a=0(b<80h) or ffh(b>=80h)
  0D14  1800          		jr	ABTOF
                      	
                      	
                      	;convert 2-byte integer to float for USR()
                      	;input: ab
                      	;output: FAC1
                      	;destroy: af,bc,hl
  0D16                	_ABTOF:	ds	ABTOF-_ABTOF
  0D16                		org	ABTOF
                      	
  0D16  67            		ld	h,a
  0D17  68            		ld	l,b
                      	;	jr	S2TOF
                      	
                      	
                      	;convert 2-byte signed integer to float
                      	;input: hl=integer (signed)
                      	;output: FAC1
                      	;destroy: af,bc,hl
  0D18                	S2TOF:
  0D18  CB7C          		bit	7,h
  0D1A  CA5C0C        		jp	z,I2TOF
  0D1D  AF            		xor	a
  0D1E  95            		sub	l
  0D1F  6F            		ld	l,a
  0D20  9C            		sbc	a,h
  0D21  95            		sub	l
  0D22  67            		ld	h,a
  0D23  CD5C0C        		call	I2TOF
                      	
                      	;FAC1=-abs(FAC1)
                      	;destroy: f,hl
  0D26                	NEGABS:
  0D26  2169FF        		ld	hl,FAC1+3
  0D29  CBFE          		set	7,(hl)
  0D2B  C9            		ret
                      	
                      	
                      	;NEGABS with checking zero
                      	;destroy: af,hl
  0D2C                	NEGABS2:
  0D2C  3A6AFF        		ld	a,(FAC1+4)
  0D2F  B7            		or	a
  0D30  C8            		ret	z
  0D31  18F3          		jr	NEGABS
                      	
                      	
                      	;LPOS() function
  0D33                	F_LPOS:
  0D33  3A25FF        		ld	a,(ARGTYP)
  0D36  FE02          		cp	02h
  0D38  D2E403        		jp	nc,SNERR
  0D3B  2A57FA        		ld	hl,(PRTPOS)
  0D3E  C3A431        		jp	SETI1
                      	
                      	
                      	;POS() function
  0D41                	F_POS:
  0D41  3A25FF        		ld	a,(ARGTYP)
  0D44  FE02          		cp	02h
  0D46  D2E403        		jp	nc,SNERR
  0D49  2AA9FD        		ld	hl,(CSRX)
  0D4C  2D            		dec	l
  0D4D  C3A431        		jp	SETI1
                      	
                      	
                      	;CSRLINE function
  0D50                	F_CSRL:
  0D50  2AA8FD        		ld	hl,(CSRY)
  0D53  2D            		dec	l
  0D54  C35A0C        		jp	I1TOF
                      	
                      	
                      	;DEF command
  0D57                	C_DEF:
  0D57  ED5B5DFA      		ld	de,(LINENUM)
  0D5B  7A            		ld	a,d
  0D5C  A3            		and	e
  0D5D  3C            		inc	a
  0D5E  CA0204        		jp	z,IDERR
  0D61  CD5A3F        		call	SKIPSP
  0D64  FEC4          		cp	FN
  0D66  C2E403        		jp	nz,SNERR
  0D69  23            		inc	hl
  0D6A  CD8433        		call	CHKVAR
  0D6D  CB79          		bit	7,c
  0D6F  C20504        		jp	nz,TMERR
  0D72  CBF8          		set	7,b
  0D74  E5            		push	hl		;program address
  0D75  CDB633        		call	SRCHVAR
  0D78  DCE033        		call	c,MAKEVAR
  0D7B  E1            		pop	hl		;program address
  0D7C  CD920B        		call	CHKLPAR
  0D7F  CD8433        		call	CHKVAR
  0D82  CB79          		bit	7,c
  0D84  C20504        		jp	nz,TMERR
  0D87  CDA10B        		call	CHKRPAR
  0D8A  CD5A3F        		call	SKIPSP
  0D8D  FED2          		cp	EQ_
  0D8F  C2E403        		jp	nz,SNERR
  0D92  CD593F        		call	SKIPSPINC
                      	
  0D95  EB            		ex	de,hl
  0D96  73            		ld	(hl),e
  0D97  23            		inc	hl
  0D98  72            		ld	(hl),d
  0D99  23            		inc	hl
  0D9A  70            		ld	(hl),b
  0D9B  23            		inc	hl
  0D9C  71            		ld	(hl),c
                      	;	inc	hl
                      	;	ld	(hl),0
  0D9D  EB            		ex	de,hl
                      	
  0D9E  2B            		dec	hl
  0D9F                	DEFLP:
  0D9F  CD603F        		call	CHKCLNINC
  0DA2  20FB          		jr	nz,DEFLP
                      	
  0DA4  224EFF        		ld	(PROGAD),hl
  0DA7  C9            		ret
                      	
                      	
                      	;INP() function
  0DA8                	F_INP:
  0DA8  CD780B        		call	CHKNUM
  0DAB  CD3507        		call	FTOI1
  0DAE  42            		ld	b,d		;d=0
  0DAF  4B            		ld	c,e
  0DB0  ED68          		in	l,(c)
  0DB2  62            		ld	h,d		;d=0
  0DB3  C35C0C        		jp	I2TOF
                      	
                      	
                      	;OUT command
  0DB6                	C_OUT:
  0DB6  CDE40D        		call	INT1ARG
  0DB9  7E            		ld	a,(hl)
  0DBA  FE2C          		cp	','
  0DBC  C2E403        		jp	nz,SNERR
  0DBF  D5            		push	de		;
  0DC0  CDE30D        		call	INT1INC
  0DC3  C1            		pop	bc		;
  0DC4  ED59          		out	(c),e
  0DC6  C9            		ret
                      	
                      	
  0DC7                	MODESTR:
  0DC7  0D0A4D4F444520		db	0dh, 0ah, "MODE ",00h
  0DCF                	PAGESTR:
  0DCF  2050414745530D		db	" PAGES", 0dh, 0ah, 00h
  0DD8                	FILESTR:
  0DD8  2046494C45530D		db	" FILES", 0dh, 0ah, 00h
                      	
                      	
                      	;increment hl and get a 1-byte integer argument (0~255)
  0DE1                	_INT1INC:ds	INT1INC-_INT1INC
  0DE3                		org	INT1INC
                      	
  0DE3  23            		inc	hl
                      	
                      	;get a 1-byte integer argument (0~255)
                      	;input: hl=program address
                      	;output: FAC1,a,de=integer, hl=next address
                      	;destroy: FAC2, f, bc
  0DE4                	_INT1ARG:ds	INT1ARG-_INT1ARG
  0DE4                		org	INT1ARG
                      	
  0DE4  CD1A0E        		call	INT2ARG
  0DE7  7A            		ld	a,d
  0DE8  B7            		or	a
  0DE9  7B            		ld	a,e
  0DEA  C8            		ret	z
  0DEB  C3ED03        		jp	FCERR
                      	
                      	
                      	;PEEK() function
  0DEE                	F_PEEK:
  0DEE  CD780B        		call	CHKNUM
  0DF1  CDB10C        		call	FTOI
  0DF4  1A            		ld	a,(de)
  0DF5  C3590C        		jp	I1TOFA
                      	
                      	
                      	;POKE command
  0DF8                	C_POKE:
  0DF8  CD6F0B        		call	NUMARGMO
  0DFB  7E            		ld	a,(hl)
  0DFC  FE2C          		cp	','
  0DFE  C2E403        		jp	nz,SNERR
  0E01  E5            		push	hl
  0E02  CDB10C        		call	FTOI
  0E05  E1            		pop	hl
  0E06  D5            		push	de		;
  0E07  23            		inc	hl
  0E08  CD6F0B        		call	NUMARGMO
  0E0B  CD3507        		call	FTOI1
  0E0E  E1            		pop	hl		;
  0E0F  73            		ld	(hl),e
  0E10  C9            		ret
                      	
                      	
                      	;get a 2-byte integer argument (-65535~65535)
                      	;input: hl=program address
                      	;output: FAC1,de=integer, hl=next address
                      	;destroy: FAC2,af,bc
  0E11                	INTARG:
  0E11  CD6F0B        		call	NUMARGMO
  0E14  E5            		push	hl
  0E15  CDB10C        		call	FTOI
  0E18  E1            		pop	hl
  0E19  C9            		ret
                      	
                      	
                      	;get a 2-byte integer argument (-32768~32767)
                      	;input: hl=program address
                      	;output: FAC1,de=integer, hl=next address
                      	;destroy: FAC2,af,bc
  0E1A                	INT2ARG:
  0E1A  CD6F0B        		call	NUMARGMO
  0E1D  E5            		push	hl
  0E1E  CD4107        		call	FTOI2
  0E21  E1            		pop	hl
  0E22  C9            		ret
                      	
                      	
                      	;get two 2-byte integer arguments (-65535~65535)
                      	;input: hl=program address
                      	;output: FAC1, bc=1st, de=2nd, hl=next address
                      	;destroy: af
  0E23                	INTARG2:
  0E23  CD110E        		call	INTARG
  0E26  7E            		ld	a,(hl)
  0E27  FE2C          		cp	','
  0E29  C2E403        		jp	nz,SNERR
  0E2C  23            		inc	hl
  0E2D  D5            		push	de		;
  0E2E  CD110E        		call	INTARG
  0E31  C1            		pop	bc		;
  0E32  C9            		ret
                      	
                      	
                      	;get two 1-byte integer arguments (0~255)
                      	;input: hl=program address
                      	;output: FAC1, bc=1st, de=2nd, hl=next address
                      	;destroy: af
  0E33                	INT1ARG2:
  0E33  CDE40D        		call	INT1ARG
  0E36  7E            		ld	a,(hl)
  0E37  FE2C          		cp	','
  0E39  C2E403        		jp	nz,SNERR
  0E3C  D5            		push	de
  0E3D  CDE30D        		call	INT1INC
  0E40  C1            		pop	bc
  0E41  C9            		ret
                      	
                      	
                      	;get two 2-byte integer arguments (-32768~32767)
                      	;input: hl=program address
                      	;output: FAC1, bc=1st, de=2nd, hl=next address
                      	;destroy: af
  0E42                	INT2ARG2:
  0E42  CD1A0E        		call	INT2ARG
  0E45  7E            		ld	a,(hl)
  0E46  FE2C          		cp	','
  0E48  C2E403        		jp	nz,SNERR
  0E4B  23            		inc	hl
  0E4C  D5            		push	de		;
  0E4D  CD1A0E        		call	INT2ARG
  0E50  C1            		pop	bc		;
  0E51  C9            		ret
                      	
                      	
                      	;convert character VRAM address to attribute address
                      	;input: hl
                      	;output: hl
                      	;destroy: f (no change in c-flag)
  0E52                	CHR2ATT:
  0E52  CB54          		bit	2,h
  0E54  2802          		jr	z,CHR2ATTZ
  0E56  25            		dec	h
  0E57  25            		dec	h
  0E58                	CHR2ATTZ:
  0E58  25            		dec	h
  0E59  25            		dec	h
  0E5A  C9            		ret
                      	
                      	
                      	;call SCRLUP or SCRLU66
                      	;destroy: af
  0E5B                	SCRLUP:
  0E5B  CD9539        		call	CHKMOD
  0E5E  C26012        		jp	nz,SCRLU60
  0E61  C3E263        		jp	SCRLU66
                      	
                      	
                      	;call SCRLD60 or SCRLD66
                      	;destroy: af
  0E64                	SCRLDW:
  0E64  CD9539        		call	CHKMOD
  0E67  C2A912        		jp	nz,SCRLD60
  0E6A  C32F64        		jp	SCRLD66
                      	
                      	
                      	;get data from port 90h
                      	;output: a
                      	;destroy: f
  0E6D                	_IN90H:	ds	IN90H-_IN90H
  0E78                		org	IN90H
                      	
  0E78  3E0C          		ld	a,0ch
  0E7A  D393          		out	(93h),a		;disable 8255 INT for writing
  0E7C                	IN90HLP:
  0E7C  DB92          		in	a,(92h)
  0E7E  2F            		cpl
  0E7F  E628          		and	28h
  0E81  20F9          		jr	nz,IN90HLP	;wait for ibf=1,intr=1
  0E83  3E0D          		ld	a,0dh
  0E85  D393          		out	(93h),a		;enable 8255 INT for writing
  0E87  DB90          		in	a,(90h)
  0E89  C9            		ret
                      	
                      	
                      	;output port 90h
                      	;input: a=data
                      	;destroy: none
  0E8A                	_OUT90H:ds	OUT90H-_OUT90H
  0E8F                		org	OUT90H
                      	
  0E8F  F5            		push	af
  0E90  3E08          		ld	a,08h
  0E92  D393          		out	(93h),a		;disable 8255 INT for reading
  0E94                	OUT90HLP:
  0E94  DB92          		in	a,(92h)
  0E96  07            		rlca
  0E97  30FB          		jr	nc,OUT90HLP	;wait for nobf=1
  0E99  3E09          		ld	a,09h
  0E9B  D393          		out	(93h),a		;enable 8255 INT for reading
  0E9D  F1            		pop	af
  0E9E  D390          		out	(90h),a
  0EA0  C9            		ret
                      	
                      	
  0EA1                	PLSONE:
  0EA1  0000000081    		db	00h, 00h, 00h, 00h, 81h
                      	
  0EA6                	MNSONE:
  0EA6  0000008081    		db	00h, 00h, 00h, 80h, 81h
                      	
  0EAB                	ZERO:
  0EAB  0000000000    		db	00h, 00h, 00h, 00h, 00h
                      	
                      	
                      	;interrupt for graphic key
  0EB0                	_INTGRP:ds	INTGRP-_INTGRP
  0EB0                		org	INTGRP
                      	
  0EB0  C5            		push	bc
  0EB1  0601          		ld	b,01h
  0EB3  1803          		jr	KEYCOMMON
                      	
                      	
                      	;interrupt for normal key
  0EB5                	_INTKEY:ds	INTKEY-_INTKEY
  0EB5                		org	INTKEY
                      	
  0EB5  C5            		push	bc
  0EB6  0600          		ld	b,00h
                      	
  0EB8                	KEYCOMMON:
  0EB8  F5            		push	af
  0EB9  CD780E        		call	IN90H
                      	
                      	;0ebch: used by SPACE HARRIER
  0EBC  D5            		push	de
  0EBD  E5            		push	hl
  0EBE  B7            		or	a
  0EBF  2865          		jr	z,RESSTOP
  0EC1  CD9315        		call	CLICK
                      	;	dec	b
                      	;	jr	nz,NORMAL
  0EC4  1015          		djnz	NORMAL
                      	
  0EC6                	GRAPH:
  0EC6  47            		ld	b,a		;;
  0EC7  D6FA          		sub	0fah
  0EC9  2842          		jr	z,STOPKEY
  0ECB  304A          		jr	nc,SPECIAL
  0ECD  3E14          		ld	a,14h
  0ECF  1825          		jr	IKBF
                      	
                      	
                      	;interrupt for reply to key query
  0ED1                	INTGAM:
  0ED1  F5            		push	af
  0ED2  CD780E        		call	IN90H
  0ED5  32CAFE        		ld	(GMKYBUF),a
  0ED8  F1            		pop	af
  0ED9  FB            		ei
  0EDA  C9            		ret
                      	
                      	
                      	;normal key
  0EDB                	NORMAL:
  0EDB  FE03          		cp	03h		;Ctrl-C
  0EDD  2833          		jr	z,STOPKEY2
  0EDF  FE1B          		cp	1bh
  0EE1  282F          		jr	z,STOPKEY2
  0EE3  06EF          		ld	b,0efh		;;Ctrl-T->14h+0efh
  0EE5  FE7F          		cp	7fh
  0EE7  2002          		jr	nz,NOTDELKEY
  0EE9  3E08          		ld	a,08h		;DEL->ctrl-H, not necessary for emulator?
                      	
  0EEB                	NOTDELKEY:
  0EEB  215AFA        		ld	hl,KEYFLG
  0EEE  CB46          		bit	0,(hl)
  0EF0  C4AC0B        		call	nz,TOUPPER
  0EF3  1801          		jr	IKBF
                      	
                      	
                      	;0ef6h: used by PORTOPIA
  0EF5                	_IKBF:ds	IKBF-_IKBF
  0EF6                		org	IKBF
                      	
  0EF6  218FFB        		ld	hl,KYBFIN
  0EF9  4E            		ld	c,(hl)		;
  0EFA  CD360F        		call	PUTKBF
                      	;	jr	c,RESSTOP
  0EFD  FE14          		cp	14h
  0EFF  2025          		jr	nz,RESSTOP
                      	
  0F01  78            		ld	a,b		;;
  0F02  CD360F        		call	PUTKBF
  0F05  301F          		jr	nc,RESSTOP
                      	
  0F07  218FFB        		ld	hl,KYBFIN
  0F0A  71            		ld	(hl),c		;
  0F0B  1819          		jr	RESSTOP
                      	
                      	
  0F0D                	STOPKEY:
  0F0D  CDD8FF        		call	HOOKSTP
  0F10  3E03          		ld	a,03h
  0F12                	STOPKEY2:
  0F12  CD360F        		call	PUTKBF
  0F15  1810          		jr	SETSTOP
                      	
                      	
                      	;fb	CAPS		bit0
                      	;fc	SHIFT+PAGE	bit1
                      	;fd	MODE		bit3
                      	;fe	KANA		bit2
  0F17                	SPECIAL:
  0F17  FE03          		cp	03h		;MODE key
  0F19  2002          		jr	nz,NOTMODE
  0F1B  3E08          		ld	a,08h
  0F1D                	NOTMODE:
  0F1D  215AFA        		ld	hl,KEYFLG
  0F20  AE            		xor	(hl)
  0F21  77            		ld	(hl),a
                      	
  0F22  AF            		xor	a
  0F23  32A7FD        		ld	(FKEYSFT),a
                      	
  0F26                	RESSTOP:
  0F26  AF            		xor	a
  0F27                	SETSTOP:
  0F27  3218FA        		ld	(STOPFLG),a
                      	;	jr	IKPOP
                      	
                      	
                      	;pop register for key interrupt
  0F2A                	_IKPOP:	ds	IKPOP-_IKPOP
  0F2B                		org	IKPOP
                      	
  0F2B  E1            		pop	hl
  0F2C  D1            		pop	de
                      	
                      	;0f2dh: used by SPACE HARRIER
  0F2D  F1            		pop	af
  0F2E  C1            		pop	bc
  0F2F  FB            		ei
  0F30  C9            		ret
                      	
                      	
                      	;put into PLAY command buffer
                      	;input: a=data
                      	;destroy: f,hl
  0F31                	PUTPLBF:
  0F31  CD941C        		call	GETPLAD
  0F34  1803          		jr	PUTBF
                      	
                      	
                      	;put into key buffer
                      	;input: a
                      	;output: c-flag (1=buffer full)
                      	;destroy: f,hl
  0F36                	PUTKBF:
  0F36  218FFB        		ld	hl,KYBFIN
                      	;	call	PUTBF
                      	;	ret
                      	
                      	
                      	;put characer into buffer
                      	;input: a=character, hl=buffer control address
                      	;output: c-flag (1=buffer full)
                      	;destroy: f,hl
  0F39                	PUTBF:
  0F39  F5            		push	af
  0F3A  7E            		ld	a,(hl)		;in
  0F3B  3C            		inc	a
  0F3C  2C            		inc	l		;inc hl
  0F3D  2C            		inc	l		;inc hl
  0F3E  2C            		inc	l		;inc hl
  0F3F  A6            		and	(hl)		;size
  0F40  2D            		dec	l		;dec hl
  0F41  2D            		dec	l		;dec hl
  0F42  BE            		cp	(hl)		;out
  0F43  2811          		jr	z,BFFULL
                      	
  0F45  2D            		dec	l		;dec hl
  0F46  77            		ld	(hl),a		;in
  0F47  2C            		inc	l		;inc hl
  0F48  2C            		inc	l		;inc hl
  0F49  2C            		inc	l		;inc hl
  0F4A  2C            		inc	l		;inc hl
  0F4B  86            		add	a,(hl)		;address
  0F4C  2C            		inc	l		;inc hl
  0F4D  66            		ld	h,(hl)
  0F4E  6F            		ld	l,a
  0F4F  3001          		jr	nc,PTBNC
  0F51  24            		inc	h
  0F52                	PTBNC:
  0F52  F1            		pop	af
  0F53  77            		ld	(hl),a
  0F54  B7            		or	a		;reset c-flag
  0F55  C9            		ret
                      	
  0F56                	BFFULL:
  0F56  F1            		pop	af
  0F57  37            		scf
  0F58  C9            		ret
                      	
                      	
                      	;interrupt for RS-232C
  0F59                	INT232:
  0F59  F5            		push	af
  0F5A  E5            		push	hl
  0F5B  3E17          		ld	a,17h		;RTS=0
  0F5D  D381          		out	(81h),a
  0F5F                	INT232LP:
  0F5F  DB81          		in	a,(81h)
  0F61  E602          		and	02h
  0F63  28FA          		jr	z,INT232LP	;wait for RxRDY=1
  0F65  DB80          		in	a,(80h)
                      	
  0F67  2195FB        		ld	hl,RSBFIN
  0F6A  CD390F        		call	PUTBF
                      	
  0F6D  3E37          		ld	a,37h		;RTS=1
  0F6F  D381          		out	(81h),a
  0F71  E1            		pop	hl
  0F72  1832          		jr	POPAF
                      	
                      	
                      	;interrupt for timer
  0F74                	_INTTIM:ds	INTTIM-_INTTIM
  0F74                		org	INTTIM
                      	
  0F74  C5            		push	bc
  0F75  F5            		push	af
  0F76  D5            		push	de
  0F77  E5            		push	hl
                      	
  0F78  CDEC1B        		call	PLAYINT
                      	
  0F7B  2128FA        		ld	hl,TMCNT
  0F7E  34            		inc	(hl)
  0F7F  34            		inc	(hl)
  0F80  20A9          		jr	nz,IKPOP
  0F82  2C            		inc	l		;inc hl
  0F83  34            		inc	(hl)
  0F84  2006          		jr	nz,TIMCSR
  0F86  2C            		inc	l
  0F87  34            		inc	(hl)
  0F88  2002          		jr	nz,TIMCSR
  0F8A  2C            		inc	l
  0F8B  34            		inc	(hl)
                      	
  0F8C                	TIMCSR:
                      	;cursor blink
  0F8C  3A92FD        		ld	a,(SCREEN1)
  0F8F  212EFA        		ld	hl,CSRBLNK
  0F92  2F            		cpl
  0F93  0F            		rrca
  0F94  A6            		and	(hl)
  0F95  C48F11        		call	nz,CSRREV	;(SCREEN1)=0or1, (CSRBLNK)=1
  0F98  1891          		jr	IKPOP
                      	
                      	
                      	;interrupt for CMT load
  0F9A                	INTCMT:
  0F9A  F5            		push	af
  0F9B  CD780E        		call	IN90H
  0F9E  321DFA        		ld	(CMTBUF),a
  0FA1  3E02          		ld	a,02h
  0FA3                	SETCMTST:
  0FA3  3219FA        		ld	(CMTSTAT),a
  0FA6                	POPAF:
  0FA6  F1            		pop	af
  0FA7                	EIRET:
  0FA7  FB            		ei
  0FA8  C9            		ret
                      	
                      	
                      	;interrupt for CMT write stop
  0FA9                	INTWSTP:
                      	;interrupt for CMT read stop
  0FA9                	INTRSTP:
  0FA9  F5            		push	af
  0FAA  3E03          		ld	a,03h
  0FAC  3218FA        		ld	(STOPFLG),a
  0FAF  18F5          		jr	POPAF
                      	
                      	
                      	;interrupt for CMT error
  0FB1                	INTERR:
  0FB1  F5            		push	af
  0FB2  3E10          		ld	a,10h
  0FB4  18ED          		jr	SETCMTST
                      	
                      	
                      	;get input character
                      	;output: a, z-flag(1=no input)
                      	;destroy: f
  0FB6                	_GETCH:	ds	GETCH-_GETCH
  0FBC                		org	GETCH
                      	
  0FBC  E5            		push	hl
  0FBD  CDF40F        		call	GETCH2
  0FC0  E1            		pop	hl
  0FC1  C9            		ret
                      	
                      	
                      	;wait for input and get a character
                      	;output: a
                      	;destroy: f
  0FC2                	_GETC:	ds	GETC-_GETC
  0FC4                		org	GETC
                      	
  0FC4  E5            		push	hl
  0FC5                	GETCLP1:
  0FC5  CD7911        		call	CSRON
  0FC8  2600          		ld	h,0
  0FCA                	GETCLP2:
  0FCA  CD7C30        		call	MODEKEY
  0FCD  24            		inc	h
  0FCE  CCB212        		call	z,PRTFKEY2
  0FD1  CDBC0F        		call	GETCH
  0FD4  28F4          		jr	z,GETCLP2
                      	
  0FD6  CD8111        		call	CSROFF
  0FD9  FEFE          		cp	0feh		;page switching key
  0FDB  2807          		jr	z,GETCPAGE
  0FDD  67            		ld	h,a
  0FDE  CD6D13        		call	CHGTXT
  0FE1  7C            		ld	a,h
  0FE2  E1            		pop	hl
  0FE3  C9            		ret
                      	
  0FE4                	GETCPAGE:
  0FE4  3A8FFD        		ld	a,(SCREEN2)
  0FE7  3C            		inc	a
  0FE8  218CFD        		ld	hl,PAGES
  0FEB  BE            		cp	(hl)
  0FEC  3801          		jr	c,GETCC
  0FEE  AF            		xor	a
  0FEF                	GETCC:
  0FEF  CD7A13        		call	CHGSCR
  0FF2  18D1          		jr	GETCLP1
                      	
                      	
  0FF4                	GETCH2:
  0FF4  3A32FA        		ld	a,(FKEYCNT)
  0FF7  B7            		or	a
  0FF8  202E          		jr	nz,GETFKEY
  0FFA  2130FA        		ld	hl,GRPWRK
  0FFD  B6            		or	(hl)		;a=0
  0FFE  2808          		jr	z,GETCHZ	;(hl)=0?
  1000  3600          		ld	(hl),0
  1002  FEEF          		cp	0efh		;Ctrl-T=14h+0efh
  1004  C8            		ret	z
  1005  C630          		add	a,30h
  1007  C9            		ret			;z-flag=0
                      	
  1008                	GETCHZ:
                      	;(GRPWRK)=0
  1008  CD3A10        		call	GETKBF
  100B  C8            		ret	z
  100C  FE14          		cp	14h
  100E  C0            		ret	nz
                      	
                      	;14h+**
  100F  CD3A10        		call	GETKBF
  1012  FEF0          		cp	0f0h
  1014  3006          		jr	nc,CNVFKEY
  1016  3230FA        		ld	(GRPWRK),a
  1019  3E14          		ld	a,14h
  101B  C9            		ret			;z-flag=0
                      	
                      	;a=f0-f9
  101C                	CNVFKEY:
  101C  21BDFB        		ld	hl,FKEYTBL+80h
                      	;	and	0fh
  101F  87            		add	a,a
  1020  87            		add	a,a
  1021  87            		add	a,a
  1022  85            		add	a,l		;no carry
  1023  6F            		ld	l,a
                      	;	jr	nc,CNVFKNC
                      	;	inc	h
                      	;CNVFKNC:
  1024  3E07          		ld	a,07h
  1026  1804          		jr	GETFKEY2
                      	
                      	;function key
  1028                	GETFKEY:
  1028  2A8DFB        		ld	hl,(FKEYAD)
  102B  3D            		dec	a
  102C                	GETFKEY2:
  102C  3232FA        		ld	(FKEYCNT),a
  102F  7E            		ld	a,(hl)
  1030  23            		inc	hl
  1031  228DFB        		ld	(FKEYAD),hl
  1034  B7            		or	a
  1035  C9            		ret
                      	
                      	
                      	;get a character from key buffer
                      	;output: a,z-flag(1=no input)
                      	;destroy: f,hl
  1036                	_GETKBF:ds	GETKBF-_GETKBF
  103A                		org	GETKBF
                      	
  103A  218FFB        		ld	hl,KYBFIN
  103D                	CALLGETBF:
  103D  F3            		di
  103E  CD0A26        		call	GETBF
  1041  FB            		ei
  1042  C9            		ret
                      	
                      	
                      	;get a character from RS-232C buffer
                      	;output: a,z-flag(1=no input)
                      	;destroy: f,hl
  1043                	GETRSBF:
  1043  2195FB        		ld	hl,RSBFIN
  1046  18F5          		jr	CALLGETBF
                      	
                      	
                      	;get from PLAY command buffer
                      	;input: b=channel+1 (1,2,3)
                      	;output: a,z
                      	;destroy: f,hl
  1048                	GETPLBF:
  1048  219BFB        		ld	hl,BUFAIN-6
  104B  78            		ld	a,b
  104C  87            		add	a,a		;*2
  104D  80            		add	a,b		;*3
  104E  87            		add	a,a		;*6
  104F  85            		add	a,l		;no carry
  1050  6F            		ld	l,a
  1051  C30A26        		jp	GETBF
                      	
                      	
                      	;clear key buffer pointer
                      	;destroy: a,(f,bc,de,hl)
  1054                	_CLRKBF:ds	CLRKBF-_CLRKBF
  1058                		org	CLRKBF
                      	
  1058  3A8FFB        		ld	a,(KYBFIN)
  105B  3290FB        		ld	(KYBFOUT),a
  105E  C9            		ret
                      	
                      	
                      	;send key-query to sub CPU and get reply
                      	;output: a (space-0-left-right-down-up-stop-shift)
                      	;destroy: f
  105F                	_STICK:	ds	STICK-_STICK
  1061                		org	STICK
                      	
  1061  3EFF          		ld	a,0ffh
  1063  32CAFE        		ld	(GMKYBUF),a
  1066  3E06          		ld	a,06h
  1068  F3            		di
  1069  CD8F0E        		call	OUT90H
  106C  FB            		ei
  106D                	STICKLP:
  106D  3ACAFE        		ld	a,(GMKYBUF)
  1070  FEFF          		cp	0ffh		;bit6=0?
  1072  28F9          		jr	z,STICKLP
  1074  C9            		ret
                      	
                      	
                      	;put a character in CRT
                      	;input: a=character code
                      	;destroy: none
  1075                	_PUTC:	ds	PUTC-_PUTC
  1075                		org	PUTC
                      	
  1075  F5            		push	af
  1076  E5            		push	hl
                      	
  1077  2A31FA        		ld	hl,(GRPFLG)
  107A  2C            		inc	l
  107B  2D            		dec	l
  107C  200D          		jr	nz,PUTGRP
  107E  FE20          		cp	20h
  1080  3010          		jr	nc,PUTCNC
  1082  D5            		push	de
  1083  C5            		push	bc
  1084  CDFA10        		call	PUTCTL
  1087  C1            		pop	bc
  1088  D1            		pop	de
  1089  180A          		jr	PUTCEND
                      	
  108B                	PUTGRP:
  108B  D630          		sub	30h
  108D  2131FA        		ld	hl,GRPFLG
  1090  3600          		ld	(hl),0
  1092                	PUTCNC:
  1092  CDAA10        		call	PUTCHR
                      	
  1095                	PUTCEND:
  1095  E1            		pop	hl
  1096  F1            		pop	af
  1097  C9            		ret
                      	
                      	
                      	;for graphic mode (screen3,4)
                      	;a=character
  1098                	PUTCHRG:
  1098  2AA8FD        		ld	hl,(CSRY)
  109B  CDD614        		call	PUTG
  109E                	CTLRHT:
  109E  2AAAFD        		ld	hl,(CSRAD)
  10A1  23            		inc	hl
  10A2  1813          		jr	CHKNL
                      	
                      	;put a character in CRT (no control code)
                      	;input: a=character code
                      	;destroy: af,hl
  10A4                	_PUTCHR:ds	PUTCHR-_PUTCHR
  10AA                		org	PUTCHR
                      	
  10AA  2A92FD        		ld	hl,(SCREEN1)
  10AD  CB4D          		bit	1,l
  10AF  20E7          		jr	nz,PUTCHRG	;screen mode 3,4
                      	
  10B1  2AAAFD        		ld	hl,(CSRAD)
  10B4  CDCA14        		call	PUT12
                      	
                      	;next line?
  10B7                	CHKNL:
  10B7  22AAFD        		ld	(CSRAD),hl
  10BA  21A9FD        		ld	hl,CSRX
  10BD  34            		inc	(hl)
  10BE  3AACFD        		ld	a,(WIDTH)
  10C1  BE            		cp	(hl)
  10C2  D0            		ret	nc
  10C3                	CHKNL2:
  10C3  3601          		ld	(hl),1
                      	
  10C5  3AA5FD        		ld	a,(LASTLIN)
  10C8  2AA2FD        		ld	hl,(CONSOL1)	;l=(CONSOL1)
  10CB  95            		sub	l
  10CC  2802          		jr	z,CTLLF
  10CE  3EFF          		ld	a,0ffh
                      	
  10D0                	CTLLF:
  10D0  3C            		inc	a		;0 or 1
  10D1  2AA8FD        		ld	hl,(CSRY)	;l=y+1,h=x+1
                      	
  10D4  E5            		push	hl
  10D5  D5            		push	de
  10D6  CD8215        		call	SETLINE
  10D9  D1            		pop	de
  10DA  E1            		pop	hl
                      	
  10DB  2C            		inc	l
  10DC  3AA5FD        		ld	a,(LASTLIN)
  10DF  BD            		cp	l
  10E0  D26D11        		jp	nc,SETCSR
                      	
                      	;scroll
  10E3  D5            		push	de
  10E4  54            		ld	d,h		;x+1
  10E5  2AA1FD        		ld	hl,(CONSOL1-1)	;h=(CONSOL1)
  10E8  1801          		jr	SKPPATCH1
                      	
                      	
                      	;10eah: to be patched by iP6plus
  10EA                	_PATCH1:ds	PATCH1-_PATCH1
  10EA                		org	PATCH1
  10EA  00            		db	00h
                      	
  10EB                	SKPPATCH1:
  10EB  6F            		ld	l,a
  10EC  9C            		sbc	a,h		;c-flag=1, (LASTLIN)-(CONSOL1)-1
  10ED  D45B0E        		call	nc,SCRLUP
                      	
  10F0  62            		ld	h,d		;x+1
  10F1  CDB811        		call	Y2AD
  10F4  CDDA11        		call	DELLIN
  10F7  D1            		pop	de
  10F8  1873          		jr	SETCSR
                      	
                      	
  10FA                	PUTCTL:
  10FA  FE14          		cp	14h
  10FC  2847          		jr	z,CTLGRP
  10FE  FE07          		cp	07h
  1100  CACD1B        		jp	z,BELL
  1103  D60A          		sub	0ah
  1105  28C9          		jr	z,CTLLF
  1107  3D            		dec	a
  1108  285B          		jr	z,CTLHOM	;0bh
  110A  3D            		dec	a
  110B  CAFB1D        		jp	z,CLS		;0ch
  110E  2AA8FD        		ld	hl,(CSRY)	;l=y+1,h=x+1
  1111  3D            		dec	a
  1112  2854          		jr	z,CTLCR		;0dh
  1114  D60F          		sub	1ch-0dh
  1116  2886          		jr	z,CTLRHT	;1ch
  1118  3D            		dec	a
  1119  2808          		jr	z,CTLLFT	;1dh
  111B  3D            		dec	a
  111C  2814          		jr	z,CTLUP		;1eh
  111E  3D            		dec	a
  111F  C0            		ret	nz
                      	;	jr	z,CTLDWN	;1fh
                      	
  1120                	CTLDWN:
  1120  2C            		inc	l
  1121  1819          		jr	CTLUPNZ
                      	
  1123                	CTLLFT:
  1123  25            		dec	h
  1124  2047          		jr	nz,SETCSR
  1126  3AA2FD        		ld	a,(CONSOL1)
  1129  BD            		cp	l
  112A  D0            		ret	nc
  112B  2D            		dec	l
  112C  3AACFD        		ld	a,(WIDTH)
  112F  67            		ld	h,a
  1130  183B          		jr	SETCSR
                      	
  1132                	CTLUP:
  1132  3AA2FD        		ld	a,(CONSOL1)
  1135  BD            		cp	l
  1136  C8            		ret	z
  1137  2D            		dec	l
  1138  2002          		jr	nz,CTLUPNZ
  113A  2E01          		ld	l,01h
  113C                	CTLUPNZ:
  113C  3AA5FD        		ld	a,(LASTLIN)
  113F  BD            		cp	l
  1140  302B          		jr	nc,SETCSR
  1142  6F            		ld	l,a
  1143  1828          		jr	SETCSR
                      	
  1145                	CTLGRP:
  1145  3231FA        		ld	(GRPFLG),a	;a=14h
  1148  C9            		ret
                      	
                      	
                      	;convert VRAM address to text screen (x,y)
                      	;input: hl=address
                      	;output: h=x+1, l=y+1(0=error)
                      	;destroy: af
  1149                	AD2XY:
  1149  D5            		push	de
  114A  112000        		ld	de,COLUMNS
                      	
  114D  CB54          		bit	2,h
  114F  2804          		jr	z,AD2XYZ
                      	
  1151  1E28          		ld	e,CLMN66
  1153  25            		dec	h
  1154  25            		dec	h
  1155                	AD2XYZ:
  1155  25            		dec	h
  1156  25            		dec	h
                      	
  1157  AF            		xor	a
  1158                	AD2XYLP:
  1158  3C            		inc	a
  1159  ED52          		sbc	hl,de
  115B  CB5C          		bit	3,h
  115D  28F9          		jr	z,AD2XYLP
  115F  19            		add	hl,de
  1160  2C            		inc	l
  1161  65            		ld	h,l
  1162  6F            		ld	l,a
  1163  D1            		pop	de
  1164  C9            		ret
                      	
  1165                	CTLHOM:
  1165  2AA2FD        		ld	hl,(CONSOL1)	;l=(CONSOL1)
                      	
  1168                	CTLCR:
  1168  2601          		ld	h,1
  116A  1801          		jr	SETCSR
                      	
                      	
                      	;set cursor position
                      	;input: h=x+1, l=y+1
                      	;output: (fda8h)=y+1,(fda9h)=x+1,(fdaa-fdab)=VRAM address
                      	;destroy: none
  116C                	_SETCSR:ds	SETCSR-_SETCSR
  116D                		org	SETCSR
  116D  E5            		push	hl
  116E  22A8FD        		ld	(CSRY),hl
  1171  CDCD11        		call	XY2AD
  1174  22AAFD        		ld	(CSRAD),hl
  1177  E1            		pop	hl
  1178  C9            		ret
                      	
                      	
                      	;cursor blink on
                      	;destroy: none
  1179                	_CSRON:
  1179                		ds	CSRON-_CSRON
  1179                		org	CSRON
                      	
  1179  F5            		push	af
  117A  3E01          		ld	a,01h
  117C  322EFA        		ld	(CSRBLNK),a
  117F  F1            		pop	af
  1180  C9            		ret
                      	
                      	
                      	;cursor blink off
                      	;destroy: hl
  1181                	_CSROFF:
  1181                		ds	CSROFF-_CSROFF
  1181                		org	CSROFF
                      	
  1181  F5            		push	af
  1182  AF            		xor	a
  1183  322EFA        		ld	(CSRBLNK),a
  1186  3A2FFA        		ld	a,(CSRSTAT)
  1189  B7            		or	a
  118A  C48F11        		call	nz,CSRREV
  118D  F1            		pop	af
  118E  C9            		ret
                      	
                      	
                      	;reverse cursor
                      	;destroy: af,hl
  118F                	CSRREV:
  118F  212FFA        		ld	hl,CSRSTAT
  1192  7E            		ld	a,(hl)
  1193  2F            		cpl
  1194  77            		ld	(hl),a
  1195  2AAAFD        		ld	hl,(CSRAD)
                      	
  1198  CB54          		bit	2,h
  119A  C25766        		jp	nz,CSRREV66
                      	
  119D  25            		dec	h
  119E  25            		dec	h
  119F  7E            		ld	a,(hl)
  11A0  CB77          		bit	6,a		;semi-graphic mode?
  11A2  2004          		jr	nz,CSRSEMI
  11A4  EE01          		xor	01h
  11A6  77            		ld	(hl),a
  11A7  C9            		ret
                      	
  11A8                	CSRSEMI:
  11A8  24            		inc	h
  11A9  24            		inc	h
  11AA  7E            		ld	a,(hl)
  11AB  2F            		cpl
  11AC  77            		ld	(hl),a
  11AD  C9            		ret
                      	
                      	
  11AE                	Y2AD2:
  11AE  CE02          		adc	a,02h
  11B0  57            		ld	d,a
  11B1  F1            		pop	af
  11B2  C9            		ret
                      	
                      	
                      	;get left edge address
                      	;input: l=y+1
                      	;output: de=VRAM address
                      	;destroy: none
  11B3                	_Y2AD:ds	Y2AD-_Y2AD
  11B8                		org	Y2AD
                      	
  11B8  F5            		push	af
  11B9  CD9539        		call	CHKMOD
  11BC  CA0066        		jp	z,Y2AD66
                      	
  11BF  7D            		ld	a,l
  11C0  3D            		dec	a
  11C1  87            		add	a,a		;*2
  11C2  87            		add	a,a		;*4
  11C3  87            		add	a,a		;*8
  11C4  87            		add	a,a		;*16
  11C5  87            		add	a,a		;*32
  11C6  5F            		ld	e,a
  11C7  3A91FD        		ld	a,(VRAM)
  11CA  18E2          		jr	Y2AD2
                      	
                      	
                      	;get VRAM character address (screen mode 1,2)
                      	;input: h=x+1, l=y+1
                      	;output: hl=VRAM address
                      	;destroy: none
  11CC                	_XY2AD:	ds	XY2AD-_XY2AD
  11CD                		org	XY2AD
                      	
  11CD  F5            		push	af
  11CE  D5            		push	de
  11CF  CDB811        		call	Y2AD
  11D2  25            		dec	h
  11D3  6C            		ld	l,h
  11D4  2600          		ld	h,0
  11D6  19            		add	hl,de
  11D7  D1            		pop	de
  11D8  F1            		pop	af
  11D9  C9            		ret
                      	
                      	
                      	;delete line
                      	;input: de=left edge address (for screen mode 1,2)
                      	;destroy: none
  11DA                	_DELLIN:ds	DELLIN-_DELLIN
  11DA                		org	DELLIN
                      	
  11DA  F5            		push	af
  11DB  E5            		push	hl
  11DC  D5            		push	de
  11DD  C5            		push	bc
                      	
  11DE  EB            		ex	de,hl
                      	
  11DF  3A92FD        		ld	a,(SCREEN1)
  11E2  FE02          		cp	02h		;;
  11E4  CB54          		bit	2,h		;;;
  11E6  C26C64        		jp	nz,DELLIN66	;;;
  11E9  3018          		jr	nc,DELG		;;
                      	
  11EB  E5            		push	hl		;
                      	;	ld	bc,COLUMNS
  11EC  010120        		ld	bc,2001h
  11EF  25            		dec	h
  11F0  25            		dec	h
                      	
  11F1                	DELLATT:
  11F1  CD3415        		call	GETSPA
  11F4  C5            		push	bc
  11F5  CD4E12        		call	MEMSET
  11F8  C1            		pop	bc
  11F9  E1            		pop	hl		;
                      	
  11FA                	DELLEND:
  11FA  CD1316        		call	GETSP
  11FD  CD4E12        		call	MEMSET
  1200  C3AB1B        		jp	POPALL
                      	
                      	
                      	;for graphic mode (screen3,4)
  1203                	DELG:
                      	;	ld	bc,COLUMNS*12
  1203  010280        		ld	bc,8002h
  1206  CD7814        		call	AD2GAD
  1209  18EF          		jr	DELLEND
                      	
                      	
                      	;for graphic mode (screen mode 3,4)
  120B                	SCRLG:
                      	;bc=a*32*12=a*(256+128)
  120B  48            		ld	c,b		;b=0
  120C  47            		ld	b,a
  120D  1F            		rra			;c-flag=0
  120E  CB19          		rr	c
  1210  80            		add	a,b
  1211  47            		ld	b,a
                      	
  1212  2601          		ld	h,1
  1214  CD7D14        		call	XY2GAD
  1217  EB            		ex	de,hl
  1218  218001        		ld	hl,COLUMNS*12
  121B  19            		add	hl,de
  121C  F1            		pop	af		;up/down
  121D  2003          		jr	nz,SCRLATT
  121F  EB            		ex	de,hl
  1220  1B            		dec	de
  1221  2B            		dec	hl
                      	
  1222                	SCRLATT:
  1222  CDB23F        		call	LDIDR
                      	
  1225                	SCRLATT2:
  1225  C1            		pop	bc
  1226  E1            		pop	hl
                      	
                      	;scroll INPUT prompt position
                      	;z=0: up,h=first,l=last
                      	;z=1: down,h=last,l=first
  1227  E5            		push	hl
                      	
  1228  1EFF          		ld	e,0-01h
  122A  2005          		jr	nz,SCRLIUP
  122C  1E01          		ld	e,01h
  122E  7C            		ld	a,h
  122F  65            		ld	h,l
  1230  6F            		ld	l,a
  1231                	SCRLIUP:
  1231  3AABFD        		ld	a,(CSRAD+1)
  1234  57            		ld	d,a
  1235  3A5CFE        		ld	a,(INPTPAG)
  1238  AA            		xor	d
  1239  E6F0          		and	0f0h
  123B  200E          		jr	nz,SCRLIEND
                      	
  123D  3A59FE        		ld	a,(INPTXY)
  1240  BC            		cp	h
  1241  3808          		jr	c,SCRLIEND
  1243  2C            		inc	l
  1244  BD            		cp	l
  1245  3004          		jr	nc,SCRLIEND
  1247  83            		add	a,e
  1248  3259FE        		ld	(INPTXY),a
  124B                	SCRLIEND:
  124B  E1            		pop	hl
                      	
  124C  D1            		pop	de
  124D  C9            		ret
                      	
                      	
                      	;set memory
                      	;input: a=data, b=inner loops, c=outer loops, hl=start address
                      	;destroy: af,bc,hl
  124E                	MEMSET:
  124E  77            		ld	(hl),a
  124F  23            		inc	hl
  1250  10FC          		djnz	MEMSET
  1252  0D            		dec	c
  1253  20F9          		jr	nz,MEMSET
  1255  C9            		ret
                      	
                      	
                      	;put a character in CRT (no control code, no move in cursor)
                      	;input: a=character code, h=x+1, l=y+1
                      	;destroy: none
  1256                	_PUTCH:	ds	PUTCH-_PUTCH
  1257                		org	PUTCH
                      	
  1257  E5            		push	hl
  1258  CDCD11        		call	XY2AD
  125B  CDAF14        		call	PUTCH2
  125E  E1            		pop	hl
  125F  C9            		ret
                      	
                      	
                      	;scroll up
                      	;input: h=first line+1, l=last line+1
                      	;destroy: af
  1260                	_SCRLU60:ds	SCRLU60-_SCRLU60
  1260                		org	SCRLU60
                      	
  1260  7D            		ld	a,l
  1261  94            		sub	h		;a=(LASTLIN)-(CONSOL1) < 16
                      	;	ret	z
                      	;	ret	c
                      	
                      	;z=0:scroll up, z=1:scroll down
  1262                	SCRLUD60:
  1262  D5            		push	de
  1263  E5            		push	hl
  1264  C5            		push	bc
  1265  F5            		push	af		;up/down
                      	
                      	;line connection status
  1266  47            		ld	b,a
  1267  04            		inc	b
  1268  50            		ld	d,b		;>0
  1269                	SCRLUD60LP:
  1269  CD7615        		call	CHKLINE4
  126C  4F            		ld	c,a
  126D  7A            		ld	a,d
  126E  E5            		push	hl
  126F  CD8215        		call	SETLINE
  1272  E1            		pop	hl
  1273  51            		ld	d,c
  1274  2D            		dec	l
  1275  F1            		pop	af		;up/down
  1276  F5            		push	af
  1277  2002          		jr	nz,SCRLUD60NZ
  1279  2C            		inc	l
  127A  2C            		inc	l
  127B                	SCRLUD60NZ:
  127B  10EC          		djnz	SCRLUD60LP
                      	
  127D  6C            		ld	l,h
  127E  3A92FD        		ld	a,(SCREEN1)
  1281  FE02          		cp	02h
  1283  D1            		pop	de		;d=a
  1284  D5            		push	de
  1285  7A            		ld	a,d
  1286  3083          		jr	nc,SCRLG	;screen mode 3 4
                      	
  1288  CDA73F        		call	MUL32
  128B  CDB811        		call	Y2AD
  128E  212000        		ld	hl,COLUMNS
  1291  19            		add	hl,de
  1292  F1            		pop	af		;up/down
  1293  2003          		jr	nz,SCRL1NZ
  1295  EB            		ex	de,hl
  1296  1B            		dec	de
  1297  2B            		dec	hl
                      	
  1298                	SCRL1NZ:
  1298  E5            		push	hl
  1299  D5            		push	de
  129A  C5            		push	bc
  129B  CDB23F        		call	LDIDR
  129E  C1            		pop	bc
  129F  D1            		pop	de
  12A0  E1            		pop	hl
                      	
                      	;attribute
  12A1  CB8C          		res	1,h
  12A3  CB8A          		res	1,d
  12A5  C32212        		jp	SCRLATT
                      	
                      	
                      	;scroll down
                      	;input: h=last line+1, l=first line+1
                      	;destroy: af
  12A8                	_SCRLD60:ds	SCRLD60-_SCRLD60
  12A9                		org	SCRLD60
                      	
  12A9  7C            		ld	a,h
  12AA  95            		sub	l
                      	;	ret	z
                      	;	ret	c
  12AB  BF            		cp	a		;set z-flag
  12AC  18B4          		jr	SCRLUD60
                      	
                      	
                      	;print function key
                      	;input: none
                      	;output: none
                      	;destroy: af
  12AE                	PRTFKEY:
  12AE  AF            		xor	a
  12AF  32A7FD        		ld	(FKEYSFT),a
                      	
  12B2                	PRTFKEY2:
  12B2  3A92FD        		ld	a,(SCREEN1)
  12B5  FE02          		cp	02h
  12B7  D0            		ret	nc		;screen mode 3 or 4
                      	
  12B8  E5            		push	hl
  12B9  D5            		push	de
  12BA  C5            		push	bc
                      	
  12BB  21A7FD        		ld	hl,FKEYSFT
  12BE  3AA6FD        		ld	a,(CONSOL3)
  12C1  B7            		or	a
  12C2  286B          		jr	z,DELFK
                      	
  12C4  113DFB        		ld	de,FKEYTBL
  12C7  CD6110        		call	STICK
  12CA  E601          		and	01h
  12CC  2802          		jr	z,FKEYZ
  12CE  1E65          		ld	e,FKEYTBL+8*5-(FKEYTBL+8*5)/256*256	;de=FKEYTBL+8*5
  12D0                	FKEYZ:
  12D0  87            		add	a,a
  12D1  3C            		inc	a
  12D2  BE            		cp	(hl)
  12D3  2856          		jr	z,PFKEND
  12D5  77            		ld	(hl),a
                      	
  12D6  D5            		push	de
  12D7  2A20FA        		ld	hl,(HEIGHT)
  12DA  CDB811        		call	Y2AD
  12DD  EB            		ex	de,hl
  12DE  D1            		pop	de
                      	
                      	
  12DF  CD3E13        		call	CHRREV
  12E2  3A8FFD        		ld	a,(SCREEN2)
  12E5  C631          		add	a,'1'
  12E7  CDCA14        		call	PUT12
                      	
  12EA  CD3E13        		call	CHRREV
  12ED  3E20          		ld	a,' '
  12EF  CDCA14        		call	PUT12
                      	
  12F2  0E05          		ld	c,05h
  12F4                	FKEYLP1:
  12F4  CD3E13        		call	CHRREV
  12F7  3AC7FE        		ld	a,(FKEYLEN)
  12FA  47            		ld	b,a
  12FB                	FKEYLP2:
  12FB  1A            		ld	a,(de)
  12FC  B7            		or	a
  12FD  280C          		jr	z,FKEYNEXT
  12FF  FE20          		cp	20h
  1301  3002          		jr	nc,FKEYNC
  1303  3E20          		ld	a,' '
  1305                	FKEYNC:
  1305  CDCA14        		call	PUT12
  1308  1C            		inc	e		;inc de
  1309  10F0          		djnz	FKEYLP2
                      	
  130B                	FKEYNEXT:
  130B  04            		inc	b
  130C                	FKEYLP3:
  130C  78            		ld	a,b
  130D  3D            		dec	a
  130E  CC3E13        		call	z,CHRREV
  1311  3E20          		ld	a,' '
  1313  CDCA14        		call	PUT12
  1316  1C            		inc	e		;inc de
  1317  10F3          		djnz	FKEYLP3
                      	
                      	;	inc	e		;inc de
                      	;	inc	e		;inc de
                      	
  1319  7B            		ld	a,e
  131A  E6F8          		and	0f8h
  131C  F605          		or	FKEYTBL-FKEYTBL/8*8
  131E  5F            		ld	e,a
                      	
  131F  0D            		dec	c
  1320  20D2          		jr	nz,FKEYLP1
                      	
  1322  CD9539        		call	CHKMOD
  1325  CC9864        		call	z,PFK66
                      	
  1328                	PFKEND2:
  1328  CD541D        		call	CNSLEND2
  132B                	PFKEND:
  132B  C1            		pop	bc
  132C  D1            		pop	de
  132D  E1            		pop	hl
  132E  C9            		ret
                      	
  132F                	DELFK:
  132F  BE            		cp	(hl)		;hl=FKEYSFT
  1330  28F9          		jr	z,PFKEND
  1332  77            		ld	(hl),a
  1333  2A20FA        		ld	hl,(HEIGHT)
  1336  CDB811        		call	Y2AD
  1339  CDDA11        		call	DELLIN
  133C  18EA          		jr	PFKEND2
                      	
                      	
                      	;reverse character attribute
                      	;destroy: af
  133E                	CHRREV:
  133E  CD9539        		call	CHKMOD
  1341  CA4B66        		jp	z,CHRREV66
  1344  3A92FD        		ld	a,(SCREEN1)
  1347  EE03          		xor	03h
  1349  2819          		jr	z,REVEND	;screen mode 4
  134B  0F            		rrca
  134C  3A93FD        		ld	a,(COLOR1)
  134F  380D          		jr	c,REV13
                      	
  1351                	REV2:
  1351  B7            		or	a
  1352  CAC015        		jp	z,SETATT
  1355  FE08          		cp	08h
  1357  3802          		jr	c,REV2C
  1359  3E08          		ld	a,08h
  135B                	REV2C:
  135B  3D            		dec	a
  135C  1806          		jr	REVEND
                      	
  135E                	REV13:
  135E  B7            		or	a
  135F  2803          		jr	z,REVEND
  1361  3D            		dec	a
  1362  E603          		and	03h
  1364                	REVEND:
  1364  EE01          		xor	01h
  1366  3C            		inc	a
  1367  3293FD        		ld	(COLOR1),a
  136A  C3C015        		jp	SETATT
                      	
                      	
                      	;change to text screen
                      	;input: none
                      	;output: none
                      	;destroy: af
  136D                	CHGTXT:
  136D  3A90FD        		ld	a,(SCREEN3)
  1370  CD0C14        		call	CHGACT
  1373  3A92FD        		ld	a,(SCREEN1)
  1376  FE02          		cp	02h
  1378  D8            		ret	c
  1379  AF            		xor	a
  137A                	CHGSCR:
  137A  CD0C14        		call	CHGACT
  137D  C3ED13        		jp	CHGDSP
                      	
                      	
                      	;change screen mode
                      	;input: a=mode-1
                      	;destroy: af,de
  1380                	_CHGMOD:ds	CHGMOD-_CHGMOD
  1390                		org	CHGMOD
                      	
  1390  FE04          		cp	04h
  1392  D2ED03        		jp	nc,FCERR
  1395  E5            		push	hl
  1396  2192FD        		ld	hl,SCREEN1
  1399  5E            		ld	e,(hl)		;
  139A  BB            		cp	e
  139B  284D          		jr	z,CMODEND
  139D  77            		ld	(hl),a
                      	
  139E  C5            		push	bc
  139F  F5            		push	af		;;
                      	
  13A0  FE02          		cp	02h
  13A2  3E20          		ld	a,COLUMNS	;screen mode 1,2,4:width=32
  13A4  2001          		jr	nz,SETWID
  13A6  1F            		rra			;screen mode 3:width=16
  13A7                	SETWID:
  13A7  32ACFD        		ld	(WIDTH),a
                      	
  13AA  2196FD        		ld	hl,M1COLOR
  13AD  010300        		ld	bc,0003h
  13B0  50            		ld	d,b		;b=0
  13B1  19            		add	hl,de		;
  13B2  19            		add	hl,de
  13B3  19            		add	hl,de
  13B4  EB            		ex	de,hl
  13B5  2193FD        		ld	hl,COLOR1
  13B8  EDB0          		ldir
                      	
  13BA  F1            		pop	af		;;
  13BB  2196FD        		ld	hl,M1COLOR
  13BE  50            		ld	d,b		;b=0
  13BF  5F            		ld	e,a
  13C0  19            		add	hl,de
  13C1  19            		add	hl,de
  13C2  19            		add	hl,de
  13C3  1193FD        		ld	de,COLOR1
  13C6  0E03          		ld	c,03h		;b=0
  13C8  EDB0          		ldir
                      	
  13CA  CD3415        		call	GETSPA
  13CD  2A90FD        		ld	hl,(VRAM-1)	;h=(VRAM)
  13D0  68            		ld	l,b		;b=0
  13D1  77            		ld	(hl),a
  13D2  04            		inc	b
  13D3  54            		ld	d,h
  13D4  58            		ld	e,b		;de=hl+1
  13D5  0D            		dec	c		;bc=1ffh
                      	
  13D6  CD9539        		call	CHKMOD
  13D9  CC3440        		call	z,CHGMOD66
                      	
  13DC  EDB0          		ldir
                      	
  13DE  CD541D        		call	CNSLEND2
  13E1  2E01          		ld	l,01h
  13E3  3A20FA        		ld	a,(HEIGHT)
  13E6  CD4516        		call	CLSMAIN
                      	
  13E9  C1            		pop	bc
  13EA                	CMODEND:
  13EA  E1            		pop	hl
  13EB  C9            		ret
                      	
                      	
                      	;change display page
                      	;page1=8000h or c000h	out (0b0h),4 or 0
                      	;page2=e000h		out (0b0h),2
                      	;page3=c000h		out (0b0h),0
                      	;page4=a000h		out (0b0h),6
                      	;input: a=page-1
                      	;destroy: af
  13EC                	_CHGDSP:ds	CHGDSP-_CHGDSP
  13ED                		org	CHGDSP
                      	
  13ED  3290FD        		ld	(SCREEN3),a
                      	
  13F0  E5            		push	hl
  13F1  C5            		push	bc
                      	
  13F2  CD3314        		call	GETPGAD
  13F5  CD9539        		call	CHKMOD		;
  13F8  7E            		ld	a,(hl)
  13F9  CC5940        		call	z,CHGDSP66
  13FC  07            		rlca
  13FD  07            		rlca
  13FE  07            		rlca
  13FF  07            		rlca
  1400  EE04          		xor	04h
                      	
  1402  0606          		ld	b,00000110b
  1404  CD541B        		call	OUTB0H
                      	
  1407  C1            		pop	bc
  1408  E1            		pop	hl
                      	
  1409  C3B212        		jp	PRTFKEY2
                      	
                      	
                      	;change active page
                      	;input: a=page-1
                      	;destroy: none
  140C                	_CHGACT:ds	CHGACT-_CHGACT
  140C                		org	CHGACT
                      	
  140C  F5            		push	af
  140D  E5            		push	hl
                      	
  140E  218FFD        		ld	hl,SCREEN2
  1411  BE            		cp	(hl)
  1412  281C          		jr	z,ACTEND
                      	
  1414  D5            		push	de
  1415  C5            		push	bc
                      	
  1416  57            		ld	d,a		;
  1417  7E            		ld	a,(hl)
  1418  72            		ld	(hl),d		;
  1419  CD3314        		call	GETPGAD
  141C  7A            		ld	a,d		;
  141D  EB            		ex	de,hl
  141E  2191FD        		ld	hl,VRAM		;top of active page data
  1421  EDB0          		ldir
                      	
  1423  CD3314        		call	GETPGAD
  1426  1191FD        		ld	de,VRAM
  1429  EDB0          		ldir
                      	
  142B  CDAE12        		call	PRTFKEY
                      	
  142E  C1            		pop	bc
  142F  D1            		pop	de
                      	
  1430                	ACTEND:
  1430  E1            		pop	hl
  1431  F1            		pop	af
  1432  C9            		ret
                      	
                      	
                      	;get page data address
                      	;input: a=page-1
                      	;output: hl=address, bc=size
                      	;destroy: af
  1433                	GETPGAD:
  1433  21B9FD        		ld	hl,PAGE1
  1436  012800        		ld	bc,PAGE2-PAGE1
  1439  B7            		or	a
  143A                	PGADLP:
  143A  C8            		ret	z
  143B  09            		add	hl,bc
  143C  3D            		dec	a
  143D  18FB          		jr	PGADLP
                      	
                      	
                      	;get VRAM dot pattern address (screen mode 3,4)
                      	;hl=(VRAM+0200h)+(X/8)+Y*32
                      	;input: bc=graphic X, de=graphic Y
                      	;output: hl=VRAM address, d=bit
                      	;destroy: af,bc,e
  143F                	GXY2GAD:
  143F  CD9539        		call	CHKMOD
  1442  CA1566        		jp	z,GXY2GAD66
  1445                	GXY2GAD60:
  1445  CDDF2B        		call	CHKGXY
  1448  EB            		ex	de,hl
  1449  29            		add	hl,hl		;*2
  144A  29            		add	hl,hl		;*4
  144B  29            		add	hl,hl		;*8
  144C  29            		add	hl,hl		;*16
  144D  29            		add	hl,hl		;*32
  144E  3A91FD        		ld	a,(VRAM)
  1451  C602          		add	a,02h
  1453  47            		ld	b,a
  1454  79            		ld	a,c
  1455  CB39          		srl	c
  1457                	GXY2GADEND:
  1457  CB39          		srl	c
  1459  CB39          		srl	c
  145B  09            		add	hl,bc
                      	
  145C  E607          		and	07h
  145E  3C            		inc	a
  145F  47            		ld	b,a
                      	
  1460  3A92FD        		ld	a,(SCREEN1)
  1463  0F            		rrca
  1464  3E01          		ld	a,01h
  1466  3806          		jr	c,GXY2GADLP	;screen mode 4
                      	
  1468  05            		dec	b
  1469  CB80          		res	0,b
  146B  04            		inc	b
  146C  3E81          		ld	a,81h
                      	
  146E                	GXY2GADLP:
  146E  0F            		rrca
  146F  10FD          		djnz	GXY2GADLP
  1471  57            		ld	d,a
  1472  C9            		ret
                      	
                      	
                      	;convert character VRAM address to graphic VRAM address
                      	;(screen mode 1,2 -> screen mode 3,4)
                      	;input: hl=character VRAM address
                      	;output: hl=graphic VRAM address
                      	;destroy: none
  1473                	_AD2GAD:ds	AD2GAD-_AD2GAD
  1478                		org	AD2GAD
                      	
  1478  F5            		push	af
  1479  CD4911        		call	AD2XY
  147C  F1            		pop	af
                      	;	jr	XY2GAD
                      	
                      	
                      	;get VRAM address (screen mode 3,4)
                      	;input: h=x+1, l=y+1
                      	;output: hl=graphic VRAM address =(VRAM+200h)+y*0180h+x
                      	;destroy: none
  147D                	XY2GAD:
  147D  F5            		push	af
  147E  25            		dec	h
  147F  2D            		dec	l
  1480  3A92FD        		ld	a,(SCREEN1)
  1483  FE02          		cp	02h
  1485  2002          		jr	nz,XY2GADC
  1487  CB24          		sla	h		;screen mode 3
  1489                	XY2GADC:
  1489  CB24          		sla	h
  148B  3A91FD        		ld	a,(VRAM)
  148E  C602          		add	a,02h
  1490  85            		add	a,l
  1491  CB3D          		srl	l
  1493  CB1C          		rr	h
  1495  85            		add	a,l
  1496  6C            		ld	l,h
  1497  67            		ld	h,a
  1498  F1            		pop	af
  1499  C9            		ret
                      	
                      	
                      	;get CGROM address (DE=6000h+A*10h)
                      	;input: a=character code
                      	;output: de=address
                      	;destroy: none
  149A                	_CGROM:	ds	CGROM-_CGROM
  14A0                		org	CGROM
                      	
  14A0  F5            		push	af
  14A1  07            		rlca
  14A2  07            		rlca
  14A3  07            		rlca
  14A4  07            		rlca
  14A5  57            		ld	d,a
  14A6  E6F0          		and	0f0h
  14A8  5F            		ld	e,a
  14A9  AA            		xor	d
  14AA  C660          		add	a,60h
  14AC  57            		ld	d,a
  14AD  F1            		pop	af
  14AE  C9            		ret
                      	
                      	;	push	af		;push flag
                      	;	ex	de,hl
                      	;	ld	h,06h
                      	;	ld	l,a
                      	;	add	hl,hl
                      	;	add	hl,hl
                      	;	add	hl,hl
                      	;	add	hl,hl
                      	;	ex	de,hl
                      	;	pop	af		;pop flag
                      	;	ret
                      	
                      	
                      	;put a character in CRT (no control code, no move in cursor)
                      	;input: a=character code, hl=VRAM address
                      	;destroy: none
  14AF                	_PUTCH2:ds	PUTCH2-_PUTCH2
  14AF                		org	PUTCH2
                      	
  14AF  E5            		push	hl
  14B0  F5            		push	af
  14B1  3A92FD        		ld	a,(SCREEN1)
  14B4  FE02          		cp	02h
  14B6  380A          		jr	c,PUTCH12
                      	
                      	;screen mode 3,4
  14B8  CD4911        		call	AD2XY
  14BB  F1            		pop	af
  14BC  F5            		push	af
  14BD  CDD614        		call	PUTG
  14C0  1805          		jr	PUTCH2END
                      	
  14C2                	PUTCH12:
  14C2  F1            		pop	af
  14C3  F5            		push	af
  14C4  CDCA14        		call	PUT12
                      	
  14C7                	PUTCH2END:
  14C7  F1            		pop	af
  14C8  E1            		pop	hl
  14C9  C9            		ret
                      	
                      	
                      	;put character in screen mode 1,2
                      	;input: a=character code, hl=VRAM address
                      	;output: hl=hl+1
                      	;destroy: af
  14CA                	PUT12:
  14CA  E5            		push	hl
  14CB  77            		ld	(hl),a
  14CC  CD520E        		call	CHR2ATT
  14CF  CDF915        		call	CNVATT1
  14D2  77            		ld	(hl),a
  14D3  E1            		pop	hl
  14D4  23            		inc	hl
  14D5  C9            		ret
                      	
                      	
                      	;put character in graphic mode (screen mode 3,4)
                      	;input: a=character code, h=x+1, l=y+1
                      	;destroy af,hl
  14D6                	PUTG:
  14D6  D5            		push	de
  14D7  C5            		push	bc
                      	
  14D8  CDA014        		call	CGROM
  14DB  3A93FD        		ld	a,(COLOR1)
  14DE  CDC015        		call	SETATT
                      	
  14E1  CD9539        		call	CHKMOD
  14E4  CA7066        		jp	z,PUTG66
  14E7  CD7D14        		call	XY2GAD
                      	
  14EA  3E04          		ld	a,04h
  14EC  D393          		out	(93h),a		;CGROM ON
                      	
  14EE  060C          		ld	b,0ch
  14F0                	PUTGLP:
  14F0  D5            		push	de
  14F1  3A92FD        		ld	a,(SCREEN1)
  14F4  0F            		rrca			;
  14F5  1A            		ld	a,(de)
  14F6  3005          		jr	nc,CALL3	;
  14F8  CD2015        		call	PUT4
  14FB  1804          		jr	CALL34END
  14FD                	CALL3:
  14FD  CD1015        		call	PUT3
  1500  2B            		dec	hl
                      	
  1501                	CALL34END:
  1501  112000        		ld	de,COLUMNS
  1504  19            		add	hl,de
  1505  D1            		pop	de
  1506  1C            		inc	e		;inc de
  1507  10E7          		djnz	PUTGLP
                      	
  1509  3E05          		ld	a,05h
  150B  D393          		out	(93h),a		;CGROM OFF
                      	
  150D  C1            		pop	bc
  150E  D1            		pop	de
  150F  C9            		ret
                      	
  1510                	PUT3:
  1510  5F            		ld	e,a
  1511  CD1515        		call	PUTHALF
  1514  23            		inc	hl
  1515                	PUTHALF:
  1515  1604          		ld	d,04h
  1517                	PUT3LP:
  1517  CB03          		rlc	e
  1519  17            		rla
  151A  0F            		rrca
  151B  07            		rlca
  151C  17            		rla
  151D  15            		dec	d
  151E  20F7          		jr	nz,PUT3LP
                      	
  1520                	PUT4:
  1520  4F            		ld	c,a
  1521  3AACFE        		ld	a,(ATTDAT)
  1524  AE            		xor	(hl)
  1525  A1            		and	c
  1526  AE            		xor	(hl)
  1527  77            		ld	(hl),a
  1528  C9            		ret
                      	
                      	
                      	;read data from CGROM
                      	;input: de
                      	;output: d
                      	;destroy: a
  1529                	READCGROM:
  1529  3E04          		ld	a,04h
  152B  D393          		out	(93h),a		;CGROM ON
  152D  1A            		ld	a,(de)
  152E  57            		ld	d,a
  152F  3E05          		ld	a,05h
  1531  D393          		out	(93h),a		;CGROM OFF
  1533  C9            		ret
                      	
                      	
                      	;get space attribute data for scroll
                      	;output: a
                      	;destroy: f
  1534                	GETSPA:
  1534  CD9539        		call	CHKMOD
  1537  3A92FD        		ld	a,(SCREEN1)
  153A  CAF264        		jp	z,GETSPA66
  153D  3D            		dec	a
  153E  FAF915        		jp	m,CNVATT1
  1541  280B          		jr	z,GETSPA2
                      	
  1543                	GETSPAG:
  1543  3D            		dec	a
  1544  3A95FD        		ld	a,(COLOR3)
  1547  2802          		jr	z,GETSPA3
  1549  C650          		add	a,50h
  154B                	GETSPA3:
  154B  C68C          		add	a,8ch		;screen mode 3=8ch, screen mode 4=dch
  154D  C9            		ret
                      	
  154E                	GETSPA2:
  154E  3A94FD        		ld	a,(COLOR2)
  1551  B7            		or	a
  1552  2003          		jr	nz,GETSPA2NZ
  1554  3A93FD        		ld	a,(COLOR1)
                      	
  1557                	GETSPA2NZ:
  1557  FE05          		cp	05h
  1559  3A95FD        		ld	a,(COLOR3)
  155C  3802          		jr	c,GETSPAC
  155E  EE02          		xor	02h
  1560                	GETSPAC:
  1560  C660          		add	a,60h
  1562  C9            		ret
                      	
                      	
                      	;check connection to previous character
                      	;input: hl=VRAM address
                      	;output: z-flag(1:connect)
                      	;destroy: af
  1563                	CHKLINE:
  1563  E5            		push	hl
  1564  CD4911        		call	AD2XY
  1567  CD6C15        		call	CHKLINE2
  156A  E1            		pop	hl
  156B  C9            		ret
                      	
                      	
                      	;check connection to previous character
                      	;input: h=x+1, l=y+1
                      	;output: z-flag(1:connect), a(0 or not)
                      	;destroy: f
  156C                	CHKLINE2:
  156C  7C            		ld	a,h
  156D  3D            		dec	a
  156E  2802          		jr	z,CHKLINE3
  1570  AF            		xor	a
  1571  C9            		ret
                      	
                      	
                      	;check connection to previous line
                      	;input: l=y+1
                      	;output: z-flag(1:connect), a(0 or not)
                      	;destroy: f
  1572                	CHKLINE3:
  1572  E5            		push	hl
  1573  2D            		dec	l
  1574  1801          		jr	CHKLMAIN
                      	
                      	;check connection to next line
                      	;input: l=y+1
                      	;output: z-flag(1:connect), a(0 or not)
                      	;destroy: f
  1576                	CHKLINE4:
  1576  E5            		push	hl
  1577                	CHKLMAIN:
  1577  CDCC3F        		call	CALCLINE
  157A  A6            		and	(hl)
  157B  E1            		pop	hl
  157C  C9            		ret
                      	
                      	
                      	;cut connection before cursor line
                      	;output: hl=line status address
                      	;destroy: af,de
  157D                	CUTLINE:
  157D  3AA8FD        		ld	a,(CSRY)	;a>0
                      	
                      	;input: a=y+1
                      	;output: hl=line status address
                      	;destroy: f,de
  1580                	CUTLINE2:
  1580  6F            		ld	l,a
  1581  2D            		dec	l
                      	;	jp	SETLINE
                      	
                      	;set line connection status (connection to next line)
                      	;input: l=y+1, a=data (0=connect or not)
                      	;output: hl=line status address
                      	;destroy: f,de
  1582                	SETLINE:
  1582  57            		ld	d,a
  1583  CDCC3F        		call	CALCLINE
  1586  14            		inc	d
  1587  15            		dec	d
  1588  2804          		jr	z,SETLINEZ
  158A  B6            		or	(hl)
  158B  77            		ld	(hl),a
  158C  7A            		ld	a,d
  158D  C9            		ret
                      	
  158E                	SETLINEZ:
  158E  2F            		cpl
  158F  A6            		and	(hl)
  1590  77            		ld	(hl),a
  1591  7A            		ld	a,d
  1592  C9            		ret
                      	
                      	
                      	;click sound
                      	;destroy: de
  1593                	CLICK:
  1593  F5            		push	af
  1594  3A2DFA        		ld	a,(CONSOL4)
  1597  B7            		or	a
  1598  2823          		jr	z,SKPCLK
                      	
  159A  C5            		push	bc
                      	
  159B  3E08          		ld	a,08h		;register8=ch.A volume
  159D  1E0F          		ld	e,0fh
  159F  CDBE1B        		call	SOUND2
  15A2  D5            		push	de		;
                      	
  15A3  3E01          		ld	a,01h		;register1=ch.A coarse tune
  15A5  1E00          		ld	e,00h
  15A7  43            		ld	b,e
  15A8  4F            		ld	c,a
  15A9  CDBE1B        		call	SOUND2		;;
                      	
  15AC  CDE825        		call	WAITLP		;bc=0001h
  15AF  3E01          		ld	a,01h		;register1=ch.A coarse tune
  15B1  5A            		ld	e,d		;;
  15B2  CDC51B        		call	SOUND
                      	
  15B5  3E08          		ld	a,08h		;register8=ch.A volume
  15B7  D1            		pop	de		;
  15B8  5A            		ld	e,d
  15B9  CDC51B        		call	SOUND
                      	
  15BC  C1            		pop	bc
                      	
  15BD                	SKPCLK:
  15BD  F1            		pop	af
  15BE  C9            		ret
                      	
                      	
                      	;set attribute data
                      	;input: a=color code
                      	;output: a,(ATTDAT)=attribute
                      	;destroy: f
  15BF                	_SETATT:ds	SETATT-_SETATT
  15C0                		org	SETATT
                      	
  15C0  F5            		push	af
  15C1  CD9539        		call	CHKMOD
  15C4  CA2C65        		jp	z,SETATT66
  15C7                	SETATT661:
  15C7  F1            		pop	af
  15C8  CDCF15        		call	CNVATT
  15CB  32ACFE        		ld	(ATTDAT),a
  15CE  C9            		ret
                      	
                      	
                      	;convert to attribute data (screen mode 1)
                      	; or color code (screen moode 2)
                      	; or bit pattern (screen mode 3,4)
                      	;input: a=color code
                      	;output: a=attribute
                      	;destroy: f
  15CF                	CNVATT:
  15CF  F5            		push	af		;color
  15D0  3A92FD        		ld	a,(SCREEN1)
  15D3  3D            		dec	a
  15D4  281C          		jr	z,ATT2
  15D6  FAFD15        		jp	m,ATT1
  15D9  3D            		dec	a
  15DA  2806          		jr	z,ATT3
                      	
  15DC                	ATT4:
  15DC  F1            		pop	af
  15DD  B7            		or	a
  15DE  C8            		ret	z
  15DF  3EFF          		ld	a,0ffh
  15E1  C9            		ret
                      	
  15E2                	ATT3:
  15E2  F1            		pop	af
  15E3  B7            		or	a
  15E4  C8            		ret	z
                      	
  15E5  C5            		push	bc
                      	;	ld	b,04h
                      	;	cp	b
                      	;	jr	c,ATT3C
                      	;	ld	a,b
                      	;ATT3C:
                      	;	dec	a
                      	;	ld	c,a
                      	;	dec	b		;=3
  15E6  0603          		ld	b,03h
  15E8  3D            		dec	a
  15E9  A0            		and	b
  15EA  4F            		ld	c,a
  15EB                	ATT3LP:
  15EB  0F            		rrca
  15EC  0F            		rrca
  15ED  B1            		or	c
  15EE  10FB          		djnz	ATT3LP
  15F0  C1            		pop	bc
  15F1  C9            		ret
                      	
  15F2                	ATT2:
  15F2  F1            		pop	af
  15F3  FE09          		cp	09h
  15F5  D8            		ret	c
  15F6  3E08          		ld	a,08h
  15F8  C9            		ret
                      	
                      	
                      	;get attribue data for screen mode 1
                      	;output: a=attirbute value
                      	;destroy: f
  15F9                	CNVATT1:
  15F9  3A93FD        		ld	a,(COLOR1)
  15FC  F5            		push	af
  15FD                	ATT1:
  15FD  CD9539        		call	CHKMOD
  1600  CA1665        		jp	z,ATT66
  1603  F1            		pop	af
  1604  B7            		or	a
  1605  2803          		jr	z,ATT1OK
  1607  3D            		dec	a
                      	;	cp	04h
                      	;	jr	c,ATT1OK
                      	;	ld	a,03h
  1608  E603          		and	03h
  160A                	ATT1OK:
  160A  C620          		add	a,20h
  160C  E5            		push	hl
  160D  2195FD        		ld	hl,COLOR3
  1610  AE            		xor	(hl)
  1611  E1            		pop	hl
  1612  C9            		ret
                      	
                      	
                      	;get space character data for scroll
                      	;output: a
                      	;destroy: f
  1613                	GETSP:
  1613  CD9539        		call	CHKMOD
  1616  3A92FD        		ld	a,(SCREEN1)
  1619  CAD364        		jp	z,GETSP66
  161C  3D            		dec	a
  161D  3E20          		ld	a,' '
  161F  F8            		ret	m		;screen mode 1
  1620  3A94FD        		ld	a,(COLOR2)
  1623  20AA          		jr	nz,CNVATT	;screen mode 3,4
                      	
                      	;screen mode 2
  1625                	GETSP2:
  1625  B7            		or	a
  1626  2806          		jr	z,GETSP2Z	;color,0
  1628  3D            		dec	a
  1629  0F            		rrca
  162A  0F            		rrca
  162B  F63F          		or	3fh
  162D  C9            		ret
                      	
  162E                	GETSP2Z:
  162E  3A93FD        		ld	a,(COLOR1)
  1631  B7            		or	a
  1632  C8            		ret	z
  1633  3D            		dec	a
  1634  FE04          		cp	04h
  1636  3802          		jr	c,GETSP2ZC
  1638  D604          		sub	04h
  163A                	GETSP2ZC:
  163A  0F            		rrca
  163B  0F            		rrca
  163C  C9            		ret
                      	
                      	
                      	;clear screen using console parameter
                      	;destroy: af,bc,de,hl
  163D                	CLSMAIN2:
  163D  2AA2FD        		ld	hl,(CONSOL1)	;l=(CONSOL1)
  1640  3AA5FD        		ld	a,(LASTLIN)
  1643  95            		sub	l
  1644  3C            		inc	a
                      	
                      	;clear from first line to last line
                      	;input: l=first line+1, a=last line-first line+1
                      	;destroy: af,bc,de,hl
  1645                	CLSMAIN:
  1645  47            		ld	b,a
  1646  4D            		ld	c,l
  1647  CDB811        		call	Y2AD
  164A                	CLSLP:
  164A  CDDA11        		call	DELLIN
  164D  212000        		ld	hl,COLUMNS
  1650  CB52          		bit	2,d
  1652  2802          		jr	z,CLS60
  1654  2E28          		ld	l,CLMN66	;h=0
  1656                	CLS60:
  1656  19            		add	hl,de
  1657  E5            		push	hl		;
  1658  69            		ld	l,c
  1659  79            		ld	a,c		;>0
  165A  CD8215        		call	SETLINE
  165D  0C            		inc	c
  165E  D1            		pop	de		;
  165F  10E9          		djnz	CLSLP
                      	
  1661  CD6511        		call	CTLHOM		;h<-1
  1664  25            		dec	h
  1665  6C            		ld	l,h		;hl=0000h
  1666  22AEFD        		ld	(GRPX1),hl
  1669  22B0FD        		ld	(GRPY1),hl
                      	
  166C  C3AE12        		jp	PRTFKEY
                      	
                      	
                      	;cold start (initialize hardware)
  166F                	COLD:
                      	
                      	;8255 (port 93h)
  166F  019306        		ld	bc,0693h
  1672  78            		ld	a,b
  1673  21E100        		ld	hl,IOTBL93
  1676  EDB3          		otir
                      	
                      	;port c1h
                      	;	ld	a,06h
  1678  D3C1          		out	(0c1h),a	;32x16 text mode
                      	
                      	;8251 (port 81h)
  167A  018105        		ld	bc,0581h
                      	;	ld	hl,IOTBL81
  167D  EDB3          		otir
                      	
                      	;port f0h-f8h
  167F  01EF09        		ld	bc,09efh
                      	;	ld	hl,IOTBLF0
  1682                	F0LP:
  1682  0C            		inc	c
  1683  EDA3          		outi
  1685  20FB          		jr	nz,F0LP
                      	
                      	;interrupt
                      	;	ld	hl,INTTBL
  1687  1102FA        		ld	de,0fa02h
  168A  0E21          		ld	c,HEIGHT-0fa00h+1	;b=0
                      	
  168C  EDB0          		ldir
  168E  7A            		ld	a,d
  168F  ED47          		ld	i,a
  1691  ED5E          		im	2
                      	
                      	;clear work area
                      	
  1693                	COLDLP1:
  1693  AF            		xor	a
  1694  12            		ld	(de),a
  1695  13            		inc	de
  1696  7A            		ld	a,d
  1697  B3            		or	e
  1698  20F9          		jr	nz,COLDLP1
                      	
                      	;stack pointer
  169A  2100E7        		ld	hl,0e700h
  169D  F9            		ld	sp,hl		;temporary
                      	
                      	;relay,VRAM,timer
  169E  3C            		inc	a		;a=1
  169F  322DFA        		ld	(CONSOL4),a
                      	
                      	;hook
  16A2  218AFF        		ld	hl,HOOK
  16A5  061E          		ld	b,1eh
  16A7  1E03          		ld	e,03h		;d=0
  16A9                	COLDLP2:
  16A9  36C9          		ld	(hl),0c9h
  16AB  19            		add	hl,de
  16AC  10FB          		djnz	COLDLP2
                      	
                      	;buffer
  16AE  21B9FB        		ld	hl,KEYBUF
  16B1  1E40          		ld	e,40h		;d=0
  16B3  2293FB        		ld	(KYBFAD),hl
  16B6  19            		add	hl,de		;hl=RSBUF
  16B7  2299FB        		ld	(RSBFAD),hl
  16BA  19            		add	hl,de		;hl=BUFA
  16BB  22A5FB        		ld	(BUFAAD),hl
  16BE  19            		add	hl,de		;hl=BUFB
  16BF  22ABFB        		ld	(BUFAAD+6),hl
  16C2  19            		add	hl,de		;hl=BUFC
  16C3  22B1FB        		ld	(BUFAAD+12),hl
                      	
  16C6  2192FB        		ld	hl,KYBFSZ
  16C9  1E06          		ld	e,06h		;d=0
  16CB  43            		ld	b,e		;e=6
  16CC                	COLDLP3:
  16CC  363F          		ld	(hl),3fh	;KYBFSZ,RSBFSZ,,BUFASZ,BUFBSZ,BUFCSZ
  16CE  19            		add	hl,de
  16CF  10FB          		djnz	COLDLP3
                      	
                      	;command/function jump table
  16D1  2161FA        		ld	hl,CMDTBL
  16D4  0668          		ld	b,0+(FILES-CMDTBL)/2
  16D6                	COLDLP4:
  16D6  36E4          		ld	(hl),SNERR-SNERR/100h*100h
  16D8  23            		inc	hl
  16D9  3603          		ld	(hl),SNERR/100h
  16DB  23            		inc	hl
  16DC  10F8          		djnz	COLDLP4
                      	
                      	;command jump table
  16DE  219A01        		ld	hl,CMDLST
  16E1  1161FA        		ld	de,CMDTBL
  16E4  0E56          		ld	c,2*(CMDLAST-80h+1)	;b=0
  16E6  EDB0          		ldir
                      	
                      	;function jump table
                      	;	ld	hl,FNCLST
  16E8  11E5FA        		ld	de,FNCTBL
  16EB  0E3C          		ld	c,2*(FNCLAST-FNC1ST+1)	;b=0
  16ED  EDB0          		ldir
                      	
                      	;screen
  16EF  1191FD        		ld	de,VRAM		;top of active page data
  16F2  3E05          		ld	a,05h
  16F4  32C7FE        		ld	(FKEYLEN),a
  16F7                	COLDLP5:
  16F7  214301        		ld	hl,PAGEDATA
  16FA  0E28          		ld	c,PAGE1-VRAM	;b=0
  16FC  EDB0          		ldir
  16FE  3D            		dec	a
  16FF  20F6          		jr	nz,COLDLP5
                      	
                      	;	ld	de,PAGE4+(PAGE4-PAGE3)
  1701  EB            		ex	de,hl
  1702  11D8FF        		ld	de,0-(PAGE4-PAGE3)
  1705  3EA0          		ld	a,0a0h
  1707                	COLDLP6:
  1707  19            		add	hl,de
  1708  77            		ld	(hl),a		;(PAGE4)=a0h, (PAGE3)=c0h, (PAGE2)=e0h
  1709  C620          		add	a,20h
  170B  20FA          		jr	nz,COLDLP6
                      	
                      	;display
                      	;	xor	a
  170D  CD0C14        		call	CHGACT
  1710  CDED13        		call	CHGDSP
  1713  CDFB1D        		call	CLS
                      	
                      	;RND()
                      	;	call	SETZERO
  1716  CDB53B        		call	RNDMNS
                      	
                      	;PLAY
  1719  CDB31B        		call	PLSTOP		;ei
                      	
                      	;initilize using 4000h-
                      	;	call	COLD2
                      	
                      	;port f0h
  171C  3E11          		ld	a,11h
  171E  3264FE        		ld	(PORTF0H),a
                      	
                      	;for mode select
  1721  3EFF          		ld	a,0ffh
  1723  324EFF        		ld	(PROGAD),a	;invalid value, not set yet
                      	
                      	;RAM access subroutine
  1726  210040        		ld	hl,READRAM_SRC
  1729  118DFE        		ld	de,READRAM
  172C  011F00        		ld	bc,RAMEND-READRAM_SRC
  172F  EDB0          		ldir
                      	
                      	;RAM size and stack work
  1731  0608          		ld	b,08h
  1733  CDE825        		call	WAITLP
  1736  CDBC0F        		call	GETCH
  1739  2100C4        		ld	hl,0c400h
  173C  0602          		ld	b,02h
  173E  280E          		jr	z,COLD16K
  1740  3D            		dec	a
                      	;	or	02h
  1741  B0            		or	b
  1742  D633          		sub	'4'-1
  1744  2008          		jr	nz,COLD16K
  1746  3C            		inc	a
  1747  3265FE        		ld	(MODE),a	;a=1 (mode=2)
  174A  2684          		ld	h,84h
  174C  0604          		ld	b,04h
  174E                	COLD16K:
  174E  2229FF        		ld	(BASICAD),hl
  1751  2C            		inc	l
  1752  225FFA        		ld	(STARTAD),hl
  1755  2D            		dec	l
  1756  78            		ld	a,b
  1757  328CFD        		ld	(PAGES),a
  175A  26F9          		ld	h,0f9h
  175C  225BFA        		ld	(STACK),hl
                      	
  175F  3E71          		ld	a,71h		;0000-3fff:BASIC ROM, 4000-7fff:external ROM
  1761  D3F0          		out	(0f0h),a
                      	
  1763  C33B00        		jp	HOT
                      	
                      	
                      	;analyze an argument
                      	;input: hl=program address
                      	;output: hl=next address, FAC1=numerical value or pointer to string descriptor
                      	;	(ARGTYP)=0(numeric), 1(string), other(cannot analyze)
                      	;destroy: FAC2,af,bc,de,hl
  1766                	ARG:
  1766  E5            		push	hl
  1767  CD070C        		call	SETZERO		;for first +-
  176A  E1            		pop	hl
  176B  AF            		xor	a
  176C  5F            		ld	e,a
  176D  D5            		push	de		;e=dummy operator
  176E  3D            		dec	a
  176F  3225FF        		ld	(ARGTYP),a	;ff=unknown
  1772  3265FF        		ld	(OPRTR),a
  1775                	ARGLP:
  1775  E5            		push	hl
  1776  CDEA34        		call	CHKFRE
  1779  E1            		pop	hl
  177A                	ARGLP2:
  177A  7E            		ld	a,(hl)
  177B  47            		ld	b,a		;
  177C  23            		inc	hl
  177D  224EFF        		ld	(PROGAD),hl
                      	;command, function, operator
  1780  B7            		or	a
  1781  FA6618        		jp	m,ARGCMD
                      	;space
  1784  FE20          		cp	' '
  1786  28F2          		jr	z,ARGLP2
                      	
                      	;previous argument without operator?
  1788  3A65FF        		ld	a,(OPRTR)
  178B  B7            		or	a
  178C  281F          		jr	z,ARGTAIL
                      	;[A-Z]
  178E  78            		ld	a,b		;
  178F  D641          		sub	'A'
  1791  FE1A          		cp	'Z'-'A'+1
  1793  384C          		jr	c,ARGVAR
                      	;[0-9&.]
  1795  D6EF          		sub	'0'-'A'
  1797  FE0A          		cp	'9'-'0'+1
  1799  78            		ld	a,b		;
  179A  382F          		jr	c,ARGNUM
  179C  FE26          		cp	'&'
  179E  282B          		jr	z,ARGNUM
  17A0  FE2E          		cp	'.'
  17A2  2827          		jr	z,ARGNUM
                      	;others
  17A4  FE22          		cp	22h		;double quotation mark
  17A6  CA3518        		jp	z,ARGSTR
  17A9  FE28          		cp	'('
  17AB  2808          		jr	z,PARL
  17AD                	ARGTAIL:
  17AD  2B            		dec	hl
  17AE  224EFF        		ld	(PROGAD),hl
  17B1  AF            		xor	a
  17B2  C3E818        		jp	OPR
                      	
  17B5                	PARL:
  17B5  CD613F        		call	CHKCLN
  17B8  CA1A04        		jp	z,MOERR
  17BB  CD6617        		call	ARG
  17BE  3A25FF        		ld	a,(ARGTYP)
  17C1  FE02          		cp	02h
  17C3  D2E403        		jp	nc,SNERR
  17C6  CDA10B        		call	CHKRPAR
  17C9  18AA          		jr	ARGLP
                      	
  17CB                	ARGNUM:
  17CB  CDD917        		call	ARGNCHK
  17CE  2B            		dec	hl
  17CF  3EFF          		ld	a,0ffh
  17D1  CD9B39        		call	ATOF
  17D4  224EFF        		ld	(PROGAD),hl
  17D7  189C          		jr	ARGLP
                      	
                      	;destroy: af,bc
  17D9                	ARGNCHK:
  17D9  AF            		xor	a
  17DA  3265FF        		ld	(OPRTR),a
  17DD  3225FF        		ld	(ARGTYP),a
  17E0  C9            		ret
                      	
  17E1                	ARGVAR:
  17E1  E5            		push	hl		;program address
  17E2  CD9233        		call	GETNAME
  17E5  3A25FF        		ld	a,(ARGTYP)
  17E8  57            		ld	d,a
  17E9  3A65FF        		ld	a,(OPRTR)
  17EC  5F            		ld	e,a
  17ED  D5            		push	de		;;
  17EE  EB            		ex	de,hl
  17EF  CD1F39        		call	PUSHF1
  17F2  EB            		ex	de,hl
                      	
  17F3  C5            		push	bc		;variable name
  17F4  7E            		ld	a,(hl)
  17F5  FE28          		cp	'('
  17F7  280D          		jr	z,ARGVARR
  17F9  224EFF        		ld	(PROGAD),hl
  17FC  CDB633        		call	SRCHVAR
  17FF  3008          		jr	nc,ARGVNC
  1801  11AB0E        		ld	de,ZERO
  1804  1803          		jr	ARGVNC
  1806                	ARGVARR:
  1806  CDAE32        		call	GETARR
  1809                	ARGVNC:
  1809  C1            		pop	bc		;variable name
  180A  CD3D39        		call	POPF1
  180D  E1            		pop	hl		;;
  180E  7C            		ld	a,h
  180F  3225FF        		ld	(ARGTYP),a
  1812  7D            		ld	a,l
  1813  3265FF        		ld	(OPRTR),a
  1816  E1            		pop	hl		;program address
  1817  CB79          		bit	7,c
  1819  2011          		jr	nz,ARGVSTR
  181B                	ARGVNUM:
  181B  CDD917        		call	ARGNCHK
  181E  EB            		ex	de,hl
  181F  1166FF        		ld	de,FAC1
  1822  EDA0          		ldi
  1824                	ARGVLDIR:
  1824  010400        		ld	bc,0004h
  1827  EDB0          		ldir
  1829  C33619        		jp	ARGNEXT2
                      	
                      	
                      	;string variable
  182C                	ARGVSTR:
  182C  CD5618        		call	ARGSCHK
  182F  EB            		ex	de,hl
  1830  112DFF        		ld	de,STRDSC1
  1833  18EF          		jr	ARGVLDIR
                      	
  1835                	ARGSTR:
  1835  CD5618        		call	ARGSCHK
  1838  222FFF        		ld	(STRDSC1+2),hl
  183B  1E00          		ld	e,00h
  183D                	ARGSLP:
  183D  7E            		ld	a,(hl)
  183E  B7            		or	a
  183F  280B          		jr	z,ARGSOK
  1841  23            		inc	hl
  1842  FE22          		cp	22h		;double quotation mark
  1844  2806          		jr	z,ARGSOK
  1846  1C            		inc	e
  1847  CA0B04        		jp	z,LSERR
  184A  18F1          		jr	ARGSLP
  184C                	ARGSOK:
  184C  ED532DFF      		ld	(STRDSC1),de
  1850  224EFF        		ld	(PROGAD),hl
  1853  C37517        		jp	ARGLP
                      	
                      	;destroy: af,bc
  1856                	ARGSCHK:
  1856  AF            		xor	a
  1857  3265FF        		ld	(OPRTR),a	;a=0
  185A  3C            		inc	a
  185B  3225FF        		ld	(ARGTYP),a	;a=1
  185E  012DFF        		ld	bc,STRDSC1
  1861  ED4367FF      		ld	(FAC1+1),bc
  1865  C9            		ret
                      	
  1866                	ARGCMD:
  1866  CD9539        		call	CHKMOD
  1869  78            		ld	a,b		;
  186A  2805          		jr	z,ARGCMD66
  186C  FEF2          		cp	FNCLAST+1	;0f2h
  186E  D2E403        		jp	nc,SNERR
  1871                	ARGCMD66:
  1871  FEFA          		cp	FLAST66+1	;0fah
  1873  D2E403        		jp	nc,SNERR
  1876  D6CA          		sub	PLUS		;0cah
  1878  FE0A          		cp	FNC1ST-PLUS
  187A  78            		ld	a,b		;
  187B  386B          		jr	c,OPR		;0cah-0d3h
                      	
  187D  3A65FF        		ld	a,(OPRTR)
  1880  B7            		or	a
  1881  CAAD17        		jp	z,ARGTAIL
                      	
  1884  78            		ld	a,b		;
  1885  FEC8          		cp	NOT_		;0c8h
  1887  285F          		jr	z,OPR
  1889  FE9F          		cp	SCREEN		;9fh
  188B  280D          		jr	z,FNC
  188D  FEC4          		cp	FN		;0c4h
  188F  2809          		jr	z,FNC
  1891  FEC6          		cp	INKEY		;0c6h
  1893  2805          		jr	z,FNC
  1895  FECA          		cp	PLUS		;0cah
  1897  DAAD17        		jp	c,ARGTAIL
                      	
                      	;	jr	FNC
                      	
                      	;function
  189A                	FNC:
  189A  AF            		xor	a
  189B  3225FF        		ld	(ARGTYP),a
  189E  78            		ld	a,b		;
  189F  FEC6          		cp	INKEY
  18A1  CA9E27        		jp	z,F_INKY
  18A4  FEC4          		cp	FN
  18A6  CAC93E        		jp	z,F_FN
  18A9  FE9F          		cp	SCREEN
  18AB  CAAC3E        		jp	z,F_SCRN
                      	
  18AE  CDC418        		call	CALLFNC
  18B1                	FNCRTN:
  18B1  2A4EFF        		ld	hl,(PROGAD)
  18B4                	CLRSTRD:
  18B4  3A25FF        		ld	a,(ARGTYP)
  18B7  B7            		or	a
  18B8  2003          		jr	nz,CLRSTRDNZ
  18BA  322DFF        		ld	(STRDSC1),a	;=0
  18BD                	CLRSTRDNZ:
  18BD  AF            		xor	a
  18BE  3265FF        		ld	(OPRTR),a
  18C1  C37517        		jp	ARGLP
                      	
  18C4                	CALLFNC:
  18C4  FEEA          		cp	LEFT_
  18C6  300B          		jr	nc,SKIPARG
                      	
                      	;SGN()...CHR$()
  18C8  F5            		push	af
  18C9  CD920B        		call	CHKLPAR
  18CC  CD6617        		call	ARG
  18CF  CDA10B        		call	CHKRPAR
  18D2  F1            		pop	af
                      	
  18D3                	SKIPARG:
  18D3  113DFA        		ld	de,FNCTBL-(FNC1ST-80h)*2
  18D6  FED7          		cp	USR
  18D8  C24B3F        		jp	nz,JPTBL
                      	
                      	;USR() function
  18DB  E5            		push	hl		;program address
  18DC  CD4B3F        		call	JPTBL
  18DF  CD780B        		call	CHKNUM
  18E2  AF            		xor	a
  18E3  322DFF        		ld	(STRDSC1),a
  18E6  F1            		pop	af		;cancel program address
  18E7  C9            		ret
                      	
                      	
                      	;operator
  18E8                	OPR:
  18E8  FED3          		cp	LT_		;0d3h
  18EA  2001          		jr	nz,OPRNZ
  18EC  3C            		inc	a		;0d3h -> 0d4h
  18ED                	OPRNZ:
  18ED  57            		ld	d,a		;operator
  18EE  3A65FF        		ld	a,(OPRTR)
  18F1  3C            		inc	a
  18F2  FE02          		cp	02h
  18F4  D29019        		jp	nc,OPROPR	;not 00 nor ff
  18F7  3A25FF        		ld	a,(ARGTYP)
  18FA  3C            		inc	a
  18FB  7A            		ld	a,d		;operator
  18FC  2010          		jr	nz,NOTHEAD
                      	;first +, for numeric and string
  18FE  FECA          		cp	PLUS
  1900  2834          		jr	z,ARGNEXT2
  1902  FECB          		cp	MINUS
  1904  2808          		jr	z,NOTHEAD
  1906  FEC8          		cp	NOT_
  1908  2804          		jr	z,NOTHEAD
  190A  B7            		or	a
  190B  C2E403        		jp	nz,SNERR
  190E                	NOTHEAD:
  190E  CDC819        		call	GETPRIO
  1911  5F            		ld	e,a
  1912  C1            		pop	bc		;c=previous operator
  1913  C5            		push	bc
  1914  79            		ld	a,c
  1915  B7            		or	a
  1916  2870          		jr	z,ARGHEAD
                      	
  1918  CDC819        		call	GETPRIO
  191B  BB            		cp	e
  191C  301E          		jr	nc,CALLOP
  191E  7A            		ld	a,d		;operator
  191F                	ARGNEXT:
  191F  3265FF        		ld	(OPRTR),a
  1922  3A25FF        		ld	a,(ARGTYP)
  1925  3D            		dec	a
  1926  2805          		jr	z,ARGNEXTS
  1928  CD1F39        		call	PUSHF1
  192B  1809          		jr	ARGNEXT2
  192D                	ARGNEXTS:
  192D  CDE419        		call	COPYSTR
  1930  2A65FF        		ld	hl,(FAC1-1)	;h=length, l=operator
  1933  CBB5          		res	6,l
  1935  E5            		push	hl
  1936                	ARGNEXT2:
  1936  2A4EFF        		ld	hl,(PROGAD)
  1939  C37517        		jp	ARGLP
                      	
                      	
  193C                	CALLOP:
  193C  D5            		push	de		;;d=following operator
  193D  C5            		push	bc		;c=previous operator
  193E  3A25FF        		ld	a,(ARGTYP)
  1941  3D            		dec	a
  1942  2829          		jr	z,CALLOPS
                      	
                      	;numeric
  1944  CD5B39        		call	CPYFAC
  1947  C1            		pop	bc		;
  1948  D1            		pop	de		;;
  1949  CD3D39        		call	POPF1
                      	
  194C                	CALLOPEND:
  194C  CB71          		bit	6,c
  194E  2007          		jr	nz,TYPNUM
  1950  CBF1          		set	6,c
  1952  2125FF        		ld	hl,ARGTYP
  1955  CBCE          		set	1,(hl)
  1957                	TYPNUM:
  1957  D5            		push	de		;;
  1958  79            		ld	a,c
  1959  FED2          		cp	GT_+1
  195B  3802          		jr	c,CALLOPOK
                      	;>,=,<
  195D  3ED1          		ld	a,GT_
                      	
  195F                	CALLOPOK:
  195F  11F600        		ld	de,OPRTBL-(0c8h-80h)*2
  1962  CD4B3F        		call	JPTBL
  1965  AF            		xor	a
  1966  3265FF        		ld	(OPRTR),a
  1969  F1            		pop	af		;;
  196A  C3E818        		jp	OPR
                      	
                      	;string
  196D                	CALLOPS:
  196D  ED4B2DFF      		ld	bc,(STRDSC1)
  1971  ED5B2FFF      		ld	de,(STRDSC1+2)
  1975  CDF819        		call	BACKSTR
  1978  ED4339FF      		ld	(STRDSC4),bc
  197C  ED533BFF      		ld	(STRDSC4+2),de
  1980  C1            		pop	bc
  1981  D1            		pop	de
  1982  E1            		pop	hl
  1983  2265FF        		ld	(FAC1-1),hl
  1986  18C4          		jr	CALLOPEND
                      	
  1988                	ARGHEAD:
  1988  82            		add	a,d		;d=0?
  1989  2094          		jr	nz,ARGNEXT
  198B  E1            		pop	hl		;cancel dummy operator
  198C  2A4EFF        		ld	hl,(PROGAD)
  198F  C9            		ret
                      	
                      	;operator and operator
  1990                	OPROPR:
  1990  7A            		ld	a,d		;operator
  1991  FEC8          		cp	NOT_		;0c8h
  1993  288A          		jr	z,ARGNEXT
  1995  FECA          		cp	PLUS		;0cah
  1997  2824          		jr	z,OPRPLS
  1999  21A60E        		ld	hl,MNSONE
  199C  FECB          		cp	MINUS		;0cbh
  199E  2820          		jr	z,OPRMNS
  19A0  FED1          		cp	GT_		;0d1h
  19A2  DAE403        		jp	c,SNERR
                      	
                      	;>,=,<
                      	;bit0: >
                      	;bit1: =
                      	;bit2: <
  19A5  2165FF        		ld	hl,OPRTR
  19A8  7E            		ld	a,(hl)
  19A9  FED1          		cp	GT_
  19AB  DAE403        		jp	c,SNERR
  19AE  B2            		or	d
  19AF  BE            		cp	(hl)
  19B0  CAE403        		jp	z,SNERR
  19B3  77            		ld	(hl),a
                      	
                      	;copy numeric/string bit
  19B4  E607          		and	07h		;<=> bits
  19B6  C1            		pop	bc		;c=previous operator
  19B7  B1            		or	c
  19B8  4F            		ld	c,a
  19B9  C5            		push	bc
  19BA  C33619        		jp	ARGNEXT2
                      	
                      	;+
  19BD                	OPRPLS:
  19BD  21A10E        		ld	hl,PLSONE
                      	;-
  19C0                	OPRMNS:
  19C0  CD0A0C        		call	SETF1
  19C3  3ECC          		ld	a,ASTRSK	;0cch
  19C5  C31F19        		jp	ARGNEXT
                      	
                      	
                      	;input: a=operator
                      	;output: a=priority
                      	;destroy: f,hl
  19C8                	GETPRIO:
  19C8  B7            		or	a
  19C9  C8            		ret	z
  19CA  21E319        		ld	hl,PRIO+GT_-NOT_
  19CD  F640          		or	40h		;numeric/string bit
  19CF  D6D1          		sub	GT_		;0d1h
  19D1  3005          		jr	nc,PRIONC	;>,=,<
  19D3  85            		add	a,l
  19D4  6F            		ld	l,a
  19D5  3801          		jr	c,PRIONC
  19D7  25            		dec	h
  19D8                	PRIONC:
  19D8  7E            		ld	a,(hl)
  19D9  C9            		ret
                      	
  19DA                	PRIO:
                      	;operator priority table
                      	;		not   +  -  *  /  ^ and or >=<
  19DA  03000505060607		db	3, 0, 5, 5, 6, 6, 7, 2, 1, 4
                      	
                      	
                      	;check string descriptor and copy
                      	;destroy: af,bc,de,hl
  19E4                	COPYSTR:
  19E4  2139FF        		ld	hl,STRDSC4
  19E7  7E            		ld	a,(hl)
  19E8  B7            		or	a
  19E9  C20E04        		jp	nz,STERR
  19EC  2B            		dec	hl		;STRDSC3+3
  19ED  113CFF        		ld	de,STRDSC4+3
  19F0  010C00        		ld	bc,000ch
  19F3  EDB8          		lddr			;STRDSC3->STRDSC4, STRDSC2->STRDSC3, STRDSC1->STRDSC2
                      	;	xor	a
  19F5  23            		inc	hl
  19F6  77            		ld	(hl),a		;(STRDSC1)=0
  19F7  C9            		ret
                      	
                      	
                      	;copy back string descriptor
                      	;destroy: af,hl
  19F8                	BACKSTR:
  19F8  D5            		push	de
  19F9  C5            		push	bc
  19FA  2131FF        		ld	hl,STRDSC2
  19FD  112DFF        		ld	de,STRDSC1
  1A00  010C00        		ld	bc,000ch
  1A03  EDB0          		ldir			;STRDSC2->STRDSC1, STRDSC3->STRDSC2, STRDSC4->STRDSC3
  1A05  AF            		xor	a
  1A06  12            		ld	(de),a		;(STRDSC4)=0
  1A07  C1            		pop	bc
  1A08  D1            		pop	de
  1A09  C9            		ret
                      	
                      	
                      	;send graphic data to PC-6021
                      	;input: c
                      	;destroy: af,b
  1A0A                	SENDGRP:
  1A0A  0608          		ld	b,08h
  1A0C                	SENDGLP:
  1A0C  CB01          		rlc	c
  1A0E  1F            		rra
  1A0F  10FB          		djnz	SENDGLP
  1A11  1824          		jr	PRINTER
                      	
                      	
                      	;put a character to printer
                      	;input: a
                      	;destroy: none
  1A13                	_PUTPRT:ds	PUTPRT-_PUTPRT
  1A1C                		org	PUTPRT
                      	
  1A1C  F5            		push	af
  1A1D  3A31FA        		ld	a,(GRPFLG)
  1A20  B7            		or	a
  1A21  2806          		jr	z,NOTGRP
  1A23  AF            		xor	a
  1A24                	SETGRP:
  1A24  3231FA        		ld	(GRPFLG),a
  1A27  F1            		pop	af
  1A28  C9            		ret
                      	
  1A29                	NOTGRP:
  1A29  F1            		pop	af
  1A2A  F5            		push	af
  1A2B  FE14          		cp	14h
  1A2D  28F5          		jr	z,SETGRP
  1A2F  CD4F1A        		call	CNVKANA
  1A32  CD371A        		call	PRINTER
  1A35  F1            		pop	af
  1A36  C9            		ret
                      	
                      	
                      	;input: a
                      	;destroy: af
  1A37                	PRINTER:
  1A37  F5            		push	af
  1A38                	PRINTERLP:
  1A38  DBC0          		in	a,(0c0h)
  1A3A  E602          		and	02h
  1A3C  2005          		jr	nz,PRINTERZ	;ready
  1A3E  CD4D27        		call	STOPESC
  1A41  18F5          		jr	PRINTERLP
                      	
  1A43                	PRINTERZ:
  1A43  F1            		pop	af
  1A44  2F            		cpl
  1A45  D391          		out	(91h),a
  1A47  3E01          		ld	a,01h
  1A49  D393          		out	(93h),a		;strobe (>1us)
  1A4B  AF            		xor	a
  1A4C  D393          		out	(93h),a
  1A4E  C9            		ret
                      	
                      	
                      	;convert hiragana -> katakana
                      	;input: a
                      	;output: a
                      	;destroy: f
  1A4F                	_CNVKANA:ds	CNVKANA-_CNVKANA
  1A4F                		org	CNVKANA
                      	
  1A4F  FE86          		cp	86h
  1A51  D8            		ret	c
  1A52  FEA0          		cp	0a0h
  1A54  3803          		jr	c,HIRAGANA
  1A56  FEE0          		cp	0e0h
  1A58  D8            		ret	c
  1A59                	HIRAGANA:
  1A59  EE20          		xor	20h
  1A5B  C9            		ret
                      	
                      	
                      	;CMT open for verify
                      	;destroy: a
  1A5C                	VRFOPN:
  1A5C  3EFF          		ld	a,0ffh
  1A5E  32D8FE        		ld	(VERIFY),a
                      	;	jr	ROPEN
                      	
                      	
                      	;open for tape read
                      	;destroy: none
  1A61                	_ROPEN:ds	ROPEN-_ROPEN
  1A61                		org	ROPEN
                      	
  1A61  F5            		push	af
  1A62  C5            		push	bc
  1A63  061E          		ld	b,1eh
  1A65  CD121B        		call	OPENCMT
  1A68  CD4B1B        		call	RLON
  1A6B  C1            		pop	bc
  1A6C  F1            		pop	af
  1A6D  C9            		ret
                      	
                      	
                      	;get 1 character from CMT
                      	;output: a=data, z(0=error, 1=no error)
                      	;destroy: f
  1A6E                	_GETCMT:ds	GETCMT-_GETCMT
  1A70                		org	GETCMT
                      	
  1A70  3A18FA        		ld	a,(STOPFLG)
  1A73  FE03          		cp	03h
  1A75  2812          		jr	z,CMTSTP
  1A77  3A19FA        		ld	a,(CMTSTAT)
  1A7A  CB67          		bit	4,a
  1A7C  C0            		ret	nz		;read error, z-flag=0
  1A7D  E602          		and	02h
  1A7F  28EF          		jr	z,GETCMT
  1A81  AF            		xor	a		;set z-flag
  1A82  3219FA        		ld	(CMTSTAT),a
  1A85  3A1DFA        		ld	a,(CMTBUF)
  1A88  C9            		ret
                      	
  1A89                	CMTSTP:
  1A89  CD991A        		call	CHKVRF
  1A8C  C35127        		jp	STOPSP
                      	
                      	
                      	;call GETCMT, if z=0 then ?TR Error
  1A8F                	GETCMTTR:
  1A8F  CD701A        		call	GETCMT
  1A92  C8            		ret	z
  1A93  CD991A        		call	CHKVRF
  1A96  C31704        		jp	TRERR
                      	
                      	
                      	;check verify or not
  1A99                	CHKVRF:
  1A99  CDAA1A        		call	RCLOSE
  1A9C                	CHKVRF2:
  1A9C  3AD8FE        		ld	a,(VERIFY)
  1A9F  B7            		or	a
  1AA0  CCDC34        		call	z,NEW
  1AA3  C9            		ret
                      	
                      	
                      	;close for tape read
                      	;destroy: none
  1AA4                	_RCLOSE:ds	RCLOSE-_RCLOSE
  1AAA                		org	RCLOSE
                      	
  1AAA  F5            		push	af
  1AAB  C5            		push	bc
  1AAC  3E1A          		ld	a,1ah
  1AAE                	CLOSEEND:
  1AAE  CD8F0E        		call	OUT90H
  1AB1  CD491B        		call	RLOFF
  1AB4  C1            		pop	bc
  1AB5  F1            		pop	af
  1AB6  C9            		ret
                      	
                      	
                      	;open for tape write
                      	;destroy: none
  1AB7                	_WOPEN:	ds	WOPEN-_WOPEN
  1AB8                		org	WOPEN
                      	
  1AB8  F5            		push	af
  1AB9  C5            		push	bc
  1ABA  CD4B1B        		call	RLON
  1ABD  CDD91A        		call	BLANK
  1AC0  063E          		ld	b,3eh
  1AC2  CD121B        		call	OPENCMT
  1AC5  CDD91A        		call	BLANK
  1AC8  C1            		pop	bc
  1AC9  F1            		pop	af
  1ACA  C9            		ret
                      	
                      	
                      	;put 1 character to CMT
                      	;input: a=data
                      	;destroy: none
  1ACB                	_PUTCMT:ds	PUTCMT-_PUTCMT
  1ACC                		org	PUTCMT
                      	
  1ACC  F5            		push	af
  1ACD                	PUTCMT2:
  1ACD  CDDC1A        		call	CHKWSTP
  1AD0  3E38          		ld	a,38h
  1AD2  CD8F0E        		call	OUT90H
  1AD5  F1            		pop	af
  1AD6  C38F0E        		jp	OUT90H
                      	
                      	
                      	;wait and check stop for tape write
                      	;destroy: af,bc
  1AD9                	BLANK:
  1AD9  CDE525        		call	WAIT
                      	;	jr	CHKWSTP
                      	
                      	;check stop for tape write
                      	;destroy: af (when not stop)
  1ADC                	CHKWSTP:
  1ADC  3A18FA        		ld	a,(STOPFLG)
  1ADF  FE03          		cp	03h
  1AE1  C0            		ret	nz
  1AE2  CD491B        		call	RLOFF
  1AE5  C35127        		jp	STOPSP
                      	
                      	
                      	;check 8255 status (ready for output to port 90h)
                      	;output: z(0=ready)
                      	;destroy: af,(b)
  1AE8                	_CHK90H:ds	CHK90H-_CHK90H
  1AED                		org	CHK90H
                      	
  1AED  3E08          		ld	a,08h
  1AEF  D393          		out	(93h),a		;disable 8255 INT for reading
  1AF1  DB92          		in	a,(92h)
  1AF3  E688          		and	88h		;nobf=1,intr=1?
  1AF5  EAF91A        		jp	pe,CHK90PE
  1AF8  AF            		xor	a		;set z-flag
  1AF9                	CHK90PE:
  1AF9  3E09          		ld	a,09h
  1AFB  D393          		out	(93h),a		;enable 8255 INT for reading
  1AFD  C9            		ret
                      	
                      	
                      	;close for tape write
                      	;destroy: none
  1AFE                	_WCLOSE:ds	WCLOSE-_WCLOSE
  1B06                		org	WCLOSE
                      	
  1B06  F5            		push	af
  1B07  C5            		push	bc
  1B08  01B003        		ld	bc,03b0h
  1B0B  CDE825        		call	WAITLP
  1B0E  3E3A          		ld	a,3ah
  1B10  189C          		jr	CLOSEEND
                      	
                      	
                      	;open CMT subroutine
                      	;input: b (1eh=read, 3eh=write)
                      	;destroy: af,b
  1B12                	OPENCMT:
  1B12  3A1FFA        		ld	a,(BAUD)	;00=600baud, others=1200baud
  1B15  FE01          		cp	01h
  1B17  9F            		sbc	a,a		;ff=600baud, 00=1200baud
  1B18  80            		add	a,b
  1B19  CD8F0E        		call	OUT90H		;read=1dh(600baud), 1eh(1200baud)
                      					;write=3dh(600baud), 3eh(1200baud)
  1B1C  E6F8          		and	0f8h
  1B1E  3C            		inc	a		;read=19h, write=39h
  1B1F  F3            		di
  1B20  CD8F0E        		call	OUT90H
  1B23  FB            		ei
  1B24  AF            		xor	a
  1B25  3219FA        		ld	(CMTSTAT),a
                      	;	ld	(STOPFLG),a
  1B28  C9            		ret
                      	
                      	
                      	;blink asterisk
                      	;destroy: af
  1B29                	_BLNKAST:ds	BLNKAST-_BLNKAST
  1B2A                		org	BLNKAST
                      	
  1B2A  E5            		push	hl
  1B2B  211EFA        		ld	hl,ASTSTAT
  1B2E  7E            		ld	a,(hl)
  1B2F  EE0A          		xor	'*'-' '
  1B31  77            		ld	(hl),a
                      	
  1B32  2AABFD        		ld	hl,(WIDTH-1)	;h=(WIDTH)
  1B35  25            		dec	h
  1B36  2E01          		ld	l,01h
  1B38  CDCD11        		call	XY2AD
  1B3B  77            		ld	(hl),a
                      	
  1B3C  E1            		pop	hl
  1B3D  C9            		ret
                      	
                      	
                      	;CMT relay on/off
                      	;destroy: af,b
  1B3E                	_RLOFF:	ds	RLOFF-_RLOFF
  1B49                		org	RLOFF
                      	
  1B49  1801          		jr	RLOFF2
                      	
  1B4B                	_RLON:	ds	RLON-_RLON
  1B4B                		org	RLON
                      	
  1B4B  3E            		db	3eh		;ld a,
  1B4C                	RLOFF2:
  1B4C  AF            		xor	a		;afh
                      	
  1B4D  0608          		ld	b,00001000b	;bit3=CMT relay
  1B4F  C3541B        		jp	OUTB0H
                      	
                      	
                      	;output port b0h
                      	;input: a=new data, b=change bit
                      	;destroy: af
  1B52                	_OUTB0H:ds	OUTB0H-_OUTB0H
  1B54                		org	OUTB0H
                      	
  1B54  E5            		push	hl
  1B55  2127FA        		ld	hl,PORTB0H
  1B58  AE            		xor	(hl)
  1B59  A0            		and	b
  1B5A  AE            		xor	(hl)
  1B5B  D3B0          		out	(0b0h),a
  1B5D  77            		ld	(hl),a
  1B5E  E1            		pop	hl
  1B5F  C9            		ret
                      	
                      	
                      	;PLAY stop sub
                      	;destroy: none
  1B60                	_PLSTPS:ds	PLSTPS-_PLSTPS
  1B60                		org	PLSTPS
                      	
  1B60  F5            		push	af
  1B61  E5            		push	hl
  1B62  D5            		push	de
  1B63  C5            		push	bc
                      	
  1B64  3E07          		ld	a,07h		;ch.ABC=tone,portAB=in
  1B66  1E38          		ld	e,38h
  1B68  CDC51B        		call	SOUND
  1B6B  3C            		inc	a		;register8=ch.A volume
  1B6C  1E00          		ld	e,00h
  1B6E  CDC51B        		call	SOUND
  1B71  3C            		inc	a		;register9=ch.B volume
  1B72  CDC51B        		call	SOUND
  1B75  3C            		inc	a		;register10=ch.C volume
  1B76  CDC51B        		call	SOUND
                      	
  1B79  AF            		xor	a
  1B7A  321BFD        		ld	(PLAYST),a
  1B7D  3214FD        		ld	(CHANNEL),a
                      	
  1B80  67            		ld	h,a
  1B81  6F            		ld	l,a
  1B82  22A1FB        		ld	(BUFAIN),hl	;clear BFIN and BFOUT for ch.A
  1B85  22A7FB        		ld	(BUFBIN),hl	;clear BFIN and BFOUT for ch.B
  1B88  22ADFB        		ld	(BUFCIN),hl	;clear BFIN and BFOUT for ch.C
                      	
  1B8B  211DFD        		ld	hl,PLWKA
  1B8E  77            		ld	(hl),a
  1B8F  54            		ld	d,h
  1B90  5D            		ld	e,l
  1B91  13            		inc	de
  1B92  012400        		ld	bc,PLWKB-PLWKA-1
  1B95  EDB0          		ldir
                      	
  1B97  21B91B        		ld	hl,PLWKTBL
  1B9A  112CFD        		ld	de,PLWKA+OCTAVE
  1B9D  0E05          		ld	c,05h		;b=0
  1B9F  EDB0          		ldir
                      	
  1BA1  211DFD        		ld	hl,PLWKA
  1BA4  1142FD        		ld	de,PLWKB
  1BA7  0E4A          		ld	c,PLWKC-PLWKA	;b=0
  1BA9  EDB0          		ldir
                      	
  1BAB                	POPALL:
  1BAB  C1            		pop	bc
  1BAC  D1            		pop	de
  1BAD  E1            		pop	hl
  1BAE  F1            		pop	af
  1BAF  C9            		ret
                      	
                      	
                      	;stop and initialize for PLAY command
                      	;destroy: none
  1BB0                	_PLSTOP:ds	PLSTOP-_PLSTOP
  1BB3                		org	PLSTOP
  1BB3  F3            		di
  1BB4  CD601B        		call	PLSTPS
  1BB7  FB            		ei
  1BB8  C9            		ret
                      	
                      	
  1BB9                	PLWKTBL:
  1BB9  04            		db	4		;O-value
  1BBA  04            		db	4		;L-value
  1BBB  78            		db	120		;T-value
  1BBC  08            		db	8		;V-value
  1BBD  FF            		db	255		;M-value(low)
                      	
                      	
                      	;get PSG resister value and set new value
                      	;input: a=register, e=value
                      	;output: d=old value
                      	;destroy: none
  1BBE                	_SOUND2:ds	SOUND2-_SOUND2
  1BBE                		org	SOUND2
                      	
  1BBE  F5            		push	af
  1BBF  D3A0          		out	(0a0h),a
  1BC1  DBA2          		in	a,(0a2h)
  1BC3  57            		ld	d,a
  1BC4  F1            		pop	af
                      	;	jp	SOUND
                      	
                      	
                      	;set PSG register
                      	;input: a=register, e=value
                      	;destroy: none
  1BC5                	_SOUND:	ds	SOUND-_SOUND
  1BC5                		org	SOUND
                      	
  1BC5  F5            		push	af
  1BC6  D3A0          		out	(0a0h),a
  1BC8  7B            		ld	a,e
  1BC9  D3A1          		out	(0a1h),a
  1BCB  F1            		pop	af
  1BCC  C9            		ret
                      	
                      	
                      	;bell
                      	;destroy: af,bc,e
  1BCD                	_BELL:	ds	BELL-_BELL
  1BCD                		org	BELL
                      	
  1BCD  CDB31B        		call	PLSTOP
                      	;tune
  1BD0  AF            		xor	a		;register0=ch.A 8bit fine tune
  1BD1  1E55          		ld	e,55h
  1BD3  CDC51B        		call	SOUND
  1BD6  5F            		ld	e,a		;a=0
  1BD7  3C            		inc	a		;register1=ch.A 4bit coarse tune
  1BD8  CDC51B        		call	SOUND
                      	;volume
  1BDB  1E07          		ld	e,07h
                      	;	ld	a,08h		;register8=ch.A volume
  1BDD  83            		add	a,e		;register8=ch.A volume
  1BDE  CDC51B        		call	SOUND
  1BE1  010004        		ld	bc,0400h
  1BE4  59            		ld	e,c		;c=0
  1BE5  CDE825        		call	WAITLP
                      	;volume
  1BE8  3E08          		ld	a,08h		;register8=ch.A volume
  1BEA  18D9          		jr	SOUND
                      	
                      	
                      	;play subroutine called by time interrupt
                      	;destroy: af,bc,de,hl
  1BEC                	PLAYINT:
  1BEC  3A14FD        		ld	a,(CHANNEL)
  1BEF  3C            		inc	a
  1BF0  3A1BFD        		ld	a,(PLAYST)
  1BF3  2802          		jr	z,PLIZ
  1BF5  B7            		or	a
  1BF6  C8            		ret	z
  1BF7                	PLIZ:
  1BF7  0F            		rrca
  1BF8  0F            		rrca
  1BF9  0F            		rrca
  1BFA  4F            		ld	c,a
  1BFB  2167FD        		ld	hl,PLWKC
  1BFE  0603          		ld	b,03h
  1C00                	PLILP:
  1C00  E5            		push	hl
  1C01  CB01          		rlc	c
  1C03  300D          		jr	nc,PLINC
                      	
  1C05  56            		ld	d,(hl)
  1C06  2C            		inc	l		;inc	hl
  1C07  5E            		ld	e,(hl)
  1C08  1B            		dec	de
  1C09  73            		ld	(hl),e
  1C0A  2D            		dec	l		;dec	hl
  1C0B  72            		ld	(hl),d
  1C0C  7A            		ld	a,d
  1C0D  B3            		or	e
  1C0E  2061          		jr	nz,PLINEXT
  1C10  180A          		jr	PLIGET
                      	
  1C12                	PLINC:
  1C12  211BFD        		ld	hl,PLAYST
  1C15  3A14FD        		ld	a,(CHANNEL)
  1C18  3C            		inc	a
  1C19  B6            		or	(hl)
  1C1A  2055          		jr	nz,PLINEXT	;if (PLAYST)<>0 or (CHANNEL)<>ff
                      	
  1C1C                	PLIGET:
                      	;length
  1C1C  CD4810        		call	GETPLBF
  1C1F  2850          		jr	z,PLINEXT
  1C21  FEFF          		cp	0ffh
  1C23  2863          		jr	z,PLIRES
  1C25  D1            		pop	de
  1C26  D5            		push	de
  1C27  12            		ld	(de),a
  1C28  CD4810        		call	GETPLBF		;no change in de
  1C2B  1C            		inc	e		;inc de
  1C2C  12            		ld	(de),a
                      	
                      	;tune
  1C2D  CD4810        		call	GETPLBF
  1C30  5F            		ld	e,a
  1C31  78            		ld	a,b
  1C32  87            		add	a,a
  1C33  3D            		dec	a		;register1,3,5=4bit coarse tune
  1C34  CDC51B        		call	SOUND
  1C37  CD4810        		call	GETPLBF
  1C3A  5F            		ld	e,a
  1C3B  78            		ld	a,b
  1C3C  3D            		dec	a
  1C3D  87            		add	a,a		;register0,2,4=8bit fine tune
  1C3E  CDC51B        		call	SOUND
                      	
                      	;volume or envelope
  1C41  CD4810        		call	GETPLBF
  1C44  57            		ld	d,a		;
  1C45  FE10          		cp	10h
  1C47  3802          		jr	c,PLIVOL
  1C49  3E10          		ld	a,10h		;envelope
  1C4B                	PLIVOL:
  1C4B  5F            		ld	e,a
  1C4C  78            		ld	a,b
  1C4D  C607          		add	a,07h		;register8,9,10=volume
  1C4F  CDC51B        		call	SOUND
  1C52  7A            		ld	a,d		;
  1C53  D610          		sub	10h
  1C55  3818          		jr	c,PLISET
                      	
                      	;period
  1C57  57            		ld	d,a		;
  1C58  CD4810        		call	GETPLBF
  1C5B  5F            		ld	e,a
  1C5C  3E0B          		ld	a,0bh
  1C5E  CDC51B        		call	SOUND
  1C61  CD4810        		call	GETPLBF
  1C64  5F            		ld	e,a
  1C65  3E0C          		ld	a,0ch
  1C67  CDC51B        		call	SOUND
                      	
                      	;envelope pattern
  1C6A  5A            		ld	e,d		;
  1C6B  3C            		inc	a		;register13=envelope pattern
  1C6C  CDC51B        		call	SOUND
                      	
                      	;status
  1C6F                	PLISET:
  1C6F  CBC1          		set	0,c
                      	
  1C71                	PLINEXT:
  1C71  E1            		pop	hl
  1C72  7D            		ld	a,l
  1C73  C6DB          		add	a,PLWKA-PLWKB	;no carry
  1C75  6F            		ld	l,a
  1C76  1088          		djnz	PLILP
                      	
  1C78  211BFD        		ld	hl,PLAYST
  1C7B  7E            		ld	a,(hl)
  1C7C  71            		ld	(hl),c
  1C7D  0C            		inc	c
  1C7E  0D            		dec	c
  1C7F  C0            		ret	nz		;new (PLAYST)<>0
  1C80  B7            		or	a		;old (PLAYST)
  1C81  C2EC1B        		jp	nz,PLAYINT
  1C84  3214FD        		ld	(CHANNEL),a	;=0
  1C87  C9            		ret
                      	
                      	;reset
  1C88                	PLIRES:
  1C88  CB81          		res	0,c
  1C8A  78            		ld	a,b
  1C8B  C607          		add	a,07h		;register8,9,10=volume
  1C8D  1E00          		ld	e,00h
  1C8F  CDC51B        		call	SOUND
  1C92  18DD          		jr	PLINEXT
                      	
                      	
                      	;get play buffer address
                      	;output: hl
                      	;destroy: f
  1C94                	GETPLAD:
  1C94  67            		ld	h,a
  1C95  3A14FD        		ld	a,(CHANNEL)
  1C98  6F            		ld	l,a
  1C99  87            		add	a,a		;a*2
  1C9A  85            		add	a,l		;a*3
  1C9B  87            		add	a,a		;a*6
  1C9C  C6A1          		add	a,BUFAIN-BUFAIN/256*256		;no carry
  1C9E  6F            		ld	l,a
  1C9F  7C            		ld	a,h
  1CA0  26FB          		ld	h,BUFAIN/256	;higher byte
  1CA2  C9            		ret
                      	
                      	
                      	;joystick
                      	;input: a=1or2
                      	;output: a (0-0-trigger2-trigger1-right-left-down-up)
                      	;destroy: f
  1CA3                	_JOYSTK:ds	JOYSTK-_JOYSTK
  1CA6                		org	JOYSTK
                      	
  1CA6  D5            		push	de
  1CA7  0F            		rrca
  1CA8  37            		scf
  1CA9  1F            		rra
  1CAA  5F            		ld	e,a		;c0h or 80h
                      	
  1CAB  3E07          		ld	a,07h		;register7=portABin-out,noise,tone
  1CAD  F3            		di
  1CAE  D3A0          		out	(0a0h),a
  1CB0  DBA2          		in	a,(0a2h)
  1CB2  1802          		jr	SKPPATCH2
                      	
                      	
                      	;1cb4h-1cb5h: to be patched by PC6001V/VX/VW
  1CB4                	_PATCH2:ds	PATCH2-_PATCH2
  1CB4                		org	PATCH2
  1CB4  0000          		db	00h, 00h
                      	
                      	
  1CB6                	SKPPATCH2:
  1CB6  57            		ld	d,a		;
                      	
  1CB7  E6BF          		and	10111111b	;parallel port A=in
  1CB9  F680          		or	10000000b	;parallel port B=out
  1CBB  D3A1          		out	(0a1h),a
                      	
  1CBD  3E0F          		ld	a,0fh		;register15=parallel port B
  1CBF  CDC51B        		call	SOUND		;c0h or 80h
                      	
  1CC2  3D            		dec	a		;register14=parallel port A
  1CC3  D3A0          		out	(0a0h),a
  1CC5  DBA2          		in	a,(0a2h)
  1CC7  2F            		cpl
  1CC8  5A            		ld	e,d		;
  1CC9  57            		ld	d,a		;;
                      	
  1CCA  3E07          		ld	a,07h
  1CCC  CDC51B        		call	SOUND
                      	
  1CCF  FB            		ei
                      	
  1CD0  7A            		ld	a,d		;;
  1CD1  D1            		pop	de
  1CD2  C9            		ret
                      	
                      	
                      	;LOCATE command
  1CD3                	C_LOCA:
  1CD3  CD330E        		call	INT1ARG2
  1CD6  61            		ld	h,c
  1CD7  3AACFD        		ld	a,(WIDTH)
  1CDA  3D            		dec	a
  1CDB  BC            		cp	h
  1CDC  DAED03        		jp	c,FCERR
  1CDF  6B            		ld	l,e
  1CE0  3A20FA        		ld	a,(HEIGHT)
  1CE3  3D            		dec	a
  1CE4  BD            		cp	l
  1CE5  DAED03        		jp	c,FCERR
  1CE8  24            		inc	h
  1CE9  2C            		inc	l
  1CEA  C36D11        		jp	SETCSR
                      	
                      	
                      	;CONSOLE command
  1CED                	C_CNSL:
  1CED  ED4BA2FD      		ld	bc,(CONSOL1)	;c=(CONSOL1),b=(CONSOL2)
  1CF1  C5            		push	bc
                      	
  1CF2  CD6C3F        		call	CHKCMM
  1CF5  2814          		jr	z,CNSLPAR2
                      	
  1CF7  CDE40D        		call	INT1ARG
  1CFA  3A20FA        		ld	a,(HEIGHT)
  1CFD  3D            		dec	a
  1CFE  BB            		cp	e
  1CFF  3801          		jr	c,CNSLC1
  1D01  7B            		ld	a,e
  1D02                	CNSLC1:
  1D02  3C            		inc	a
  1D03  C1            		pop	bc
  1D04  4F            		ld	c,a
  1D05  C5            		push	bc
                      	
  1D06  CD7C3F        		call	CHKCLCM
  1D09  2840          		jr	z,CNSLEND
                      	
  1D0B                	CNSLPAR2:
  1D0B  CD6C3F        		call	CHKCMM
  1D0E  2818          		jr	z,CNSLPAR3
                      	
  1D10  CDE40D        		call	INT1ARG
                      	
  1D13  ED5B20FA      		ld	de,(HEIGHT)
  1D17  C1            		pop	bc
  1D18  81            		add	a,c
  1D19  DAED03        		jp	c,FCERR
  1D1C  3D            		dec	a
  1D1D  BB            		cp	e
  1D1E  3801          		jr	c,CNSLC2
  1D20  7B            		ld	a,e
  1D21                	CNSLC2:
  1D21  47            		ld	b,a
  1D22  C5            		push	bc
                      	
  1D23  CD7C3F        		call	CHKCLCM
  1D26  2823          		jr	z,CNSLEND
                      	
  1D28                	CNSLPAR3:
  1D28  CD6C3F        		call	CHKCMM
  1D2B  2813          		jr	z,CNSLPAR4
                      	
  1D2D  CDE40D        		call	INT1ARG
  1D30  FE02          		cp	02h
  1D32  D2ED03        		jp	nc,FCERR
  1D35  32A6FD        		ld	(CONSOL3),a
                      	
  1D38  CDB212        		call	PRTFKEY2
  1D3B  CD7C3F        		call	CHKCLCM
  1D3E  280B          		jr	z,CNSLEND
                      	
  1D40                	CNSLPAR4:
  1D40  CDE40D        		call	INT1ARG
  1D43  FE02          		cp	02h
  1D45  D2ED03        		jp	nc,FCERR
  1D48  322DFA        		ld	(CONSOL4),a
                      	
  1D4B                	CNSLEND:
  1D4B  E1            		pop	hl
  1D4C  7C            		ld	a,h
  1D4D  BD            		cp	l
  1D4E  DAED03        		jp	c,FCERR
  1D51  22A2FD        		ld	(CONSOL1),hl
                      	
  1D54                	CNSLEND2:
  1D54  3A20FA        		ld	a,(HEIGHT)
  1D57  21A6FD        		ld	hl,CONSOL3
  1D5A  96            		sub	(hl)
  1D5B  47            		ld	b,a		;
                      	
  1D5C  21A2FD        		ld	hl,CONSOL1
  1D5F  BE            		cp	(hl)
  1D60  3001          		jr	nc,CNSLNC
  1D62  77            		ld	(hl),a
  1D63                	CNSLNC:
  1D63  7E            		ld	a,(hl)
  1D64  CD8015        		call	CUTLINE2	;a=(CONSOL1)
                      	
  1D67  21A5FD        		ld	hl,LASTLIN
  1D6A  3AA3FD        		ld	a,(CONSOL2)
  1D6D  77            		ld	(hl),a
  1D6E  B8            		cp	b		;
  1D6F  3808          		jr	c,CNSLC3
  1D71  3A92FD        		ld	a,(SCREEN1)
  1D74  FE02          		cp	02h
  1D76  3001          		jr	nc,CNSLC3	;screen mode 3,4
  1D78  70            		ld	(hl),b
                      	
  1D79                	CNSLC3:
  1D79  3AA8FD        		ld	a,(CSRY)
  1D7C  3D            		dec	a
  1D7D  BE            		cp	(hl)
  1D7E  D8            		ret	c
                      	
  1D7F  6E            		ld	l,(hl)
  1D80  C36811        		jp	CTLCR
                      	
                      	
                      	;COLOR command
  1D83                	_C_COLR:ds	C_COLR-_C_COLR
  1D9B                		org	C_COLR
                      	
  1D9B  1193FD        		ld	de,COLOR1
  1D9E  0602          		ld	b,02h
  1DA0                	COLRLP:
  1DA0  CD6C3F        		call	CHKCMM
  1DA3  2810          		jr	z,COLRZ
  1DA5  C5            		push	bc
  1DA6  D5            		push	de
  1DA7  CDE40D        		call	INT1ARG
  1DAA  D1            		pop	de
  1DAB  C1            		pop	bc
  1DAC  12            		ld	(de),a
  1DAD  CD613F        		call	CHKCLN		;a=(hl)
  1DB0  C8            		ret	z
  1DB1  FE2C          		cp	','
  1DB3  C0            		ret	nz
  1DB4  23            		inc	hl
  1DB5                	COLRZ:
  1DB5  13            		inc	de
  1DB6  10E8          		djnz	COLRLP
                      	
  1DB8                	COLRPAR3:
  1DB8  CDE40D        		call	INT1ARG
                      	;	jp	SETC3
                      	
                      	
                      	;set color 3rd parameter
                      	;input: a=3rd color parameter (1 or 2)
                      	;destroy: af,bc,de
  1DBB                	_SETC3:	ds	SETC3-_SETC3
  1DBB                		org	SETC3
                      	
  1DBB  EB            		ex	de,hl
  1DBC  3D            		dec	a
  1DBD  FE02          		cp	02h
  1DBF  D2ED03        		jp	nc,FCERR
  1DC2  87            		add	a,a		;0 or 2
                      	
  1DC3  2195FD        		ld	hl,COLOR3
  1DC6  BE            		cp	(hl)
  1DC7  C8            		ret	z
  1DC8  77            		ld	(hl),a
                      	
  1DC9  2A90FD        		ld	hl,(VRAM-1)
  1DCC  010200        		ld	bc,0002h	;32*16=256*2
  1DCF  68            		ld	l,b		;b=0
  1DD0                	SETC3LP:
  1DD0  7E            		ld	a,(hl)
  1DD1  EE02          		xor	02h
  1DD3  77            		ld	(hl),a
  1DD4  23            		inc	hl
  1DD5  10F9          		djnz	SETC3LP
  1DD7  0D            		dec	c
  1DD8  20F6          		jr	nz,SETC3LP
  1DDA  EB            		ex	de,hl
  1DDB  C9            		ret
                      	
                      	
                      	;CLS command
                      	;destroy: af,de
  1DDC                	_CLS:	ds	CLS-_CLS
  1DFB                	C_CLS:
  1DFB                		org	CLS
                      	
  1DFB  E5            		push	hl
  1DFC  C5            		push	bc
  1DFD  CD3D16        		call	CLSMAIN2
  1E00  C1            		pop	bc
  1E01  E1            		pop	hl
  1E02  C9            		ret
                      	
                      	
                      	;SCREEN command
  1E03                	_C_SCRN:ds	C_SCRN-_C_SCRN
  1E04                		org	C_SCRN
                      	
  1E04  3A92FD        		ld	a,(SCREEN1)
  1E07  5F            		ld	e,a
  1E08  1601          		ld	d,01h		;d>0: no 1st parameter
  1E0A  D5            		push	de
  1E0B  ED5B8FFD      		ld	de,(SCREEN2)	;e=(SCREEN2),d=(SCREEN3)
  1E0F  D5            		push	de
                      	
  1E10  CD6C3F        		call	CHKCMM
  1E13  280E          		jr	z,SCRPAR2
  1E15  CDE40D        		call	INT1ARG
  1E18  1D            		dec	e
  1E19  C1            		pop	bc		;c=2nd,b=3rd parameter
  1E1A  EB            		ex	de,hl
  1E1B  E3            		ex	(sp),hl		;cancel 1st parameter, l=1st parameter, h=0
  1E1C  EB            		ex	de,hl
  1E1D  C5            		push	bc		;c=2nd,b=3rd parameter
                      	
  1E1E  CD7C3F        		call	CHKCLCM
  1E21  2818          		jr	z,SCRMAIN
                      	
  1E23                	SCRPAR2:
  1E23  CD6C3F        		call	CHKCMM
  1E26  280C          		jr	z,SCRPAR3
  1E28  CDE40D        		call	INT1ARG
  1E2B  3D            		dec	a
                      	
  1E2C  D1            		pop	de		;e=2nd,d=3rd parameter
  1E2D  5F            		ld	e,a
  1E2E  D5            		push	de
                      	
  1E2F  CD7C3F        		call	CHKCLCM
  1E32  2807          		jr	z,SCRMAIN
                      	
  1E34                	SCRPAR3:
  1E34  CDE40D        		call	INT1ARG
  1E37  3D            		dec	a
                      	
  1E38  D1            		pop	de		;e=2nd,d=3rd parameter
  1E39  57            		ld	d,a
  1E3A  D5            		push	de
                      	
  1E3B                	SCRMAIN:
  1E3B  D1            		pop	de		;e=2nd,d=3rd parameter
  1E3C  C1            		pop	bc		;c=1st parameter
                      	
  1E3D  3A8CFD        		ld	a,(PAGES)
  1E40  3D            		dec	a
  1E41  BA            		cp	d
  1E42  DAED03        		jp	c,FCERR
  1E45  BB            		cp	e
  1E46  DAED03        		jp	c,FCERR
                      	
  1E49  79            		ld	a,c
  1E4A  FE02          		cp	02h
  1E4C  380D          		jr	c,SCROK
  1E4E  FE04          		cp	04h
  1E50  D2ED03        		jp	nc,FCERR
  1E53  7B            		ld	a,e
  1E54  B7            		or	a
  1E55  2004          		jr	nz,SCROK
  1E57  B0            		or	b		;b>0: no 1st parameter
  1E58  CAED03        		jp	z,FCERR		;if 1st>=2 and 2nd=0
  1E5B                	SCROK:
  1E5B  D5            		push	de		;e=2nd,d=3rd parameter
  1E5C  7B            		ld	a,e
  1E5D  CD0C14        		call	CHGACT
                      	
  1E60  F1            		pop	af		;a=3rd parameter
  1E61  2190FD        		ld	hl,SCREEN3
  1E64  BE            		cp	(hl)
  1E65  C4ED13        		call	nz,CHGDSP
                      	
  1E68  78            		ld	a,b
  1E69  B7            		or	a
  1E6A  79            		ld	a,c
  1E6B  CA9013        		jp	z,CHGMOD	;b>0: no 1st parameter
  1E6E  C9            		ret
                      	
                      	
                      	;TIME function
  1E6F                	F_TIME:
  1E6F  2A28FA        		ld	hl,(TMCNT)
  1E72  ED5B2AFA      		ld	de,(TMCNT+2)
  1E76  C39A0C        		jp	I4TOF
                      	
                      	
                      	;SOUND command
  1E79                	C_SOUN:
  1E79  CD613F        		call	CHKCLN
  1E7C  CAE403        		jp	z,SNERR
  1E7F  CD330E        		call	INT1ARG2
  1E82  79            		ld	a,c
  1E83  FE10          		cp	10h
  1E85  D2ED03        		jp	nc,FCERR
  1E88  F3            		di
  1E89  CDC51B        		call	SOUND
  1E8C  FB            		ei
  1E8D  C9            		ret
                      	
                      	
                      	;PLAY command
  1E8E                	C_PLAY:
  1E8E  CDB31E        		call	PLAY
  1E91  224EFF        		ld	(PROGAD),hl
  1E94  C9            		ret
                      	
                      	
                      	;play routine
                      	;input: hl=data address, (z=0)
                      	;output: hl=next address
                      	;destroy: af,bc,de
  1E95                	_PLAY:	ds	PLAY-_PLAY
  1EB3                		org	PLAY
                      	
  1EB3  DDE5          		push	ix
  1EB5  ED5B4EFF      		ld	de,(PROGAD)
  1EB9  D5            		push	de
                      	
  1EBA  AF            		xor	a
  1EBB  3244FD        		ld	(PLWKB+PLLEN),a
  1EBE  3269FD        		ld	(PLWKC+PLLEN),a
                      	
  1EC1  DD211DFD      		ld	ix,PLWKA
  1EC5  0603          		ld	b,03h
  1EC7                	PLAYLP1:
  1EC7  C5            		push	bc
  1EC8  CD8926        		call	STRARG
  1ECB  DD7702        		ld	(ix+PLLEN),a
  1ECE  DD7303        		ld	(ix+PLADR),e
  1ED1  DD7204        		ld	(ix+PLADR+1),d
  1ED4  012500        		ld	bc,PLWKB-PLWKA
  1ED7  DD09          		add	ix,bc
  1ED9  C1            		pop	bc
  1EDA  CD7C3F        		call	CHKCLCM
  1EDD  2802          		jr	z,PLSTR0
  1EDF  10E6          		djnz	PLAYLP1
                      	
                      	;check string length=0?
  1EE1                	PLSTR0:
  1EE1  2169FD        		ld	hl,PLWKC+PLLEN
  1EE4  11DBFF        		ld	de,PLWKB-PLWKC
  1EE7  0603          		ld	b,03h
  1EE9                	PLAYLP2:
  1EE9  7E            		ld	a,(hl)
  1EEA  B7            		or	a
  1EEB  200C          		jr	nz,PLAYNZ
  1EED  78            		ld	a,b
  1EEE  3D            		dec	a
  1EEF  3214FD        		ld	(CHANNEL),a
  1EF2  3EFF          		ld	a,0ffh
  1EF4  E5            		push	hl
  1EF5  CD310F        		call	PUTPLBF
  1EF8  E1            		pop	hl
  1EF9                	PLAYNZ:
  1EF9  19            		add	hl,de
  1EFA  10ED          		djnz	PLAYLP2
                      	
                      	
  1EFC                	PLAYLP3:
  1EFC  3A18FA        		ld	a,(STOPFLG)
  1EFF  FE03          		cp	03h
  1F01  CCB31B        		call	z,PLSTOP
  1F04  2856          		jr	z,PLAYEND
                      	
  1F06  DD2167FD      		ld	ix,PLWKC
  1F0A  0603          		ld	b,03h
  1F0C                	PLAYLP4:
  1F0C  78            		ld	a,b
  1F0D  3D            		dec	a
  1F0E  3214FD        		ld	(CHANNEL),a
  1F11  DD7E02        		ld	a,(ix+PLLEN)
  1F14  B7            		or	a
  1F15  2827          		jr	z,PLAYNEXT
                      	
  1F17  DD6E03        		ld	l,(ix+PLADR)
  1F1A  DD6604        		ld	h,(ix+PLADR+1)
                      	
  1F1D  3217FD        		ld	(PLAYLEN),a
  1F20  2218FD        		ld	(PLAYSTR),hl
  1F23  C5            		push	bc
  1F24  CD671F        		call	CNVPLAY
  1F27  C1            		pop	bc
  1F28  3A17FD        		ld	a,(PLAYLEN)
  1F2B  DD7702        		ld	(ix+PLLEN),a
  1F2E  2A18FD        		ld	hl,(PLAYSTR)
  1F31  DD7503        		ld	(ix+PLADR),l
  1F34  DD7404        		ld	(ix+PLADR+1),h
                      	
  1F37  B7            		or	a
  1F38  2004          		jr	nz,PLAYNEXT
  1F3A  3D            		dec	a
  1F3B  CD310F        		call	PUTPLBF		;a=ffh
                      	
  1F3E                	PLAYNEXT:
  1F3E  11DBFF        		ld	de,PLWKB-PLWKC
  1F41  DD19          		add	ix,de
  1F43  10C7          		djnz	PLAYLP4
                      	
  1F45  3EFF          		ld	a,0ffh
  1F47  3214FD        		ld	(CHANNEL),a
                      	
  1F4A  3A1FFD        		ld	a,(PLWKA+PLLEN)
  1F4D  2144FD        		ld	hl,PLWKB+PLLEN
  1F50  B6            		or	(hl)
  1F51  2169FD        		ld	hl,PLWKC+PLLEN
  1F54  B6            		or	(hl)
  1F55  20A5          		jr	nz,PLAYLP3
                      	
  1F57  F3            		di
  1F58  CDEC1B        		call	PLAYINT
  1F5B  FB            		ei
                      	
  1F5C                	PLAYEND:
  1F5C  D1            		pop	de
  1F5D  2A4EFF        		ld	hl,(PROGAD)
  1F60  ED534EFF      		ld	(PROGAD),de
  1F64  DDE1          		pop	ix
  1F66  C9            		ret
                      	
                      	
                      	;convert play data
                      	;input: a=string length, hl=string address, ix=play work
                      	;destroy: af,bc,de,hl
  1F67                	CNVPLAY:
  1F67  CD941C        		call	GETPLAD
  1F6A  56            		ld	d,(hl)
  1F6B  14            		inc	d		;in+1
  1F6C  23            		inc	hl
  1F6D  7E            		ld	a,(hl)		;out
  1F6E  92            		sub	d
  1F6F  3004          		jr	nc,CNVPLNC
                      	
  1F71  23            		inc	hl
  1F72  23            		inc	hl		;size
  1F73  3C            		inc	a
  1F74  86            		add	a,(hl)
  1F75                	CNVPLNC:
  1F75  FE08          		cp	08h
  1F77  D8            		ret	c
                      	
  1F78  CD1B20        		call	PLAYGETC
  1F7B  C8            		ret	z
  1F7C  CD6A20        		call	PLAYINC
  1F7F  CDAC0B        		call	TOUPPER
  1F82  CD871F        		call	PLAYCMD
  1F85  18E0          		jr	CNVPLAY
                      	
                      	
  1F87                	PLAYCMD:
  1F87  D641          		sub	'A'
  1F89  FE07          		cp	'G'-'A'+1
  1F8B  DAC720        		jp	c,TONE
  1F8E  219F1F        		ld	hl,PLAYTBL
  1F91  0608          		ld	b,08h
  1F93                	PLCMDLP:
  1F93  BE            		cp	(hl)
  1F94  23            		inc	hl
  1F95  CA523F        		jp	z,JPTBLNC
  1F98  23            		inc	hl
  1F99  23            		inc	hl
  1F9A  10F7          		djnz	PLCMDLP
  1F9C  C3ED03        		jp	FCERR
                      	
                      	
  1F9F                	PLAYTBL:
  1F9F  15            		db	'V'-'A'
  1FA0  B71F          		dw	PLAYV
  1FA2  0C            		db	'M'-'A'
  1FA3  C71F          		dw	PLAYM
  1FA5  12            		db	'S'-'A'
  1FA6  DB1F          		dw	PLAYS
  1FA8  0B            		db	'L'-'A'
  1FA9  E71F          		dw	PLAYL
  1FAB  13            		db	'T'-'A'
  1FAC  F91F          		dw	PLAYT
  1FAE  0E            		db	'O'-'A'
  1FAF  0920          		dw	PLAYO
  1FB1  11            		db	'R'-'A'
  1FB2  9520          		dw	PLAYR
  1FB4  0D            		db	'N'-'A'
  1FB5  7620          		dw	PLAYN
                      	
                      	
  1FB7                	PLAYV:
  1FB7  CD5621        		call	GETNUM1
  1FBA  3802          		jr	c,PLAYVNUM
  1FBC  3E08          		ld	a,08h
  1FBE                	PLAYVNUM:
  1FBE  FE10          		cp	10h
  1FC0  D2ED03        		jp	nc,FCERR
  1FC3                	PUTV:
  1FC3  DD7712        		ld	(ix+VOLUME),a
  1FC6  C9            		ret
                      	
  1FC7                	PLAYM:
  1FC7  CD6121        		call	GETNUM2
  1FCA  3803          		jr	c,PLAYMNUM
  1FCC  11FF00        		ld	de,00ffh
  1FCF                	PLAYMNUM:
  1FCF  7A            		ld	a,d
  1FD0  B3            		or	e
  1FD1  CAED03        		jp	z,FCERR
  1FD4  DD7313        		ld	(ix+PERIOD),e
  1FD7  DD7214        		ld	(ix+PERIOD+1),d
  1FDA  C9            		ret
                      	
  1FDB                	PLAYS:
  1FDB  CD5621        		call	GETNUM1
  1FDE  FE10          		cp	10h
  1FE0  D2ED03        		jp	nc,FCERR
  1FE3  C610          		add	a,10h
  1FE5  18DC          		jr	PUTV
                      	
  1FE7                	PLAYL:
  1FE7  CD5621        		call	GETNUM1
  1FEA  3802          		jr	c,PLAYLNUM
  1FEC  3E04          		ld	a,04h
  1FEE                	PLAYLNUM:
  1FEE  3D            		dec	a
  1FEF  FE40          		cp	40h
  1FF1  D2ED03        		jp	nc,FCERR
  1FF4  3C            		inc	a
  1FF5  DD7710        		ld	(ix+LENGTH),a
  1FF8  C9            		ret
                      	
  1FF9                	PLAYT:
  1FF9  CD5621        		call	GETNUM1
  1FFC  3802          		jr	c,PLAYTNUM
  1FFE  3E78          		ld	a,120
  2000                	PLAYTNUM:
  2000  FE20          		cp	32
  2002  DAED03        		jp	c,FCERR
  2005  DD7711        		ld	(ix+TEMPO),a
  2008  C9            		ret
                      	
  2009                	PLAYO:
  2009  CD5621        		call	GETNUM1
  200C  3802          		jr	c,PLAYONUM
  200E  3E04          		ld	a,04h
  2010                	PLAYONUM:
  2010  3D            		dec	a
  2011  FE08          		cp	08h
  2013  D2ED03        		jp	nc,FCERR
  2016  3C            		inc	a
  2017  DD770F        		ld	(ix+OCTAVE),a
  201A  C9            		ret
                      	
                      	
                      	;get a character from PLAY string
                      	;output: a,z-flag(1=no character)
                      	;destroy: f,hl
  201B                	PLAYGETC:
  201B  3A17FD        		ld	a,(PLAYLEN)
  201E  B7            		or	a
  201F  C8            		ret	z		;a=0 if no character
  2020  2A18FD        		ld	hl,(PLAYSTR)
  2023  7E            		ld	a,(hl)
  2024  FE20          		cp	' '
  2026  C0            		ret	nz
  2027  CD6A20        		call	PLAYINC
  202A  18EF          		jr	PLAYGETC
                      	
                      	
                      	;scale data
                      	;address probably equals to 6001mkII/6601 ROM (used by BELUGA)
  202C                	_SCALE2:ds	SCALE2-_SCALE2
  2030                		org	SCALE2
                      	
                      	;		c/b+	c+/d-	d	d+/e-	e/f-	f/e+
  2030  E80E120E480D89		dw	0ee8h,	0e12h,	0d48h,	0c89h,	0bd5h,	0b2bh
                      	;		f+/g-	g	g+/a-	a	a+/b-	b/c-
  203C  8A0AF3096409DD		dw	0a8ah,	09f3h,	0964h,	08ddh,	085eh,	07e6h
                      	
                      	
                      	;scale data
  2048                	_SCALE:	ds	SCALE-_SCALE
  204B                		org	SCALE
                      	
                      	;		c/b+	c+/d-	d	d+/e-	e/f-	f/e+
  204B  E80E120E480D89		dw	0ee8h,	0e12h,	0d48h,	0c89h,	0bd5h,	0b2bh
                      	;		f+/g-	g	g+/a-	a	a+/b-	b/c-
  2057  8A0AF3096409DD		dw	0a8ah,	09f3h,	0964h,	08ddh,	085eh,	07e6h
                      	
                      	
  2063                	TONETBL:
                      	;		a   b   c  d  e  f   g
  2063  12160004080A0E		db	18, 22, 0, 4, 8, 10, 14
                      	
                      	
                      	;increment (PLAYSTR) and decrement (PLAYLEN)
                      	;destroy: f,hl
  206A                	PLAYINC:
  206A  2117FD        		ld	hl,PLAYLEN
  206D  35            		dec	(hl)
  206E  2118FD        		ld	hl,PLAYSTR
  2071  34            		inc	(hl)
  2072  C0            		ret	nz
  2073  2C            		inc	l
  2074  34            		inc	(hl)
  2075  C9            		ret
                      	
                      	
  2076                	PLAYN:
  2076  CD5621        		call	GETNUM1
  2079  D2ED03        		jp	nc,FCERR
  207C  FE61          		cp	97
  207E  D2ED03        		jp	nc,FCERR
  2081  B7            		or	a
  2082  283C          		jr	z,PLAYN0
                      	
  2084  0600          		ld	b,00h
  2086                	PLAYNLP:
  2086  04            		inc	b
  2087  D60C          		sub	0ch
  2089  30FB          		jr	nc,PLAYNLP
  208B  87            		add	a,a
  208C  16FF          		ld	d,0ffh
  208E  5F            		ld	e,a
  208F  216320        		ld	hl,SCALE+24
  2092  19            		add	hl,de
  2093  1859          		jr	GETFREQ
                      	
  2095                	PLAYR:
  2095  AF            		xor	a
  2096  F5            		push	af		;volume
  2097  D5            		push	de		;(tune)
  2098  CD5621        		call	GETNUM1
  209B  3006          		jr	nc,PLAYRNC
  209D  B7            		or	a
  209E  2068          		jr	nz,CHKLEN
  20A0  C3ED03        		jp	FCERR
                      	
  20A3                	PLAYRNC:
  20A3  3E04          		ld	a,04h
  20A5  1861          		jr	CHKLEN
                      	
                      	;accidental mark
  20A7                	PLAYPLS:
  20A7  CD6A20        		call	PLAYINC
  20AA  1C            		inc	e
  20AB  1C            		inc	e
  20AC  7B            		ld	a,e
  20AD  D618          		sub	24
  20AF  3834          		jr	c,NOACC
  20B1  5F            		ld	e,a		;=0
  20B2  1831          		jr	NOACC
                      	
  20B4                	PLAYMNS:
  20B4  CD6A20        		call	PLAYINC
  20B7  1D            		dec	e
  20B8  1D            		dec	e
  20B9  F2E520        		jp	P,NOACC
  20BC  1E16          		ld	e,22
  20BE  1825          		jr	NOACC
                      	
  20C0                	PLAYN0:
  20C0  AF            		xor	a
  20C1  F5            		push	af		;volume
  20C2  D5            		push	de		;(tune)
                      	
                      	;for compatibility with PC-6001
  20C3  3E50          		ld	a,80
  20C5  1846          		jr	CALCLEN
                      	
                      	
  20C7                	TONE:
  20C7  216320        		ld	hl,TONETBL
  20CA  1600          		ld	d,00h
  20CC  5F            		ld	e,a
  20CD  19            		add	hl,de
  20CE  5E            		ld	e,(hl)
  20CF  CD1B20        		call	PLAYGETC
  20D2  2811          		jr	z,NOACC
  20D4  FE2B          		cp	'+'
  20D6  28CF          		jr	z,PLAYPLS
  20D8  FE23          		cp	'#'
  20DA  28CB          		jr	z,PLAYPLS
  20DC  FE2D          		cp	'-'
  20DE  28D4          		jr	z,PLAYMNS
  20E0  FE3D          		cp	'='
  20E2  CAED03        		jp	z,FCERR
                      	
  20E5                	NOACC:
  20E5  DD460F        		ld	b,(ix+OCTAVE)
  20E8  214B20        		ld	hl,SCALE
  20EB  1600          		ld	d,00h
  20ED  19            		add	hl,de
  20EE                	GETFREQ:
  20EE  7E            		ld	a,(hl)
  20EF  23            		inc	hl
  20F0  56            		ld	d,(hl)
  20F1  05            		dec	b
  20F2  2805          		jr	z,OCTAVE1
  20F4                	OCTVLP:
  20F4  CB3A          		srl	d
  20F6  1F            		rra
  20F7  10FB          		djnz	OCTVLP
  20F9                	OCTAVE1:
  20F9  5F            		ld	e,a
  20FA  DD7E12        		ld	a,(ix+VOLUME)
                      	
  20FD                	PUSHVOL:
  20FD  F5            		push	af		;volume
  20FE  D5            		push	de		;tune
  20FF  CD5621        		call	GETNUM1
  2102  B7            		or	a
  2103  2003          		jr	nz,CHKLEN
  2105  DD7E10        		ld	a,(ix+LENGTH)
  2108                	CHKLEN:
  2108  FE41          		cp	65
  210A  D2ED03        		jp	nc,FCERR
                      	
  210D                	CALCLEN:
                      	;60[s/min]/T[/min]/(L/4)/(8192/4000000[Hz])=117187.5/T/L
  210D  DD4611        		ld	b,(ix+TEMPO)	;T-value
  2110  CD5E24        		call	MULINT1		;hl=T*L (<=3fc0h)
  2113  11E2E4        		ld	de,0e4e2h	;117187.5/2
  2116  CD8924        		call	DIVINT2		;bc=(117187.5/2)/(T*L)*2
  2119  50            		ld	d,b
  211A  59            		ld	e,c
                      	
                      	;dotted note
  211B                	DOTLP:
  211B  CD1B20        		call	PLAYGETC
  211E  FE2E          		cp	'.'
  2120  200C          		jr	nz,NOTDOT
  2122  CD6A20        		call	PLAYINC
  2125  CB38          		srl	b
  2127  CB19          		rr	c
  2129  EB            		ex	de,hl
  212A  09            		add	hl,bc
  212B  EB            		ex	de,hl
  212C  18ED          		jr	DOTLP
  212E                	NOTDOT:
                      	
  212E  F3            		di
  212F  7A            		ld	a,d		;length
  2130  CD310F        		call	PUTPLBF
  2133  7B            		ld	a,e
  2134  CD310F        		call	PUTPLBF
  2137  D1            		pop	de		;tune
  2138  7A            		ld	a,d
  2139  CD310F        		call	PUTPLBF
  213C  7B            		ld	a,e
  213D  CD310F        		call	PUTPLBF
  2140  F1            		pop	af		;volume
  2141  CD310F        		call	PUTPLBF
  2144  FE10          		cp	10h
  2146  380C          		jr	c,PLCMDEND
  2148  DD7E13        		ld	a,(ix+PERIOD)	;period
  214B  CD310F        		call	PUTPLBF
  214E  DD7E14        		ld	a,(ix+PERIOD+1)
  2151  CD310F        		call	PUTPLBF
  2154                	PLCMDEND:
  2154  FB            		ei
  2155  C9            		ret
                      	
                      	
  2156                	GETNUM1:
                      	;output: a,c-flag(1=number)
                      	;destroy: f,bc,de,hl
  2156  CD6121        		call	GETNUM2
  2159  7B            		ld	a,e
  215A  D0            		ret	nc
  215B  14            		inc	d
  215C  15            		dec	d
  215D  C8            		ret	z		;c-flag=1
  215E  C3ED03        		jp	FCERR
                      	
                      	
  2161                	GETNUM2:
                      	;output: de,c-flag(1=number)
                      	;destroy: af,bc,de
  2161  CD1B20        		call	PLAYGETC
  2164  110000        		ld	de,0000h
  2167  C8            		ret	z		;c-flag=0
  2168  FE3D          		cp	'='
  216A  2835          		jr	z,GETNUMEQ
  216C  FE3B          		cp	';'
  216E  282A          		jr	z,GETNUMSEMI
  2170  D630          		sub	'0'
  2172  FE0A          		cp	'9'-'0'+1
  2174  D0            		ret	nc		;c-flag=0
  2175  2A18FD        		ld	hl,(PLAYSTR)
  2178  E5            		push	hl		;
  2179  3A17FD        		ld	a,(PLAYLEN)
  217C  47            		ld	b,a
  217D  CDD127        		call	ATOI2
  2180  2218FD        		ld	(PLAYSTR),hl
  2183  C1            		pop	bc		;
  2184  B7            		or	a
  2185  ED42          		sbc	hl,bc
  2187  3A17FD        		ld	a,(PLAYLEN)
  218A  95            		sub	l
  218B  3217FD        		ld	(PLAYLEN),a
  218E  CD1B20        		call	PLAYGETC
  2191  2805          		jr	z,GETNUMZ
  2193  FE3B          		cp	';'
  2195  CC6A20        		call	z,PLAYINC
  2198                	GETNUMZ:
  2198  37            		scf			;set c-flag
  2199  C9            		ret
                      	
  219A                	GETNUMSEMI:
  219A  CD6A20        		call	PLAYINC
  219D  AF            		xor	a		;reset c-flag
  219E  57            		ld	d,a
  219F  5F            		ld	e,a
  21A0  C9            		ret
                      	
  21A1                	GETNUMEQ:
  21A1  CD6A20        		call	PLAYINC
  21A4  11DAFE        		ld	de,INPBUF
  21A7                	GETNUMEQLP:
  21A7  CD1B20        		call	PLAYGETC
  21AA  CAED03        		jp	z,FCERR
  21AD  CD6A20        		call	PLAYINC
  21B0  CDAF0B        		call	TOUPPER2
  21B3  12            		ld	(de),a
  21B4  13            		inc	de
  21B5  FE3B          		cp	';'
  21B7  20EE          		jr	nz,GETNUMEQLP
                      	
  21B9  21DAFE        		ld	hl,INPBUF
  21BC  46            		ld	b,(hl)
  21BD  78            		ld	a,b
  21BE  D641          		sub	'A'
  21C0  FE1A          		cp	'Z'-'A'+1
  21C2  D2ED03        		jp	nc,FCERR
  21C5  23            		inc	hl
  21C6  CD9233        		call	GETNAME
                      	
  21C9  FE24          		cp	'$'
  21CB  CA0504        		jp	z,TMERR
                      	
  21CE  FE28          		cp	'('
  21D0  2811          		jr	z,GETNUMARR
                      	
  21D2  CDB633        		call	SRCHVAR
  21D5  EB            		ex	de,hl
  21D6  3003          		jr	nc,GETNUMEQNC
  21D8  21AB0E        		ld	hl,ZERO
  21DB                	GETNUMEQNC:
  21DB  CD0A0C        		call	SETF1
  21DE  CDB10C        		call	FTOI
  21E1  37            		scf
  21E2  C9            		ret
                      	
                      	
  21E3                	GETNUMARR:
  21E3  ED5B4EFF      		ld	de,(PROGAD)
  21E7  D5            		push	de
  21E8  CDAE32        		call	GETARR
  21EB  E1            		pop	hl
  21EC  224EFF        		ld	(PROGAD),hl
  21EF  EB            		ex	de,hl
  21F0  18E9          		jr	GETNUMEQNC
                      	
                      	
                      	;STICK() function
  21F2                	F_STCK:
  21F2  CD3207        		call	FNCI1		;a=0
  21F5  83            		add	a,e
  21F6  2813          		jr	z,STCK0		;e=0?
  21F8  FE03          		cp	03h
  21FA  D2ED03        		jp	nc,FCERR
  21FD  CDA61C        		call	JOYSTK
                      	;exchange bit2 and bit3
  2200  47            		ld	b,a
  2201  E60C          		and	0ch
  2203  78            		ld	a,b
  2204  EA1022        		jp	pe,CNVSTCK
  2207  EE0C          		xor	0ch
  2209  1805          		jr	CNVSTCK
                      	
  220B                	STCK0:
  220B  CD6110        		call	STICK
  220E  0F            		rrca
  220F  0F            		rrca
  2210                	CNVSTCK:
  2210  E60F          		and	0fh
  2212  211E22        		ld	hl,STCKTBL
  2215  85            		add	a,l
  2216  6F            		ld	l,a
  2217  3001          		jr	nc,STCKNC
  2219  24            		inc	h
  221A                	STCKNC:
  221A  6E            		ld	l,(hl)
  221B  C35A0C        		jp	I1TOF
                      	
  221E                	STCKTBL:
                      	;		    u   d   ud  r   ur  dr  udr
  221E  00010500030204		db	0,  1,  5,  0,  3,  2,  4,  3
                      	;		l   ul  dl  udl rl url drl udrl
  2226  07080607000105		db	7,  8,  6,  7,  0,  1,  5,  0
                      	
                      	
                      	;STRIG() function
  222E                	F_STRG:
  222E  CD3207        		call	FNCI1		;a=0
  2231  83            		add	a,e
  2232  2813          		jr	z,STRG0		;e=0?
  2234  FE03          		cp	03h
  2236  D2ED03        		jp	nc,FCERR
  2239  CDA61C        		call	JOYSTK
  223C  E610          		and	10h
  223E                	STRGEND:
  223E  CA070C        		jp	z,SETZERO
                      	;	jp	SETPLS1
                      	
  2241                	SETPLS1:
  2241  21A10E        		ld	hl,PLSONE
  2244  C30A0C        		jp	SETF1
                      	
  2247                	STRG0:
  2247  CD6110        		call	STICK
  224A  E680          		and	80h
  224C  18F0          		jr	STRGEND
                      	
                      	
                      	;LCOPY command
  224E                	C_LCPY:
  224E  218422        		ld	hl,LCPYHD
  2251  0605          		ld	b,05h
  2253                	LCPYLP1:
  2253  7E            		ld	a,(hl)
  2254  CD371A        		call	PRINTER
  2257  23            		inc	hl
  2258  10F9          		djnz	LCPYLP1
                      	
  225A  2A90FD        		ld	hl,(VRAM-1)	;h=(VRAM)
  225D  24            		inc	h
  225E  24            		inc	h
  225F  68            		ld	l,b		;b=0
  2260  3A92FD        		ld	a,(SCREEN1)
  2263  FE02          		cp	02h
  2265  3822          		jr	c,LCPYTXT
                      	
  2267                	LCPYGRP:
  2267  110018        		ld	de,1800h
  226A                	LCPYLP2:
  226A  4E            		ld	c,(hl)
  226B  CD0A1A        		call	SENDGRP
  226E  23            		inc	hl
  226F  1B            		dec	de
  2270  7A            		ld	a,d
  2271  B3            		or	e
  2272  20F6          		jr	nz,LCPYLP2
                      	
  2274                	LCPYEND:
  2274  010020        		ld	bc,2000h
  2277  CD7D22        		call	LCPYLP3
                      	
  227A  010A06        		ld	bc,060ah
  227D                	LCPYLP3:
  227D  79            		ld	a,c
  227E  CD371A        		call	PRINTER
  2281  10FA          		djnz	LCPYLP3
  2283  C9            		ret
                      	
                      	;header for lcopy
  2284                	LCPYHD:
  2284  20200A1DC1    		db	20h, 20h, 0ah, 1dh, 0c1h
                      	
                      	;lcopy text screen
  2289                	LCPYTXT:
  2289  3E04          		ld	a,04h
  228B  D393          		out	(93h),a		;CGROM ON
  228D  3A20FA        		ld	a,(HEIGHT)
  2290  47            		ld	b,a
  2291                	LCPYTLP1:
  2291  C5            		push	bc
  2292  0E0C          		ld	c,0ch
  2294                	LCPYTLP2:
  2294  0620          		ld	b,COLUMNS
  2296                	LCPYTLP3:
  2296  C5            		push	bc
  2297  7E            		ld	a,(hl)
  2298  CDA014        		call	CGROM
  229B  7B            		ld	a,e
  229C  C60C          		add	a,0ch
  229E  91            		sub	c
  229F  5F            		ld	e,a
  22A0  1A            		ld	a,(de)
                      	
  22A1  57            		ld	d,a		;
  22A2  25            		dec	h
  22A3  25            		dec	h
  22A4  7E            		ld	a,(hl)		;attribute
  22A5  24            		inc	h
  22A6  24            		inc	h
  22A7  CB77          		bit	6,a
  22A9  201F          		jr	nz,LCPYSEMI
  22AB  0F            		rrca
  22AC  7A            		ld	a,d		;
  22AD  3001          		jr	nc,NOTREV
  22AF  2F            		cpl
  22B0                	NOTREV:
  22B0  4F            		ld	c,a
  22B1  CD0A1A        		call	SENDGRP
  22B4  23            		inc	hl
  22B5  C1            		pop	bc
  22B6  10DE          		djnz	LCPYTLP3
                      	
  22B8  0D            		dec	c
  22B9  2806          		jr	z,LCPYTZ
  22BB  11E0FF        		ld	de,0-COLUMNS
  22BE  19            		add	hl,de
  22BF  18D3          		jr	LCPYTLP2
                      	
  22C1                	LCPYTZ:
  22C1  C1            		pop	bc
  22C2  10CD          		djnz	LCPYTLP1
                      	
  22C4  3E05          		ld	a,05h
  22C6  D393          		out	(93h),a		;CGROM OFF
  22C8  18AA          		jr	LCPYEND
                      	
  22CA                	LCPYSEMI:
                      	;c=	9-12	xx**....
                      	;	5-8	xx..**..
                      	;	1-4	xx....**
                      	
  22CA  7E            		ld	a,(hl)
  22CB  0D            		dec	c
  22CC  CB51          		bit	2,c
  22CE  2006          		jr	nz,SEMI58	;c=5-8
  22D0  CB59          		bit	3,c
  22D2  2804          		jr	z,SEMI14	;c=1-4
                      	
  22D4  0F            		rrca
  22D5  0F            		rrca
  22D6                	SEMI58:
  22D6  0F            		rrca
  22D7  0F            		rrca
  22D8                	SEMI14:
  22D8  E603          		and	03h
                      	
                      	;00h->00h, 01h->0fh, 02h->f0h, 03h->ffh
  22DA  1F            		rra			;c-flag=0
  22DB  3002          		jr	nc,SEMINC
  22DD  C61E          		add	a,0fh*2
  22DF                	SEMINC:
  22DF  1F            		rra			;c-flag=0
  22E0  30CE          		jr	nc,NOTREV
  22E2  C6F0          		add	a,0f0h
  22E4  18CA          		jr	NOTREV
                      	
                      	
                      	;KEY command
  22E6                	C_KEY:
  22E6  CDE40D        		call	INT1ARG
  22E9  3D            		dec	a
  22EA  FE0A          		cp	0ah
  22EC  D2ED03        		jp	nc,FCERR
  22EF  113DFB        		ld	de,FKEYTBL
  22F2  87            		add	a,a		;*2
  22F3  87            		add	a,a		;*4
  22F4  87            		add	a,a		;*8
  22F5  83            		add	a,e		;no carry
  22F6  5F            		ld	e,a
  22F7  7E            		ld	a,(hl)
  22F8  FE2C          		cp	','
  22FA  C2E403        		jp	nz,SNERR
  22FD  D5            		push	de		;
  22FE  23            		inc	hl
  22FF  CD8926        		call	STRARG
  2302  EB            		ex	de,hl
  2303  D1            		pop	de		;
                      	
  2304  01FF08        		ld	bc,08ffh
  2307  3C            		inc	a
  2308                	KEYLP1:
  2308  3D            		dec	a
  2309  2806          		jr	z,KEYLP2
  230B  EDA0          		ldi
  230D  10F9          		djnz	KEYLP1
  230F  1804          		jr	KEYEND
                      	
  2311                	KEYLP2:
  2311  12            		ld	(de),a		;a=0
  2312  13            		inc	de
  2313  10FC          		djnz	KEYLP2
  2315                	KEYEND:
  2315  C3AE12        		jp	PRTFKEY
                      	
                      	
                      	;CSAVE command
  2318                	C_CSV:
  2318  CD8926        		call	STRARG
  231B  B7            		or	a
  231C  CAED03        		jp	z,FCERR
  231F  4F            		ld	c,a
                      	
                      	;write header (d3h*10)
  2320  CDB81A        		call	WOPEN
  2323  3ED3          		ld	a,0d3h
  2325  060A          		ld	b,0ah
  2327                	CSVLP1:
  2327  CDCC1A        		call	PUTCMT
  232A  10FB          		djnz	CSVLP1
                      	
                      	;file name
  232C  0606          		ld	b,06h
                      	
  232E  0C            		inc	c
  232F                	CSVLP2:
  232F  1A            		ld	a,(de)
  2330  0D            		dec	c
  2331  2002          		jr	nz,CSVNZ
  2333  AF            		xor	a
  2334  0C            		inc	c
  2335                	CSVNZ:
  2335  CDCC1A        		call	PUTCMT
  2338  13            		inc	de
  2339  10F4          		djnz	CSVLP2
                      	
                      	;data
  233B                	CSVDATA:
  233B  01B024        		ld	bc,24b0h
  233E  CDE825        		call	WAITLP
                      	
  2341  2A5FFA        		ld	hl,(STARTAD)
  2344  ED5B56FF      		ld	de,(VARAD)
  2348                	CSVLP3:
  2348  7E            		ld	a,(hl)
  2349  CDCC1A        		call	PUTCMT
  234C  23            		inc	hl
  234D  E7            		rst	CPHLDE
  234E  20F8          		jr	nz,CSVLP3
                      	
                      	;footer (00h*9)
  2350  0609          		ld	b,09h
  2352                	CSVLP4:
  2352  CDCC1A        		call	PUTCMT		;a=0
  2355  10FB          		djnz	CSVLP4
                      	
  2357  C3061B        		jp	WCLOSE
                      	
                      	
                      	;CLOAD command
  235A                	C_CLD:
  235A  F1            		pop	af		;cancel return address
  235B  AF            		xor	a
  235C  3258FA        		ld	(DEVICE),a
                      	
  235F  4F            		ld	c,a		;file name length
  2360  CD5A3F        		call	SKIPSP
  2363  FE95          		cp	PRINT
  2365  79            		ld	a,c		;=0
  2366  2002          		jr	nz,CLDNZ1
  2368  23            		inc	hl
  2369  2F            		cpl
  236A                	CLDNZ1:
  236A  32D8FE        		ld	(VERIFY),a
  236D  F5            		push	af		;verify?
  236E  CD613F        		call	CHKCLN
  2371  2808          		jr	z,NOTARGET
  2373  CD8926        		call	STRARG
  2376  B7            		or	a
  2377  CAED03        		jp	z,FCERR
  237A  4F            		ld	c,a
  237B                	NOTARGET:
  237B  CD611A        		call	ROPEN
                      	
  237E                	CLDLP1:
  237E  EB            		ex	de,hl
  237F  CD3925        		call	GETFN
  2382  EB            		ex	de,hl
                      	
                      	;compare file name
  2383  79            		ld	a,c
  2384  B7            		or	a
  2385  2815          		jr	z,CLDFND
                      	
  2387  D5            		push	de		;target
                      	
  2388  21D1FE        		ld	hl,FNAME
  238B  0C            		inc	c
  238C  0606          		ld	b,06h
  238E                	CLDLP2:
  238E  1A            		ld	a,(de)
  238F  0D            		dec	c
  2390  2002          		jr	nz,CLDNZ2
  2392  AF            		xor	a
  2393  0C            		inc	c
  2394                	CLDNZ2:
  2394  BE            		cp	(hl)
  2395  2041          		jr	nz,CLDSKIP
  2397  23            		inc	hl
  2398  13            		inc	de
  2399  10F3          		djnz	CLDLP2
  239B  D1            		pop	de		;target
                      	
  239C                	CLDFND:
  239C  217625        		ld	hl,FOUND
  239F  CD8325        		call	PRTFN
  23A2  CD9C1A        		call	CHKVRF2
                      	
  23A5  F1            		pop	af		;verify?
  23A6  4F            		ld	c,a		;c=0: not verify
                      	
  23A7  2A5FFA        		ld	hl,(STARTAD)
  23AA                	CLDLP3:
  23AA  060A          		ld	b,0ah
  23AC                	CLDLP4:
  23AC  EB            		ex	de,hl
  23AD  21FEFF        		ld	hl,0-0002h
  23B0  39            		add	hl,sp
  23B1  E7            		rst	CPHLDE
  23B2  2833          		jr	z,CLDOM		;over memory error
  23B4  EB            		ex	de,hl
  23B5  CD8F1A        		call	GETCMTTR
  23B8  0C            		inc	c
  23B9  0D            		dec	c
  23BA  2803          		jr	z,CLDZ2		;c=0: not verify
  23BC  BE            		cp	(hl)
  23BD  2031          		jr	nz,CLDBAD
  23BF                	CLDZ2:
  23BF  77            		ld	(hl),a
  23C0  23            		inc	hl
  23C1  B7            		or	a
  23C2  20E6          		jr	nz,CLDLP3
  23C4  CD2A1B        		call	BLNKAST
  23C7  10E3          		djnz	CLDLP4
  23C9  CDAA1A        		call	RCLOSE
                      	
  23CC  2256FF        		ld	(VARAD),hl
                      	;	inc	c
                      	;	dec	c
                      	;	call	z,RESSTK	;c=0: not verify
  23CF  CDF934        		call	RESSTK
                      	
  23D2  CDD804        		call	CHGLKP
  23D5  C34504        		jp	EDIT2
                      	
  23D8                	CLDSKIP:
  23D8  217D25        		ld	hl,SKIP
  23DB  CD8325        		call	PRTFN
                      	
                      	;check footer (00h*10)
  23DE  11000A        		ld	de,0a00h
  23E1  CD4E25        		call	CMTSKP
  23E4  D1            		pop	de		;target
  23E5  1897          		jr	CLDLP1
                      	
  23E7                	CLDOM:
  23E7  CDAA1A        		call	RCLOSE
  23EA  CDDC34        		call	NEW
  23ED  C3F303        		jp	OMERR
                      	
  23F0                	CLDBAD:
  23F0  CDAA1A        		call	RCLOSE
  23F3  21F923        		ld	hl,BAD
  23F6  C3DB00        		jp	PUTSEDIT
                      	
  23F9                	BAD:
  23F9  42616400      		db	"Bad", 00h
                      	
                      	
                      	;input by external device
                      	;input: a=(INPDEV), hl=INPBUF-1
                      	;destroy: af,bc,de,hl
  23FD                	INPTEXT:
  23FD  FE02          		cp	02h
  23FF  F5            		push	af
  2400  2807          		jr	z,INPT232
  2402  07            		rlca
  2403  D2ED03        		jp	nc,FCERR
  2406  CD9A25        		call	INPOPN
  2409                	INPT232:
  2409  21DAFE        		ld	hl,INPBUF
  240C  0647          		ld	b,71
  240E                	INPTEXTLP:
  240E  F1            		pop	af
  240F  F5            		push	af
  2410  2023          		jr	nz,INPTCMT
                      	
  2412  E5            		push	hl
  2413                	INPT232LP:
  2413  3A18FA        		ld	a,(STOPFLG)
  2416  FE03          		cp	03h
  2418  CA5127        		jp	z,STOPSP
  241B  CD4310        		call	GETRSBF
  241E  28F3          		jr	z,INPT232LP
  2420  E1            		pop	hl
  2421                	INPTCHKRET:
  2421  FE0D          		cp	0dh
  2423  2804          		jr	z,INPTEXTEND
  2425  77            		ld	(hl),a
  2426  23            		inc	hl
  2427  10E5          		djnz	INPTEXTLP
                      	
  2429                	INPTEXTEND:
  2429  F1            		pop	af
  242A  C4AA1A        		call	nz,RCLOSE
  242D  3600          		ld	(hl),0
  242F  21D9FE        		ld	hl,INPBUF-1
  2432  C3D809        		jp	INPTANA
                      	
  2435                	INPTCMT:
  2435  CD8F1A        		call	GETCMTTR
  2438  18E7          		jr	INPTCHKRET
                      	
  243A                	EXTRA:
  243A  3F457874726120		db	"?Extra ignored", 0dh, 0ah, 00h
                      	
  244B                	REDO:
  244B  3F5265646F2066		db	"?Redo from start", 0dh, 0ah, 00h
                      	
                      	
                      	;hl=a*b
                      	;input: a,b
                      	;output: hl
                      	;destroy: af,c
  245E                	MULINT1:
  245E  210000        		ld	hl,0000h
  2461  4D            		ld	c,l		;=0
  2462  1801          		jr	MULI1NZ
  2464                	MULI1C:
  2464  09            		add	hl,bc
  2465                	MULI1NZ:
  2465  CB38          		srl	b
  2467  CB19          		rr	c
  2469  87            		add	a,a
  246A  38F8          		jr	c,MULI1C
  246C  20F7          		jr	nz,MULI1NZ
  246E  C9            		ret
                      	
                      	
                      	;dehl=de*hl
                      	;input: de,hl
                      	;output: dehl
                      	;destroy: af,bc
  246F                	MULINT2:
  246F  7C            		ld	a,h
  2470  4D            		ld	c,l
  2471  210000        		ld	hl,0000h
  2474  0610          		ld	b,10h
  2476                	MULI2LP:
  2476  1F            		rra
  2477  CB19          		rr	c
  2479  3001          		jr	nc,MULI2NC
  247B  19            		add	hl,de
  247C                	MULI2NC:
  247C  CB1C          		rr	h
  247E  CB1D          		rr	l
  2480  10F4          		djnz	MULI2LP
  2482  1F            		rra
  2483  CB19          		rr	c
  2485  59            		ld	e,c
  2486  57            		ld	d,a
  2487  EB            		ex	de,hl
  2488  C9            		ret
                      	
                      	
                      	;bc=de/hl*2
                      	;input: de,hl(<8000h)
                      	;output: bc
                      	;destroy: af,de,hl
  2489                	DIVINT2:
  2489  AF            		xor	a
  248A  010002        		ld	bc,0200h	;*2^(b-1)
  248D                	DIVILP1:
  248D  04            		inc	b
  248E  ED6A          		adc	hl,hl		;c-flag=0
  2490  F28D24        		jp	p,DIVILP1
  2493  EB            		ex	de,hl
  2494                	DIVILP2:
  2494  B7            		or	a
  2495  ED52          		sbc	hl,de
  2497  3001          		jr	nc,DIVNC
  2499  19            		add	hl,de
  249A                	DIVNC:
  249A  3F            		ccf
  249B  CB11          		rl	c
  249D  17            		rla
  249E  CB3A          		srl	d
  24A0  CB1B          		rr	e
  24A2  10F0          		djnz	DIVILP2
                      	
  24A4  47            		ld	b,a
  24A5  C9            		ret
                      	
                      	
                      	;add 4-byte integer and 4byte integer
                      	;input: FAC1(integer),FAC2(integer)
                      	;output: FAC1(integer),f
                      	;destroy: de,hl
  24A6                	ADDINT4:
  24A6  2A66FF        		ld	hl,(FAC1)
  24A9  ED5B6DFF      		ld	de,(FAC2)
  24AD  19            		add	hl,de
  24AE  2266FF        		ld	(FAC1),hl
  24B1  2A68FF        		ld	hl,(FAC1+2)
  24B4  ED5B6FFF      		ld	de,(FAC2+2)
  24B8  ED5A          		adc	hl,de
  24BA  2268FF        		ld	(FAC1+2),hl
  24BD  C9            		ret
                      	
                      	
                      	;subtract 4-byte integer from 4byte integer
                      	;input: FAC1(integer),FAC2(integer)
                      	;output: FAC1(integer),f
                      	;destroy: de,hl
  24BE                	SUBINT4:
  24BE  2A66FF        		ld	hl,(FAC1)
  24C1  ED5B6DFF      		ld	de,(FAC2)
  24C5  B7            		or	a
  24C6  ED52          		sbc	hl,de
  24C8  2266FF        		ld	(FAC1),hl
  24CB  2A68FF        		ld	hl,(FAC1+2)
  24CE  ED5B6FFF      		ld	de,(FAC2+2)
  24D2  ED52          		sbc	hl,de
  24D4  2268FF        		ld	(FAC1+2),hl
  24D7  C9            		ret
                      	
                      	
                      	;a=FAC1(int4)/(hl)<=9, FAC1%=(hl), hl+=4
                      	;input: FAC1(integer), hl=division factor (4byte int) address
                      	;output: a=FAC1/(hl4), FAC1=FAC1%(hl4), hl=hl+4, a=[0,9]
                      	;destroy: f,FAC2
  24D8                	DIVINT4:
  24D8  C5            		push	bc
  24D9  D5            		push	de
  24DA  CD180C        		call	SETF2
  24DD  2B            		dec	hl
  24DE  E5            		push	hl
  24DF  AF            		xor	a
  24E0                	DIVINT4LP:
  24E0  3C            		inc	a
  24E1  CDBE24        		call	SUBINT4
  24E4  30FA          		jr	nc,DIVINT4LP
  24E6  3D            		dec	a
  24E7  CDA624        		call	ADDINT4
  24EA  E1            		pop	hl
  24EB  D1            		pop	de
  24EC  C1            		pop	bc
  24ED  C9            		ret
                      	
                      	
                      	;negate 4-byte integer
                      	;input: FAC1(integer)
                      	;output: FAC1(integer), c-flag, z-flag
                      	;destroy: af,hl
  24EE                	NEGINT4:
  24EE  2166FF        		ld	hl,FAC1
  24F1  AF            		xor	a
  24F2  96            		sub	(hl)
  24F3  77            		ld	(hl),a
  24F4  23            		inc	hl
  24F5  3E00          		ld	a,00h
  24F7  9E            		sbc	a,(hl)
  24F8  77            		ld	(hl),a
  24F9  23            		inc	hl
  24FA  3E00          		ld	a,00h
  24FC  9E            		sbc	a,(hl)
  24FD  77            		ld	(hl),a
  24FE  23            		inc	hl
  24FF  3E00          		ld	a,00h
  2501  9E            		sbc	a,(hl)
  2502  77            		ld	(hl),a
  2503  C9            		ret
                      	
                      	
                      	;compare 4-byte integer and 4-byte integer
                      	;input: FAC1(integer), FAC2(integer)
                      	;output: c-flag,z-flag
                      	;destroy: f,de,hl
  2504                	CMPINT4:
  2504  2A68FF        		ld	hl,(FAC1+2)
  2507  ED5B6FFF      		ld	de,(FAC2+2)
  250B  B7            		or	a
  250C  ED52          		sbc	hl,de
  250E  C0            		ret	nz
  250F  2A66FF        		ld	hl,(FAC1)
  2512  ED5B6DFF      		ld	de,(FAC2)
  2516  ED52          		sbc	hl,de
  2518  C9            		ret
                      	
                      	
                      	;decrement 4-byte integer
                      	;input: FAC1
                      	;output: FAC1
                      	;destroy: af,hl
  2519                	DECINT4:
  2519  2A66FF        		ld	hl,(FAC1)
  251C  7C            		ld	a,h
  251D  B5            		or	l		;
  251E  2B            		dec	hl
  251F  2266FF        		ld	(FAC1),hl
  2522  C0            		ret	nz		;
  2523  2A68FF        		ld	hl,(FAC1+2)
  2526  2B            		dec	hl
  2527  2268FF        		ld	(FAC1+2),hl
  252A  C9            		ret
                      	
                      	
                      	;4-byte integer=0?
                      	;output: a(4 bytes OR),z
                      	;destroy: af
  252B                	CHKINT4:
  252B  E5            		push	hl
  252C  2A66FF        		ld	hl,(FAC1)
  252F  7C            		ld	a,h
  2530  B5            		or	l
  2531  2A68FF        		ld	hl,(FAC1+2)
  2534  B4            		or	h
  2535  B5            		or	l
  2536  E1            		pop	hl
  2537  C9            		ret
                      	
                      	
                      	;check cload header and get file name
                      	;destroy: af,b,de (if no error)
  2538                	_GETFN:	ds	GETFN-_GETFN
  2539                		org	GETFN
                      	
                      	;check header (d3h*10)
  2539  11D30A        		ld	de,0ad3h
  253C  CD4E25        		call	CMTSKP
                      	;file name
  253F  11D1FE        		ld	de,FNAME
                      	
  2542  0606          		ld	b,06h
  2544                	GETFNLP:
  2544  CD8F1A        		call	GETCMTTR
  2547  12            		ld	(de),a
  2548  13            		inc	de
  2549  10F9          		djnz	GETFNLP
  254B  C9            		ret
                      	
                      	
                      	;skip CMT data
                      	;input: d=count, e=data
                      	;destroy: af,b
  254C                	_CMTSKP:ds	CMTSKP-_CMTSKP
  254E                		org	CMTSKP
                      	
  254E  42            		ld	b,d
  254F                	CMTSKPLP:
  254F  CD8F1A        		call	GETCMTTR
  2552  BB            		cp	e
  2553  20F9          		jr	nz,CMTSKP
  2555  10F8          		djnz	CMTSKPLP
  2557  C9            		ret
                      	
                      	
  2558                	_FOUND:	ds	FOUND-_FOUND
  2576                		org	FOUND
                      	
  2576  466F756E643A00		db	"Found:", 00h
                      	
  257D                	SKIP:
  257D  536B69703A00  		db	"Skip:", 00h
                      	
                      	
                      	;print message and file name
                      	;input: hl=message address
                      	;destroy: af,hl,(bc,de,FAC1)
  2583                	_PRTFN:ds	PRTFN-_PRTFN
  2583                		org	PRTFN
                      	
  2583  CDCF30        		call	PUTS
  2586  21D1FE        		ld	hl,FNAME
  2589  CDCF30        		call	PUTS
  258C  C33927        		jp	PUTNL
                      	
                      	
                      	;CMT open for INPUT #-1
                      	;destroy: af,b
  258F                	_INPOPN:ds	INPOPN-_INPOPN
  259A                		org	INPOPN
                      	
                      	;	ld	a,0ffh
                      	;	ld	(VERIFY),a
                      	;	call	ROPEN
  259A  CD5C1A        		call	VRFOPN
  259D  D5            		push	de
  259E  119C06        		ld	de,069ch
  25A1  CD4E25        		call	CMTSKP
  25A4  D1            		pop	de
  25A5  C9            		ret
                      	
                      	
                      	;CMT open for PRINT #-1
                      	;destroy: a,b
  25A6                	_PRTOPN:ds	PRTOPN-_PRTOPN
  25A8                		org	PRTOPN
                      	
  25A8  CDB81A        		call	WOPEN
  25AB  3E9C          		ld	a,9ch
  25AD  0606          		ld	b,06h
  25AF                	PRTOPNLP:
  25AF  CDCC1A        		call	PUTCMT
  25B2  10FB          		djnz	PRTOPNLP
  25B4  C9            		ret
                      	
                      	
                      	;convert intermediate code to command/function ascii characters
                      	;input: a=code
                      	;output: a=first character, hl=address
                      	;destroy: f,b,hl
  25B5                	CNVASC:
  25B5  212B02        		ld	hl,CMDNAME-1
  25B8  FEAB          		cp	CMDLAST+1
  25BA  3819          		jr	c,CNVASCC
  25BC  213941        		ld	hl,CMDNAME66-1
  25BF  FEC2          		cp	CLAST66+1
  25C1  3004          		jr	nc,CNVFNC
  25C3  D62B          		sub	CMDLAST-7fh
  25C5  180E          		jr	CNVASCC
                      	
                      	;function
  25C7                	CNVFNC:
  25C7  21E302        		ld	hl,FNCNAME-1
  25CA  D642          		sub	TAB-80h
  25CC  FEB0          		cp	FNCLAST-(TAB-80h)+1
  25CE  3805          		jr	c,CNVASCC
  25D0  21A141        		ld	hl,FNCNAME66-1
  25D3  D630          		sub	FNCLAST+1-TAB
                      	
  25D5                	CNVASCC:
  25D5  D67F          		sub	7fh
  25D7  47            		ld	b,a
  25D8                	CNVASCLP:
  25D8  23            		inc	hl
  25D9  7E            		ld	a,(hl)
  25DA  D680          		sub	80h
  25DC  38FA          		jr	c,CNVASCLP
  25DE  10F8          		djnz	CNVASCLP
  25E0  C9            		ret
                      	
                      	
                      	;wait for about 3.5s
                      	;destroy: af,bc
  25E1                	_WAIT:	ds	WAIT-_WAIT
  25E5                		org	WAIT
                      	
  25E5  010000        		ld	bc,0000h
                      	;25e8
  25E8                	WAITLP:
  25E8  3A18FA        		ld	a,(STOPFLG)
  25EB  FE03          		cp	03h
  25ED  C8            		ret	z
                      	
  25EE  F1            		pop	af		;waste time
  25EF  F5            		push	af		;waste time
                      	
  25F0  0B            		dec	bc
  25F1  78            		ld	a,b
  25F2  B1            		or	c
  25F3  C8            		ret	z
  25F4  18F2          		jr	WAITLP
                      	
                      	
                      	;EXEC command
  25F6                	C_EXEC:
  25F6  CD6F0B        		call	NUMARGMO
  25F9  CDB10C        		call	FTOI
                      	
                      	;for compatibility with N60-BASIC
  25FC  2A4EFF        		ld	hl,(PROGAD)
  25FF  EB            		ex	de,hl
  2600  7C            		ld	a,h
  2601  B5            		or	l
  2602  ED44          		neg		;set c-flag if hl<>0
  2604  D5            		push	de
  2605  CDA507        		call	JPHL
  2608  D1            		pop	de
  2609  C9            		ret
                      	
                      	
                      	;get a character from buffer
                      	;input: hl=buffer map address
                      	;output: a,z-flag(1=no input)
                      	;destroy: f,hl
  260A                	GETBF:
  260A  7E            		ld	a,(hl)		;in
  260B  2C            		inc	l		;inc hl
  260C  BE            		cp	(hl)		;out
  260D  C8            		ret	z
  260E  7E            		ld	a,(hl)
  260F  3C            		inc	a
  2610  2C            		inc	l		;inc hl
  2611  2C            		inc	l		;inc hl
  2612  A6            		and	(hl)		;size
  2613  2D            		dec	l		;dec hl
  2614  2D            		dec	l		;dec hl
  2615  77            		ld	(hl),a		;out
  2616  2C            		inc	l		;inc hl
  2617  2C            		inc	l		;inc hl
  2618  2C            		inc	l		;inc hl
  2619  86            		add	a,(hl)		;hl=(buffer address)+a
  261A  2C            		inc	l		;inc hl, l>0, reset z-flag
  261B  66            		ld	h,(hl)
  261C  6F            		ld	l,a
  261D  3001          		jr	nc,GETBFNC
  261F  24            		inc	h		;h>0, reset z-flag
  2620                	GETBFNC:
  2620  7E            		ld	a,(hl)
  2621  C9            		ret
                      	
                      	
                      	;input: a=length, hl=string address
                      	;destroy: af,bc,de,hl
  2622                	MAKESTR:
  2622  322DFF        		ld	(STRDSC1),a
  2625  222FFF        		ld	(STRDSC1+2),hl
  2628  AF            		xor	a
  2629  1803          		jr	ADDSTR2
                      	
                      	;input: STRDSC1, STRDSC4
                      	;destroy: af,bc,de,hl
  262B                	ADDSTR:
  262B  3A39FF        		ld	a,(STRDSC4)
  262E                	ADDSTR2:
  262E  47            		ld	b,a		;;
  262F  3A2DFF        		ld	a,(STRDSC1)
  2632  4F            		ld	c,a		;
  2633  80            		add	a,b		;c+b
  2634  DA0B04        		jp	c,LSERR		;over 255 characters
                      	
  2637  CD6526        		call	GCCHECK
  263A  223DFF        		ld	(STRAD),hl
  263D  23            		inc	hl
  263E  EB            		ex	de,hl
  263F  2A2FFF        		ld	hl,(STRDSC1+2)
  2642  ED532FFF      		ld	(STRDSC1+2),de
                      	
  2646  78            		ld	a,b		;;
  2647  81            		add	a,c		;
  2648  322DFF        		ld	(STRDSC1),a
  264B  90            		sub	b		;c=0?
                      	
  264C  78            		ld	a,b
  264D  0600          		ld	b,00h
  264F  2802          		jr	z,ADDSZ1
  2651  EDB0          		ldir
  2653                	ADDSZ1:
  2653  B7            		or	a
  2654  2806          		jr	z,ADDSZ2
  2656  4F            		ld	c,a		;b=0
  2657  2A3BFF        		ld	hl,(STRDSC4+2)
  265A  EDB0          		ldir
  265C                	ADDSZ2:
  265C  AF            		xor	a
  265D  3239FF        		ld	(STRDSC4),a
  2660  3C            		inc	a
  2661  3225FF        		ld	(ARGTYP),a	;=1
  2664  C9            		ret
                      	
                      	
                      	;check string area and call GC if necessary
                      	;input: a=new string length
                      	;output: hl=new (STRAD)+1
                      	;destroy: af,de
  2665                	GCCHECK:
  2665  C5            		push	bc
  2666  1600          		ld	d,00h
  2668  5F            		ld	e,a
  2669  D5            		push	de
  266A  CD7D26        		call	CHKSAREA
  266D  D1            		pop	de
  266E  300B          		jr	nc,GCCHECKOK
  2670  D5            		push	de
  2671  CD0F31        		call	GC
  2674  D1            		pop	de
  2675  CD7D26        		call	CHKSAREA
  2678  DA0804        		jp	c,OSERR
  267B                	GCCHECKOK:
  267B  C1            		pop	bc
  267C  C9            		ret
                      	
                      	;check string area
  267D                	CHKSAREA:
  267D  2A3DFF        		ld	hl,(STRAD)
  2680  B7            		or	a
  2681  ED52          		sbc	hl,de
  2683  ED5B5BFA      		ld	de,(STACK)
  2687  E7            		rst	CPHLDE
  2688  C9            		ret
                      	
                      	
                      	;get a string argument
                      	;input: hl=program address
                      	;output: a=length, de=string address, hl=next address, z-flag(1=ok)
                      	;destroy: f,bc,FAC1,FAC2
  2689                	STRARG:
  2689  CD613F        		call	CHKCLN
  268C  CA1A04        		jp	z,MOERR
  268F                	STRARG3:
  268F  CD6617        		call	ARG
  2692                	STRARG2:
  2692  EB            		ex	de,hl
  2693  CD840B        		call	CHKSTR
                      	;get string pointer
  2696  23            		inc	hl
  2697  23            		inc	hl
  2698  46            		ld	b,(hl)
  2699  23            		inc	hl
  269A  66            		ld	h,(hl)
  269B  68            		ld	l,b
  269C  EB            		ex	de,hl
  269D  C9            		ret
                      	
                      	
                      	;get string,integer argument
                      	;input: hl=program address
                      	;output: STRDSC1, a=length, hl=string address, FAC1,de=integer
                      	;destroy: FAC1, FAC2, f,bc
  269E                	ARGSI1:
  269E  CD920B        		call	CHKLPAR
  26A1  CD8926        		call	STRARG
  26A4  F5            		push	af
  26A5  322DFF        		ld	(STRDSC1),a	;length
  26A8  ED532FFF      		ld	(STRDSC1+2),de	;string address
  26AC  7E            		ld	a,(hl)
  26AD  FE2C          		cp	','
  26AF  C2E403        		jp	nz,SNERR
  26B2  CDBA26        		call	ARGI1
  26B5  2A2FFF        		ld	hl,(STRDSC1+2)	;string address
  26B8  F1            		pop	af		;length
  26B9  C9            		ret
                      	
                      	
                      	;protect string descriptor and get integer argument
                      	;input: hl=program address
                      	;output: FAC1,de=integer
                      	;destroy: FAC1, FAC2, af, bc, de
  26BA                	ARGI1:
  26BA  E5            		push	hl		;program address
  26BB  CDE419        		call	COPYSTR
  26BE  E1            		pop	hl
  26BF  CDE30D        		call	INT1INC
  26C2  C3F819        		jp	BACKSTR
                      	
                      	
                      	;put a character in device
                      	;input: a=character code, (DEVICE)=0:CRT, 1:printer, 2:RS-232C, 80h-ffh:CMT
                      	;destroy: af
  26C5                	_PUTDEV:ds	PUTDEV-_PUTDEV
  26C7                		org	PUTDEV
                      	
  26C7  F5            		push	af
  26C8  3A58FA        		ld	a,(DEVICE)
  26CB  B7            		or	a
  26CC  2834          		jr	z,PUTCRT
  26CE  FACD1A        		jp	m,PUTCMT2
  26D1  3D            		dec	a
  26D2  2805          		jr	z,PUTPRT2
  26D4  3D            		dec	a
  26D5  282F          		jr	z,PUT232
  26D7  F1            		pop	af
  26D8  C9            		ret
                      	
                      	
  26D9                	PUTPRT2:
  26D9  F1            		pop	af
  26DA  FE09          		cp	09h
  26DC  2812          		jr	z,PUTPRTTAB
  26DE                	PUTPRT3:
  26DE  F5            		push	af
  26DF  CD1C1A        		call	PUTPRT
  26E2  F1            		pop	af
  26E3  D60D          		sub	0dh
  26E5  2805          		jr	z,PUTPRTZ	;a=0 if CR
  26E7  D8            		ret	c
  26E8  3A57FA        		ld	a,(PRTPOS)
  26EB  3C            		inc	a
  26EC                	PUTPRTZ:
  26EC  3257FA        		ld	(PRTPOS),a
  26EF  C9            		ret
                      	
                      	
  26F0                	PUTPRTTAB:
  26F0  C5            		push	bc
  26F1  3A57FA        		ld	a,(PRTPOS)
  26F4  2F            		cpl
  26F5  E607          		and	07h
  26F7  3C            		inc	a
  26F8  47            		ld	b,a
  26F9                	PUTPRTTABLP:
  26F9  3E20          		ld	a,' '
  26FB  CDDE26        		call	PUTPRT3
  26FE  10F9          		djnz	PUTPRTTABLP
  2700  C1            		pop	bc
  2701  C9            		ret
                      	
                      	
  2702                	PUTCRT:
  2702  F1            		pop	af
  2703  C37510        		jp	PUTC
                      	
                      	
                      	;input: a
                      	;output: none
                      	;destroy: af
  2706                	PUT232:
  2706  3E17          		ld	a,17h		;RTS=0
  2708  D381          		out	(81h),a
                      	
  270A                	PUT232LP:
  270A  DB81          		in	a,(81h)
  270C  2F            		cpl
  270D  E681          		and	81h
  270F  280C          		jr	z,PUT232Z	;if DSR=1, TxRDY=1
                      	
  2711  3A18FA        		ld	a,(STOPFLG)
  2714  FE03          		cp	03h
  2716  20F2          		jr	nz,PUT232LP
                      	;stop
  2718  CD2027        		call	PUT232END
  271B  1834          		jr	STOPSP
                      	
  271D                	PUT232Z:
  271D  F1            		pop	af
  271E  D380          		out	(80h),a
  2720                	PUT232END:
  2720  3E37          		ld	a,37h		;RTS=1
  2722  D381          		out	(81h),a
  2724  C9            		ret
                      	
                      	
                      	;put new line
                      	;destroy: af
  2725                	_PUTNL:	ds	PUTNL-_PUTNL
  2739                		org	PUTNL
                      	
  2739  3E0D          		ld	a,0dh
  273B  CDC726        		call	PUTDEV
  273E  3E0A          		ld	a,0ah
  2740  C3C726        		jp	PUTDEV
                      	
                      	
                      	;STOP and ESC
                      	;destroy: af
  2743                	_STOPESC:ds	STOPESC-_STOPESC
  274D                		org	STOPESC
                      	
  274D  CD5B27        		call	CHKSTOP
  2750  C0            		ret	nz
                      	;	jp	STOPSP
                      	
                      	;reset sp and stop
  2751                	STOPSP:
  2751  ED7B5BFA      		ld	sp,(STACK)
  2755  21FFFF        		ld	hl,0ffffh
  2758  C33B35        		jp	STOP2
                      	
                      	
                      	;check STOP/ESC
                      	;output: z-flag (1=STOP)
                      	;destroy: af
  275B                	CHKSTOP:
  275B  3A18FA        		ld	a,(STOPFLG)
  275E  FE03          		cp	03h
  2760  C8            		ret	z
  2761  FE1B          		cp	1bh
  2763  C0            		ret	nz
  2764  CDBC0F        		call	GETCH		;cancel ESC
  2767                	CHKSTLP:
  2767  3A18FA        		ld	a,(STOPFLG)
  276A  FE1B          		cp	1bh
  276C  28F9          		jr	z,CHKSTLP
  276E  CDBC0F        		call	GETCH		;ESC end
  2771  18E8          		jr	CHKSTOP
                      	
                      	
                      	;get device number
                      	;in	out
                      	;#0	0	CRT
                      	;#-1	80h	CMT
                      	;#-2	2	RS-232C
                      	;#-3	1	printer
                      	;input: hl=program address
                      	;output: a, hl,(PROGAD)=next address
                      	;destroy: f,bc,de
  2773                	DEVNUM:
  2773  CD5A3F        		call	SKIPSP
  2776  FE23          		cp	'#'
  2778  3E00          		ld	a,00h
  277A  C0            		ret	nz
                      	
  277B  23            		inc	hl
  277C  CD1A0E        		call	INT2ARG
  277F  E5            		push	hl
  2780  1B            		dec	de
  2781  210400        		ld	hl,0004h
  2784  19            		add	hl,de
  2785  D2ED03        		jp	nc,FCERR
  2788  7D            		ld	a,l
  2789  3C            		inc	a
  278A  FE03          		cp	03h
  278C  3803          		jr	c,DEVNUMC	;#-2,#-3
  278E  E601          		and	01h
  2790  0F            		rrca
  2791                	DEVNUMC:
  2791  E1            		pop	hl
  2792  F5            		push	af
  2793  CD6C3F        		call	CHKCMM
  2796  C2E403        		jp	nz,SNERR
  2799  224EFF        		ld	(PROGAD),hl
  279C  F1            		pop	af
  279D  C9            		ret
                      	
                      	
                      	;INKEY$
  279E                	F_INKY:
  279E  21B118        		ld	hl,FNCRTN
  27A1  E5            		push	hl
                      	
  27A2  CDBC0F        		call	GETCH
  27A5  2827          		jr	z,INKYZ
                      	
  27A7  FE03          		cp	03h
  27A9  2823          		jr	z,INKYZ
  27AB  FE1B          		cp	1bh
  27AD  281F          		jr	z,INKYZ
                      	
  27AF  47            		ld	b,a		;
  27B0                	INKYNZ:
  27B0  3E01          		ld	a,01h
  27B2  CD6526        		call	GCCHECK
  27B5  223DFF        		ld	(STRAD),hl
  27B8  23            		inc	hl
  27B9  70            		ld	(hl),b		;
  27BA  222FFF        		ld	(STRDSC1+2),hl
  27BD  3E01          		ld	a,01h
  27BF                	INKYLEN:
  27BF  322DFF        		ld	(STRDSC1),a
                      	
  27C2                	INKYEND:
  27C2  212DFF        		ld	hl,STRDSC1
  27C5  2267FF        		ld	(FAC1+1),hl
  27C8  3E01          		ld	a,01h
  27CA  3225FF        		ld	(ARGTYP),a
  27CD  C9            		ret
                      	
  27CE                	INKYZ:
  27CE  AF            		xor	a
  27CF  18EE          		jr	INKYLEN
                      	
                      	
                      	;convert string to 2-byte integer (unsigned)
                      	;input: hl=program address, b=string length
                      	;output: de=integer, hl=next address
                      	;destroy: af,bc
  27D1                	ATOI2:
  27D1  110000        		ld	de,0000h
  27D4  2B            		dec	hl
  27D5                	ATOI2LP:
  27D5  23            		inc	hl
  27D6  7E            		ld	a,(hl)
  27D7  FE20          		cp	' '
  27D9  28FA          		jr	z,ATOI2LP
  27DB  D630          		sub	'0'
  27DD  FE0A          		cp	'9'-'0'+1
  27DF  D0            		ret	nc
                      	
  27E0  E5            		push	hl
                      	
  27E1  2166E6        		ld	hl,0-6554
  27E4  19            		add	hl,de
  27E5  3813          		jr	c,ATOI2END
                      	
  27E7  62            		ld	h,d
  27E8  6B            		ld	l,e
  27E9  29            		add	hl,hl
  27EA  29            		add	hl,hl
  27EB  19            		add	hl,de
  27EC  29            		add	hl,hl
                      	
  27ED  85            		add	a,l
  27EE  6F            		ld	l,a
  27EF  3003          		jr	nc,ATOI2NC
  27F1  24            		inc	h
  27F2  2806          		jr	z,ATOI2END
                      	
  27F4                	ATOI2NC:
  27F4  EB            		ex	de,hl
  27F5  E1            		pop	hl
  27F6  10DD          		djnz	ATOI2LP
  27F8  23            		inc	hl
  27F9  C9            		ret
                      	
  27FA                	ATOI2END:
  27FA  E1            		pop	hl
  27FB  C9            		ret
                      	
                      	
                      	;convert string to float (integer part)
                      	;input: b=length, hl=program address
                      	;output: FAC1, hl=next address, b=remained length, d=sign(0=plus, 1=minus)
                      	;destroy: FAC2, af,de
  27FC                	ATOIF:
  27FC  78            		ld	a,b		;
  27FD  E5            		push	hl
  27FE  CD070C        		call	SETZERO
  2801  E1            		pop	hl
  2802  47            		ld	b,a		;
  2803  1600          		ld	d,00h		;sign
                      	
  2805                	ATOIFLP1:
  2805  CD8C3A        		call	SKIPSPB
  2808  C8            		ret	z		;all space
                      	
  2809  05            		dec	b
  280A  FE2B          		cp	'+'
  280C  2810          		jr	z,ATOIFLP2
  280E  FECA          		cp	PLUS
  2810  280C          		jr	z,ATOIFLP2
  2812  14            		inc	d
  2813  FE2D          		cp	'-'
  2815  2807          		jr	z,ATOIFLP2
  2817  FECB          		cp	MINUS
  2819  2803          		jr	z,ATOIFLP2
  281B  04            		inc	b
  281C  15            		dec	d
  281D  2B            		dec	hl
  281E                	ATOIFLP2:
  281E  CD2528        		call	CTOF
  2821  D0            		ret	nc
  2822  10FA          		djnz	ATOIFLP2
  2824  C9            		ret
                      	
                      	
                      	;FAC1 = FAC1 * 10 + [0-9]
                      	;input: FAC1, hl=program address, b=length(>0), d=sign(0=plus, 1=minus)
                      	;output: FAC1, c-flag(1=OK), b=remained length(for space), hl=next address
                      	;destroy: FAC2,af
  2825                	CTOF:
  2825  CD8C3A        		call	SKIPSPB
  2828  2B            		dec	hl
  2829  C8            		ret	z
                      	
  282A  D630          		sub	'0'
  282C  FE0A          		cp	'9'-'0'+1
  282E  D0            		ret	nc
  282F  23            		inc	hl
  2830  E5            		push	hl		;program address
                      	
  2831  D5            		push	de
  2832  C5            		push	bc
  2833  F5            		push	af
  2834  CD1939        		call	ABS
  2837  CD9037        		call	MULF10
  283A  CD5B39        		call	CPYFAC
  283D  F1            		pop	af
  283E  CD590C        		call	I1TOFA
  2841  CD8F36        		call	ADDF
  2844  C1            		pop	bc
  2845  D1            		pop	de
                      	
  2846  7A            		ld	a,d
  2847  0F            		rrca
  2848  DC2C0D        		call	c,NEGABS2
                      	
  284B  E1            		pop	hl		;program address
  284C  37            		scf
  284D  C9            		ret
                      	
                      	
                      	;insert a character
                      	;input: a=data (for checking BELL)
                      	;output: hl=VRAM address
                      	;destroy: f,bc,de
  284E                	INSERT:
  284E  FE07          		cp	07h
  2850  2005          		jr	nz,INSNZ
  2852  CD7510        		call	PUTC
  2855  3E20          		ld	a,' '
  2857                	INSNZ:
  2857  F5            		push	af
                      	
  2858  2AAAFD        		ld	hl,(CSRAD)
                      	
  285B  CDD128        		call	GETSCRC
  285E  47            		ld	b,a		;
                      	
  285F  23            		inc	hl
  2860  CD6315        		call	CHKLINE
  2863  201C          		jr	nz,INSSCRL
                      	
  2865  CDF915        		call	CNVATT1
  2868  4F            		ld	c,a
                      	
  2869                	INSLP:
  2869  CDD128        		call	GETSCRC
                      	
  286C  E5            		push	hl
  286D  CD520E        		call	CHR2ATT
  2870  71            		ld	(hl),c
  2871  E1            		pop	hl
                      	
  2872  70            		ld	(hl),b
  2873  47            		ld	b,a
  2874  23            		inc	hl
  2875  CD6315        		call	CHKLINE
  2878  28EF          		jr	z,INSLP
                      	
  287A  78            		ld	a,b
  287B  FE20          		cp	' '
  287D  2002          		jr	nz,INSSCRL
  287F  F1            		pop	af
  2880  C9            		ret
                      	
                      	
  2881                	INSSCRL:
  2881  E5            		push	hl
                      	
  2882  CD4911        		call	AD2XY
                      	
  2885  3AA5FD        		ld	a,(LASTLIN)
  2888  BD            		cp	l
  2889  381B          		jr	c,INSSCRLU
                      	
  288B  67            		ld	h,a		;(LASTLIN)
  288C  2837          		jr	z,NOSCRLD
  288E  CD640E        		call	SCRLDW
                      	
  2891                	INSSCRLEND:
  2891  4D            		ld	c,l		;;
  2892  2D            		dec	l
  2893  AF            		xor	a
                      	
  2894                	INSSCRLEND2:
  2894  CD8215        		call	SETLINE
  2897  69            		ld	l,c		;;
  2898  CDB811        		call	Y2AD
  289B  CDDA11        		call	DELLIN
  289E  E1            		pop	hl
                      	
  289F  78            		ld	a,b
  28A0  CDCA14        		call	PUT12
  28A3  2B            		dec	hl
                      	
  28A4  F1            		pop	af
  28A5  C9            		ret
                      	
  28A6                	INSSCRLU:
  28A6  E1            		pop	hl
  28A7  11E0FF        		ld	de,0-COLUMNS
  28AA  CB54          		bit	2,h
  28AC  2802          		jr	z,INSSCRLU60
  28AE  1ED8          		ld	e,0-CLMN66	;d=0ffh
  28B0                	INSSCRLU60:
  28B0  19            		add	hl,de
  28B1  E5            		push	hl
                      	
  28B2  6F            		ld	l,a		;(LASTLIN)
  28B3  3E1E          		ld	a,1eh		;up
  28B5  CD7510        		call	PUTC
                      	
  28B8  3AA2FD        		ld	a,(CONSOL1)
  28BB  67            		ld	h,a
  28BC  95            		sub	l
  28BD  4D            		ld	c,l
  28BE  280B          		jr	z,NOSCRLU	;a=0
                      	
  28C0  CD5B0E        		call	SCRLUP
  28C3  18CC          		jr	INSSCRLEND
                      	
  28C5                	NOSCRLD:
  28C5  AF            		xor	a
  28C6  3259FE        		ld	(INPTXY),a	;scroll out
  28C9  18C6          		jr	INSSCRLEND
                      	
  28CB                	NOSCRLU:
                      	;	xor	a
  28CB  3259FE        		ld	(INPTXY),a	;scroll out
  28CE  3C            		inc	a
  28CF  18C3          		jr	INSSCRLEND2
                      	
                      	
                      	;get character from screen
                      	;input: hl
                      	;output: a
                      	;destroy: f
  28D1                	GETSCRC:
  28D1  CD9539        		call	CHKMOD
  28D4  CA6166        		jp	z,GETSCRC66
  28D7  7E            		ld	a,(hl)
  28D8  25            		dec	h
  28D9  25            		dec	h
  28DA  CB76          		bit	6,(hl)
  28DC  2802          		jr	z,GETSCRCZ
  28DE  3E20          		ld	a,' '
  28E0                	GETSCRCZ:
  28E0  24            		inc	h
  28E1  24            		inc	h
  28E2  C9            		ret
                      	
                      	
                      	;one line input
                      	;output: hl=INPBUF-1, c-flag(1=stop)
                      	;destroy: af,bc,de
  28E3                	_INPT1:	ds	INPT1-_INPT1
  28F9                		org	INPT1
                      	
  28F9  2AA8FD        		ld	hl,(CSRY)
  28FC  225AFE        		ld	(INPTX-1),hl	;h=end position for INPUT command
  28FF  2259FE        		ld	(INPTXY),hl	;initial position for INPUT command
  2902  3AABFD        		ld	a,(CSRAD+1)
  2905  325CFE        		ld	(INPTPAG),a	;page for INPUT command
                      	
  2908                	INPT1LP:
  2908  CDC40F        		call	GETC
  290B  CD1029        		call	INPT1CMD
  290E  18F8          		jr	INPT1LP
                      	
                      	
                      	;one line input main routine
  2910                	INPT1CMD:
  2910  FE20          		cp	20h
  2912  3832          		jr	c,INPT1CTL
                      	
  2914  2A5DFE        		ld	hl,(INSMODE)
  2917  2C            		inc	l
  2918  2D            		dec	l
  2919  C44E28        		call	nz,INSERT
                      	
  291C                	INPT1PUTC:
  291C  CD7510        		call	PUTC
                      	
  291F                	CHKIPOS2:
  291F  2AAAFD        		ld	hl,(CSRAD)
                      	
                      	;check cursor position for input command
                      	;input: hl=cursor address
                      	;output: hl=cursor XY, de=cursor address
                      	;destroy: af
  2922                	CHKIPOS:
  2922  54            		ld	d,h
  2923  5D            		ld	e,l
  2924  CD4911        		call	AD2XY
  2927  3A59FE        		ld	a,(INPTXY)	;y+1
  292A  BD            		cp	l
  292B  C0            		ret	nz
                      	
  292C  3A5BFE        		ld	a,(INPTX)
  292F  BC            		cp	h
  2930  3004          		jr	nc,IPOSNC
  2932  7C            		ld	a,h
  2933  325BFE        		ld	(INPTX),a
  2936                	IPOSNC:
  2936  3A5AFE        		ld	a,(INPTXY+1)	;x+1
  2939  BC            		cp	h
  293A  D8            		ret	c
                      	
  293B  3A5CFE        		ld	a,(INPTPAG)
  293E  AA            		xor	d
  293F  E6F0          		and	0f0h
  2941  C0            		ret	nz
                      	
  2942  2259FE        		ld	(INPTXY),hl
  2945  C9            		ret
                      	
                      	
                      	;control code
  2946                	INPT1CTL:
  2946  21192B        		ld	hl,NOINSTBL
  2949  010C00        		ld	bc,000ch
  294C  EDB1          		cpir
  294E  2004          		jr	nz,INPT1CMDNZ
  2950  215DFE        		ld	hl,INSMODE
  2953  70            		ld	(hl),b		;b=0
  2954                	INPT1CMDNZ:
  2954  2AAAFD        		ld	hl,(CSRAD)
                      	
  2957  FE02          		cp	02h
  2959  CADD29        		jp	z,INPT1CTLB
  295C  FE03          		cp	03h
  295E  CA772A        		jp	z,INPT1STOP
  2961  FE05          		cp	05h
  2963  2866          		jr	z,INPT1CTLE
  2965  FE06          		cp	06h
  2967  CAFF29        		jp	z,INPT1CTLF
  296A  FE08          		cp	08h
  296C  2824          		jr	z,INPT1DEL
  296E  FE09          		cp	09h
  2970  CA542A        		jp	z,INPT1TAB
  2973  FE0A          		cp	0ah
  2975  CA2B2A        		jp	z,INPT1CTLJ
  2978  FE0D          		cp	0dh
  297A  CA932A        		jp	z,INPT1RET
  297D  FE12          		cp	12h
  297F  280A          		jr	z,INPT1INS
  2981  FE14          		cp	14h
  2983  2897          		jr	z,INPT1PUTC
  2985  FE15          		cp	15h
  2987  283D          		jr	z,INPT1CTLU
  2989  1891          		jr	INPT1PUTC	;1ch,1dh,1eh,1fh
                      	
                      	
  298B                	INPT1INS:
  298B  215DFE        		ld	hl,INSMODE
  298E  7E            		ld	a,(hl)
  298F  2F            		cpl
  2990  77            		ld	(hl),a
  2991  C9            		ret
                      	
                      	
  2992                	INPT1DEL:
  2992  CD6315        		call	CHKLINE
  2995  C0            		ret	nz
  2996  E5            		push	hl
  2997  21C129        		ld	hl,DELSTR
  299A  CDCF30        		call	PUTS
  299D  CD1F29        		call	CHKIPOS2
  29A0  D1            		pop	de
  29A1  62            		ld	h,d
  29A2  6B            		ld	l,e
  29A3  1B            		dec	de
  29A4  CDF915        		call	CNVATT1
  29A7  4F            		ld	c,a
  29A8                	DELLP:
  29A8  CDD128        		call	GETSCRC
  29AB  12            		ld	(de),a
                      	
  29AC  E5            		push	hl
  29AD  CD520E        		call	CHR2ATT
  29B0  71            		ld	(hl),c
  29B1  E1            		pop	hl
                      	
  29B2  13            		inc	de
  29B3  23            		inc	hl
                      	
  29B4  CD6315        		call	CHKLINE
  29B7  28EF          		jr	z,DELLP
                      	
  29B9  2B            		dec	hl
  29BA  3620          		ld	(hl),' '
  29BC  CD520E        		call	CHR2ATT
  29BF  71            		ld	(hl),c
                      	
  29C0  C9            		ret
                      	
  29C1                	DELSTR:
  29C1  1D201D00      		db	1dh, ' ', 1dh, 00h
                      	
                      	
  29C5                	CTLULP:
  29C5  2B            		dec	hl
  29C6                	INPT1CTLU:
  29C6  CD6315        		call	CHKLINE
  29C9  28FA          		jr	z,CTLULP
                      	
  29CB                	INPT1CTLE:
  29CB  E5            		push	hl
  29CC  CD520E        		call	CHR2ATT
  29CF  CDF915        		call	CNVATT1
  29D2  77            		ld	(hl),a
  29D3  E1            		pop	hl
                      	
  29D4  3620          		ld	(hl),' '
  29D6  23            		inc	hl
  29D7  CD6315        		call	CHKLINE
  29DA  28EF          		jr	z,INPT1CTLE
  29DC  C9            		ret
                      	
                      	
  29DD                	INPT1CTLB:
  29DD  CDEE29        		call	CHKCTLB
  29E0  30FB          		jr	nc,INPT1CTLB
  29E2                	CTLBLP:
  29E2  CDEE29        		call	CHKCTLB
  29E5  38FB          		jr	c,CTLBLP
  29E7  23            		inc	hl
  29E8  CD2229        		call	CHKIPOS
  29EB  C36D11        		jp	SETCSR
                      	
  29EE                	CHKCTLB:
  29EE  2B            		dec	hl
  29EF  54            		ld	d,h
  29F0  5D            		ld	e,l
  29F1  CD4911        		call	AD2XY
  29F4  3AA2FD        		ld	a,(CONSOL1)
  29F7  2C            		inc	l
  29F8  BD            		cp	l
  29F9  3821          		jr	c,CTLBC
  29FB                	CTLBNC:
  29FB  F1            		pop	af		;cancel return address
  29FC  C36811        		jp	CTLCR
                      	
                      	
  29FF                	INPT1CTLF:
  29FF  CD102A        		call	CHKCTLF
  2A02  38FB          		jr	c,INPT1CTLF
  2A04                	CTLFLP:
  2A04  CD102A        		call	CHKCTLF
  2A07  30FB          		jr	nc,CTLFLP
  2A09  EB            		ex	de,hl
  2A0A  CD6D11        		call	SETCSR
  2A0D  C31F29        		jp	CHKIPOS2
                      	
  2A10                	CHKCTLF:
  2A10  23            		inc	hl
  2A11  54            		ld	d,h
  2A12  5D            		ld	e,l
  2A13  CD4911        		call	AD2XY
  2A16  3AA5FD        		ld	a,(LASTLIN)
  2A19  BD            		cp	l
  2A1A  3807          		jr	c,CTLFC
  2A1C                	CTLBC:
  2A1C  EB            		ex	de,hl
  2A1D  CDD128        		call	GETSCRC
  2A20  C3B50B        		jp	ALPNUM2
                      	
  2A23                	CTLFC:
                      	;	ld	l,a
                      	;	ld	h,COLUMNS
                      	
  2A23  2AABFD        		ld	hl,(WIDTH-1)	;h=(WIDTH)
  2A26  6F            		ld	l,a
                      	
  2A27  F1            		pop	af		;cancel return address
  2A28  C36D11        		jp	SETCSR
                      	
                      	
  2A2B                	INPT1CTLJ:
  2A2B  3A5DFE        		ld	a,(INSMODE)
  2A2E  B7            		or	a
  2A2F  3E0A          		ld	a,0ah
  2A31  CA1C29        		jp	z,INPT1PUTC
                      	
  2A34  2AA8FD        		ld	hl,(CSRY)	;l=y+1, h=x+1
                      	;	ld	a,COLUMNS+1
                      	
  2A37  3AACFD        		ld	a,(WIDTH)
  2A3A  3C            		inc	a
                      	
  2A3B  94            		sub	h
  2A3C  47            		ld	b,a
  2A3D                	CTLJLP:
  2A3D  C5            		push	bc
  2A3E  3E20          		ld	a,' '
  2A40  CD4E28        		call	INSERT
  2A43  2AAAFD        		ld	hl,(CSRAD)
  2A46  77            		ld	(hl),a
  2A47  C1            		pop	bc
  2A48  10F3          		djnz	CTLJLP
                      	
  2A4A  CD4911        		call	AD2XY
  2A4D  CD6D11        		call	SETCSR
  2A50  7C            		ld	a,h		;>0
  2A51  C38215        		jp	SETLINE
                      	
                      	
  2A54                	INPT1TAB:
  2A54  3AACFD        		ld	a,(WIDTH)
  2A57  D607          		sub	07h
  2A59  47            		ld	b,a
  2A5A  3AA9FD        		ld	a,(CSRX)
  2A5D  90            		sub	b
  2A5E  DE07          		sbc	a,07h
  2A60  C8            		ret	z
  2A61  2F            		cpl
  2A62  E607          		and	07h
  2A64  3C            		inc	a
  2A65  47            		ld	b,a
  2A66  3A5DFE        		ld	a,(INSMODE)
  2A69  E604          		and	04h
  2A6B  C61C          		add	a,1ch		;1ch(right) or 20h(space)
  2A6D  4F            		ld	c,a
  2A6E                	INPT1TABLP:
  2A6E  C5            		push	bc
  2A6F  79            		ld	a,c
  2A70  CD1029        		call	INPT1CMD
  2A73  C1            		pop	bc
  2A74  10F8          		djnz	INPT1TABLP
  2A76  C9            		ret
                      	
                      	
  2A77                	INPT1STOP:
  2A77  E1            		pop	hl		;cancel return address
  2A78  2AA8FD        		ld	hl,(CSRY)
  2A7B                	STOPLP:
  2A7B  2C            		inc	l
  2A7C  CD7215        		call	CHKLINE3
  2A7F  28FA          		jr	z,STOPLP
  2A81  2D            		dec	l
  2A82  CD6D11        		call	SETCSR
  2A85  CD3927        		call	PUTNL
                      	
  2A88  21DAFE        		ld	hl,INPBUF
  2A8B  AF            		xor	a
  2A8C  3218FA        		ld	(STOPFLG),a
  2A8F  77            		ld	(hl),a
  2A90  2B            		dec	hl
  2A91  37            		scf
  2A92  C9            		ret
                      	
                      	
  2A93                	INPT1RET:
  2A93  F1            		pop	af		;cancel return address
                      	
  2A94  3AABFD        		ld	a,(CSRAD+1)
  2A97  57            		ld	d,a
  2A98  3A5CFE        		ld	a,(INPTPAG)
  2A9B  AA            		xor	d		;
  2A9C  E6F0          		and	0f0h
  2A9E  2018          		jr	nz,IRETNZ1
                      	
  2AA0  3AA8FD        		ld	a,(CSRY)
  2AA3  ED5B59FE      		ld	de,(INPTXY)
  2AA7  BB            		cp	e
  2AA8  200E          		jr	nz,IRETNZ1
                      	
  2AAA  E5            		push	hl
  2AAB  6B            		ld	l,e
  2AAC  CD7215        		call	CHKLINE3
  2AAF  E1            		pop	hl
  2AB0  2806          		jr	z,IRETNZ1
                      	
  2AB2  3A5BFE        		ld	a,(INPTX)
  2AB5  92            		sub	d
  2AB6  1802          		jr	SETINPTX
  2AB8                	IRETNZ1:
  2AB8  3E47          		ld	a,71
  2ABA                	SETINPTX:
  2ABA  325BFE        		ld	(INPTX),a
                      	
  2ABD                	IRETLP1:
  2ABD  CD6315        		call	CHKLINE
  2AC0  2B            		dec	hl
  2AC1  28FA          		jr	z,IRETLP1
  2AC3  23            		inc	hl
  2AC4  54            		ld	d,h		;
  2AC5  CD4911        		call	AD2XY
  2AC8  3A5CFE        		ld	a,(INPTPAG)
  2ACB  AA            		xor	d		;
  2ACC  E6F0          		and	0f0h
  2ACE  2009          		jr	nz,IRETNZ2
                      	
  2AD0  ED5B59FE      		ld	de,(INPTXY)	;initial position
  2AD4  7D            		ld	a,l
  2AD5  BB            		cp	e
  2AD6  2001          		jr	nz,IRETNZ2
  2AD8  EB            		ex	de,hl
                      	
  2AD9                	IRETNZ2:
  2AD9  CDCD11        		call	XY2AD
                      	
  2ADC                	IRETLP2:
  2ADC  CDD128        		call	GETSCRC
  2ADF  11DAFE        		ld	de,INPBUF
  2AE2  0647          		ld	b,71
  2AE4                	IRETLP3:
  2AE4  CDD128        		call	GETSCRC
  2AE7  FE20          		cp	20h
  2AE9  300D          		jr	nc,IRETNC
  2AEB  EB            		ex	de,hl
  2AEC  3614          		ld	(hl),14h
  2AEE  EB            		ex	de,hl
                      	;	dec	b
                      	;	jr	nz,IRETGRP
  2AEF  1004          		djnz	IRETGRP
  2AF1  AF            		xor	a
  2AF2  12            		ld	(de),a
  2AF3  180D          		jr	IRETNZ3
  2AF5                	IRETGRP:
  2AF5  13            		inc	de
  2AF6  C630          		add	a,30h
                      	
  2AF8                	IRETNC:
  2AF8  12            		ld	(de),a
  2AF9  13            		inc	de
  2AFA  23            		inc	hl
  2AFB  CD6315        		call	CHKLINE
  2AFE  2002          		jr	nz,IRETNZ3
  2B00  10E2          		djnz	IRETLP3
                      	
  2B02                	IRETNZ3:
  2B02  2B            		dec	hl
  2B03  CD4911        		call	AD2XY
  2B06  CD6D11        		call	SETCSR
                      	
  2B09                	IRETLP4:
  2B09  1B            		dec	de
  2B0A  1A            		ld	a,(de)
  2B0B  FE20          		cp	' '
  2B0D  28FA          		jr	z,IRETLP4
  2B0F  13            		inc	de
  2B10  AF            		xor	a
  2B11  12            		ld	(de),a
                      	
  2B12  CD3927        		call	PUTNL
                      	
  2B15  21D9FE        		ld	hl,INPBUF-1
  2B18  C9            		ret
                      	
  2B19                	NOINSTBL:
  2B19  020305060B0C0D		db	02h, 03h, 05h, 06h, 0bh, 0ch, 0dh, 15h, 1ch, 1dh, 1eh, 1fh
                      	
                      	
                      	;x=x+-(8 or 4 or 2 or 1)
                      	;input: b(bit7=0:increment, bit7=1:decrement), (GRPX3)
                      	;output: hl,(GRPX3)=X
                      	;destroy: af,de
  2B25                	INCGX:
  2B25  3A92FD        		ld	a,(SCREEN1)
  2B28  3C            		inc	a
  2B29  57            		ld	d,a
  2B2A  3E10          		ld	a,10h
  2B2C                	INCGXLP:
  2B2C  0F            		rrca
  2B2D  15            		dec	d
  2B2E  20FC          		jr	nz,INCGXLP
                      	
  2B30  2AB1FE        		ld	hl,(GRPX3)
  2B33  5F            		ld	e,a
  2B34  CB78          		bit	7,b
  2B36  2003          		jr	nz,INCGXNZ
                      	
  2B38  19            		add	hl,de		;de=8,4,2,1
  2B39  1802          		jr	INCGXEND
                      	
  2B3B                	INCGXNZ:
                      	;	or	a
  2B3B  ED52          		sbc	hl,de		;de=8,4,2,1
                      	
  2B3D                	INCGXEND:
  2B3D  22B1FE        		ld	(GRPX3),hl
  2B40  C9            		ret
                      	
                      	
                      	;y=y+(12 or 4 or 1 or 1)
                      	;input: (GRPY3)
                      	;output: de=(GRPY3)
                      	;destroy: af
  2B41                	INCGY:
  2B41  CD9539        		call	CHKMOD
  2B44  CA916C        		jp	z,INCGY66
  2B47  3A92FD        		ld	a,(SCREEN1)
  2B4A  3D            		dec	a
  2B4B  3E04          		ld	a,04h		;screen mode 2
  2B4D  2807          		jr	z,INCGYZ
  2B4F  3E01          		ld	a,01h		;screen mode 3,4
  2B51  F2562B        		jp	p,INCGYZ
  2B54  3E0C          		ld	a,0ch		;screen mode 1
  2B56                	INCGYZ:
  2B56  ED5BB3FE      		ld	de,(GRPY3)
  2B5A  83            		add	a,e
  2B5B  5F            		ld	e,a
  2B5C  32B3FE        		ld	(GRPY3),a	;<256
  2B5F  C9            		ret
                      	
                      	
                      	;error-=|dx|*2
                      	;input: bc=dx, hl=error
                      	;output: hl=error
                      	;destroy: af
  2B60                	SUB2DX:
  2B60  78            		ld	a,b
  2B61  07            		rlca
  2B62  3805          		jr	c,SUB2DXNZ
                      	;dx>0
                      	;	or	a
  2B64  ED42          		sbc	hl,bc
  2B66  ED42          		sbc	hl,bc
  2B68  C9            		ret
                      	
                      	;dx<0
  2B69                	SUB2DXNZ:
  2B69  09            		add	hl,bc
  2B6A  09            		add	hl,bc
  2B6B  C9            		ret
                      	
                      	
                      	;x1 <-> x2, y1 <-> y2
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2
                      	;output: (GRPX2)=larger x,(GRPY2)=larger y,(GRPX3)=smaller x,(GRPY3)=smaller y
                      	;destroy: bc,de,hl
  2B6C                	SORTXY:
  2B6C  F5            		push	af
  2B6D  CDBC2B        		call	CHKGXY23
  2B70  3807          		jr	c,SORTXOK
  2B72  22AFFE        		ld	(GRPY2),hl
  2B75  ED53B3FE      		ld	(GRPY3),de
  2B79                	SORTXOK:
  2B79  2AADFE        		ld	hl,(GRPX2)
  2B7C  ED5BB1FE      		ld	de,(GRPX3)
  2B80  E7            		rst	CPHLDE
  2B81  3816          		jr	c,SORTX
  2B83  F1            		pop	af
  2B84  C9            		ret
                      	
                      	
                      	;(x1,y1) <-> (x2,y2)
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2
                      	;output: (GRPX2),(GRPY2)=larger y with x, (GRPX3),(GRPY3)=small y with x
                      	;destroy: bc,de,hl
  2B85                	SORTY:
  2B85  F5            		push	af
  2B86  CDBC2B        		call	CHKGXY23
  2B89  3815          		jr	c,NOSORT
  2B8B  22AFFE        		ld	(GRPY2),hl
  2B8E  ED53B3FE      		ld	(GRPY3),de
  2B92  2AADFE        		ld	hl,(GRPX2)
  2B95  ED5BB1FE      		ld	de,(GRPX3)
  2B99                	SORTX:
  2B99  ED53ADFE      		ld	(GRPX2),de
  2B9D  22B1FE        		ld	(GRPX3),hl
  2BA0                	NOSORT:
  2BA0  F1            		pop	af
  2BA1  C9            		ret
                      	
                      	
                      	;sort XY and put bc,de,hl
                      	;output: bc=smaller x, de=smaller y, hl=larger y
                      	;destroy: none
  2BA2                	SORTXY2:
  2BA2  CD6C2B        		call	SORTXY
  2BA5  ED4BB1FE      		ld	bc,(GRPX3)	;smaller x, b=0
  2BA9  ED5BB3FE      		ld	de,(GRPY3)	;smaller y
  2BAD  2AAFFE        		ld	hl,(GRPY2)	;larger y
  2BB0  C9            		ret
                      	
                      	
                      	;push (GRPX2),(GRPY2)
                      	;destroy: af,hl
  2BB1                	PUSHGXY:
  2BB1  F1            		pop	af		;return address
  2BB2  2AADFE        		ld	hl,(GRPX2)
  2BB5  E5            		push	hl
  2BB6  2AAFFE        		ld	hl,(GRPY2)
  2BB9  E5            		push	hl
  2BBA  F5            		push	af		;return address
  2BBB  C9            		ret
                      	
                      	
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2
                      	;output: bc=(GRPX2)=x2, de=(GRPY2)=y2, hl=(GRPY3)=y1, (GRPX3)=x1, z,c(y1>y2?)
                      	;destroy: af
  2BBC                	CHKGXY23:
  2BBC  CDDF2B        		call	CHKGXY
  2BBF  ED43B1FE      		ld	(GRPX3),bc
  2BC3  ED53B3FE      		ld	(GRPY3),de
  2BC7  ED4BADFE      		ld	bc,(GRPX2)
  2BCB  ED5BAFFE      		ld	de,(GRPY2)
  2BCF  CDDF2B        		call	CHKGXY
  2BD2  ED43ADFE      		ld	(GRPX2),bc
  2BD6  ED53AFFE      		ld	(GRPY2),de
                      	
  2BDA  2AB3FE        		ld	hl,(GRPY3)
  2BDD  E7            		rst	CPHLDE
  2BDE  C9            		ret
                      	
                      	
                      	;check and round graphic coordinates (x,y)
                      	;input: bc=x, de=y
                      	;output: bc=x, de=y
                      	;destroy: af,hl
  2BDF                	CHKGXY:
  2BDF  CD9539        		call	CHKMOD
  2BE2  CA426C        		jp	z,CHKGXY66
  2BE5  78            		ld	a,b
  2BE6  B7            		or	a
  2BE7  2802          		jr	z,CHKMNS
  2BE9  0EFF          		ld	c,0ffh
  2BEB                	CHKMNS:
  2BEB  B2            		or	d
  2BEC  FAED03        		jp	m,FCERR
                      	
  2BEF  3A92FD        		ld	a,(SCREEN1)
  2BF2  47            		ld	b,a		;
  2BF3  0F            		rrca
  2BF4  2F            		cpl
  2BF5  21A6FD        		ld	hl,CONSOL3
  2BF8  A6            		and	(hl)
  2BF9  0F            		rrca
  2BFA  21BF00        		ld	hl,191
  2BFD  3003          		jr	nc,NOFKEY
  2BFF  21B300        		ld	hl,191-12
  2C02                	NOFKEY:
  2C02  E7            		rst	CPHLDE
  2C03  3001          		jr	nc,CHKYOK
  2C05  EB            		ex	de,hl
  2C06                	CHKYOK:
  2C06  78            		ld	a,b		;
  2C07  3D            		dec	a
  2C08  280D          		jr	z,ROUNDY2
  2C0A  F21B2C        		jp	p,ROUNDX	;screen mode 3,4
                      	
                      	;round off y for screen mode 1
  2C0D                	ROUNDY1:
  2C0D  CDBA3F        		call	DIV12
  2C10  7B            		ld	a,e
  2C11  87            		add	a,a		;*2
  2C12  83            		add	a,e		;*3
  2C13  87            		add	a,a		;*6
  2C14  87            		add	a,a		;*12
  2C15  1803          		jr	ROUNDY2END
                      	
                      	;round off y for screen mode 2
  2C17                	ROUNDY2:
  2C17  7B            		ld	a,e
  2C18  E6FC          		and	0fch
  2C1A                	ROUNDY2END:
  2C1A  5F            		ld	e,a
                      	
  2C1B                	ROUNDX:
  2C1B  04            		inc	b		;
  2C1C  3EF0          		ld	a,0f0h
  2C1E                	ROUNDXLP:
  2C1E  37            		scf
  2C1F  1F            		rra			;f8,fc,fe,ff
  2C20  10FC          		djnz	ROUNDXLP
                      	
  2C22  A1            		and	c
  2C23  4F            		ld	c,a		;b=0
  2C24  C9            		ret
                      	
                      	
                      	;screen mode 2
  2C25                	PSET2:
  2C25  C5            		push	bc		;X
  2C26  CD8E3F        		call	GXY2AD60
                      	
  2C29  3AACFE        		ld	a,(ATTDAT)
  2C2C  5E            		ld	e,(hl)		;
  2C2D  B7            		or	a
  2C2E  2004          		jr	nz,PS2NZ1
  2C30  CB73          		bit	6,e
  2C32  2004          		jr	nz,PS2NZ2
  2C34                	PS2NZ1:
  2C34  CD5715        		call	GETSPA2NZ
  2C37  77            		ld	(hl),a
  2C38                	PS2NZ2:
  2C38  24            		inc	h
  2C39  24            		inc	h
  2C3A  CB73          		bit	6,e		;
  2C3C  2004          		jr	nz,PS2SEMI	;semi-graphic mode?
  2C3E  CD1316        		call	GETSP
  2C41  77            		ld	(hl),a
                      	
  2C42                	PS2SEMI:
  2C42  C1            		pop	bc		;X
  2C43  CD612C        		call	MASK2
  2C46  47            		ld	b,a
                      	
  2C47  7E            		ld	a,(hl)
  2C48  E63F          		and	3fh
  2C4A  B0            		or	b
  2C4B  4F            		ld	c,a
                      	
  2C4C  3AACFE        		ld	a,(ATTDAT)
  2C4F  B7            		or	a
  2C50  2809          		jr	z,PSET2C0
  2C52  3D            		dec	a
  2C53  E603          		and	03h
  2C55  0F            		rrca
  2C56  0F            		rrca
  2C57  81            		add	a,c
  2C58  77            		ld	(hl),a
  2C59  E1            		pop	hl
  2C5A  C9            		ret
                      	
  2C5B                	PSET2C0:
  2C5B  78            		ld	a,b
  2C5C  2F            		cpl
  2C5D  A6            		and	(hl)
  2C5E  77            		ld	(hl),a
  2C5F  E1            		pop	hl
  2C60  C9            		ret
                      	
                      	
                      	;screen mode 2 dot bit mask
                      	;input: c=X, d=Y mod 12
                      	;output: a
                      	; bit5 bit4
                      	; bit3 bit2
                      	; bit1 bit0
                      	;destroy: f,bc
  2C61                	MASK2:
  2C61  79            		ld	a,c
  2C62  2F            		cpl
  2C63  E604          		and	04h
  2C65  C604          		add	a,04h
  2C67  CB52          		bit	2,d
  2C69  C0            		ret	nz	;4<=d<=7
  2C6A  CB5A          		bit	3,d
  2C6C  2003          		jr	nz,MASK2NZ
  2C6E  07            		rlca
  2C6F  07            		rlca
  2C70  C9            		ret		;0<=d<=3
  2C71                	MASK2NZ:
  2C71  0F            		rrca
  2C72  0F            		rrca
  2C73  C9            		ret		;8<=d<=11
                      	
                      	
                      	;continued from BFG
  2C74                	BFG2:
  2C74  3AB1FE        		ld	a,(GRPX3)	;smaller x
  2C77  E6F8          		and	0f8h
  2C79  47            		ld	b,a
  2C7A  3AADFE        		ld	a,(GRPX2)	;larger x
  2C7D  E6F8          		and	0f8h
  2C7F  90            		sub	b		;
  2C80  0F            		rrca
  2C81  0F            		rrca
  2C82  0F            		rrca			;int(larger/8)-int(smaller/8)
  2C83  47            		ld	b,a		;bytes
  2C84  2003          		jr	nz,BFGLP3	;a=0?
  2C86  7A            		ld	a,d
  2C87  A3            		and	e
  2C88  57            		ld	d,a
                      	
  2C89                	BFGLP3:
                      	;left part
  2C89  C5            		push	bc
  2C8A  3AACFE        		ld	a,(ATTDAT)
  2C8D  AE            		xor	(hl)
  2C8E  A2            		and	d		;d=left part mask
  2C8F  AE            		xor	(hl)
  2C90  77            		ld	(hl),a
                      	
  2C91  78            		ld	a,b
  2C92  B7            		or	a
  2C93  2811          		jr	z,BFGNEXT
                      	
                      	;middle part
  2C95  E5            		push	hl		;VRAM address
  2C96  3AACFE        		ld	a,(ATTDAT)
  2C99  05            		dec	b
  2C9A  2804          		jr	z,BFGRHT
  2C9C                	BFGLP4:
  2C9C  23            		inc	hl
  2C9D  77            		ld	(hl),a
  2C9E  10FC          		djnz	BFGLP4
                      	
                      	;right part
  2CA0                	BFGRHT:
  2CA0  23            		inc	hl
  2CA1  AE            		xor	(hl)
  2CA2  A3            		and	e		;e=right part mask
  2CA3  AE            		xor	(hl)
  2CA4  77            		ld	(hl),a
  2CA5  E1            		pop	hl		;VRAM address
                      	
  2CA6                	BFGNEXT:
  2CA6  012000        		ld	bc,0020h
  2CA9  09            		add	hl,bc
  2CAA  C1            		pop	bc
  2CAB  0D            		dec	c
  2CAC  20DB          		jr	nz,BFGLP3
  2CAE  C3C62E        		jp	LINEEND2
                      	
                      	
                      	;|dy/dx|<=1
  2CB1                	SLOPEX:
  2CB1  AF            		xor	a
  2CB2  95            		sub	l
  2CB3  6F            		ld	l,a
  2CB4  9C            		sbc	a,h
  2CB5  95            		sub	l
  2CB6  67            		ld	h,a
  2CB7  E5            		push	hl		;error=-|dx|
                      	
  2CB8                	LINELP2:
  2CB8  ED4BB1FE      		ld	bc,(GRPX3)
  2CBC  ED5BB3FE      		ld	de,(GRPY3)
  2CC0  CD472D        		call	PSET
                      	
  2CC3  E1            		pop	hl		;error
  2CC4  C1            		pop	bc		;dx
  2CC5  D1            		pop	de		;dy
  2CC6  D5            		push	de		;dy
  2CC7  C5            		push	bc		;dx
                      	
  2CC8  19            		add	hl,de		;error+=dy
  2CC9  19            		add	hl,de		;error+=dy
  2CCA  CB7C          		bit	7,h
  2CCC  2006          		jr	nz,ERRMNS
                      	
                      	;if error>=0
  2CCE  CD602B        		call	SUB2DX		;error-=|dx|*2
  2CD1  CD412B        		call	INCGY		;increment Y
                      	
  2CD4                	ERRMNS:
  2CD4  E5            		push	hl		;error
  2CD5  CD252B        		call	INCGX		;increment or decrement X
  2CD8  DAC12E        		jp	c,LINEEND
                      	
  2CDB  EB            		ex	de,hl		;de=X
  2CDC  2AADFE        		ld	hl,(GRPX2)
  2CDF  CB78          		bit	7,b
  2CE1  2801          		jr	z,LINEZ
  2CE3  EB            		ex	de,hl		;if dx<0
  2CE4                	LINEZ:
  2CE4  E7            		rst	CPHLDE
  2CE5  30D1          		jr	nc,LINELP2
  2CE7  C3C12E        		jp	LINEEND
                      	
                      	
                      	;get (step)(x,y) cordinate
                      	;input: hl=program address
                      	;output: bc=graphic X, de=graphic Y,
                      	;	 (GRPX1)=(GRPX2),(GRPY1)=(GRPY2)=0-32767
                      	;	 a=next data, hl=next data address, z(, or not)
                      	;destroy: f
  2CEA                	GETGXY:
  2CEA  CD5A3F        		call	SKIPSP
  2CED  FEC9          		cp	STEP
  2CEF  F5            		push	af		;STEP?
  2CF0  2001          		jr	nz,GETGXYNZ
  2CF2  23            		inc	hl
  2CF3                	GETGXYNZ:
  2CF3  CD920B        		call	CHKLPAR
  2CF6  CD230E        		call	INTARG2		;bc,de
  2CF9  CDA10B        		call	CHKRPAR
  2CFC  F1            		pop	af		;STEP?
  2CFD  CD132D        		call	SETGXY
  2D00  CD5A3F        		call	SKIPSP
  2D03  FE2C          		cp	','
  2D05  C9            		ret
                      	
                      	
                      	;input: bc=x, de=y, z(0=absolute, 1=relative)
                      	;output: bc=x, de=y, (GRPX1)=(GRPX2)=x, (GRPY1)=(GRPY2)=y
                      	;destroy: f
  2D06                	_SETGXY:ds	SETGXY-_SETGXY
  2D13                		org	SETGXY
                      	
  2D13  E5            		push	hl
  2D14  200B          		jr	nz,SETGXYNZ
  2D16  2AAEFD        		ld	hl,(GRPX1)
  2D19  09            		add	hl,bc
  2D1A  44            		ld	b,h
  2D1B  4D            		ld	c,l
  2D1C  2AB0FD        		ld	hl,(GRPY1)
  2D1F  19            		add	hl,de
  2D20  EB            		ex	de,hl
  2D21                	SETGXYNZ:
  2D21  ED43AEFD      		ld	(GRPX1),bc
  2D25  ED43ADFE      		ld	(GRPX2),bc
  2D29  ED53B0FD      		ld	(GRPY1),de
  2D2D  ED53AFFE      		ld	(GRPY2),de
  2D31  E1            		pop	hl
  2D32  C9            		ret
                      	
                      	
                      	;PRESET command
  2D33                	C_PRST:
  2D33  3A94FD        		ld	a,(COLOR2)
  2D36  1803          		jr	PSETRST
                      	
                      	;PSET command
  2D38                	C_PSET:
  2D38  3A93FD        		ld	a,(COLOR1)
                      	
                      	;PSET and PRESET
  2D3B                	PSETRST:
  2D3B  CDC015        		call	SETATT
  2D3E  CDEA2C        		call	GETGXY
  2D41  CC6C2D        		call	z,PSCOLR
                      	;	jp	PSET
                      	
                      	
                      	;input: bc=x1, de=y1, (ATTDAT)=attribute
                      	;destroy: af,bc,de
  2D44                	_PSET:	ds	PSET-_PSET
  2D47                		org	PSET
                      	
  2D47  E5            		push	hl
                      	;	call	CHKGXY
  2D48  CD9539        		call	CHKMOD
  2D4B  CAA16B        		jp	z,PSET66
  2D4E  3A92FD        		ld	a,(SCREEN1)
  2D51  3D            		dec	a
  2D52  CA252C        		jp	z,PSET2
  2D55  F2602D        		jp	p,PSETG
                      	
                      	
                      	;screen mode 1
  2D58                	PSET1:
  2D58  CD8E3F        		call	GXY2AD60
  2D5B  3AACFE        		ld	a,(ATTDAT)
  2D5E  1809          		jr	PSETEND
                      	
                      	
                      	;screen mode 3,4
  2D60                	PSETG:
  2D60  CD4514        		call	GXY2GAD60
  2D63  3AACFE        		ld	a,(ATTDAT)
  2D66  AE            		xor	(hl)
  2D67  A2            		and	d
  2D68  AE            		xor	(hl)
  2D69                	PSETEND:
  2D69  77            		ld	(hl),a
  2D6A  E1            		pop	hl
  2D6B  C9            		ret
                      	
                      	
  2D6C                	PSCOLR:
  2D6C  C5            		push	bc		;x
  2D6D  D5            		push	de		;y
  2D6E  CDE30D        		call	INT1INC
  2D71  D1            		pop	de		;y
  2D72  C1            		pop	bc		;x
  2D73  C3C015        		jp	SETATT
                      	
                      	
                      	;POINT() function
  2D76                	F_POIN:
  2D76  CDEA2C        		call	GETGXY
  2D79  CD6E3E        		call	POINT
  2D7C  C3590C        		jp	I1TOFA
                      	
                      	
                      	;prepare for line command
  2D7F                	PRELINE:
  2D7F  CD5A3F        		call	SKIPSP
  2D82  FECB          		cp	MINUS
  2D84  ED4BAEFD      		ld	bc,(GRPX1)
  2D88  ED5BB0FD      		ld	de,(GRPY1)
  2D8C  2808          		jr	z,LINE2P
                      	
  2D8E                	LINE1P:
  2D8E  CDEA2C        		call	GETGXY
  2D91  FECB          		cp	MINUS
  2D93  C2E403        		jp	nz,SNERR
                      	
  2D96                	LINE2P:
  2D96  C5            		push	bc		;x1
  2D97  D5            		push	de		;y1
                      	
  2D98  23            		inc	hl
  2D99  CDEA2C        		call	GETGXY
  2D9C  ED43ADFE      		ld	(GRPX2),bc	;x2
  2DA0  ED53AFFE      		ld	(GRPY2),de	;y2
  2DA4  3A93FD        		ld	a,(COLOR1)
  2DA7  2011          		jr	nz,NOTBOX
  2DA9  5F            		ld	e,a
  2DAA  CD593F        		call	SKIPSPINC
  2DAD  FE2C          		cp	','
  2DAF  280C          		jr	z,CHKBF
                      	
                      	;color
  2DB1  CDE40D        		call	INT1ARG
  2DB4  7E            		ld	a,(hl)
  2DB5  FE2C          		cp	','
  2DB7  2804          		jr	z,CHKBF
  2DB9  7B            		ld	a,e
                      	
  2DBA                	NOTBOX:
  2DBA  B7            		or	a		;reset c-flag
  2DBB  1815          		jr	PRELEND
                      	
                      	;check 'B' and 'F'
  2DBD                	CHKBF:
  2DBD  CD593F        		call	SKIPSPINC
  2DC0  FE42          		cp	'B'
  2DC2  C2E403        		jp	nz,SNERR
                      	
  2DC5  CD593F        		call	SKIPSPINC
  2DC8  FE46          		cp	'F'
  2DCA  2001          		jr	nz,BOX
  2DCC  23            		inc	hl		;for box fill
  2DCD                	BOX:
  2DCD  224EFF        		ld	(PROGAD),hl
  2DD0  7B            		ld	a,e
  2DD1  37            		scf
                      	
  2DD2                	PRELEND:
  2DD2  D1            		pop	de		;y1
  2DD3  C1            		pop	bc		;x1
                      	
  2DD4  F5            		push	af
  2DD5  CDC015        		call	SETATT
  2DD8  F1            		pop	af
  2DD9  C9            		ret
                      	
                      	
                      	;LINE command
  2DDA                	C_LINE:
  2DDA  CD7F2D        		call	PRELINE
  2DDD  3040          		jr	nc,LINE
  2DDF  2054          		jr	nz,LINEB
                      	;	jr	LINEBF
                      	
                      	
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2, (ATTDAT)=attribute
                      	;destroy: af,bc,de
  2DE1                	_LINEBF:ds	LINEBF-_LINEBF
  2DE4                		org	LINEBF
                      	
  2DE4  E5            		push	hl
  2DE5  CDB12B        		call	PUSHGXY
  2DE8  CDA22B        		call	SORTXY2
                      	
  2DEB  3A92FD        		ld	a,(SCREEN1)
  2DEE  FE02          		cp	02h
  2DF0  3868          		jr	c,BF12
                      	
                      	;line bf (graphic mode)
  2DF2                	BFG:
  2DF2  3AADFE        		ld	a,(GRPX2)	;larger x
  2DF5  2001          		jr	nz,BF4
  2DF7  3C            		inc	a		;screen mode 3
  2DF8                	BF4:
  2DF8  E607          		and	07h
  2DFA  3C            		inc	a
  2DFB  47            		ld	b,a
  2DFC  AF            		xor	a
  2DFD                	BFGLP1:
  2DFD  37            		scf
  2DFE  1F            		rra			;right part mask
  2DFF  10FC          		djnz	BFGLP1
                      	
                      	;	or	a
  2E01  ED52          		sbc	hl,de
  2E03  2C            		inc	l
  2E04  E5            		push	hl		;l=lines
                      	
  2E05  6F            		ld	l,a		;right part mask
                      	
  2E06  79            		ld	a,c		;smaller x
  2E07  E607          		and	07h
  2E09  47            		ld	b,a
  2E0A  3EFF          		ld	a,0ffh
  2E0C  2804          		jr	z,BFGZ
  2E0E                	BFGLP2:
  2E0E  CB3F          		srl	a
  2E10  10FC          		djnz	BFGLP2
  2E12                	BFGZ:
  2E12  67            		ld	h,a		;left part mask
                      	
  2E13  E5            		push	hl
  2E14  CD4514        		call	GXY2GAD60	;b=0
  2E17  D1            		pop	de		;d=left part mask, e=right part mask
  2E18  C1            		pop	bc		;c=lines
                      	
  2E19  C3742C        		jp	BFG2
                      	
                      	
                      	;by Bresenham's line algorithm
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2, (ATTDAT)=attribute
                      	;destroy: af
  2E1C                	_LINE:	ds	LINE-_LINE
  2E1F                		org	LINE
                      	
  2E1F  E5            		push	hl
  2E20  CDB12B        		call	PUSHGXY
  2E23  D5            		push	de
  2E24  C5            		push	bc
                      	
  2E25  CD852B        		call	SORTY
  2E28  ED4BB3FE      		ld	bc,(GRPY3)	;start (smaller y)
  2E2C  2AAFFE        		ld	hl,(GRPY2)	;end (larger y)
  2E2F  B7            		or	a
  2E30  ED42          		sbc	hl,bc		;dy
  2E32  1835          		jr	LINE2
                      	
                      	
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2, (ATTDAT)=attribute
                      	;destroy: af,bc,de
  2E34                	_LINEB:	ds	LINEB-_LINEB
  2E35                		org	LINEB
                      	
  2E35  E5            		push	hl
  2E36  CDB12B        		call	PUSHGXY
  2E39  CDA22B        		call	SORTXY2
  2E3C  EB            		ex	de,hl
                      	
                      	;down-up-right-left
  2E3D  C5            		push	bc
  2E3E  CD1F2E        		call	LINE
  2E41  22AFFE        		ld	(GRPY2),hl	;smaller y
  2E44  EB            		ex	de,hl
  2E45  CD1F2E        		call	LINE
  2E48  ED4BADFE      		ld	bc,(GRPX2)	;larger x
  2E4C  EB            		ex	de,hl		;larger y
  2E4D  CD1F2E        		call	LINE
  2E50  C1            		pop	bc		;smaller x
  2E51  ED43ADFE      		ld	(GRPX2),bc
  2E55  CD1F2E        		call	LINE
  2E58  186C          		jr	LINEEND2
                      	
                      	
                      	;line bf (screen mode 1,2)
  2E5A                	BF12:
  2E5A  ED53AFFE      		ld	(GRPY2),de
  2E5E  CD1F2E        		call	LINE
  2E61  E7            		rst	CPHLDE
  2E62  2862          		jr	z,LINEEND2
  2E64  CD412B        		call	INCGY
  2E67  18F1          		jr	BF12
                      	
                      	
  2E69                	LINE2:
  2E69  CD9539        		call	CHKMOD
  2E6C  3A92FD        		ld	a,(SCREEN1)
  2E6F  CA226C        		jp	z,LINE66
  2E72  0F            		rrca
  2E73  3801          		jr	c,SKIPY
                      	;screen mode 1 or 3: dy=dy*2
  2E75  29            		add	hl,hl
                      	
  2E76                	SKIPY:
  2E76  EB            		ex	de,hl
  2E77  ED4BB1FE      		ld	bc,(GRPX3)	;start (x)
  2E7B  2AADFE        		ld	hl,(GRPX2)	;end (x)
  2E7E  B7            		or	a
  2E7F  ED42          		sbc	hl,bc		;dx
  2E81  B7            		or	a
  2E82  2004          		jr	nz,SKIPX
                      	;screen mode 1: dx=dx*3
  2E84  44            		ld	b,h
  2E85  4D            		ld	c,l
  2E86  29            		add	hl,hl
  2E87  09            		add	hl,bc
                      	
  2E88                	SKIPX:
  2E88  D5            		push	de		;dy
  2E89  E5            		push	hl		;dx
                      	
  2E8A  CB7C          		bit	7,h
  2E8C  2806          		jr	z,DXPLUS	;dx>0
                      	;if dx<0, hl=-hl
  2E8E  AF            		xor	a
  2E8F  95            		sub	l
  2E90  6F            		ld	l,a
  2E91  9C            		sbc	a,h
  2E92  95            		sub	l
  2E93  67            		ld	h,a
  2E94                	DXPLUS:
  2E94  E7            		rst	CPHLDE
  2E95  D2B12C        		jp	nc,SLOPEX	;if |dy/dx|<=1
                      	
                      	;|dy/dx|>1
  2E98  D5            		push	de		;error=dy
                      	
  2E99  ED5BB3FE      		ld	de,(GRPY3)
  2E9D                	LINELP1:
  2E9D  ED4BB1FE      		ld	bc,(GRPX3)
  2EA1  CD472D        		call	PSET
                      	
  2EA4  E1            		pop	hl		;error
  2EA5  C1            		pop	bc		;dx
  2EA6  D1            		pop	de		;dy
  2EA7  D5            		push	de		;dy
  2EA8  C5            		push	bc		;dx
                      	
  2EA9  CD602B        		call	SUB2DX		;error-=|dx|*2
  2EAC  E5            		push	hl
  2EAD  CB7C          		bit	7,h
  2EAF  2807          		jr	z,ERRPLS
                      	
                      	;if error<0
  2EB1  E1            		pop	hl
  2EB2  19            		add	hl,de		;error+=dy
  2EB3  19            		add	hl,de		;error+=dy
  2EB4  E5            		push	hl		;error
  2EB5  CD252B        		call	INCGX		;increment or decrement X
                      	;	jr	c,LINEEND
                      	
  2EB8                	ERRPLS:
  2EB8  CD412B        		call	INCGY		;increment Y
  2EBB  2AAFFE        		ld	hl,(GRPY2)
  2EBE  E7            		rst	CPHLDE
  2EBF  30DC          		jr	nc,LINELP1
                      	
  2EC1                	LINEEND:
  2EC1  F1            		pop	af		;cancel error
  2EC2  F1            		pop	af		;cancel dx
  2EC3  F1            		pop	af		;cancel dy
                      	
  2EC4  C1            		pop	bc
  2EC5  D1            		pop	de
                      	
  2EC6                	LINEEND2:
  2EC6  E1            		pop	hl
  2EC7  22AFFE        		ld	(GRPY2),hl
  2ECA  E1            		pop	hl
  2ECB  22ADFE        		ld	(GRPX2),hl
  2ECE  E1            		pop	hl
  2ECF  C9            		ret
                      	
                      	
                      	;PAINT command
  2ED0                	C_PAIN:
  2ED0  CDEA2C        		call	GETGXY
  2ED3  C5            		push	bc		;X
  2ED4  D5            		push	de		;Y
  2ED5  3A93FD        		ld	a,(COLOR1)
  2ED8  2003          		jr	nz,PASETATT
  2EDA  CDE30D        		call	INT1INC
  2EDD                	PASETATT:
  2EDD  CDC015        		call	SETATT
  2EE0  7E            		ld	a,(hl)
  2EE1  FE2C          		cp	','
  2EE3  3AC5FE        		ld	a,(BORDERA)
  2EE6  2006          		jr	nz,PANZ
  2EE8  CDE30D        		call	INT1INC
  2EEB  32C6FE        		ld	(BORDERC),a
  2EEE                	PANZ:
  2EEE  5F            		ld	e,a
                      	;	jp	PAINT2
                      	
                      	
                      	;paint called by OKHOTSK
                      	;input: e=color code, (sp)=Y, (sp+2)=X
  2EEF                	_PAINT2:ds	PAINT2-_PAINT2
  2EF1                		org	PAINT2
                      	
  2EF1  7B            		ld	a,e
  2EF2  CDCF15        		call	CNVATT
  2EF5  32C5FE        		ld	(BORDERA),a
  2EF8  D1            		pop	de		;Y
  2EF9  C1            		pop	bc		;X
                      	
                      	
                      	;input: bc=x, de=y, (ATTDAT)=attribute, (BORDERA)=attribute, (BORDERC)=color
                      	;destroy: af,bc,de
  2EFA                	_PAINT:	ds	PAINT-_PAINT
  2EFA                		org	PAINT
                      	
  2EFA  3A92FD        		ld	a,(SCREEN1)
  2EFD  3D            		dec	a
  2EFE  C8            		ret	z		;screen mode 2
  2EFF  E5            		push	hl
  2F00  FA0B2F        		jp	m,PAINT1	;screen mode 1
  2F03  CD4514        		call	GXY2GAD60
  2F06                	PAMAIN:
  2F06  CD122F        		call	PADWN
  2F09  E1            		pop	hl
  2F0A  C9            		ret
                      	
  2F0B                	PAINT1:
  2F0B  CD8E3F        		call	GXY2AD60
  2F0E  16FF          		ld	d,0ffh
  2F10  18F4          		jr	PAMAIN
                      	
                      	
  2F12                	PADWN:
  2F12  CDC42F        		call	PALINE
  2F15  C8            		ret	z
  2F16  E5            		push	hl		;address
  2F17  D5            		push	de		;bit
  2F18  ED4BB5FE      		ld	bc,(PAWRK)
  2F1C  C5            		push	bc
  2F1D  CD812F        		call	PAUP2
  2F20  E1            		pop	hl
  2F21  22B5FE        		ld	(PAWRK),hl
  2F24  D1            		pop	de		;bit
  2F25  E1            		pop	hl		;address
                      	
  2F26                	PADWN2:
  2F26  3A92FD        		ld	a,(SCREEN1)
  2F29  B7            		or	a
  2F2A  1E19          		ld	e,19h
  2F2C  2002          		jr	nz,PADWNG
  2F2E  1E01          		ld	e,01h
  2F30                	PADWNG:
  2F30  7C            		ld	a,h
  2F31  E61F          		and	1fh
  2F33  BB            		cp	e
  2F34  3804          		jr	c,PADWNOK
  2F36  7D            		ld	a,l
  2F37  FEE0          		cp	0e0h
  2F39  D0            		ret	nc
  2F3A                	PADWNOK:
  2F3A  012000        		ld	bc,COLUMNS
  2F3D  09            		add	hl,bc
                      	
  2F3E  AF            		xor	a
  2F3F  32B7FE        		ld	(PACNT),a
  2F42                	PADWNLP1:
  2F42  CD1E30        		call	SRCHOK
  2F45  3812          		jr	c,CALLDWN
  2F47  E5            		push	hl		;address
  2F48  21B7FE        		ld	hl,PACNT
  2F4B  34            		inc	(hl)
  2F4C  D5            		push	de		;bit
  2F4D  CDEA34        		call	CHKFRE
  2F50  D1            		pop	de
  2F51  E1            		pop	hl
  2F52  E5            		push	hl
  2F53  D5            		push	de
                      	
                      	;	ld	a,l
                      	;	inc	a
                      	;	and	1fh
                      	;	jr	nz,PADWNNZ
                      	;	bit	0,d
                      	;	jr	nz,CALLDWN
                      	;PADWNNZ:
                      	;	call	INCGXPA
                      	
  2F54  CD3730        		call	SRCHNG
  2F57  30E9          		jr	nc,PADWNLP1
                      	
  2F59                	CALLDWN:
  2F59  3AB7FE        		ld	a,(PACNT)
  2F5C  B7            		or	a
  2F5D  C8            		ret	z
  2F5E                	PADWNLP2:
  2F5E  D1            		pop	de		;bit
  2F5F  E1            		pop	hl		;address
  2F60  3D            		dec	a
  2F61  32B7FE        		ld	(PACNT),a
  2F64  28AC          		jr	z,PADWN
  2F66  F5            		push	af
  2F67  CD122F        		call	PADWN
  2F6A  F1            		pop	af
  2F6B  18F1          		jr	PADWNLP2
                      	
                      	
  2F6D                	PAUP:
  2F6D  CDC42F        		call	PALINE
  2F70  C8            		ret	z
  2F71  E5            		push	hl		;address
  2F72  D5            		push	de		;bit
  2F73  ED4BB5FE      		ld	bc,(PAWRK)
  2F77  C5            		push	bc
  2F78  CD262F        		call	PADWN2
  2F7B  E1            		pop	hl
  2F7C  22B5FE        		ld	(PAWRK),hl
  2F7F  D1            		pop	de		;bit
  2F80  E1            		pop	hl		;address
                      	
  2F81                	PAUP2:
                      	;if (hl - start address) < 0020h
  2F81  3A92FD        		ld	a,(SCREEN1)
  2F84  E602          		and	02h		;0(screen mode 1) or 2(screen mode 3,4)
  2F86  5F            		ld	e,a
  2F87  7C            		ld	a,h
  2F88  E61F          		and	1fh
  2F8A  BB            		cp	e
  2F8B  2004          		jr	nz,PAUPNZ1
  2F8D  7D            		ld	a,l
  2F8E  FE20          		cp	20h
  2F90  D8            		ret	c
  2F91                	PAUPNZ1:
  2F91  01E0FF        		ld	bc,0-COLUMNS
  2F94  09            		add	hl,bc
                      	
  2F95  AF            		xor	a
  2F96  32B7FE        		ld	(PACNT),a
  2F99                	PAUPLP1:
  2F99  CD1E30        		call	SRCHOK
  2F9C  3812          		jr	c,CALLUP
  2F9E  E5            		push	hl		;address
  2F9F  21B7FE        		ld	hl,PACNT
  2FA2  34            		inc	(hl)
  2FA3  D5            		push	de		;bit
  2FA4  CDEA34        		call	CHKFRE
  2FA7  D1            		pop	de
  2FA8  E1            		pop	hl
  2FA9  E5            		push	hl
  2FAA  D5            		push	de
                      	
                      	;	ld	a,l
                      	;	inc	a
                      	;	and	1fh
                      	;	jr	nz,PAUPNZ2
                      	;	bit	0,d
                      	;	jr	nz,CALLUP
                      	;PAUPNZ2:
                      	;	call	INCGXPA
                      	
  2FAB  CD3730        		call	SRCHNG
  2FAE  30E9          		jr	nc,PAUPLP1
                      	
  2FB0                	CALLUP:
  2FB0  3AB7FE        		ld	a,(PACNT)
  2FB3  B7            		or	a
  2FB4  C8            		ret	z
  2FB5                	PAUPLP2:
  2FB5  D1            		pop	de		;bit
  2FB6  E1            		pop	hl		;address
  2FB7  3D            		dec	a
  2FB8  32B7FE        		ld	(PACNT),a
  2FBB  28B0          		jr	z,PAUP
  2FBD  F5            		push	af
  2FBE  CD6D2F        		call	PAUP
  2FC1  F1            		pop	af
  2FC2  18F1          		jr	PAUPLP2
                      	
                      	
                      	;paint 1 line
                      	;input: hl=address, d=bit
                      	;output: hl, d, z-flag(1=not painted)
                      	;destroy: af,bc
  2FC4                	PALINE:
  2FC4  CD4D27        		call	STOPESC
  2FC7  CD0F30        		call	CHKPA
  2FCA  C8            		ret	z
  2FCB  E5            		push	hl		;address
  2FCC  D5            		push	de		;bit
  2FCD  CDF42F        		call	PAINTR
  2FD0  7D            		ld	a,l
  2FD1  E61F          		and	1fh
  2FD3  6F            		ld	l,a
  2FD4  62            		ld	h,d
  2FD5  22B5FE        		ld	(PAWRK),hl	;X_right
  2FD8  D1            		pop	de		;bit
  2FD9  E1            		pop	hl		;address
                      	;	jr	PAINTL		;z-flag=0
                      	
                      	
                      	;paint to left direction
                      	;input: hl=address, d=bit
                      	;output: hl, d, z-flag=0
                      	;destroy: af,bc
  2FDA                	PAINTL:
  2FDA  7D            		ld	a,l
  2FDB  E61F          		and	1fh
  2FDD  2003          		jr	nz,PALOK
  2FDF  CB7A          		bit	7,d
  2FE1  C0            		ret	nz
                      	
  2FE2                	PALOK:
  2FE2  CD0530        		call	DECGXPA
  2FE5  CD0F30        		call	CHKPA
  2FE8  20F0          		jr	nz,PAINTL
                      	;	jp	INCGXPA
                      	
                      	
                      	;increment x for paint
                      	;input: hl=address, d=bit
                      	;output: hl, d, z-flag=0
                      	;destroy: af
  2FEA                	INCGXPA:
  2FEA  CB0A          		rrc	d
  2FEC  E2F12F        		jp	po,INCGXPA4	;screen mode 4
  2FEF  CB0A          		rrc	d		;screen mode 1 or 3
  2FF1                	INCGXPA4:
  2FF1  D0            		ret	nc
  2FF2  23            		inc	hl
  2FF3  C9            		ret
                      	
                      	
                      	;paint to right direction
                      	;input: hl=address, d=bit
                      	;output: hl,d
                      	;destroy: af,bc
  2FF4                	PAINTR:
  2FF4  7D            		ld	a,l
  2FF5  3C            		inc	a
  2FF6  E61F          		and	1fh
  2FF8  2003          		jr	nz,PAROK
  2FFA  CB42          		bit	0,d
  2FFC  C0            		ret	nz
                      	
  2FFD                	PAROK:
  2FFD  CDEA2F        		call	INCGXPA
  3000  CD0F30        		call	CHKPA
  3003  20EF          		jr	nz,PAINTR
                      	;	jp	DECGXPA
                      	
                      	
                      	;decrement x for paint
                      	;input: hl=address, d=bit
                      	;output: hl, d
                      	;destroy: af
  3005                	DECGXPA:
  3005  CB02          		rlc	d
  3007  E20C30        		jp	po,DECGXPA4	;screen mode 4
  300A  CB02          		rlc	d		;screen mode 1 or 3
  300C                	DECGXPA4:
  300C  D0            		ret	nc
  300D  2B            		dec	hl
  300E  C9            		ret
                      	
                      	
                      	;check and paint
                      	;input: hl=address, d=bit
                      	;output: z(1=not painted)
                      	;destroy: af
  300F                	CHKPA:
  300F  3AC5FE        		ld	a,(BORDERA)
  3012  AE            		xor	(hl)
  3013  A2            		and	d
  3014  C8            		ret	z
                      	
  3015  3AACFE        		ld	a,(ATTDAT)
  3018  AE            		xor	(hl)
  3019  A2            		and	d
  301A  AE            		xor	(hl)
  301B  77            		ld	(hl),a
  301C  B2            		or	d		;d>0, reset z-flag
  301D  C9            		ret
                      	
                      	
                      	;search for paintable area
                      	;input: hl=address, d=bit
                      	;output: hl, d, c-flag(1=over,0=OK)
                      	;destroy: af,e
  301E                	SRCHOK:
  301E  CD4930        		call	CMPPAX
  3021  D8            		ret	c
                      	
  3022  5E            		ld	e,(hl)
  3023  3AC5FE        		ld	a,(BORDERA)
  3026  AB            		xor	e
  3027  A2            		and	d
  3028  2806          		jr	z,SRCHOKZ
                      	
  302A  3AACFE        		ld	a,(ATTDAT)
  302D  AB            		xor	e
  302E  A2            		and	d
  302F  C0            		ret	nz		;c-flag=0
                      	
  3030                	SRCHOKZ:
  3030  CD5930        		call	GXLARGE
  3033  20E9          		jr	nz,SRCHOK
  3035  37            		scf
  3036  C9            		ret
                      	
                      	
                      	;search for unpaintable area
                      	;get unpaintable area
                      	;input: hl=address, d=bit
                      	;output: hl, d, c-flag(1=over,0=NG)
                      	;destroy: af,e
  3037                	SRCHNG:
  3037  CD4930        		call	CMPPAX
  303A  D8            		ret	c
                      	
  303B  5E            		ld	e,(hl)
  303C  3AC5FE        		ld	a,(BORDERA)
  303F  AB            		xor	e
  3040  A2            		and	d
  3041  C8            		ret	z		;c-flag=0
                      	
  3042  CD5930        		call	GXLARGE
  3045  20F0          		jr	nz,SRCHNG
  3047  37            		scf
  3048  C9            		ret
                      	
                      	
                      	;compare  X to (PAWRK)
                      	;input: hl=address, d=bit
                      	;output: f
                      	;destroy: af,e
  3049                	CMPPAX:
  3049  7D            		ld	a,l
  304A  E61F          		and	1fh
  304C  5F            		ld	e,a
  304D  3AB5FE        		ld	a,(PAWRK)	;address low (5 bits)
  3050  BB            		cp	e
  3051  C0            		ret	nz
                      	
  3052  3AB6FE        		ld	a,(PAWRK+1)	;bit
  3055  3D            		dec	a
  3056  BA            		cp	d
  3057  3F            		ccf
  3058  C9            		ret
                      	
                      	
                      	;increment x and compare graphic width (=320)
                      	;output: z-flag(1=over)
                      	;destroy: af
  3059                	GXLARGE:
  3059  CDEA2F        		call	INCGXPA
  305C  7D            		ld	a,l
  305D  E61F          		and	1fh
  305F  C0            		ret	nz
  3060  7A            		ld	a,d
  3061  2F            		cpl
  3062  E680          		and	80h
  3064  C9            		ret
                      	
                      	
                      	;STR$() function
  3065                	F_STR:
  3065  CD780B        		call	CHKNUM
  3068  CDAC3A        		call	FTOA
  306B  54            		ld	d,h
  306C  5D            		ld	e,l
                      	
  306D  06FF          		ld	b,0-01h
  306F                	STRLP:
  306F  04            		inc	b
  3070  1A            		ld	a,(de)
  3071  13            		inc	de
  3072  B7            		or	a
  3073  20FA          		jr	nz,STRLP
                      	
  3075  78            		ld	a,b
  3076  CD2226        		call	MAKESTR
  3079  C3C227        		jp	INKYEND
                      	
                      	
                      	;MODE key
                      	;destroy: af
  307C                	MODEKEY:
  307C  E5            		push	hl
  307D  D5            		push	de
  307E  C5            		push	bc
                      	
  307F  215AFA        		ld	hl,KEYFLG
  3082  CB5E          		bit	3,(hl)
  3084  283E          		jr	z,MODEEND
  3086  CB9E          		res	3,(hl)
                      	
  3088  2A5DFA        		ld	hl,(LINENUM)
  308B  7C            		ld	a,h
  308C  A5            		and	l
  308D  3C            		inc	a
  308E  2034          		jr	nz,MODEEND	;not direct command mode
                      	
  3090  CD8111        		call	CSROFF
                      	
  3093  21C70D        		ld	hl,MODESTR
  3096  CDCF30        		call	PUTS
  3099  3A65FE        		ld	a,(MODE)
  309C  3C            		inc	a
  309D  CD7A39        		call	PUTI1
  30A0  CD3927        		call	PUTNL
                      	
  30A3  3A8CFD        		ld	a,(PAGES)
  30A6  CD7A39        		call	PUTI1
  30A9  21CF0D        		ld	hl,PAGESTR
  30AC  CDCF30        		call	PUTS
                      	
  30AF  3A75FE        		ld	a,(DRVBIT)		;?
  30B2  B7            		or	a
  30B3  280C          		jr	z,SKPFILES
                      	
  30B5  3A31FB        		ld	a,(FILES)
  30B8  CD7A39        		call	PUTI1
  30BB  21D80D        		ld	hl,FILESTR
  30BE  CDCF30        		call	PUTS
                      	
  30C1                	SKPFILES:
  30C1  CD7911        		call	CSRON
                      	
  30C4                	MODEEND:
  30C4  C1            		pop	bc
  30C5  D1            		pop	de
  30C6  E1            		pop	hl
  30C7  C9            		ret
                      	
                      	
                      	;put characters (skip first character) (used by LIZARD)
  30C8                	_PUTSINC:ds	PUTSINC-_PUTSINC
  30CE                		org	PUTSINC
                      	
  30CE  23            		inc	hl
                      	
                      	;put characters
                      	;input: hl,(DEVICE)=0:CRT, 1:printer, 2:RS-232C, 80h-ffh:CMT
                      	;destroy: af,hl,(bc,de,FAC1)
  30CF                	_PUTS:	ds	PUTS-_PUTS
  30CF                		org	PUTS
                      	
  30CF  7E            		ld	a,(hl)
  30D0  B7            		or	a
  30D1  C8            		ret	z
  30D2  FE22          		cp	22h		;double quotation mark
  30D4  C8            		ret	z
  30D5  CDC726        		call	PUTDEV
  30D8  18F4          		jr	PUTSINC
                      	
                      	
                      	;input: bc=candidate of string descriptor address
                      	;       hl=string descriptor address to be checked
                      	;	(GCWRK)=candidate of string data address to be comacted
                      	;	stack=string descriptor address pointing to same data (endmark=0000)
                      	;output: bc=string descriptor address to be compacted
                      	;	 (GCWRK)=string data address to be comacted
                      	;	 hl=next string descriptor address
                      	;	 stack=string descriptor address pointing to same data (endmark=0000)
                      	;destroy: af,de
  30DA                	GETSTR:
  30DA  E5            		push	hl
  30DB  7E            		ld	a,(hl)
  30DC  23            		inc	hl
  30DD  23            		inc	hl
  30DE  5E            		ld	e,(hl)
  30DF  23            		inc	hl
  30E0  56            		ld	d,(hl)
  30E1  23            		inc	hl
                      	
  30E2  B7            		or	a
  30E3  2852          		jr	z,GETNOSTR2	;length=0
                      	
  30E5  E5            		push	hl
  30E6  2A56FF        		ld	hl,(VARAD)
  30E9  E7            		rst	CPHLDE
  30EA  304A          		jr	nc,GETNOSTR	;in program area
  30EC  2A3DFF        		ld	hl,(STRAD)
  30EF  E7            		rst	CPHLDE
  30F0  3844          		jr	c,GETNOSTR	;in work area or have been compacted
  30F2  2A41FF        		ld	hl,(GCWRK)
  30F5  E7            		rst	CPHLDE
  30F6  E1            		pop	hl
  30F7  2811          		jr	z,GETSTRZ
  30F9  303C          		jr	nc,GETNOSTR2	;de < candidate
                      	
                      	;new candidate found
  30FB  ED5341FF      		ld	(GCWRK),de
  30FF  C1            		pop	bc
  3100  D1            		pop	de		;return address
                      	
  3101                	GETSTRLP:
  3101  F1            		pop	af		;pushed address? (a=higher byte)
  3102  F5            		push	af
  3103  D5            		push	de		;return address
  3104  B7            		or	a
  3105  C8            		ret	z		;no data
  3106  D1            		pop	de		;return address
  3107  F1            		pop	af		;cancel
  3108  18F7          		jr	GETSTRLP
                      	
  310A                	GETSTRZ:
  310A  F1            		pop	af
  310B  D1            		pop	de		;return address
  310C  F5            		push	af
  310D  D5            		push	de		;return address
  310E  C9            		ret
                      	
                      	
                      	;garbage collection
                      	;destroy: af,bc,de,hl
  310F                	_GC:	ds	GC-_GC
  310F                		org	GC
                      	
  310F  2A27FF        		ld	hl,(STREND)
  3112  223DFF        		ld	(STRAD),hl
                      	
                      	;	ld	hl,0000h
  3115  2600          		ld	h,00h		;higher byte
  3117                	GCLP1:
  3117  E5            		push	hl
  3118  2241FF        		ld	(GCWRK),hl
  311B  2A56FF        		ld	hl,(VARAD)
                      	
                      	;normal variable
  311E                	GCVAR:
  311E  ED5B58FF      		ld	de,(ARRAD)
  3122  E7            		rst	CPHLDE
  3123  3014          		jr	nc,GCARR
  3125  23            		inc	hl
  3126  7E            		ld	a,(hl)
  3127  07            		rlca
  3128  3806          		jr	c,GCVARS
  312A  110600        		ld	de,0006h
  312D  19            		add	hl,de
  312E  18EE          		jr	GCVAR
  3130                	GCVARS:
  3130  23            		inc	hl
  3131  CDDA30        		call	GETSTR
  3134  18E8          		jr	GCVAR
                      	
                      	
  3136                	GETNOSTR:
  3136  E1            		pop	hl
  3137                	GETNOSTR2:
  3137  F1            		pop	af	;cancel
  3138  C9            		ret
                      	
                      	
                      	;array variable
  3139                	GCARR:
  3139  ED5B5AFF      		ld	de,(FREEAD)
  313D  E7            		rst	CPHLDE
  313E  3029          		jr	nc,GCSDSC
  3140  23            		inc	hl
  3141  7E            		ld	a,(hl)
  3142  23            		inc	hl
  3143  5E            		ld	e,(hl)
  3144  23            		inc	hl
  3145  56            		ld	d,(hl)
  3146  23            		inc	hl
  3147  07            		rlca
  3148  3803          		jr	c,GCARRS
  314A  19            		add	hl,de
  314B  18EC          		jr	GCARR
                      	
  314D                	GCARRS:
  314D  EB            		ex	de,hl
  314E  19            		add	hl,de
  314F  EB            		ex	de,hl
  3150  D5            		push	de
  3151  5E            		ld	e,(hl)		;dimensions
  3152  1600          		ld	d,00h
  3154  23            		inc	hl
  3155  19            		add	hl,de
  3156  19            		add	hl,de
  3157                	GCARRLP:
  3157  D1            		pop	de
  3158  E7            		rst	CPHLDE
  3159  30DE          		jr	nc,GCARR
  315B  ED5350FF      		ld	(TMP),de
  315F  CDDA30        		call	GETSTR
  3162  ED5B50FF      		ld	de,(TMP)
  3166  D5            		push	de
  3167  18EE          		jr	GCARRLP
                      	
                      	;temporary string descriptor
  3169                	GCSDSC:
  3169  212DFF        		ld	hl,STRDSC1
  316C  CDDA30        		call	GETSTR
                      	;	ld	hl,STRDSC2
  316F  CDDA30        		call	GETSTR
                      	;	ld	hl,STRDSC3
  3172  CDDA30        		call	GETSTR
                      	;	ld	hl,STRDSC4
  3175  CDDA30        		call	GETSTR
                      	
  3178  2A41FF        		ld	hl,(GCWRK)
  317B  7C            		ld	a,h
                      	;	or	l
  317C  B7            		or	a		;higher byte
  317D  D1            		pop	de		;cancel
  317E  C8            		ret	z
  317F  D5            		push	de
                      	
                      	;compaction
                      	;input:	bc=string descriptor address
                      	;	hl=string data address to be comacted
                      	
  3180  0A            		ld	a,(bc)
  3181  C5            		push	bc		;
  3182  0600          		ld	b,00h
  3184  4F            		ld	c,a
  3185  09            		add	hl,bc
  3186  2B            		dec	hl
  3187  ED5B3DFF      		ld	de,(STRAD)
  318B  EDB8          		lddr
  318D  ED533DFF      		ld	(STRAD),de
  3191  13            		inc	de
                      	
  3192  E1            		pop	hl		;
  3193                	GCLP2:
  3193  23            		inc	hl
  3194  23            		inc	hl
  3195  73            		ld	(hl),e
  3196  23            		inc	hl
  3197  72            		ld	(hl),d
  3198  E1            		pop	hl
  3199  7C            		ld	a,h
                      	;	or	l
  319A  B7            		or	a		;higher byte
  319B  CA1731        		jp	z,GCLP1
  319E  18F3          		jr	GCLP2
                      	
                      	
                      	;LEN() function
  31A0                	F_LEN:
  31A0  CD840B        		call	CHKSTR
  31A3                	SETI1A:
  31A3  6F            		ld	l,a
  31A4                	SETI1:
  31A4  CD5A0C        		call	I1TOF
  31A7                	SETTYP0:
  31A7  AF            		xor	a
  31A8  3225FF        		ld	(ARGTYP),a	;0=numeric
  31AB  C9            		ret
                      	
                      	
                      	;ASC() function
  31AC                	F_ASC:
  31AC  CD9226        		call	STRARG2
  31AF  B7            		or	a
  31B0  CAED03        		jp	z,FCERR
  31B3  1A            		ld	a,(de)
  31B4  18ED          		jr	SETI1A
                      	
                      	
                      	;CHR$() function
  31B6                	F_CHR:
  31B6  CD780B        		call	CHKNUM
  31B9  CD3507        		call	FTOI1
  31BC  43            		ld	b,e
  31BD  C3B027        		jp	INKYNZ
                      	
                      	
                      	;LEFT$() function
  31C0                	F_LEFT:
  31C0  CD9E26        		call	ARGSI1
  31C3  0E00          		ld	c,00h
  31C5  1824          		jr	MID
                      	
                      	
                      	;RIGHT$() function
  31C7                	F_RHT:
  31C7  CD9E26        		call	ARGSI1
  31CA  57            		ld	d,a		;
  31CB  93            		sub	e
  31CC  3001          		jr	nc,RHTNC
  31CE  AF            		xor	a
  31CF                	RHTNC:
  31CF  4F            		ld	c,a
  31D0  5A            		ld	e,d		;
  31D1  7A            		ld	a,d
  31D2  1817          		jr	MID
                      	
                      	
                      	;MID$() function
  31D4                	F_MID:
  31D4  CD9E26        		call	ARGSI1
  31D7  57            		ld	d,a		;length
  31D8  1D            		dec	e
  31D9  D5            		push	de		;d=length, e=2nd parameter-1
  31DA  1C            		inc	e
  31DB  CAED03        		jp	z,FCERR		;if 2nd parameter=0
                      	
  31DE  2A4EFF        		ld	hl,(PROGAD)
  31E1  1EFF          		ld	e,0ffh
  31E3  7E            		ld	a,(hl)
  31E4  FE2C          		cp	','
  31E6  CCBA26        		call	z,ARGI1
  31E9  C1            		pop	bc		;b=length, c=2nd parameter-1
  31EA  78            		ld	a,b
                      	
                      	;input: STRDSC1=string, a=string length, c=2nd parameter-1, e=3rd parameter
  31EB                	MID:
  31EB  91            		sub	c
  31EC  3001          		jr	nc,MIDNC
  31EE  AF            		xor	a
  31EF                	MIDNC:
  31EF  BB            		cp	e
  31F0  3801          		jr	c,MIDC
  31F2  7B            		ld	a,e
  31F3                	MIDC:
  31F3  47            		ld	b,a		;output length
  31F4  CD6526        		call	GCCHECK
  31F7  78            		ld	a,b		;output length
  31F8  2A2FFF        		ld	hl,(STRDSC1+2)
  31FB  0600          		ld	b,00h
  31FD  09            		add	hl,bc
  31FE  CD2226        		call	MAKESTR
  3201  2A4EFF        		ld	hl,(PROGAD)
  3204  CDA10B        		call	CHKRPAR
  3207  C3C227        		jp	INKYEND
                      	
                      	
                      	;VAL() function
  320A                	F_VAL:
  320A  CD9226        		call	STRARG2
  320D  EB            		ex	de,hl
  320E  CD9B39        		call	ATOF
  3211  1894          		jr	SETTYP0
                      	
                      	
                      	;FRE() function
  3213                	F_FRE:
  3213  2125FF        		ld	hl,ARGTYP
  3216  7E            		ld	a,(hl)
  3217  B7            		or	a
  3218  2815          		jr	z,FRENUM
  321A  3D            		dec	a
  321B  C2E403        		jp	nz,SNERR
                      	;string
  321E  77            		ld	(hl),a		;=0
  321F  322DFF        		ld	(STRDSC1),a	;=0
  3222  CD0F31        		call	GC
  3225  2A3DFF        		ld	hl,(STRAD)
  3228  ED5B5BFA      		ld	de,(STACK)
  322C  B7            		or	a
  322D  1807          		jr	CALCFRE
                      	;numeric
  322F                	FRENUM:
  322F  67            		ld	h,a		;a=0
  3230  6F            		ld	l,a
  3231  39            		add	hl,sp
  3232  ED5B5AFF      		ld	de,(FREEAD)
  3236                	CALCFRE:
                      	;	or	a
  3236  ED52          		sbc	hl,de
  3238  C35C0C        		jp	I2TOF
                      	
                      	
                      	;DIM command
  323B                	C_DIM:
  323B  CD8433        		call	CHKVAR
                      	
  323E  7E            		ld	a,(hl)
  323F  23            		inc	hl
  3240  FE28          		cp	'('
  3242  2049          		jr	nz,NOTARR
                      	
  3244  E5            		push	hl		;program address
  3245  CD2F34        		call	SRCHARR
  3248  D2FC03        		jp	nc,DDERR
  324B  CD7A33        		call	SETARNM
  324E  E1            		pop	hl		;program address
  324F  D5            		push	de		;array address
  3250  CB79          		bit	7,c
  3252  010400        		ld	bc,0004h
  3255  2001          		jr	nz,DIMSTR
  3257  0C            		inc	c		;numeric:bc=5, string:bc=4
  3258                	DIMSTR:
  3258  D5            		push	de		;array address
  3259  C5            		push	bc		;element bytes
                      	
  325A  48            		ld	c,b		;b=0
  325B                	DIMLP:
  325B  C5            		push	bc		;dimensions
  325C  CD1A0E        		call	INT2ARG
  325F  C1            		pop	bc		;dimensions
  3260  CB7A          		bit	7,d
  3262  C2ED03        		jp	nz,FCERR
  3265  0C            		inc	c
  3266  CAF303        		jp	z,OMERR		;over 255 dimensions
  3269  13            		inc	de		;+1
  326A  E1            		pop	hl		;element bytes
                      	
  326B  EB            		ex	de,hl
  326C  E3            		ex	(sp),hl		;push size, pop array address
  326D  EB            		ex	de,hl
                      	
  326E  D5            		push	de		;array address
  326F  E5            		push	hl		;element bytes
  3270  2A4EFF        		ld	hl,(PROGAD)
  3273  7E            		ld	a,(hl)
  3274  23            		inc	hl
  3275  FE2C          		cp	','
  3277  28E2          		jr	z,DIMLP
  3279  FE29          		cp	')'
  327B  C2E403        		jp	nz,SNERR
                      	
  327E                	CALLMKA:
  327E  CD4B34        		call	MAKEARR
  3281  2A4EFF        		ld	hl,(PROGAD)
                      	
  3284  2B            		dec	hl
  3285  D7            		rst	ANADAT
  3286  C8            		ret	z
  3287  23            		inc	hl
                      	
  3288  FE2C          		cp	','
  328A  C0            		ret	nz
  328B  18AE          		jr	C_DIM
                      	
                      	
  328D                	NOTARR:
  328D  2B            		dec	hl
  328E  224EFF        		ld	(PROGAD),hl
  3291  CDB633        		call	SRCHVAR
  3294  D0            		ret	nc
  3295  C3E033        		jp	MAKEVAR
                      	
                      	
                      	;get variable address
                      	;input: bc=variable name, hl=program address
                      	;output: de=variable address, (PROGAD)=next program address
                      	;destroy: FAC1,FAC2,af,de
  3298                	GETVAR:
  3298  C5            		push	bc
  3299  7E            		ld	a,(hl)
  329A  FE28          		cp	'('
  329C  280B          		jr	z,GETVARR
  329E  224EFF        		ld	(PROGAD),hl
  32A1  CDB633        		call	SRCHVAR
  32A4  DCE033        		call	c,MAKEVAR
  32A7  C1            		pop	bc
  32A8  C9            		ret
  32A9                	GETVARR:
  32A9  CDAE32        		call	GETARR
  32AC  C1            		pop	bc
  32AD  C9            		ret
                      	
                      	
                      	;get array address
                      	;input: bc=variable name, hl=program address of '('
                      	;output: de=array address
                      	;destroy: af,bc,hl
  32AE                	GETARR:
  32AE  23            		inc	hl
  32AF  224EFF        		ld	(PROGAD),hl
  32B2  C5            		push	bc		;variable name
  32B3  CD2F34        		call	SRCHARR
  32B6  300F          		jr	nc,ARROK
                      	
  32B8  D5            		push	de		;array address
  32B9  2A4EFF        		ld	hl,(PROGAD)
  32BC  E5            		push	hl		;program address
  32BD  CD4233        		call	DIMAUTO
  32C0  E1            		pop	hl		;program address
  32C1  224EFF        		ld	(PROGAD),hl
  32C4  D1            		pop	de		;array address
  32C5  13            		inc	de
  32C6  13            		inc	de
  32C7                	ARROK:
  32C7  EB            		ex	de,hl
  32C8  23            		inc	hl
  32C9  23            		inc	hl
  32CA  0600          		ld	b,00h
  32CC  4E            		ld	c,(hl)		;dimensions
  32CD  09            		add	hl,bc
  32CE  09            		add	hl,bc
  32CF  E5            		push	hl		;array address
  32D0  79            		ld	a,c
  32D1  08            		ex	af,af'		;dimensions
  32D2  F5            		push	af
  32D3  48            		ld	c,b		;=0
  32D4  C5            		push	bc		;pointer
  32D5  E5            		push	hl		;array address
  32D6  210100        		ld	hl,0001h
  32D9  2250FF        		ld	(TMP),hl	;multiplied sizes
                      	
  32DC                	GETALP:
  32DC  2A50FF        		ld	hl,(TMP)
  32DF  E5            		push	hl		;multiplied sizes
  32E0  2A4EFF        		ld	hl,(PROGAD)
  32E3  CD1A0E        		call	INT2ARG		;get suffix
  32E6  E1            		pop	hl		;multiplied sizes
  32E7  2250FF        		ld	(TMP),hl
  32EA  E1            		pop	hl		;array address
  32EB  D5            		push	de		;suffix
  32EC  56            		ld	d,(hl)		;de=size of each dimension
  32ED  2B            		dec	hl
  32EE  5E            		ld	e,(hl)
  32EF  2B            		dec	hl
  32F0  E3            		ex	(sp),hl		;push array address, pop suffix
  32F1  E7            		rst	CPHLDE
  32F2  D2F903        		jp	nc,BSERR
                      	
  32F5  D5            		push	de		;size
  32F6  ED5B50FF      		ld	de,(TMP)	;multiplied sizes
  32FA  CD6F24        		call	MULINT2		;hl = multiplied sizes * suffix
  32FD  C1            		pop	bc		;size
  32FE  EB            		ex	de,hl
  32FF  E1            		pop	hl		;array address
  3300  E3            		ex	(sp),hl		;push array address, pop pointer
  3301  19            		add	hl,de		;pointer += multiplied size * suffix
  3302  E5            		push	hl		;pointer
  3303  2A50FF        		ld	hl,(TMP)	;multiplied sizes
  3306  50            		ld	d,b		;size
  3307  59            		ld	e,c
  3308  CD6F24        		call	MULINT2		;hl = multiplied size * size
  330B  2250FF        		ld	(TMP),hl
  330E  E1            		pop	hl		;pointer
  330F  E3            		ex	(sp),hl		;push poniter, pop array address
  3310  E5            		push	hl		;array address
                      	
  3311  08            		ex	af,af'		;dimensions
  3312  3D            		dec	a
  3313  47            		ld	b,a
  3314  08            		ex	af,af'
  3315  2A4EFF        		ld	hl,(PROGAD)
  3318  7E            		ld	a,(hl)
  3319  FE2C          		cp	','
  331B  200A          		jr	nz,NOTCMM
  331D  23            		inc	hl
  331E  224EFF        		ld	(PROGAD),hl
  3321  04            		inc	b
                      	;	dec	b
                      	;	jr	nz,GETALP
  3322  10B8          		djnz	GETALP
  3324  C3E403        		jp	SNERR
                      	
  3327                	NOTCMM:
  3327  04            		inc	b
  3328  05            		dec	b
  3329  C2F903        		jp	nz,BSERR
  332C  CDA10B        		call	CHKRPAR
                      	
  332F  D1            		pop	de		;array address
  3330  E1            		pop	hl		;pointer
  3331  F1            		pop	af
  3332  08            		ex	af,af'
  3333  D1            		pop	de		;array address
  3334  C1            		pop	bc		;variable name
  3335  79            		ld	a,c
  3336  44            		ld	b,h
  3337  4D            		ld	c,l
  3338  29            		add	hl,hl		;*2
  3339  29            		add	hl,hl		;*4
  333A  07            		rlca
  333B  3801          		jr	c,NCMMSTR
  333D  09            		add	hl,bc		;*5
  333E                	NCMMSTR:
  333E  19            		add	hl,de
  333F  23            		inc	hl
  3340  EB            		ex	de,hl
  3341  C9            		ret
                      	
                      	
  3342                	DIMAUTO:
  3342  CD7A33        		call	SETARNM
  3345  D5            		push	de		;array address
                      	
  3346  CB79          		bit	7,c
  3348  010400        		ld	bc,0004h
  334B  2001          		jr	nz,AUTOSTR
  334D  0C            		inc	c		;numeric:bc=5, string:bc=4
  334E                	AUTOSTR:
  334E  D5            		push	de		;array address
  334F  C5            		push	bc		;element bytes
                      	
  3350  2A4EFF        		ld	hl,(PROGAD)
  3353  48            		ld	c,b		;b=0
  3354                	AUTOLP1:
  3354  C5            		push	bc		;dimensions
  3355  CD1A0E        		call	INT2ARG		;de=size
                      	;	ld	a,d
                      	;	or	a
                      	;	jp	nz,BSERR
                      	;	ld	a,e
                      	;	ld	e,0bh		;de=10+1
                      	;	cp	e
                      	;	jp	nc,BSERR
                      	
  3358  110B00        		ld	de,000bh
                      	
  335B  C1            		pop	bc		;dimensions
  335C  0C            		inc	c
  335D  79            		ld	a,c
  335E  FE04          		cp	04h
  3360  D2F903        		jp	nc,BSERR	;over 3 dimensions
                      	
  3363  EB            		ex	de,hl
  3364  D1            		pop	de		;element bytes
  3365  E3            		ex	(sp),hl		;push size, pop array address
  3366  E5            		push	hl		;array address
  3367  D5            		push	de		;element bytes
                      	
                      	
  3368  2A4EFF        		ld	hl,(PROGAD)
  336B  7E            		ld	a,(hl)
  336C  23            		inc	hl
  336D  FE2C          		cp	','
  336F  28E3          		jr	z,AUTOLP1
  3371  FE29          		cp	')'
  3373  C2E403        		jp	nz,SNERR
  3376  CD4B34        		call	MAKEARR
  3379  C9            		ret
                      	
                      	
                      	;set array name
                      	;input: bc=name, de=array address
                      	;output: de=array address (next of name)
                      	;destroy: af,hl
  337A                	SETARNM:
  337A  EB            		ex	de,hl
  337B  CDED34        		call	CHKSTK
  337E  70            		ld	(hl),b
  337F  23            		inc	hl
  3380  71            		ld	(hl),c
  3381  23            		inc	hl
  3382  EB            		ex	de,hl
  3383  C9            		ret
                      	
                      	
                      	;check variable name
                      	;input: hl=program address
                      	;output: bc=name, hl=next address
                      	;destroy: af
  3384                	CHKVAR:
  3384  7E            		ld	a,(hl)
  3385  23            		inc	hl
  3386  FE20          		cp	' '
  3388  28FA          		jr	z,CHKVAR
  338A  47            		ld	b,a
  338B  D641          		sub	'A'
  338D  FE1A          		cp	'Z'-'A'+1
  338F  D2E403        		jp	nc,SNERR
                      	;	call	GETNAME
                      	;	ret
                      	
                      	
                      	;get variable name
                      	;input: hl=2nd character address, b=1st character
                      	;output: bc=name, hl=next address
                      	;destroy: af
  3392                	GETNAME:
  3392  0E00          		ld	c,00h
  3394  2B            		dec	hl
  3395                	NAMELP1:
  3395  23            		inc	hl
  3396  7E            		ld	a,(hl)
  3397  FE20          		cp	' '
  3399  28FA          		jr	z,NAMELP1
  339B  FE24          		cp	'$'
  339D  2813          		jr	z,NAMESTR
  339F  CDBF0B        		call	ALPNUM
  33A2  D0            		ret	nc
  33A3  4F            		ld	c,a
  33A4                	NAMELP2:
  33A4  23            		inc	hl
  33A5  7E            		ld	a,(hl)
  33A6  FE20          		cp	' '
  33A8  28FA          		jr	z,NAMELP2
  33AA  CDBF0B        		call	ALPNUM
  33AD  38F5          		jr	c,NAMELP2
  33AF  FE24          		cp	'$'
  33B1  C0            		ret	nz
  33B2                	NAMESTR:
  33B2  23            		inc	hl
  33B3  CBF9          		set	7,c
  33B5  C9            		ret
                      	
                      	
                      	;search for variable
                      	;input: bc=variable name
                      	;output: de=variable address, c-flag(1=not found)
                      	;destroy: af,hl
  33B6                	SRCHVAR:
  33B6  2A5EFF        		ld	hl,(FNPAR)
  33B9  7D            		ld	a,l
  33BA  B8            		cp	b
  33BB  2006          		jr	nz,SRCHVMAIN
  33BD  7C            		ld	a,h
  33BE  B9            		cp	c
  33BF  1160FF        		ld	de,FNARG
  33C2  C8            		ret	z
                      	
  33C3                	SRCHVMAIN:
  33C3  ED5B56FF      		ld	de,(VARAD)
  33C7                	SRCHVLP:
  33C7  2A58FF        		ld	hl,(ARRAD)
  33CA  2B            		dec	hl
  33CB  E7            		rst	CPHLDE
  33CC  D8            		ret	c		;not found
  33CD  1A            		ld	a,(de)
  33CE  13            		inc	de
  33CF  B8            		cp	b		;
  33D0  1A            		ld	a,(de)
  33D1  13            		inc	de
  33D2  2002          		jr	nz,VARNEXT	;
  33D4  B9            		cp	c
  33D5  C8            		ret	z		;found
  33D6                	VARNEXT:
  33D6  07            		rlca			;c-flag=1 if string
  33D7  3F            		ccf
  33D8  210400        		ld	hl,6-2
  33DB  ED5A          		adc	hl,de
  33DD  EB            		ex	de,hl
  33DE  18E7          		jr	SRCHVLP
                      	
                      	
                      	;make variable
                      	;input: bc=variable name, de=variable address
                      	;output: de=de+2
                      	;destroy: af,bc,hl
  33E0                	MAKEVAR:
  33E0  C5            		push	bc		;variable name
  33E1  D5            		push	de		;variable address
                      	
  33E2  110600        		ld	de,0006h
  33E5  CB79          		bit	7,c
  33E7  2001          		jr	nz,MAKEVSTR	;numeric=7, string=6
  33E9  1C            		inc	e
  33EA                	MAKEVSTR:
  33EA  2A5AFF        		ld	hl,(FREEAD)
  33ED  ED4B58FF      		ld	bc,(ARRAD)
  33F1  B7            		or	a
  33F2  ED42          		sbc	hl,bc
  33F4  44            		ld	b,h
  33F5  4D            		ld	c,l
                      	
  33F6  2A5AFF        		ld	hl,(FREEAD)
                      	
  33F9  19            		add	hl,de
  33FA  D5            		push	de		;numeric=7, string=6
  33FB  CDED34        		call	CHKSTK
  33FE  D1            		pop	de		;numeric=7, string=6
  33FF  225AFF        		ld	(FREEAD),hl
  3402  2A58FF        		ld	hl,(ARRAD)
  3405  19            		add	hl,de
  3406  2258FF        		ld	(ARRAD),hl
                      	
  3409  78            		ld	a,b
  340A  B1            		or	c
  340B  280B          		jr	z,NOLDDR
  340D  2A5AFF        		ld	hl,(FREEAD)
  3410  E5            		push	hl		;
                      	;	or	a
  3411  ED52          		sbc	hl,de
  3413  2B            		dec	hl
  3414  D1            		pop	de		;
  3415  1B            		dec	de
  3416  EDB8          		lddr
  3418                	NOLDDR:
  3418  E1            		pop	hl		;variable address
  3419  C1            		pop	bc		;variable name
  341A  70            		ld	(hl),b
  341B  23            		inc	hl
  341C  71            		ld	(hl),c
  341D  23            		inc	hl
  341E  E5            		push	hl		;variable address
                      	
  341F  EB            		ex	de,hl
  3420  21AB0E        		ld	hl,ZERO
  3423  CB79          		bit	7,c
  3425  010400        		ld	bc,0004h
  3428  2001          		jr	nz,INISTR
  342A  0C            		inc	c		;numeric:bc=5, string:bc=4
  342B                	INISTR:
  342B  EDB0          		ldir
  342D  D1            		pop	de		;variable address
  342E  C9            		ret
                      	
                      	
                      	;search for array variable
                      	;input: bc=variable name
                      	;output: de=array address, c-flag(1=not found)
                      	;destroy: af,hl
  342F                	SRCHARR:
  342F  ED5B58FF      		ld	de,(ARRAD)
  3433                	SRCHALP:
  3433  2A5AFF        		ld	hl,(FREEAD)
  3436  2B            		dec	hl
  3437  E7            		rst	CPHLDE
  3438  D8            		ret	c		;not found
  3439  1A            		ld	a,(de)
  343A  13            		inc	de
  343B  B8            		cp	b		;
  343C  1A            		ld	a,(de)
  343D  13            		inc	de
  343E  2002          		jr	nz,ARRNEXT	;
  3440  B9            		cp	c
  3441  C8            		ret	z		;found
  3442                	ARRNEXT:
  3442  EB            		ex	de,hl
  3443  5E            		ld	e,(hl)
  3444  23            		inc	hl
  3445  56            		ld	d,(hl)
  3446  23            		inc	hl
  3447  19            		add	hl,de
  3448  EB            		ex	de,hl
  3449  18E8          		jr	SRCHALP
                      	
                      	
                      	;make array
                      	;input: c=dimensions, hl=program address
                      	;pushed: size*(1~255), array address, element bytes
                      	;destroy:
  344B                	MAKEARR:
  344B  224EFF        		ld	(PROGAD),hl
  344E  E1            		pop	hl		;return address
  344F  2250FF        		ld	(TMP),hl
  3452  D1            		pop	de		;element bytes
  3453  E1            		pop	hl		;array address
  3454  23            		inc	hl
  3455  23            		inc	hl
  3456  71            		ld	(hl),c		;dimensions
  3457  23            		inc	hl
  3458  EB            		ex	de,hl
                      	
  3459  41            		ld	b,c
  345A                	MKALP:
  345A  E3            		ex	(sp),hl		;push element bytes, pop size
  345B  EB            		ex	de,hl
  345C  73            		ld	(hl),e
  345D  23            		inc	hl
  345E  72            		ld	(hl),d
  345F  23            		inc	hl
  3460  E3            		ex	(sp),hl		;push array address, pop element bytes
  3461  C5            		push	bc		;dimensions
  3462  CD6F24        		call	MULINT2		;element bytes *= each dimension size
  3465  C1            		pop	bc		;dimensions
  3466  7A            		ld	a,d
  3467  B3            		or	e
  3468  C2F903        		jp	nz,BSERR	;for compatibility with N60-BASIC
  346B  D1            		pop	de		;array address
  346C  10EC          		djnz	MKALP
                      	
  346E  E5            		push	hl		;element bytes
  346F  EB            		ex	de,hl
  3470  60            		ld	h,b
  3471  69            		ld	l,c
  3472  29            		add	hl,hl
  3473  23            		inc	hl
  3474  19            		add	hl,de
  3475  DAF303        		jp	c,OMERR
                      	
  3478  E5            		push	hl		;dimensions*2 + element bytes + 1
  3479  ED5B5AFF      		ld	de,(FREEAD)
  347D  13            		inc	de		;+2(total bytes)
  347E  13            		inc	de
  347F  13            		inc	de		;+2(name)
  3480  13            		inc	de
  3481  19            		add	hl,de
  3482  DAF303        		jp	c,OMERR
  3485  CDED34        		call	CHKSTK
  3488  225AFF        		ld	(FREEAD),hl
                      	
  348B  79            		ld	a,c		;dimensions
  348C  D1            		pop	de		;dimensions*2 + element bytes + 1
  348D  E1            		pop	hl		;element bytes
  348E  E3            		ex	(sp),hl		;push element bytes, pop array address
                      	
  348F  73            		ld	(hl),e
  3490  23            		inc	hl
  3491  72            		ld	(hl),d
  3492  23            		inc	hl
  3493  23            		inc	hl
  3494  09            		add	hl,bc
  3495  09            		add	hl,bc
                      	
  3496  70            		ld	(hl),b		;b=0
  3497  54            		ld	d,h
  3498  5D            		ld	e,l
  3499  13            		inc	de
  349A  C1            		pop	bc		;element bytes
  349B  0B            		dec	bc
  349C  EDB0          		ldir
  349E  2A50FF        		ld	hl,(TMP)	;return address
  34A1  E9            		jp	(hl)
                      	
                      	
                      	;put into variable
                      	;input: bc=variable name, hl=program address, de=variable address
                      	;output: hl=next program address
                      	;destroy: FAC1,FAC2,af,bc,de
  34A2                	VARIN:
  34A2  CD5A3F        		call	SKIPSP
  34A5  FED2          		cp	EQ_		;0d2h
  34A7  C2E403        		jp	nz,SNERR
                      	
  34AA  D5            		push	de		;variable address
  34AB  23            		inc	hl
  34AC  CB79          		bit	7,c
  34AE  2814          		jr	z,VARNUM
                      	
                      	;string
  34B0  CD8926        		call	STRARG
  34B3  47            		ld	b,a
  34B4  7A            		ld	a,d
  34B5  FEFA          		cp	0fah		;fa00h=work area start address
  34B7  78            		ld	a,b
  34B8  EB            		ex	de,hl
  34B9  D42226        		call	nc,MAKESTR
  34BC  212DFF        		ld	hl,STRDSC1
  34BF  010400        		ld	bc,0004h
  34C2  1809          		jr	VARINOK
                      	
  34C4                	VARNUM:
  34C4  CD6F0B        		call	NUMARGMO
  34C7  2166FF        		ld	hl,FAC1
  34CA  010500        		ld	bc,0005h
  34CD                	VARINOK:
  34CD  D1            		pop	de		;variable address
  34CE  EDB0          		ldir
  34D0  2A4EFF        		ld	hl,(PROGAD)
  34D3  C9            		ret
                      	
                      	
                      	;NEW command
  34D4                	C_NEW:
  34D4  214204        		ld	hl,EDIT
  34D7  E5            		push	hl
                      	
  34D8                	NEWRESSTK:
  34D8  21F934        		ld	hl,RESSTK
  34DB  E5            		push	hl
                      	;	jp	NEW
                      	
                      	;destroy: af,hl
  34DC                	NEW:
  34DC  2A29FF        		ld	hl,(BASICAD)
  34DF  AF            		xor	a
  34E0  77            		ld	(hl),a
  34E1  23            		inc	hl
  34E2  77            		ld	(hl),a
  34E3  23            		inc	hl
  34E4  77            		ld	(hl),a
  34E5  23            		inc	hl
  34E6  2256FF        		ld	(VARAD),hl
  34E9  C9            		ret
                      	
                      	
                      	;check free size
                      	;output: de=free size
                      	;destroy: f,hl
  34EA                	CHKFRE:
  34EA  2A5AFF        		ld	hl,(FREEAD)
                      	
                      	;check stack size
                      	;hl <= stack - 003bh?
                      	;input: hl=address
                      	;output: de=free size
                      	;destroy: f
  34ED                	CHKSTK:
  34ED  EB            		ex	de,hl
  34EE  21C6FF        		ld	hl,0-003bh+1
  34F1  39            		add	hl,sp
  34F2  ED52          		sbc	hl,de		;c-flag=1
  34F4  DAF303        		jp	c,OMERR
  34F7  EB            		ex	de,hl
  34F8  C9            		ret
                      	
                      	
                      	;reset stack and variables
                      	;destroy: a,bc,de
  34F9                	_RESSTK:ds	RESSTK-_RESSTK
  34F9                		org	RESSTK
                      	
  34F9  EB            		ex	de,hl
  34FA  C1            		pop	bc		;return address
  34FB  ED7B5BFA      		ld	sp,(STACK)
  34FF  C5            		push	bc		;return address
  3500  3EFF          		ld	a,0ffh
  3502  3255FF        		ld	(STOPAD+1),a
                      	
  3505  2A56FF        		ld	hl,(VARAD)
  3508  2258FF        		ld	(ARRAD),hl
  350B  225AFF        		ld	(FREEAD),hl
  350E                	RSTRZ:
  350E  2A29FF        		ld	hl,(BASICAD)
  3511  225CFF        		ld	(DATAAD),hl
  3514  EB            		ex	de,hl
  3515  C9            		ret
                      	
                      	
                      	;RESTORE command
  3516                	C_RSTR:
  3516  CD613F        		call	CHKCLN
  3519  224EFF        		ld	(PROGAD),hl
  351C  28F0          		jr	z,RSTRZ
  351E  CD5F07        		call	GETLN
  3521  224EFF        		ld	(PROGAD),hl
  3524  CDF304        		call	SRCHLN
  3527  D2F603        		jp	nc,ULERR
  352A  ED435CFF      		ld	(DATAAD),bc
  352E  C9            		ret
                      	
                      	
                      	;STOP command
  352F                	C_STOP:
  352F  CD613F        		call	CHKCLN
  3532  C2E403        		jp	nz,SNERR
  3535  F1            		pop	af		;cancel return address
                      	
  3536                	STOP1:
  3536  7C            		ld	a,h
  3537  FEFA          		cp	0fah
  3539  300F          		jr	nc,STOPNC
  353B                	STOP2:
  353B  2254FF        		ld	(STOPAD),hl
  353E                	STOP3:
  353E  2A8FFD        		ld	hl,(SCREEN2)	;l=(SCREEN2),h=(SCREEN3)
  3541  225EFE        		ld	(STOPSC2),hl	;(STOPSC2)=l,(STOPSC3)=h
  3544  2A5DFA        		ld	hl,(LINENUM)
  3547  2252FF        		ld	(STOPLN),hl
  354A                	STOPNC:
  354A  FB            		ei
  354B  AF            		xor	a
  354C  3218FA        		ld	(STOPFLG),a
                      	
  354F  CD5709        		call	PRTNLX
  3552  CD6D13        		call	CHGTXT
  3555  215E35        		ld	hl,BREAK
  3558  CDCF30        		call	PUTS
  355B  C33604        		jp	PRTLNUM
                      	
  355E                	BREAK:
  355E  07427265616B00		db	07h, "Break", 00h
                      	
                      	
                      	;END command
  3565                	C_END:
  3565  F1            		pop	af		;cancel stack
  3566  C34204        		jp	EDIT
                      	
                      	
                      	;CONT command
  3569                	C_CONT:
  3569  F1            		pop	af		;cancel return address
                      	
  356A  7C            		ld	a,h
  356B  FEFA          		cp	0fah
  356D  DA1104        		jp	c,CNERR
                      	
  3570  2A54FF        		ld	hl,(STOPAD)
  3573  7C            		ld	a,h
  3574  FEFA          		cp	0fah
  3576  D24204        		jp	nc,EDIT		;if direct command mode
                      	
  3579  9F            		sbc	a,a		;c-flag=1
  357A  3255FF        		ld	(STOPAD+1),a	;a=ffh
                      	
  357D  EB            		ex	de,hl
  357E  2A52FF        		ld	hl,(STOPLN)
  3581  225DFA        		ld	(LINENUM),hl
  3584  2A5EFE        		ld	hl,(STOPSC2)	;l=(STOPSC2),h=(STOPSC3)
  3587  7D            		ld	a,l
  3588  CD0C14        		call	CHGACT
  358B  7C            		ld	a,h
  358C  CDED13        		call	CHGDSP
  358F  EB            		ex	de,hl
                      	
  3590  C30A07        		jp	INTPRT
                      	
                      	
                      	;CLEAR command
  3593                	C_CLR:
  3593  CD613F        		call	CHKCLN
  3596  CAF934        		jp	z,RESSTK
  3599  CD1A0E        		call	INT2ARG
  359C  CB7A          		bit	7,d
  359E  C2ED03        		jp	nz,FCERR
  35A1  D5            		push	de		;1st parameter
  35A2  ED5B27FF      		ld	de,(STREND)
  35A6  13            		inc	de
  35A7  7E            		ld	a,(hl)
  35A8  FE2C          		cp	','
  35AA  2007          		jr	nz,CLRNZ
  35AC  23            		inc	hl
  35AD  CD6F0B        		call	NUMARGMO
  35B0  CDB10C        		call	FTOI
                      	
  35B3                	CLRNZ:
  35B3  2A8DFD        		ld	hl,(USREND)
  35B6  23            		inc	hl
  35B7  E7            		rst	CPHLDE
  35B8  DAED03        		jp	c,FCERR
  35BB  EB            		ex	de,hl
  35BC  C1            		pop	bc		;1st parameter
  35BD  2B            		dec	hl
                      	
                      	;input: bc=1st parameter, hl=2nd parameter-1
  35BE                	CLRMAIN:
  35BE  E5            		push	hl		;2nd parameter-1
  35BF  B7            		or	a
  35C0  ED42          		sbc	hl,bc
  35C2  EB            		ex	de,hl
  35C3  2A56FF        		ld	hl,(VARAD)
  35C6  013800        		ld	bc,0038h
  35C9  09            		add	hl,bc
  35CA  EB            		ex	de,hl
  35CB  E7            		rst	CPHLDE
  35CC  DAF303        		jp	c,OMERR
  35CF  225BFA        		ld	(STACK),hl
  35D2  E1            		pop	hl		;2nd parameter-1
  35D3  2227FF        		ld	(STREND),hl
  35D6  223DFF        		ld	(STRAD),hl
  35D9  C3F934        		jp	RESSTK
                      	
                      	
                      	;NEXT command
  35DC                	C_NEXT:
  35DC  F1            		pop	af		;cancel return address
  35DD  0600          		ld	b,00h
  35DF                	NEXTLP:
  35DF  CD613F        		call	CHKCLN
  35E2  C48433        		call	nz,CHKVAR
  35E5  224EFF        		ld	(PROGAD),hl
                      	
  35E8                	NEXTVLP:
  35E8  CDD107        		call	SRCHSTK
  35EB  CAE103        		jp	z,NFERR		;not found or gosub identifier found
  35EE  33            		inc	sp		;identifier
                      	
  35EF  D1            		pop	de		;variable address
                      	
  35F0  78            		ld	a,b
  35F1  B7            		or	a
  35F2  2813          		jr	z,NEXTOK
                      	
  35F4  1B            		dec	de
  35F5  1A            		ld	a,(de)
  35F6  B9            		cp	c
  35F7  2007          		jr	nz,NEXTNZ
  35F9  1B            		dec	de
  35FA  1A            		ld	a,(de)
  35FB  13            		inc	de
  35FC  13            		inc	de
  35FD  B8            		cp	b
  35FE  2807          		jr	z,NEXTOK
  3600                	NEXTNZ:
  3600  211000        		ld	hl,0010h	;STEP(6)+TO(6)+line number(2)+program address(2)
  3603  39            		add	hl,sp
  3604  F9            		ld	sp,hl
  3605  18E1          		jr	NEXTVLP
                      	
  3607                	NEXTOK:
  3607  CD3D39        		call	POPF1		;STEP value
  360A  CD1F39        		call	PUSHF1		;STEP value
                      	
  360D  D5            		push	de		;variable address
  360E  EB            		ex	de,hl
  360F  CD8036        		call	SETADDF
  3612  D1            		pop	de		;variable address
  3613  D5            		push	de		;variable address
  3614  2166FF        		ld	hl,FAC1
  3617  CD0D0C        		call	SETF
                      	
  361A  D1            		pop	de		;variable address
                      	
  361B  CD4C39        		call	POPF2		;STEP value
  361E  CD3D39        		call	POPF1		;TO value
  3621  CD1F39        		call	PUSHF1		;TO value
  3624  CD2E39        		call	PUSHF2		;STEP value
                      	
  3627  D5            		push	de		;variable address
                      	
  3628  2A70FF        		ld	hl,(FAC2+3)
  362B  7C            		ld	a,h
  362C  B7            		or	a		;z-flag
  362D  7D            		ld	a,l
  362E  07            		rlca			;c-flag
  362F  EB            		ex	de,hl		;variable address
  3630  CD180C        		call	SETF2		;no change in z,c-flag
  3633  2822          		jr	z,STEP0		;if STEP value = 0
  3635  DC6E39        		call	c,EXFAC		;if STEP value < 0
  3638  CD1D3F        		call	CMPF
  363B  381F          		jr	c,NEXTEND	;for-next loop end
                      	
  363D                	NEXTCONT:
  363D  210E00        		ld	hl,000eh	;variable address(2)+STEP(6)+TO(6)
  3640  39            		add	hl,sp
  3641  5E            		ld	e,(hl)
  3642  23            		inc	hl
  3643  56            		ld	d,(hl)
  3644  ED535DFA      		ld	(LINENUM),de
  3648  23            		inc	hl
  3649  5E            		ld	e,(hl)
  364A  23            		inc	hl
  364B  56            		ld	d,(hl)
  364C  ED534EFF      		ld	(PROGAD),de
  3650  3E81          		ld	a,FOR
  3652  F5            		push	af		;identifier
  3653  33            		inc	sp
  3654  C3E706        		jp	INTPEND
                      	
  3657                	STEP0:
  3657  CD1D3F        		call	CMPF
  365A  20E1          		jr	nz,NEXTCONT
                      	
  365C                	NEXTEND:
  365C  211200        		ld	hl,0012h	;variable address(2)+STEP(6)+TO(6)+line number(2)+program address(2)
  365F  39            		add	hl,sp
  3660  F9            		ld	sp,hl
                      	
  3661  2A4EFF        		ld	hl,(PROGAD)
  3664  7E            		ld	a,(hl)
  3665  23            		inc	hl
  3666  FE2C          		cp	','
  3668  C2E706        		jp	nz,INTPEND
  366B  47            		ld	b,a		;not variable name
  366C  C3DF35        		jp	NEXTLP
                      	
                      	
                      	;+ operator
  366F                	O_PLS:
  366F  3A25FF        		ld	a,(ARGTYP)
  3672  B7            		or	a
  3673  281A          		jr	z,ADDF
                      	
  3675                	PLSSTR:
  3675  D603          		sub	03h		;string and string
  3677  CA2B26        		jp	z,ADDSTR
  367A  C30504        		jp	TMERR
                      	
                      	
                      	;FAC1=FAC1+1
                      	;destroy: FAC2,af,bc,de,hl
  367D                	INCF1:
  367D  21A10E        		ld	hl,PLSONE
                      	
                      	;set FAC2 and add
                      	;input: FAC1, hl=float address
  3680                	SETADDF:
  3680  CD180C        		call	SETF2
  3683  180A          		jr	ADDF
                      	
                      	
                      	;- operator
  3685                	O_MNS:
  3685  CD780B        		call	CHKNUM
                      	;	call	SUBF
                      	;	ret
                      	
                      	
                      	;FAC1 = FAC1 - FAC2
                      	;input: FAC1,FAC2
                      	;output: FAC1
                      	;destroy: FAC2,af,b,de,hl
  3688                	SUBF:
  3688  2170FF        		ld	hl,FAC2+3
  368B                	CHGSGNADD:
  368B  7E            		ld	a,(hl)
  368C  EE80          		xor	80h
  368E  77            		ld	(hl),a
                      	;	call	ADDF
                      	;	ret
                      	
                      	
                      	;FAC1 = FAC1 + FAC2
                      	;input: FAC1,FAC2
                      	;output: FAC1
                      	;destroy: FAC2,af,bc,de,hl
  368F                	ADDF:
  368F  2A70FF        		ld	hl,(FAC2+3)	;l=(FAC2+3),h=(FAC2+4)
  3692  7C            		ld	a,h
  3693  B7            		or	a
  3694  C8            		ret	z		;FAC2=0
                      	
  3695  E5            		push	hl
  3696  CBFD          		set	7,l
  3698  2270FF        		ld	(FAC2+3),hl
                      	
  369B  2A69FF        		ld	hl,(FAC1+3)	;l=(FAC1+3),h=(FAC1+4)
  369E  E5            		push	hl
  369F  CBFD          		set	7,l
  36A1  2269FF        		ld	(FAC1+3),hl
                      	
  36A4  94            		sub	h
  36A5  3814          		jr	c,ADD1GT2	;|FAC1| > |FAC2|
  36A7  2005          		jr	nz,ADD1LT2	;|FAC1| < |FAC2|
                      	
  36A9  CD1D3F        		call	CMPF
  36AC  380D          		jr	c,ADD1GT2	;|FAC1| > |FAC2|
                      	
  36AE                	ADD1LT2:
  36AE  CD6E39        		call	EXFAC
                      	
  36B1  D1            		pop	de		;e=(FAC1+3),d=(FAC1+4)
  36B2  E1            		pop	hl		;l=(FAC2+3),h=(FAC2+4)
                      	
  36B3  7A            		ld	a,d
  36B4  B7            		or	a
  36B5  2006          		jr	nz,ADDCHKSGN
  36B7  2269FF        		ld	(FAC1+3),hl
  36BA  C9            		ret
                      	
  36BB                	ADD1GT2:
  36BB  E1            		pop	hl		;l=(FAC1+3),h=(FAC1+4)
  36BC  D1            		pop	de		;e=(FAC2+3),d=(FAC2+4)
                      	
  36BD                	ADDCHKSGN:
  36BD  7C            		ld	a,h
  36BE  92            		sub	d
  36BF  47            		ld	b,a		;
                      	
  36C0  7D            		ld	a,l
  36C1  F5            		push	af		;sign
                      	
  36C2  AB            		xor	e
  36C3  07            		rlca
  36C4  F5            		push	af		;c-flag=0:same sign
  36C5  3009          		jr	nc,SAMESGN
                      	
  36C7  CD6E39        		call	EXFAC
  36CA  CDEE24        		call	NEGINT4
  36CD  CD6E39        		call	EXFAC
                      	
  36D0                	SAMESGN:
  36D0  0E00          		ld	c,00h		;guard/round/sticky bit
  36D2  2A6DFF        		ld	hl,(FAC2)
  36D5  ED5B6FFF      		ld	de,(FAC2+2)
                      	
  36D9                	ADDFLP1:
  36D9  78            		ld	a,b
  36DA  D608          		sub	08h
  36DC  3818          		jr	c,EXPLT8
  36DE  47            		ld	b,a
                      	
  36DF  7D            		ld	a,l
  36E0  E63F          		and	3fh
  36E2  2004          		jr	nz,SETSBIT
  36E4  0C            		inc	c
  36E5  0D            		dec	c
  36E6  2802          		jr	z,NOSBIT
  36E8                	SETSBIT:
  36E8  0E20          		ld	c,20h		;set sticky bit
  36EA                	NOSBIT:
  36EA  AD            		xor	l
  36EB  B1            		or	c
  36EC  4F            		ld	c,a
  36ED  6C            		ld	l,h
  36EE  63            		ld	h,e
  36EF  5A            		ld	e,d
  36F0  F1            		pop	af		;same sign?
  36F1  F5            		push	af
  36F2  9F            		sbc	a,a		;00h or ffh
  36F3  57            		ld	d,a
  36F4  18E3          		jr	ADDFLP1
                      	
  36F6                	EXPLT8:
  36F6  C608          		add	a,08h
  36F8  2813          		jr	z,SAMEEXP
                      	
  36FA                	ADDFLP2:
  36FA  F1            		pop	af		;same sign?
  36FB  F5            		push	af
  36FC  CB1A          		rr	d
  36FE  CB1B          		rr	e
  3700  CB1C          		rr	h
  3702  CB1D          		rr	l
                      	
  3704  79            		ld	a,c
  3705  CB19          		rr	c
  3707  E620          		and	20h		;sticky bit
  3709  B1            		or	c
                      	;	and	0e0h
  370A  4F            		ld	c,a
  370B  10ED          		djnz	ADDFLP2
                      	
  370D                	SAMEEXP:
  370D  226DFF        		ld	(FAC2),hl
  3710  ED536FFF      		ld	(FAC2+2),de
                      	
  3714  EB            		ex	de,hl
                      	
  3715  2A66FF        		ld	hl,(FAC1)
                      	;	ld	de,(FAC2)
  3718  19            		add	hl,de
  3719  2266FF        		ld	(FAC1),hl
  371C  2A68FF        		ld	hl,(FAC1+2)
  371F  ED5B6FFF      		ld	de,(FAC2+2)
  3723  ED5A          		adc	hl,de
  3725  2268FF        		ld	(FAC1+2),hl
                      	
  3728  17            		rla
  3729  E1            		pop	hl		;l-bit0=same sign?
  372A  AD            		xor	l
  372B  0F            		rrca
  372C  301A          		jr	nc,SEARCH1
                      	
  372E  216AFF        		ld	hl,FAC1+4
  3731  34            		inc	(hl)
  3732  CAF003        		jp	z,OVERR
                      	
                      	;	scf			;c-flag=1
  3735  2D            		dec	l		;dec hl,FAC1+3
  3736  CB1E          		rr	(hl)
  3738  2D            		dec	l		;dec hl,FAC1+2
  3739  CB1E          		rr	(hl)
  373B  2D            		dec	l		;dec hl,FAC1+1
  373C  CB1E          		rr	(hl)
  373E  2D            		dec	l		;dec hl,FAC1
  373F  CB1E          		rr	(hl)
                      	
  3741  79            		ld	a,c
  3742  CB19          		rr	c
  3744  E620          		and	20h		;sticky bit
  3746  B1            		or	c
                      	;	and	0e0h
  3747  4F            		ld	c,a
                      	
  3748                	SEARCH1:
  3748  2A66FF        		ld	hl,(FAC1)
  374B  ED5B68FF      		ld	de,(FAC1+2)
                      	;	ld	a,h
                      	;	or	l
                      	;	or	d
                      	;	or	e
                      	;	or	c
                      	;	jp	z,MULFZERO
                      	
  374F                	ADDFLP3:
  374F  CB7A          		bit	7,d
  3751  2014          		jr	nz,CHKROUND
  3753  CB21          		sla	c
  3755  ED6A          		adc	hl,hl
  3757  CB13          		rl	e
  3759  CB12          		rl	d
  375B  3A6AFF        		ld	a,(FAC1+4)
  375E  3D            		dec	a
  375F  326AFF        		ld	(FAC1+4),a
  3762  20EB          		jr	nz,ADDFLP3
  3764  C33338        		jp	MULFZERO	;pop af/jp SETZERO
                      	
                      	;round to the nearest even
  3767                	CHKROUND:
  3767  7D            		ld	a,l
  3768  0F            		rrca
  3769  79            		ld	a,c
  376A  8F            		adc	a,a
  376B  3015          		jr	nc,ADDSGN	;guard bit=0
  376D  2813          		jr	z,ADDSGN	;round bit=0 and sticky bit=0 and l=even
                      	
                      	;round up
  376F  23            		inc	hl
  3770  7C            		ld	a,h
  3771  B5            		or	l
  3772  200E          		jr	nz,ADDSGN
  3774  13            		inc	de
  3775  7A            		ld	a,d
  3776  B3            		or	e
  3777  2009          		jr	nz,ADDSGN
                      	
  3779  216AFF        		ld	hl,FAC1+4
  377C  34            		inc	(hl)
  377D  CAF003        		jp	z,OVERR
                      	;	ld	d,80h
  3780  63            		ld	h,e		;e=0
  3781  6B            		ld	l,e		;e=0
                      	
  3782                	ADDSGN:
  3782  F1            		pop	af		;sign
  3783  AA            		xor	d
  3784  E680          		and	80h
  3786  AA            		xor	d
  3787  57            		ld	d,a
                      	
                      	;set 4-byte integer in FAC1
                      	;input: de-hl
  3788                	SETI4:
  3788  2266FF        		ld	(FAC1),hl
  378B  ED5368FF      		ld	(FAC1+2),de
  378F  C9            		ret
                      	
                      	
                      	;FAC1 = FAC1 * 10
                      	;input: FAC1
                      	;output: FAC1
                      	;destroy: FAC2,af,bc,de,hl
  3790                	MULF10:
  3790  219837        		ld	hl,TEN
  3793  CD180C        		call	SETF2
  3796  1808          		jr	MULF
                      	
  3798                	TEN:
  3798  0000002084    		db	00h, 00h, 00h, 20h, 84h
                      	
                      	
                      	;* operator
  379D                	O_MUL:
  379D  CD780B        		call	CHKNUM
                      	;	call	MULF
                      	;	ret
                      	
                      	
                      	;FAC1 = FAC1 * FAC2
                      	;input: FAC1,FAC2
                      	;output: FAC1
                      	;destroy: FAC2,af,bc,de,hl
  37A0                	MULF:
                      	
                      	;result=bc-de-de'-hl'
                      	
  37A0  3A6AFF        		ld	a,(FAC1+4)
  37A3  B7            		or	a
  37A4  C8            		ret	z
                      	
  37A5  2171FF        		ld	hl,FAC2+4
  37A8  7E            		ld	a,(hl)
  37A9  B7            		or	a
  37AA  CA070C        		jp	z,SETZERO
                      	
  37AD  2D            		dec	l		;dec hl,FAC2+3
  37AE  7E            		ld	a,(hl)
  37AF  CBFE          		set	7,(hl)
  37B1  2E69          		ld	l,FAC1+3-(FAC1+3)/256*256	;hl=FAC1+3
  37B3  AE            		xor	(hl)
  37B4  F5            		push	af		;sign
  37B5  CBFE          		set	7,(hl)
                      	
  37B7  010000        		ld	bc,0000h
  37BA  50            		ld	d,b
  37BB  59            		ld	e,c
                      	
  37BC  D9            		exx
  37BD  E5            		push	hl
  37BE  D5            		push	de
  37BF  C5            		push	bc
                      	
  37C0  2A66FF        		ld	hl,(FAC1)
  37C3  ED5B68FF      		ld	de,(FAC1+2)
                      	;	or	a		;c-flag=0
                      	
  37C7  0620          		ld	b,20h
  37C9                	MULFLP:
                      	;shift result and FAC1
  37C9  D9            		exx
  37CA  CB18          		rr	b
  37CC  CB19          		rr	c
  37CE  CB1A          		rr	d
  37D0  CB1B          		rr	e
  37D2  D9            		exx
  37D3  CB1A          		rr	d
  37D5  CB1B          		rr	e
  37D7  CB1C          		rr	h
  37D9  CB1D          		rr	l
  37DB  300E          		jr	nc,MULFNC1
                      	
                      	;add
  37DD  D9            		exx
  37DE  2A6DFF        		ld	hl,(FAC2)
  37E1  19            		add	hl,de
  37E2  EB            		ex	de,hl
  37E3  2A6FFF        		ld	hl,(FAC2+2)
  37E6  ED4A          		adc	hl,bc
  37E8  44            		ld	b,h
  37E9  4D            		ld	c,l
  37EA  D9            		exx
  37EB                	MULFNC1:
  37EB  10DC          		djnz	MULFLP
                      	
  37ED  D9            		exx
  37EE  216AFF        		ld	hl,FAC1+4
  37F1  300D          		jr	nc,MULFNC2
                      	
                      	;shift result
  37F3  CB18          		rr	b
  37F5  CB19          		rr	c
  37F7  CB1A          		rr	d
  37F9  CB1B          		rr	e
  37FB  D9            		exx
  37FC  CB1A          		rr	d
                      	;	rr	e
                      	;	rr	h
                      	;	rr	l
  37FE  D9            		exx
  37FF  34            		inc	(hl)
                      	
  3800                	MULFNC2:
  3800  35            		dec	(hl)		;;
                      	
                      	;round to the nearest even
  3801  D9            		exx
  3802  7A            		ld	a,d
  3803  8F            		adc	a,a		;check d-bit7
  3804  3041          		jr	nc,NOROUNDUP
  3806  B3            		or	e
  3807  B4            		or	h
  3808  B5            		or	l
  3809  C1            		pop	bc
  380A  D1            		pop	de
  380B  E1            		pop	hl
  380C  D9            		exx
  380D  2004          		jr	nz,ROUNDUP
  380F  7B            		ld	a,e
  3810  0F            		rrca
  3811  300E          		jr	nc,MULFEND
                      	
  3813                	ROUNDUP:
  3813  13            		inc	de
  3814  7A            		ld	a,d
  3815  B3            		or	e
  3816  2009          		jr	nz,MULFEND
  3818  03            		inc	bc
  3819  78            		ld	a,b
  381A  B1            		or	c
  381B  2004          		jr	nz,MULFEND
                      	;	ld	b,80h
  381D  34            		inc	(hl)
  381E  CAF003        		jp	z,OVERR
                      	
  3821                	MULFEND:
  3821  ED5366FF      		ld	(FAC1),de
  3825  ED4368FF      		ld	(FAC1+2),bc
                      	
                      	;exponent
  3829  3A71FF        		ld	a,(FAC2+4)
  382C  86            		add	a,(hl)
  382D  3808          		jr	c,MULFC
  382F  D680          		sub	80h		;;not 81h
  3831  3009          		jr	nc,MULEXP
                      	
  3833                	MULFZERO:
  3833  F1            		pop	af		;cancel
  3834  C3070C        		jp	SETZERO
                      	
  3837                	MULFC:
  3837  D680          		sub	80h		;;not 81h
  3839                	MULFCHKOV:
  3839  D2F003        		jp	nc,OVERR
  383C                	MULEXP:
  383C  77            		ld	(hl),a		;exponent
  383D  28F4          		jr	z,MULFZERO
  383F  2D            		dec	l		;dec hl,FAC1+3
  3840  F1            		pop	af		;sign
  3841  07            		rlca
  3842  7E            		ld	a,(hl)
  3843  17            		rla
  3844  0F            		rrca
  3845  77            		ld	(hl),a
  3846  C9            		ret
                      	
  3847                	NOROUNDUP:
  3847  C1            		pop	bc
  3848  D1            		pop	de
  3849  E1            		pop	hl
  384A  D9            		exx
  384B  18D4          		jr	MULFEND
                      	
                      	
                      	;FAC1 = FAC1 * 0.1
                      	;input: FAC1
                      	;output: FAC1
                      	;destroy: FAC2,af,bc,de,hl
  384D                	DIVF10:
  384D  215638        		ld	hl,EM1
  3850  CD180C        		call	SETF2
  3853  C3A037        		jp	MULF
                      	
                      	;0.1
  3856                	EM1:
  3856  CDCCCC4C7D    		db	0cdh, 0cch, 0cch, 4ch, 7dh
                      	
                      	
                      	;/ operator
  385B                	O_DIV:
  385B  CD780B        		call	CHKNUM
                      	;	call	DIVF
                      	;	ret
                      	
                      	
                      	;FAC1 = FAC1 / FAC2
                      	;input: FAC1,FAC2
                      	;output: FAC1
                      	;destroy: FAC2,af,bc,de,hl
  385E                	DIVF:
  385E  3A6AFF        		ld	a,(FAC1+4)
  3861  B7            		or	a
  3862  C8            		ret	z
                      	
  3863  2171FF        		ld	hl,FAC2+4
  3866  7E            		ld	a,(hl)
  3867  B7            		or	a
  3868  CAFF03        		jp	z,DIV0ERR
                      	
  386B  2D            		dec	l		;dec hl,FAC2+3
  386C  7E            		ld	a,(hl)
  386D  CBFE          		set	7,(hl)
  386F  2E69          		ld	l,FAC1+3-(FAC1+3)/256*256	;hl=FAC1+3
  3871  AE            		xor	(hl)
  3872  F5            		push	af		;sign
  3873  CBFE          		set	7,(hl)
                      	
  3875  210000        		ld	hl,0000h
  3878  54            		ld	d,h
  3879  5D            		ld	e,l
                      	
  387A  D9            		exx			;
  387B  E5            		push	hl
  387C  D5            		push	de
                      	
  387D  CD0425        		call	CMPINT4
  3880  3007          		jr	nc,DIVFNC
  3882  216AFF        		ld	hl,FAC1+4
  3885  35            		dec	(hl)
  3886  CD3C3F        		call	SLAF1
                      	
  3889                	DIVFNC:
  3889  0620          		ld	b,20h
  388B                	DIVFLP:
  388B  3805          		jr	c,DIVFC1
  388D  CD0425        		call	CMPINT4
  3890  381A          		jr	c,DIVFC2
  3892                	DIVFC1:
  3892  2A66FF        		ld	hl,(FAC1)
  3895  ED5B6DFF      		ld	de,(FAC2)
  3899  B7            		or	a
  389A  ED52          		sbc	hl,de
  389C  2266FF        		ld	(FAC1),hl
  389F  2A68FF        		ld	hl,(FAC1+2)
  38A2  ED5B6FFF      		ld	de,(FAC2+2)
  38A6  ED52          		sbc	hl,de
  38A8  2268FF        		ld	(FAC1+2),hl
  38AB  B7            		or	a		;reset c-flag
  38AC                	DIVFC2:
  38AC  3F            		ccf
  38AD  D9            		exx			;
  38AE  ED6A          		adc	hl,hl
  38B0  CB13          		rl	e
  38B2  CB12          		rl	d
  38B4  D9            		exx			;
                      	
  38B5  CD3C3F        		call	SLAF1
  38B8  10D1          		djnz	DIVFLP
                      	
  38BA  17            		rla			;store c-flag
  38BB  CD0425        		call	CMPINT4		;no change in a
  38BE  D1            		pop	de
  38BF  E1            		pop	hl
  38C0  D9            		exx
                      	
  38C1  1F            		rra
  38C2  3809          		jr	c,DIVFUP
  38C4  07            		rlca
  38C5  381B          		jr	c,DIVFNOUP
                      	
                      	;round to the nearest even
  38C7  2004          		jr	nz,DIVFUP
  38C9  7D            		ld	a,l
  38CA  0F            		rrca
  38CB  3015          		jr	nc,DIVFNOUP
                      	
                      	;round up
  38CD                	DIVFUP:
  38CD  23            		inc	hl
  38CE  7C            		ld	a,h
  38CF  B5            		or	l
  38D0  2010          		jr	nz,DIVFNOUP
  38D2  13            		inc	de
  38D3  7A            		ld	a,d
  38D4  B3            		or	e
  38D5  200B          		jr	nz,DIVFNOUP
  38D7  216AFF        		ld	hl,FAC1+4
  38DA  34            		inc	(hl)
  38DB  CAF003        		jp	z,OVERR
  38DE  EB            		ex	de,hl		;hl<-0
  38DF  110080        		ld	de,8000h
                      	
  38E2                	DIVFNOUP:
  38E2  2266FF        		ld	(FAC1),hl
  38E5  ED5368FF      		ld	(FAC1+2),de
                      	
  38E9  3A71FF        		ld	a,(FAC2+4)
  38EC  47            		ld	b,a
  38ED  216AFF        		ld	hl,FAC1+4
  38F0  7E            		ld	a,(hl)
  38F1  90            		sub	b
  38F2  3806          		jr	c,DIVF1LT2
                      	
                      	;FAC1>=FAC2
  38F4  C681          		add	a,81h
  38F6  3F            		ccf
  38F7  C33938        		jp	MULFCHKOV
                      	
                      	
                      	;FAC1<FAC2
  38FA                	DIVF1LT2:
  38FA  F2070C        		jp	p,SETZERO
  38FD  C681          		add	a,81h
  38FF  C33C38        		jp	MULEXP
                      	
                      	
                      	;continued from CHKSGN
  3902                	CHKSGN2:
  3902  3A69FF        		ld	a,(FAC1+3)
  3905  07            		rlca
  3906  9F            		sbc	a,a		;00h or ffh
  3907  D8            		ret	c		;ffh
  3908  3C            		inc	a
  3909  C9            		ret			;01h
                      	
                      	
                      	;SGN() function
  390A                	F_SGN:
  390A  CD780B        		call	CHKNUM
  390D  EF            		rst	CHKSGN
  390E  C8            		ret	z
  390F  3C            		inc	a
  3910  CA1D0C        		jp	z,SETMNS1
  3913  C34122        		jp	SETPLS1
                      	
                      	
                      	;ABS() function
  3916                	F_ABS:
  3916  CD780B        		call	CHKNUM
  3919                	ABS:
  3919  2169FF        		ld	hl,FAC1+3
  391C  CBBE          		res	7,(hl)
  391E  C9            		ret
                      	
                      	
                      	;push FAC1
                      	;input: FAC1
                      	;output: sp=sp-6
                      	;destroy: af,hl
  391F                	PUSHF1:
  391F  F1            		pop	af		;return address
  3920  2A69FF        		ld	hl,(FAC1+3)
  3923  E5            		push	hl
  3924  2A67FF        		ld	hl,(FAC1+1)
  3927  E5            		push	hl
  3928  2A65FF        		ld	hl,(FAC1-1)
  392B  E5            		push	hl
  392C  F5            		push	af		;
  392D  C9            		ret
                      	
                      	
                      	;push FAC2
                      	;input: FAC2
                      	;output: sp=sp-6
                      	;destroy: af,hl
  392E                	PUSHF2:
  392E  F1            		pop	af		;return address
  392F  2A70FF        		ld	hl,(FAC2+3)
  3932  E5            		push	hl
  3933  2A6EFF        		ld	hl,(FAC2+1)
  3936  E5            		push	hl
  3937  2A6CFF        		ld	hl,(FAC2-1)
  393A  E5            		push	hl
  393B  F5            		push	af		;
  393C  C9            		ret
                      	
                      	
                      	;pop FAC1
                      	;input: none
                      	;output: FAC1,sp=sp+6
                      	;destroy: af,hl
  393D                	POPF1:
  393D  F1            		pop	af		;return address
  393E  E1            		pop	hl
  393F  2265FF        		ld	(FAC1-1),hl
  3942  E1            		pop	hl
  3943  2267FF        		ld	(FAC1+1),hl
  3946  E1            		pop	hl
  3947  2269FF        		ld	(FAC1+3),hl
  394A  F5            		push	af		;
  394B  C9            		ret
                      	
                      	
                      	;pop FAC2
                      	;input: none
                      	;output: FAC2,sp=sp+6
                      	;destroy: af,hl
  394C                	POPF2:
  394C  F1            		pop	af		;return address
  394D  E1            		pop	hl
  394E  226CFF        		ld	(FAC2-1),hl
  3951  E1            		pop	hl
  3952  226EFF        		ld	(FAC2+1),hl
  3955  E1            		pop	hl
  3956  2270FF        		ld	(FAC2+3),hl
  3959  F5            		push	af		;
  395A  C9            		ret
                      	
                      	
                      	;copy FAC1 to FAC2
                      	;input: FAC1
                      	;output: FAC2
                      	;destroy: hl
  395B                	CPYFAC:
  395B  2A65FF        		ld	hl,(FAC1-1)
  395E  226CFF        		ld	(FAC2-1),hl
  3961  2A67FF        		ld	hl,(FAC1+1)
  3964  226EFF        		ld	(FAC2+1),hl
  3967  2A69FF        		ld	hl,(FAC1+3)
  396A  2270FF        		ld	(FAC2+3),hl
  396D  C9            		ret
                      	
                      	
                      	;exchange FAC1 and FAC2
                      	;input: FAC1,FAC2
                      	;output: FAC1,FAC2
                      	;destroy: hl
  396E                	EXFAC:
  396E  F5            		push	af
  396F  CD2E39        		call	PUSHF2
  3972  CD5B39        		call	CPYFAC
  3975  CD3D39        		call	POPF1
  3978  F1            		pop	af
  3979  C9            		ret
                      	
                      	
                      	;print 1-byte integer (unsigned)
                      	;input: a
                      	;destroy: af,bc,de,hl
  397A                	_PUTI1:	ds	PUTI1-_PUTI1
  397A                		org	PUTI1
                      	
  397A  2600          		ld	h,0
  397C  6F            		ld	l,a
  397D  C3A13A        		jp	PUTI2
                      	
                      	
                      	;INT() function
                      	;(round toward minus infinity)
  3980                	F_INT:
  3980  CD780B        		call	CHKNUM
  3983                	INT:
  3983  CD5B39        		call	CPYFAC
  3986  CDE20C        		call	GETINT
  3989  CD1D3F        		call	CMPF
  398C  C8            		ret	z
  398D  D8            		ret	c
  398E  21A60E        		ld	hl,MNSONE
  3991  C38036        		jp	SETADDF
                      	
                      	
                      	;check BASIC mode
                      	;output: a=mode, z(1=mode 5)
                      	;destroy: f
  3994                	_CHKMOD:
  3994                		ds	CHKMOD-_CHKMOD
  3995                		org	CHKMOD
                      	
  3995  3A65FE        		ld	a,(MODE)
  3998  FE04          		cp	04h
  399A  C9            		ret
                      	
                      	
                      	;convert string to float
                      	;input: a=max length, hl=program address
                      	;output: FAC1, hl=next address (except for VAL())
                      	;destroy: FAC2, af,bc,de
  399B                	ATOF:
  399B  47            		ld	b,a
  399C  CD8C3A        		call	SKIPSPB
  399F  CA070C        		jp	z,SETZERO
  39A2  FE26          		cp	'&'
  39A4  CA3B3A        		jp	z,ATOFHEX
  39A7  2B            		dec	hl
                      	
  39A8  CDFC27        		call	ATOIF
                      	
  39AB  CD8C3A        		call	SKIPSPB
  39AE  C8            		ret	z
  39AF  0E00          		ld	c,00h		;after-dot counter
  39B1  FE2E          		cp	'.'
  39B3  280F          		jr	z,ATOFDOT
  39B5  05            		dec	b
  39B6  F620          		or	20h
  39B8  FE65          		cp	'e'
  39BA  281B          		jr	z,ATOFEXP
  39BC  2B            		dec	hl
  39BD  C9            		ret
                      	
  39BE                	ATOFLP1:
  39BE  CD2528        		call	CTOF
  39C1  3005          		jr	nc,CHKEXP
  39C3  0C            		inc	c
  39C4                	ATOFDOT:
  39C4  10F8          		djnz	ATOFLP1
  39C6  180F          		jr	ATOFEXP
                      	
  39C8                	CHKEXP:
  39C8  CD8C3A        		call	SKIPSPB
  39CB  280A          		jr	z,ATOFEXP
  39CD  05            		dec	b
  39CE  F620          		or	20h
  39D0  FE65          		cp	'e'
  39D2  2803          		jr	z,ATOFEXP
                      	
  39D4  2B            		dec	hl
  39D5  0600          		ld	b,00h
  39D7                	ATOFEXP:
  39D7  EB            		ex	de,hl
  39D8  CD1F39        		call	PUSHF1
  39DB  EB            		ex	de,hl
                      	
  39DC  C5            		push	bc		;c=after-dot counter
  39DD  78            		ld	a,b
  39DE  B7            		or	a
  39DF  2805          		jr	z,ATOFE0
  39E1  CDFC27        		call	ATOIF
  39E4  1805          		jr	CALCEXP
                      	
  39E6                	ATOFE0:
  39E6  E5            		push	hl		;program address
  39E7  CD070C        		call	SETZERO
  39EA  E1            		pop	hl		;program address
                      	
  39EB                	CALCEXP:
  39EB  C1            		pop	bc		;c=after-dot counter
  39EC  E5            		push	hl		;program address
  39ED  CD1F39        		call	PUSHF1
  39F0  69            		ld	l,c
  39F1  CD5A0C        		call	I1TOF
  39F4  CD4C39        		call	POPF2
  39F7  CD0F3E        		call	SUBF21
                      	
  39FA  D1            		pop	de		;program address
  39FB  CD5B39        		call	CPYFAC
  39FE  CD3D39        		call	POPF1
  3A01  D5            		push	de		;program address
                      	
  3A02  2170FF        		ld	hl,FAC2+3
  3A05  7E            		ld	a,(hl)
  3A06  F5            		push	af		;E sign
  3A07  CBBE          		res	7,(hl)
                      	
  3A09                	ATOFLP2:
  3A09  3A71FF        		ld	a,(FAC2+4)
  3A0C  B7            		or	a
  3A0D  2829          		jr	z,ATOFEND	;E0
                      	
  3A0F  3A6AFF        		ld	a,(FAC1+4)
  3A12  B7            		or	a
  3A13  2823          		jr	z,ATOFEND	;=0
                      	
  3A15  CD1F39        		call	PUSHF1
  3A18  CD1D0C        		call	SETMNS1
  3A1B  CD8F36        		call	ADDF
  3A1E  CD5B39        		call	CPYFAC
  3A21  CD3D39        		call	POPF1
                      	
  3A24  C1            		pop	bc		;b=E sign
  3A25  C5            		push	bc
  3A26  CD2E39        		call	PUSHF2
  3A29  78            		ld	a,b
  3A2A  07            		rlca
  3A2B  F5            		push	af
  3A2C  D49037        		call	nc,MULF10
  3A2F  F1            		pop	af
  3A30  DC4D38        		call	c,DIVF10
  3A33  CD4C39        		call	POPF2
                      	
  3A36  18D1          		jr	ATOFLP2
                      	
  3A38                	ATOFEND:
  3A38  F1            		pop	af
  3A39  E1            		pop	hl		;program address
  3A3A  C9            		ret
                      	
  3A3B                	ATOFHEX:
  3A3B  2B            		dec	hl
  3A3C  05            		dec	b
  3A3D  CD463A        		call	HEX
  3A40  EB            		ex	de,hl
  3A41  CD180D        		call	S2TOF
  3A44  EB            		ex	de,hl
  3A45  C9            		ret
                      	
                      	
                      	;convert hexadecimal string to integer
                      	;input: hl="&" address, b=max length-1("&")
                      	;output: de=decimal, hl=next address
                      	;destroy: af,bc
  3A46                	HEX:
  3A46  110000        		ld	de,0000h
  3A49                	HEXLP1:
  3A49  23            		inc	hl
  3A4A  7E            		ld	a,(hl)
  3A4B  FE20          		cp	' '
  3A4D  2003          		jr	nz,CHKH
  3A4F  10F8          		djnz	HEXLP1
  3A51  C9            		ret
                      	
  3A52                	CHKH:
  3A52  F620          		or	20h
  3A54  FE68          		cp	'h'
  3A56  C2E403        		jp	nz,SNERR
  3A59  05            		dec	b
  3A5A  0E05          		ld	c,05h
                      	
  3A5C                	HEXLP2:
  3A5C  23            		inc	hl
  3A5D  7E            		ld	a,(hl)
  3A5E  FE20          		cp	' '
  3A60  281F          		jr	z,HEXEND
  3A62  FE93          		cp	DEF		;93h
  3A64  281F          		jr	z,HEXDEF
  3A66  D630          		sub	'0'
  3A68  FE0A          		cp	'9'-'0'+1
  3A6A  3809          		jr	c,HEX0F
  3A6C  F620          		or	20h
  3A6E  D631          		sub	'a'-'0'
  3A70  FE06          		cp	'f'-'a'+1
  3A72  D0            		ret	nc		;not hex
  3A73  C60A          		add	a,0ah
  3A75                	HEX0F:
  3A75  0D            		dec	c
  3A76  CAF003        		jp	z,OVERR
  3A79  EB            		ex	de,hl
  3A7A  29            		add	hl,hl		;*2
  3A7B  29            		add	hl,hl		;*4
  3A7C  29            		add	hl,hl		;*8
  3A7D  29            		add	hl,hl		;*16
  3A7E  85            		add	a,l		;no carry
  3A7F  6F            		ld	l,a
  3A80  EB            		ex	de,hl
  3A81                	HEXEND:
  3A81  10D9          		djnz	HEXLP2
  3A83  23            		inc	hl
  3A84  C9            		ret
                      	
  3A85                	HEXDEF:
  3A85  53            		ld	d,e
  3A86  1EDE          		ld	e,0deh
  3A88  3E0F          		ld	a,0fh
  3A8A  18E9          		jr	HEX0F
                      	
                      	
                      	;skip space and decrement b
                      	;input: hl=program address, b=length
                      	;output: a=data, hl=next address, b=remained length, z-flag(1:b=0)
                      	;destroy: f
  3A8C                	SKIPSPB:
  3A8C  04            		inc	b
  3A8D                	SKIPSPBLP:
  3A8D  05            		dec	b
  3A8E  C8            		ret	z
  3A8F  7E            		ld	a,(hl)
  3A90  23            		inc	hl
  3A91  FE20          		cp	' '
  3A93  C0            		ret	nz
  3A94  18F7          		jr	SKIPSPBLP
                      	
                      	
                      	;print "in *****"
                      	;input: hl
                      	;destory: af,bc,de,hl
  3A96                	_INLNUM:
  3A96                		ds	INLNUM-_INLNUM
  3A99                		org	INLNUM
                      	
  3A99  E5            		push	hl		;
  3A9A  218B03        		ld	hl,ERRIN
  3A9D  CDCF30        		call	PUTS
  3AA0  E1            		pop	hl		;
                      	;	jp	PUTI2
                      	
                      	
                      	;print 2-byte integer (unsigned)
                      	;input: hl
                      	;destory: af,bc,de,hl
  3AA1                	_PUTI2:	ds	PUTI2-_PUTI2
  3AA1                		org	PUTI2
                      	
  3AA1  11CE30        		ld	de,PUTSINC
  3AA4  D5            		push	de
                      	;	jp	I2TOA
                      	
                      	
                      	;convert 2-byte integer (unsigned) to string
                      	;input: hl
                      	;output: FAC3, hl=FAC3
                      	;destroy: af,bc,de
  3AA5                	_I2TOA:	ds	I2TOA-_I2TOA
  3AA5                		org	I2TOA
                      	
  3AA5  CD5C0C        		call	I2TOF
  3AA8  C3AC3A        		jp	FTOA
                      	
                      	
                      	;convert float to string
                      	;input: FAC1
                      	;output: FAC3, hl=FAC3
                      	;destroy: FAC1,FAC2,af,bc,de
  3AAB                	_FTOA:	ds	FTOA-_FTOA
  3AAC                		org	FTOA
                      	
  3AAC  2172FF        		ld	hl,FAC3
  3AAF  3620          		ld	(hl),' '
  3AB1  EF            		rst	CHKSGN
  3AB2  CA643B        		jp	z,FTOAZERO	;a=0
  3AB5  3D            		dec	a
  3AB6  2802          		jr	z,FTOAPLS	;if FAC1>0
  3AB8  362D          		ld	(hl),'-'
  3ABA                	FTOAPLS:
  3ABA  CD1939        		call	ABS
                      	
  3ABD                	FTOA2:
  3ABD  216D3B        		ld	hl,E8
  3AC0  CD1A3F        		call	SETCMPF
  3AC3  3070          		jr	nc,LARGE	;FAC1 >= 1e8
  3AC5  21813B        		ld	hl,EM2
  3AC8  CD1A3F        		call	SETCMPF
  3ACB  3856          		jr	c,SMALL		;FAC1 < 1e-2
                      	
  3ACD  0609          		ld	b,09h
  3ACF                	FTOALP1:
  3ACF  C5            		push	bc
  3AD0  21723B        		ld	hl,E7
  3AD3  CD1A3F        		call	SETCMPF
  3AD6  3007          		jr	nc,FTOAOK
  3AD8  CD9037        		call	MULF10
  3ADB  C1            		pop	bc
  3ADC  10F1          		djnz	FTOALP1
  3ADE  C5            		push	bc
                      	
  3ADF                	FTOAOK:
  3ADF  3A6AFF        		ld	a,(FAC1+4)
  3AE2  D697          		sub	97h
  3AE4  47            		ld	b,a
  3AE5  3A66FF        		ld	a,(FAC1)
  3AE8                	FTOALP2:
  3AE8  07            		rlca
  3AE9  10FD          		djnz	FTOALP2
  3AEB  DC7D36        		call	c,INCF1		;round up
                      	
  3AEE  CD7B0C        		call	FTOI4
                      	
  3AF1  21863B        		ld	hl,INTE7
  3AF4  1173FF        		ld	de,FAC3+1
  3AF7  C1            		pop	bc
  3AF8  48            		ld	c,b		;
  3AF9  05            		dec	b
  3AFA                	FTOALP3:
  3AFA  05            		dec	b
  3AFB  FA073B        		jp	m,FTOADOT
  3AFE  CDD824        		call	DIVINT4
  3B01  C630          		add	a,'0'
  3B03  12            		ld	(de),a
  3B04  13            		inc	de
  3B05  18F3          		jr	FTOALP3
                      	
  3B07                	FTOADOT:
  3B07  CD2B25        		call	CHKINT4
  3B0A  2812          		jr	z,FTOAEND
                      	
  3B0C  3E2E          		ld	a,'.'
  3B0E  12            		ld	(de),a
  3B0F  13            		inc	de
                      	
  3B10  79            		ld	a,c		;
  3B11  B7            		or	a
  3B12                	FTOALP4:
  3B12  C4D824        		call	nz,DIVINT4
  3B15  C630          		add	a,'0'
  3B17  12            		ld	(de),a
  3B18  13            		inc	de
  3B19  CD2B25        		call	CHKINT4
  3B1C  20F4          		jr	nz,FTOALP4
                      	
  3B1E                	FTOAEND:
  3B1E  12            		ld	(de),a		;a=0
  3B1F  2172FF        		ld	hl,FAC3
  3B22  C9            		ret
                      	
  3B23                	SMALL:
  3B23  0600          		ld	b,00h
  3B25                	SMALLLP:
  3B25  05            		dec	b
  3B26  C5            		push	bc
  3B27  CD9037        		call	MULF10
  3B2A  217C3B        		ld	hl,E0
  3B2D  CD1A3F        		call	SETCMPF
  3B30  C1            		pop	bc
  3B31  38F2          		jr	c,SMALLLP
  3B33  1810          		jr	LARSMA
                      	
  3B35                	LARGE:
  3B35  0600          		ld	b,00h
  3B37                	LARGELP:
  3B37  04            		inc	b
  3B38  C5            		push	bc
  3B39  CD4D38        		call	DIVF10
  3B3C  21773B        		ld	hl,E2
  3B3F  CD1A3F        		call	SETCMPF
  3B42  C1            		pop	bc
  3B43  30F2          		jr	nc,LARGELP
                      	
  3B45                	LARSMA:
  3B45  C5            		push	bc		;
  3B46  CDBD3A        		call	FTOA2
                      	
  3B49                	LARLP2:
  3B49  23            		inc	hl
  3B4A  7E            		ld	a,(hl)
  3B4B  B7            		or	a
  3B4C  20FB          		jr	nz,LARLP2
                      	
  3B4E  3645          		ld	(hl),'E'
  3B50  23            		inc	hl
  3B51  362B          		ld	(hl),'+'
  3B53  F1            		pop	af		;
  3B54  3804          		jr	c,LARPLS
  3B56  ED44          		neg
  3B58  362D          		ld	(hl),'-'
                      	
  3B5A                	LARPLS:
  3B5A  23            		inc	hl
  3B5B  010A2F        		ld	bc,2f0ah	;b='0'-1, c=10
  3B5E                	LARLP3:
  3B5E  04            		inc	b
  3B5F  91            		sub	c
  3B60  30FC          		jr	nc,LARLP3
  3B62  81            		add	a,c
  3B63  70            		ld	(hl),b
                      	
  3B64                	FTOAZERO:
  3B64  23            		inc	hl
  3B65  C630          		add	a,'0'
  3B67  77            		ld	(hl),a
  3B68  23            		inc	hl
  3B69  EB            		ex	de,hl
  3B6A  AF            		xor	a
  3B6B  18B1          		jr	FTOAEND
                      	
                      	
                      	;99999999.5
  3B6D                	E8:
  3B6D  F01FBC3E9B    		db	0f0h, 1fh, 0bch, 3eh, 9bh
                      	
                      	;9999999.95
  3B72                	E7:
  3B72  F37F961898    		db	0f3h, 7fh, 96h, 18h, 98h
                      	
                      	;9.99999995
  3B77                	E2:
  3B77  F3FFFF1F84    		db	0f3h, 0ffh, 0ffh, 1fh, 84h
                      	
                      	;0.999999995
  3B7C                	E0:
  3B7C  EBFFFF7F80    		db	0ebh, 0ffh, 0ffh, 7fh, 80h
                      	
                      	;0.00999999995
  3B81                	EM2:
  3B81  300AD7237A    		db	30h, 0ah, 0d7h, 23h, 7ah
                      	
  3B86                	INTE7:
  3B86  80969800      		db	80h, 96h, 98h, 00h	;10^7
  3B8A  40420F00      		db	40h, 42h, 0fh, 00h	;10^6
  3B8E  A0860100      		db	0a0h,86h, 01h, 00h	;10^5
  3B92  10270000      		db	10h, 27h, 00h, 00h	;10^4
  3B96  E8030000      		db	0e8h,03h, 00h, 00h	;10^3
  3B9A  64000000      		db	64h, 00h, 00h, 00h	;10^2
  3B9E  0A000000      		db	0ah, 00h, 00h, 00h	;10^1
  3BA2  01000000      		db	01h, 00h, 00h, 00h	;10^0
                      	
                      	
                      	;RND() function
  3BA6                	_F_RND:	ds	RNDPLS-9-_F_RND
  3BA6                		org	RNDPLS-9
  3BA6                	F_RND:
  3BA6  CD780B        		call	CHKNUM
  3BA9  EF            		rst	CHKSGN
  3BAA  2815          		jr	z,RND0		;rnd(0)
  3BAC  3C            		inc	a
  3BAD  2806          		jr	z,RNDMNS	;rnd(-x)
                      	
                      	;rnd(+x)
  3BAF                	_RNDPLS:ds	RNDPLS-_RNDPLS
  3BAF                		org	RNDPLS
                      	
  3BAF  2151FA        		ld	hl,RSEED
  3BB2  CD0A0C        		call	SETF1
  3BB5                	RNDMNS:
  3BB5  CD1925        		call	DECINT4
  3BB8  21D53B        		ld	hl,RNDFCT
  3BBB  CD180C        		call	SETF2
  3BBE  CDD93B        		call	MULRND
  3BC1                	RND0:
  3BC1  2A51FA        		ld	hl,(RSEED)
  3BC4  ED5B53FA      		ld	de,(RSEED+2)
  3BC8  CD9A0C        		call	I4TOF
  3BCB  216AFF        		ld	hl,FAC1+4
  3BCE  7E            		ld	a,(hl)
  3BCF  B7            		or	a
  3BD0  C8            		ret	z
  3BD1  D620          		sub	20h
  3BD3  77            		ld	(hl),a
  3BD4  C9            		ret
                      	
                      	
  3BD5                	RNDFCT:
  3BD5  65520F00      		db	65h, 52h, 0fh, 00h
                      	
                      	
                      	;RSEED = (FAC1 (integer) * FAC2 (integer)) & ff,ff,ff,ff,ffh
                      	; for RND() function
                      	;input: FAC1,FAC2 (not zero)
                      	;output: RSEED
                      	;destroy: FAC1,af,b,de,hl
  3BD9                	MULRND:
  3BD9  21AB0E        		ld	hl,ZERO
  3BDC  1151FA        		ld	de,RSEED
  3BDF  CD0D0C        		call	SETF
  3BE2  AF            		xor	a
  3BE3  326AFF        		ld	(FAC1+4),a
                      	
  3BE6  D9            		exx			;
  3BE7  E5            		push	hl
  3BE8  D5            		push	de
  3BE9  C5            		push	bc
  3BEA  D9            		exx			;
                      	
  3BEB  2A6DFF        		ld	hl,(FAC2)
  3BEE  ED5B6FFF      		ld	de,(FAC2+2)
                      	
  3BF2  0620          		ld	b,20h
  3BF4                	MULRLP1:
  3BF4  CB3A          		srl	d
  3BF6  CB1B          		rr	e
  3BF8  CB1C          		rr	h
  3BFA  CB1D          		rr	l
  3BFC  D9            		exx			;
  3BFD  3010          		jr	nc,MULRNC
                      	
  3BFF  1166FF        		ld	de,FAC1
  3C02  2151FA        		ld	hl,RSEED
  3C05  B7            		or	a
  3C06  0605          		ld	b,05h
  3C08                	MULRLP2:
  3C08  1A            		ld	a,(de)
  3C09  8E            		adc	a,(hl)
  3C0A  77            		ld	(hl),a
  3C0B  1C            		inc	e		;inc de
  3C0C  2C            		inc	l		;inc hl
  3C0D  10F9          		djnz	MULRLP2
                      	
  3C0F                	MULRNC:
  3C0F  CD3C3F        		call	SLAF1
  3C12  216AFF        		ld	hl,FAC1+4
  3C15  CB16          		rl	(hl)
  3C17  D9            		exx			;
  3C18  10DA          		djnz	MULRLP1
                      	
  3C1A  D9            		exx			;
  3C1B  C1            		pop	bc
  3C1C  D1            		pop	de
  3C1D  E1            		pop	hl
  3C1E  D9            		exx			;
  3C1F  C9            		ret
                      	
                      	
                      	;EXP() function
                      	;exp(x)=2^n*e^a, n=[x/log2], a=x-n*log2
  3C20                	F_EXP:
  3C20  CD780B        		call	CHKNUM
  3C23                	EXP:
  3C23  CD1F39        		call	PUSHF1		;x
  3C26  218E3C        		ld	hl,LOG2
  3C29  CD180C        		call	SETF2
  3C2C  CD5E38        		call	DIVF		;x/log2
                      	
  3C2F  2A69FF        		ld	hl,(FAC1+3)
  3C32  7C            		ld	a,h		;(FAC1+4)
  3C33  FE89          		cp	89h
  3C35  304C          		jr	nc,EXPLARGE
                      	
  3C37  CD8339        		call	INT		;n=[x/log2]
  3C3A  CDB10C        		call	FTOI
  3C3D  D5            		push	de		;n
  3C3E  218E3C        		ld	hl,LOG2
  3C41  CD180C        		call	SETF2
  3C44  CDA037        		call	MULF		;n*log2
  3C47  D1            		pop	de		;n
  3C48  CD4C39        		call	POPF2
  3C4B  D5            		push	de		;n
  3C4C  CD0F3E        		call	SUBF21		;a=x-n*log2
                      	
                      	;1+a(1+a/2(1+a/3(1+...(1+a/10))))))))))
  3C4F  CD5B39        		call	CPYFAC
  3C52  CD4122        		call	SETPLS1
                      	
  3C55  0E0A          		ld	c,0ah
  3C57                	EXPLP:
  3C57  CD2E39        		call	PUSHF2		;a
  3C5A  C5            		push	bc
  3C5B  CDA037        		call	MULF		;a*y
  3C5E  CD5B39        		call	CPYFAC
  3C61  E1            		pop	hl
  3C62  E5            		push	hl
  3C63  CD5A0C        		call	I1TOF
  3C66  CD6E39        		call	EXFAC
  3C69  CD5E38        		call	DIVF		;a*y/b
  3C6C  CD7D36        		call	INCF1		;a*y/b+1
  3C6F  C1            		pop	bc
  3C70  CD4C39        		call	POPF2		;a
  3C73  0D            		dec	c
  3C74  20E1          		jr	nz,EXPLP
                      	
  3C76  D1            		pop	de		;n
                      	;	ld	a,(FAC1+4)	;=81h?
  3C77  3E81          		ld	a,81h
  3C79  83            		add	a,e
  3C7A  326AFF        		ld	(FAC1+4),a	;e^a*2^n
  3C7D  79            		ld	a,c		;c=0
  3C7E  8A            		adc	a,d
  3C7F  C8            		ret	z
  3C80  C3F003        		jp	OVERR
                      	
  3C83                	EXPLARGE:
  3C83  CB7D          		bit	7,l		;(FAC1+3)
  3C85  CAF003        		jp	z,OVERR		;x>0
  3C88  CD3D39        		call	POPF1
  3C8B  C3070C        		jp	SETZERO		;x<0
                      	
                      	;log(2)
  3C8E                	LOG2:
  3C8E  F817723180    		db	0f8h, 17h, 72h, 31h, 80h
                      	
                      	
                      	;LOG() function
                      	;log(x)=log(a*2^n)=log(a)+n*log(2)
                      	;a'=(a-1)/(a+1)
                      	;log(a)=2*(a'+a'^3/3+a'^5/5+...)=2a'(1+1/3*a'^2(1+3/5*a'^2(...(1+19/21*a'^2))))))))))
  3C93                	F_LOG:
  3C93  CD780B        		call	CHKNUM
  3C96                	LOG:
  3C96  EF            		rst	CHKSGN
  3C97  3D            		dec	a
  3C98  C2ED03        		jp	nz,FCERR	;x<=0
                      	
  3C9B  216AFF        		ld	hl,FAC1+4
  3C9E  7E            		ld	a,(hl)
  3C9F  D681          		sub	81h
  3CA1  F5            		push	af		;n
  3CA2  3681          		ld	(hl),81h	;a
  3CA4  CD1F39        		call	PUSHF1		;a
  3CA7  CD7D36        		call	INCF1
  3CAA  CD4C39        		call	POPF2		;a
  3CAD  CD1F39        		call	PUSHF1		;a+1
  3CB0  CD1D0C        		call	SETMNS1
  3CB3  CD8F36        		call	ADDF		;a-1
  3CB6  CD4C39        		call	POPF2		;a+1
  3CB9  CD5E38        		call	DIVF		;a'=(a-1)/(a+1)
  3CBC  CD1F39        		call	PUSHF1		;a'
  3CBF  CD5B39        		call	CPYFAC
  3CC2  CDA037        		call	MULF		;a'^2
  3CC5  CD5B39        		call	CPYFAC		;a'^2
  3CC8  CD4122        		call	SETPLS1		;y
                      	
  3CCB  0E12          		ld	c,12h
  3CCD                	LOGLP:
  3CCD  CD2E39        		call	PUSHF2		;a'^2
  3CD0  C5            		push	bc
  3CD1  CDA037        		call	MULF		;y*a'^2
  3CD4  CD5B39        		call	CPYFAC
  3CD7  E1            		pop	hl		;l=c
  3CD8  E5            		push	hl
  3CD9  2C            		inc	l
  3CDA  CD5A0C        		call	I1TOF
  3CDD  CD6E39        		call	EXFAC
  3CE0  CD5E38        		call	DIVF		;y*a'^2/(c+1)
  3CE3  CD5B39        		call	CPYFAC
  3CE6  E1            		pop	hl
  3CE7  2D            		dec	l
  3CE8  E5            		push	hl
  3CE9  CD5A0C        		call	I1TOF		;c-1
  3CEC  CDA037        		call	MULF		;y*a'^2*(c-1)/(c+1)
  3CEF  CD7D36        		call	INCF1		;y=1+y*a'^2*(c-1)/(c+1)
  3CF2  C1            		pop	bc
  3CF3  CD4C39        		call	POPF2		;a'^2
  3CF6  0D            		dec	c
  3CF7  20D4          		jr	nz,LOGLP
                      	
  3CF9  CD4C39        		call	POPF2		;a'
  3CFC  CDA037        		call	MULF		;a'*y
  3CFF  216AFF        		ld	hl,FAC1+4
  3D02  7E            		ld	a,(hl)
  3D03  B7            		or	a
  3D04  2804          		jr	z,LOGZ
  3D06  34            		inc	(hl)		;2*a'*y
  3D07  CAF003        		jp	z,OVERR
  3D0A                	LOGZ:
  3D0A  C1            		pop	bc		;b=n
  3D0B  CD1F39        		call	PUSHF1		;2*a'*y
  3D0E  CD110D        		call	S1TOF
  3D11  218E3C        		ld	hl,LOG2
  3D14  CD180C        		call	SETF2
  3D17  CDA037        		call	MULF		;n*log(2)
  3D1A  CD4C39        		call	POPF2		;2*a'*y
  3D1D  C38F36        		jp	ADDF		;n*log(2)+2*a'*y
                      	
                      	
                      	;^ operator
  3D20                	O_POW:
  3D20  CD780B        		call	CHKNUM
                      	
  3D23  2A70FF        		ld	hl,(FAC2+3)
  3D26  7C            		ld	a,h		;(FAC2+4)
  3D27  B7            		or	a
  3D28  CA4122        		jp	z,SETPLS1	;x^0
                      	
  3D2B  EF            		rst	CHKSGN
  3D2C  2812          		jr	z,POWZERO
  3D2E  3C            		inc	a
  3D2F  2815          		jr	z,POWNEG
                      	
                      	;x^y=exp(ylog(x))
  3D31                	POWPOS:
  3D31  CD2E39        		call	PUSHF2		;y
  3D34  CD963C        		call	LOG		;log(x)
  3D37  CD4C39        		call	POPF2		;y
  3D3A  CDA037        		call	MULF		;ylog(x)
  3D3D  C3233C        		jp	EXP
                      	
                      	;0^y
  3D40                	POWZERO:
  3D40  7D            		ld	a,l		;(FAC2+3)
  3D41  07            		rlca
  3D42  D0            		ret	nc		;0^(positive)
  3D43  C3FF03        		jp	DIV0ERR		;0^(negative)
                      	
                      	;(negative)^y
  3D46                	POWNEG:
  3D46  7C            		ld	a,h		;(FAC2+4)
  3D47  FEA1          		cp	0a1h
  3D49  D2ED03        		jp	nc,FCERR
                      	
  3D4C  CD1F39        		call	PUSHF1
  3D4F  CD2E39        		call	PUSHF2
  3D52  CD3D39        		call	POPF1
                      	
  3D55  CDE20C        		call	GETINT
  3D58  CD1D3F        		call	CMPF
  3D5B  C2ED03        		jp	nz,FCERR	;y=not integer
  3D5E  CD7B0C        		call	FTOI4
  3D61  3A66FF        		ld	a,(FAC1)	;even/odd
  3D64  47            		ld	b,a
                      	
  3D65  CD3D39        		call	POPF1
  3D68  C5            		push	bc		;
  3D69  CD1939        		call	ABS
  3D6C  CD313D        		call	POWPOS
  3D6F  F1            		pop	af		;
  3D70  0F            		rrca
  3D71  D0            		ret	nc		;y=even
  3D72  C3260D        		jp	NEGABS		;y=odd
                      	
                      	
                      	;COS() function
                      	;cos(x)=sin(pi/2-|x|)
  3D75                	F_COS:
  3D75  CD780B        		call	CHKNUM
  3D78                	COS:
  3D78  CD2C0D        		call	NEGABS2
  3D7B  21833D        		ld	hl,PIDIV2
  3D7E  CD8036        		call	SETADDF		;pi/2-|x|
  3D81  1808          		jr	SIN
                      	
                      	;pi/2
  3D83                	PIDIV2:
  3D83  A2DA0F4981    		db	0a2h, 0dah, 0fh, 49h, 81h
                      	
                      	
                      	;SIN() function
                      	;x-x^3/3!+x^5/5!-...=x(1-x^2/(2*3)(1-x^2/(4*5)(...(1-x^2/(12*13)))))))))))
  3D88                	F_SIN:
  3D88  CD780B        		call	CHKNUM
  3D8B                	SIN:
  3D8B  CD1F39        		call	PUSHF1		;x
  3D8E  21153E        		ld	hl,PI2
  3D91  CD180C        		call	SETF2
  3D94  CD5E38        		call	DIVF		;x/2pi
  3D97  CDE20C        		call	GETINT		;int(x/2pi)
  3D9A  21153E        		ld	hl,PI2
  3D9D  CD180C        		call	SETF2
  3DA0  CDA037        		call	MULF		;int(x/2pi)*2pi
  3DA3  CD4C39        		call	POPF2		;x
  3DA6  CD0F3E        		call	SUBF21		;x'=x-int(x/2pi)*2pi
                      	
  3DA9  CDFA3D        		call	SINRANGE	;-pi~+pi
  3DAC  CDFA3D        		call	SINRANGE	;-pi/2~+pi/2
                      	
  3DAF  CD1F39        		call	PUSHF1		;x'
  3DB2  CD5B39        		call	CPYFAC
  3DB5  CDA037        		call	MULF		;x'^2
                      	
  3DB8  CD5B39        		call	CPYFAC
  3DBB  CD4122        		call	SETPLS1		;y=1
                      	
  3DBE  060C          		ld	b,0ch
  3DC0                	SINLP:
  3DC0  CD2E39        		call	PUSHF2		;x'^2
  3DC3  C5            		push	bc
  3DC4  CDA037        		call	MULF		;x'^2*y
  3DC7  C1            		pop	bc
  3DC8  C5            		push	bc
  3DC9  CD1F39        		call	PUSHF1		;x'^2*y
                      	
  3DCC  78            		ld	a,b
  3DCD  04            		inc	b
  3DCE  CD5E24        		call	MULINT1		;hl=b(b+1)
  3DD1  CD5C0C        		call	I2TOF		;hl->FAC1
                      	
  3DD4  CD5B39        		call	CPYFAC
  3DD7  CD3D39        		call	POPF1		;x'^2*y
  3DDA  CD5E38        		call	DIVF		;x'^2/b/(b+1)*y
  3DDD  CD2C0D        		call	NEGABS2		;-x'^2/b/(b+1)*y (y>0)
  3DE0  CD7D36        		call	INCF1		;y=1-x'^2/b/(b+1)*y
                      	
  3DE3  C1            		pop	bc
  3DE4  CD4C39        		call	POPF2		;x'^2
  3DE7  05            		dec	b
  3DE8  10D6          		djnz	SINLP
                      	
  3DEA  CD4C39        		call	POPF2		;x'
  3DED  CDA037        		call	MULF
                      	
                      	;if |sin(x)|>1
  3DF0  3A6AFF        		ld	a,(FAC1+4)
  3DF3  D681          		sub	81h
  3DF5  C0            		ret	nz
  3DF6  3266FF        		ld	(FAC1),a	;=0
  3DF9  C9            		ret
                      	
                      	;-pi/2~+pi/2
  3DFA                	SINRANGE:
  3DFA  21833D        		ld	hl,PIDIV2	;pi/2
  3DFD  CD1A3F        		call	SETCMPF
  3E00  3009          		jr	nc,RANGENC
  3E02  2170FF        		ld	hl,FAC2+3
  3E05  CBFE          		set	7,(hl)		;-pi/2
  3E07  CD1D3F        		call	CMPF
  3E0A  D0            		ret	nc
  3E0B                	RANGENC:
  3E0B  2171FF        		ld	hl,FAC2+4
  3E0E  34            		inc	(hl)		;+-pi
                      	
                      	;FAC1=FAC2-FAC1
  3E0F                	SUBF21:
  3E0F  2169FF        		ld	hl,FAC1+3
  3E12  C38B36        		jp	CHGSGNADD
                      	
                      	;pi*2
  3E15                	PI2:
  3E15  A2DA0F4983    		db	0a2h, 0dah, 0fh, 49h, 83h
                      	
                      	
                      	;SQR() function
                      	;y_n+1=(y_n + x/y_n)/2
  3E1A                	F_SQR:
  3E1A  CD780B        		call	CHKNUM
  3E1D  EF            		rst	CHKSGN
  3E1E  C8            		ret	z		;sqr(0)=0
  3E1F  3C            		inc	a
  3E20  CAED03        		jp	z,FCERR		;sqr(-x)
                      	
  3E23  CD1F39        		call	PUSHF1
  3E26  216AFF        		ld	hl,FAC1+4
  3E29  7E            		ld	a,(hl)
  3E2A  D681          		sub	81h
  3E2C  1F            		rra			;=sra a,c-flag=bit7
  3E2D  C681          		add	a,81h
  3E2F  77            		ld	(hl),a		;exponent of y_0 = (exponent of x)/2
                      	
  3E30  0605          		ld	b,05h
  3E32                	SQRLP:
  3E32  CD5B39        		call	CPYFAC
  3E35  CD3D39        		call	POPF1		;x
  3E38  CD1F39        		call	PUSHF1		;x
  3E3B  C5            		push	bc
  3E3C  CD2E39        		call	PUSHF2		;;y
  3E3F  CD5E38        		call	DIVF		;x/y
  3E42  CD4C39        		call	POPF2		;;y
  3E45  CD8F36        		call	ADDF		;x/y+y
  3E48  216AFF        		ld	hl,FAC1+4
  3E4B  35            		dec	(hl)		;y=(x/y+y)/2
  3E4C  C1            		pop	bc
  3E4D  10E3          		djnz	SQRLP
  3E4F  CD4C39        		call	POPF2
  3E52  C9            		ret
                      	
                      	
                      	;TAN() function
                      	;tan(x)=sin(x)/cos(x)
  3E53                	F_TAN:
  3E53  CD780B        		call	CHKNUM
  3E56  CD1F39        		call	PUSHF1		;x
  3E59  CD783D        		call	COS		;cos(x)
  3E5C  CD5B39        		call	CPYFAC
  3E5F  CD3D39        		call	POPF1		;x
  3E62  CD2E39        		call	PUSHF2		;cos(x)
  3E65  CD8B3D        		call	SIN		;sin(x)
  3E68  CD4C39        		call	POPF2		;cos(x)
  3E6B  C35E38        		jp	DIVF		;sin(x)/cos(x)
                      	
                      	
                      	;input: bc=X, de=Y
                      	;output: a=color
                      	;destroy: f,bc,de,hl
  3E6E                	POINT:
  3E6E  CD9539        		call	CHKMOD
  3E71  CAC362        		jp	z,POINT66
  3E74  3A92FD        		ld	a,(SCREEN1)
  3E77  3D            		dec	a
  3E78  281A          		jr	z,POINT2
  3E7A  F2843E        		jp	p,POINTG
                      	
                      	;screen mode 1
  3E7D                	POINT1:
  3E7D  CD8E3F        		call	GXY2AD60
  3E80  7E            		ld	a,(hl)
  3E81  D61F          		sub	1fh
  3E83  C9            		ret
                      	
                      	;graphic mode (screen mode 3,4)
  3E84                	POINTG:
  3E84  CD4514        		call	GXY2GAD60
  3E87  7E            		ld	a,(hl)
  3E88  A2            		and	d
  3E89  07            		rlca
  3E8A                	POINTLP:
  3E8A  0F            		rrca
  3E8B  CB0A          		rrc	d
  3E8D  30FB          		jr	nc,POINTLP
  3E8F                	POINTOK:
  3E8F  CB0A          		rrc	d
  3E91  D0            		ret	nc		;screen mode 4
  3E92  3C            		inc	a		;screen mode 3
  3E93  C9            		ret
                      	
                      	;screen mode 2
  3E94                	POINT2:
  3E94  C5            		push	bc		;x
  3E95  CD8E3F        		call	GXY2AD60
  3E98  C1            		pop	bc		;x
  3E99  CD612C        		call	MASK2
  3E9C  46            		ld	b,(hl)		;
  3E9D  24            		inc	h
  3E9E  24            		inc	h
  3E9F  A6            		and	(hl)
  3EA0  C8            		ret	z
                      	
  3EA1  78            		ld	a,b		;
  3EA2  0F            		rrca
  3EA3  0F            		rrca
  3EA4  7E            		ld	a,(hl)
  3EA5  17            		rla
  3EA6  17            		rla
  3EA7  17            		rla
  3EA8  E607          		and	07h
  3EAA  3C            		inc	a
  3EAB  C9            		ret
                      	
                      	
                      	;SCREEN() function
                      	;not called but jumped
  3EAC                	F_SCRN:
  3EAC  CD920B        		call	CHKLPAR
  3EAF  CD330E        		call	INT1ARG2
  3EB2  CDA10B        		call	CHKRPAR
  3EB5  60            		ld	h,b
  3EB6  6B            		ld	l,e
  3EB7  24            		inc	h
  3EB8  2C            		inc	l
  3EB9  CDCD11        		call	XY2AD
  3EBC  CD9539        		call	CHKMOD
  3EBF  CABA62        		jp	z,F_SCRN66
  3EC2  6E            		ld	l,(hl)
  3EC3  CD5A0C        		call	I1TOF
  3EC6  C3B118        		jp	FNCRTN
                      	
                      	
                      	;FN() function
                      	;not called but jumped
  3EC9                	F_FN:
  3EC9  CD8433        		call	CHKVAR
  3ECC  E5            		push	hl		;program address
  3ECD  CBF8          		set	7,b
  3ECF  CDB633        		call	SRCHVAR
  3ED2  DA1404        		jp	c,UFERR
  3ED5  E1            		pop	hl		;program address
  3ED6  D5            		push	de		;function address
  3ED7  CD640B        		call	FNCNUM
  3EDA  C1            		pop	bc		;function address
  3EDB  E5            		push	hl		;program address
                      	
                      	;push old FN() argument
  3EDC  2A63FF        		ld	hl,(FNARG+3)
  3EDF  E5            		push	hl
  3EE0  2A61FF        		ld	hl,(FNARG+1)
  3EE3  E5            		push	hl
  3EE4  3A60FF        		ld	a,(FNARG)
  3EE7  F5            		push	af
  3EE8  2A5EFF        		ld	hl,(FNPAR)
  3EEB  E5            		push	hl		;old FN() parameter
                      	
  3EEC  C5            		push	bc		;function address
  3EED  2166FF        		ld	hl,FAC1
  3EF0  1160FF        		ld	de,FNARG
  3EF3  CD0D0C        		call	SETF
  3EF6  E1            		pop	hl		;function address
                      	
  3EF7  5E            		ld	e,(hl)
  3EF8  23            		inc	hl
  3EF9  56            		ld	d,(hl)
  3EFA  23            		inc	hl
  3EFB  7E            		ld	a,(hl)
  3EFC  23            		inc	hl
  3EFD  66            		ld	h,(hl)
  3EFE  6F            		ld	l,a
  3EFF  225EFF        		ld	(FNPAR),hl
                      	
  3F02  EB            		ex	de,hl
  3F03  CD6617        		call	ARG
                      	
  3F06  E1            		pop	hl		;old FN() parameter
  3F07  225EFF        		ld	(FNPAR),hl
                      	
                      	;pop old FN() argument
  3F0A  F1            		pop	af
  3F0B  3260FF        		ld	(FNARG),a
  3F0E  E1            		pop	hl
  3F0F  2261FF        		ld	(FNARG+1),hl
  3F12  E1            		pop	hl
  3F13  2263FF        		ld	(FNARG+3),hl
  3F16  E1            		pop	hl		;program address
  3F17  C3B418        		jp	CLRSTRD
                      	
                      	
                      	;set FAC2 and compare
                      	;input: FAC1,hl=float address
                      	;output: c-flag, z-flag, FAC2
                      	;destroy: af,bc,de,hl
  3F1A                	SETCMPF:
  3F1A  CD180C        		call	SETF2
                      	;	jp	CMPF
                      	
                      	
                      	;compare FAC2 and FAC1
                      	;input: FAC1,FAC2
                      	;output: c-flag,z-flag
                      	;destroy: af,b,de,hl
  3F1D                	CMPF:
  3F1D  1169FF        		ld	de,FAC1+3
  3F20  2170FF        		ld	hl,FAC2+3
  3F23  B4            		or	h		;h>0, reset z-flag
  3F24  7E            		ld	a,(hl)
  3F25  07            		rlca
  3F26  1A            		ld	a,(de)
  3F27  380E          		jr	c,CMPFNEG
  3F29  07            		rlca
  3F2A  D8            		ret	c
                      	
  3F2B                	CMPFPOS:
  3F2B  13            		inc	de
  3F2C  23            		inc	hl
  3F2D  0605          		ld	b,05h
  3F2F                	CMPFLP:
  3F2F  1A            		ld	a,(de)
  3F30  BE            		cp	(hl)
  3F31  C0            		ret	nz
  3F32  2B            		dec	hl
  3F33  1B            		dec	de
  3F34  10F9          		djnz	CMPFLP
  3F36  C9            		ret
                      	
  3F37                	CMPFNEG:
  3F37  07            		rlca
  3F38  D0            		ret	nc
                      	
                      	;FAC1<0, FAC2<0
  3F39  EB            		ex	de,hl
  3F3A  18EF          		jr	CMPFPOS
                      	
                      	
                      	;shift left arithmetic for FAC1
                      	;input: FAC1
                      	;output: FAC1,c-flag
                      	;destroy: f,hl
  3F3C                	SLAF1:
  3F3C  2166FF        		ld	hl,FAC1
  3F3F  CB26          		sla	(hl)
  3F41  23            		inc	hl
  3F42  CB16          		rl	(hl)
  3F44  23            		inc	hl
  3F45  CB16          		rl	(hl)
  3F47  23            		inc	hl
  3F48  CB16          		rl	(hl)
  3F4A  C9            		ret
                      	
                      	
                      	;jump subroutine in table
                      	;input: de=table address, a=data(00h-7fh or 80h-ffh)
                      	;output: de=jump address
                      	;destroy: af
  3F4B                	JPTBL:
  3F4B  EB            		ex	de,hl
  3F4C  87            		add	a,a
  3F4D  85            		add	a,l
  3F4E  6F            		ld	l,a
  3F4F  3001          		jr	nc,JPTBLNC
  3F51  24            		inc	h
  3F52                	JPTBLNC:
  3F52  7E            		ld	a,(hl)
  3F53  23            		inc	hl
  3F54  66            		ld	h,(hl)
  3F55  6F            		ld	l,a
                      	
  3F56  EB            		ex	de,hl
  3F57  D5            		push	de
  3F58  C9            		ret
                      	
                      	
                      	;skip space
                      	;input: hl=program address-1
                      	;output: a=data, hl=next address
                      	;destroy: f
  3F59                	SKIPSPINC:
  3F59  23            		inc	hl
  3F5A                	SKIPSP:
  3F5A  7E            		ld	a,(hl)
  3F5B  FE20          		cp	' '
  3F5D  C0            		ret	nz
  3F5E  18F9          		jr	SKIPSPINC
                      	
                      	
                      	;check colon and line end
                      	;input: hl=program address
                      	;output: a=(hl), z-flag(1= 00h or ":")
                      	;destroy: af
  3F60                	CHKCLNINC:
  3F60  23            		inc	hl
  3F61                	CHKCLN:
  3F61  7E            		ld	a,(hl)
  3F62  B7            		or	a
  3F63  C8            		ret	z
  3F64  FE3A          		cp	':'
  3F66  C8            		ret	z
  3F67  FE20          		cp	' '
  3F69  C0            		ret	nz
  3F6A  18F4          		jr	CHKCLNINC
                      	
                      	
                      	;check comma or argument
                      	;input: hl=program address
                      	;output: a=(hl), f(z=1:comma), hl=next address
  3F6C                	CHKCMM:
  3F6C  CD613F        		call	CHKCLN		;a=(hl)
  3F6F  CA1A04        		jp	z,MOERR
  3F72  23            		inc	hl
  3F73  FE20          		cp	' '
  3F75  28F5          		jr	z,CHKCMM
  3F77  FE2C          		cp	','
  3F79  C8            		ret	z
  3F7A  2B            		dec	hl
  3F7B  C9            		ret
                      	
                      	
                      	;check colon and comma
                      	;input: hl=program address
                      	;output: a=(hl), z-flag(1= 00h or ":" ), hl=hl+1(comma)
                      	;destroy: af
  3F7C                	CHKCLCM:
  3F7C  CD613F        		call	CHKCLN
  3F7F  C8            		ret	z
  3F80  FE2C          		cp	','
  3F82  C2E403        		jp	nz,SNERR
  3F85  23            		inc	hl
  3F86  B7            		or	a		;reset z-flag
  3F87  C9            		ret
                      	
                      	
                      	;get VRAM attirbute address (screen mode 1,2)
                      	;hl=(VRAM)+X/8+Y/12*32
                      	;input: bc=graphic X, de=graphic Y
                      	;output: hl=VRAM address, d=Y mod 12
                      	;destroy: af,bc,e
  3F88                	GXY2AD:
  3F88  CD9539        		call	CHKMOD
  3F8B  CA2E66        		jp	z,GXY2AD66
  3F8E                	GXY2AD60:
  3F8E  CDDF2B        		call	CHKGXY
  3F91  CDBA3F        		call	DIV12
  3F94  EB            		ex	de,hl
  3F95  57            		ld	d,a
  3F96  29            		add	hl,hl		;*2
  3F97  29            		add	hl,hl		;*4
  3F98  29            		add	hl,hl		;*8
  3F99  29            		add	hl,hl		;*16
  3F9A  29            		add	hl,hl		;*32
  3F9B  3A91FD        		ld	a,(VRAM)
  3F9E  47            		ld	b,a
  3F9F  CB39          		srl	c
  3FA1  CB39          		srl	c
  3FA3  CB39          		srl	c
  3FA5  09            		add	hl,bc
  3FA6  C9            		ret
                      	
                      	
                      	;bc=a*32
                      	;input: a(<=16), b=0
                      	;output: bc
                      	;destroy: f
  3FA7                	MUL32:
  3FA7  87            		add	a,a		;*2
  3FA8  87            		add	a,a		;*4
  3FA9  87            		add	a,a		;*8
  3FAA  87            		add	a,a		;*16
  3FAB  CB10          		rl	b
  3FAD  87            		add	a,a		;*32
  3FAE  CB10          		rl	b
  3FB0  4F            		ld	c,a
  3FB1  C9            		ret
                      	
                      	
                      	;ldir or lddr
                      	;input: bc,de,hl,z(0=ldir,1=lddr)
                      	;output: bc=0,de,hl
                      	;destroy: f
  3FB2                	LDIDR:
  3FB2  2803          		jr	z,LDIDRZ
  3FB4  EDB0          		ldir
  3FB6  C9            		ret
  3FB7                	LDIDRZ:
  3FB7  EDB8          		lddr
  3FB9  C9            		ret
                      	
                      	
                      	;de=de/12
                      	;input: de<192
                      	;output: de=int(de/12), a=de mod 12
                      	;destroy: f,b=0,l
  3FBA                	DIV12:
  3FBA  7B            		ld	a,e
  3FBB  5A            		ld	e,d		;d=0
  3FBC  2E60          		ld	l,01100000b
  3FBE  0604          		ld	b,04h
  3FC0                	DIV12LP:
  3FC0  BD            		cp	l
  3FC1  3801          		jr	c,DIV12C
  3FC3  95            		sub	l
  3FC4                	DIV12C:
  3FC4  3F            		ccf
  3FC5  CB13          		rl	e
  3FC7  CB3D          		srl	l
  3FC9  10F5          		djnz	DIV12LP
  3FCB  C9            		ret
                      	
                      	
                      	;calculate line status address and bit (connection to next line)
                      	;input: l=y+1
                      	;output: hl=line status address, a=bit
                      	;destroy: f
  3FCC                	CALCLINE:
  3FCC  C5            		push	bc
  3FCD  7D            		ld	a,l
  3FCE  21B4FD        		ld	hl,LINEST-1
  3FD1                	CALCLLP1:
  3FD1  23            		inc	hl
  3FD2  D608          		sub	08h
  3FD4  30FB          		jr	nc,CALCLLP1
  3FD6  C609          		add	a,09h
  3FD8  47            		ld	b,a
  3FD9  3E80          		ld	a,80h
  3FDB                	CALCLLP2:
  3FDB  07            		rlca
  3FDC  10FD          		djnz	CALCLLP2
  3FDE  C1            		pop	bc
  3FDF  C9            		ret
                      	
                      	
                      	;check external ROM (4000=CD? 6000=CD?)
                      	;input: hl=4003h or 6003h
                      	;output: a=mode, z-flag(0=found, 1=not found)
                      	;destroy: f,bc,de
  3FE0                	CHKEXTCD:
  3FE0  1643          		ld	d,'C'
  3FE2  01            		db	01h		;ld bc,
                      	
                      	;check external ROM (4000=AB? 6000=AB?)
                      	;input: hl=4003h or 6003h
                      	;output: a=mode, z-flag(0=found, 1=not found)
                      	;destroy: f,bc,de
  3FE3                	CHKEXTAB:
  3FE3  1641          		ld	d,'A'
  3FE5  5A            		ld	e,d
  3FE6  1C            		inc	e		;de="AB" or "CD"
  3FE7  E5            		push	hl
  3FE8  46            		ld	b,(hl)
  3FE9  2D            		dec	l
  3FEA  4E            		ld	c,(hl)
  3FEB  2D            		dec	l
  3FEC  7E            		ld	a,(hl)
  3FED  2D            		dec	l
  3FEE  66            		ld	h,(hl)
  3FEF  6F            		ld	l,a
  3FF0  E7            		rst	CPHLDE
  3FF1  2006          		jr	nz,NOABCD	;"AB" "CD" not found
  3FF3  60            		ld	h,b
  3FF4  69            		ld	l,c
  3FF5  CDA507        		call	JPHL
  3FF8  F6            		db	0f6h		;or afh, reset z-flag
                      	
  3FF9                	NOABCD:
  3FF9  AF            		xor	a		;set z-flag
  3FFA  3A65FE        		ld	a,(MODE)
  3FFD  E1            		pop	hl
  3FFE  C9            		ret
                      	
                      	
                      	;60 ROM end
  3FFF                	_4000H:	ds	4000h-_4000H
                      	
                      	
                      	;read RAM data
                      	;input: hl
                      	;output: a
                      	;destroy: none
                      	;fe8dh
  4000                	READRAM_SRC:
  4000  CD6B01        		call	CHGRAM
  4003  7E            		ld	a,(hl)
  4004  1805          		jr	CHGROM_SRC
                      	
                      	
                      	;LDIR in RAM
                      	;input: bc,de,hl
                      	;output: bc=0, de=de+bc, hl=hl+bc
                      	;destroy: f (no changes in szc-flag)
                      	;fe93h
  4006                	LDIRRAM_SRC:
  4006  CD6B01        		call	CHGRAM
  4009  EDB0          		ldir
                      	;	jp	CHGROM
                      	
                      	
                      	;change 0000-7fffh to BASIC ROM
                      	;destroy: none
                      	;fe98h: used by HURRY FOX
  400B                	CHGROM_SRC:
  400B  F5            		push	af
  400C  3E11          		ld	a,11h
                      	;	ld	a,(PORTF0H)
  400E  D3F0          		out	(0f0h),a
  4010  FB            		ei
  4011  F1            		pop	af
  4012  C9            		ret
  4013  00            		nop
                      	
                      	
                      	;fea1h
  4014                	OUTF0H_SRC:
  4014  D3F0          		out	(0f0h),a
  4016  F1            		pop	af
  4017  C9            		ret
                      	
                      	
                      	;LDDR in RAM
                      	;input: bc,de,hl
                      	;output: bc=0, de=de-bc, hl=hl-bc
                      	;destroy: f (no changes in szc-flag)
                      	;fea5h
  4018                	LDDRRAM_SRC:
  4018  CD6B01        		call	CHGRAM
  401B  EDB8          		lddr
  401D  18EC          		jr	CHGROM_SRC
  401F                	RAMEND:
                      	
                      	
                      	;check exteral ROM (6000-) and select mode
                      	;output: z(1=mode 5), a=mode-1(if z=0)
  401F                	CHKEXT6000:
  401F  2165FE        		ld	hl,MODE
  4022  34            		inc	(hl)
  4023  34            		inc	(hl)		;mode1->mode3, mode2->mode4
  4024  210360        		ld	hl,6003h
  4027  CDE33F        		call	CHKEXTAB
  402A  C0            		ret	nz		;AB found, skip menu
  402B  CDE03F        		call	CHKEXTCD
  402E  CD98FE        		call	CHGROM		;0000-7fff:BASIC ROM
  4031  C32060        		jp	SELMOD
                      	
                      	
                      	;continued from CHGMOD for mode 5
  4034                	CHGMOD66:
  4034  3A8FFD        		ld	a,(SCREEN2)
  4037  47            		ld	b,a
  4038  3A90FD        		ld	a,(SCREEN3)
  403B  B8            		cp	b
  403C  CCED13        		call	z,CHGDSP
                      	
  403F  3A92FD        		ld	a,(SCREEN1)
  4042  3D            		dec	a
  4043  2006          		jr	nz,CHGMOD66NZ
  4045  CDF915        		call	CNVATT1
  4048  F680          		or	80h
  404A  77            		ld	(hl),a
                      	
  404B                	CHGMOD66NZ:
  404B  3D            		dec	a
  404C  3E28          		ld	a,CLMN66
  404E  2002          		jr	nz,CHGMOD66OK
  4050  3E14          		ld	a,CLMN66/2
  4052                	CHGMOD66OK:
  4052  32ACFD        		ld	(WIDTH),a
  4055  011F03        		ld	bc,CLMN66*ROWS66-1
  4058  C9            		ret
                      	
                      	
                      	;continued from CHGDSP for mode 5
  4059                	CHGDSP66:
  4059  F5            		push	af
                      	
  405A  3A8FFD        		ld	a,(SCREEN2)
  405D  47            		ld	b,a
  405E  3A90FD        		ld	a,(SCREEN3)
  4061  B8            		cp	b
  4062  2003          		jr	nz,CHGDSP66NZ
  4064  2191FD        		ld	hl,VRAM
  4067                	CHGDSP66NZ:
  4067  23            		inc	hl
  4068  7E            		ld	a,(hl)		;(SCREEN1)
  4069  FE02          		cp	02h
  406B  3E00          		ld	a,00h
  406D  3804          		jr	c,CHGDSP12
  406F  2004          		jr	nz,CHGDSP4
  4071                	CHGDSP3:
  4071  C604          		add	a,04h
  4073                	CHGDSP12:
  4073  C604          		add	a,04h
  4075                	CHGDSP4:
  4075  D3C1          		out	(0c1h),a
                      	
  4077  3A95FD        		ld	a,(COLOR3)
  407A  D3C0          		out	(0c0h),a
                      	
  407C  F1            		pop	af
  407D  0F            		rrca
  407E  C9            		ret
                      	
                      	
                      	;set command/function table for mode3,4,5
  407F                	SETTBL:
  407F  212045        		ld	hl,F_HEX
  4082  2207FB        		ld	(0fb07h),hl	;HEX$
  4085  21FD4E        		ld	hl,C_CLDEX
  4088  22A7FA        		ld	(0faa7h),hl	;CLOAD
  408B  21D34E        		ld	hl,C_CSVEX
  408E  22A9FA        		ld	(0faa9h),hl	;CLOAD
                      	
  4091  21FC40        		ld	hl,CMDLST66
  4094  11B7FA        		ld	de,CMDTBL+(CMDLAST-80h+1)*2
  4097  012E00        		ld	bc,FNCLST66-CMDLST66
  409A  EDB0          		ldir
                      	
                      	;	ld	hl,FNCLST66
  409C  1121FB        		ld	de,FNCTBL+(FNCLAST-FNC1ST+1)*2
  409F  011000        		ld	bc,CMDNAME66-FNCLST66
  40A2  EDB0          		ldir
                      	
                      	
  40A4  11E403        		ld	de,SNERR
                      	
  40A7  3A75FE        		ld	a,(DRVBIT)
  40AA  B7            		or	a
  40AB  200B          		jr	nz,SETTBLNZ
                      	
                      	;BLOAD-KILL -> ?SN Error
  40AD  21BFFA        		ld	hl,0fabfh
  40B0  060F          		ld	b,0fh
  40B2                	SETTBLLP1:
  40B2  73            		ld	(hl),e
  40B3  23            		inc	hl
  40B4  72            		ld	(hl),d
  40B5  23            		inc	hl
  40B6  10FA          		djnz	SETTBLLP1
                      	
  40B8                	SETTBLNZ:
  40B8  CD9539        		call	CHKMOD
  40BB  C8            		ret	z
                      	
                      	;TALK-DELETE -> ?SN Error
  40BC  21DDFA        		ld	hl,0faddh
  40BF  0604          		ld	b,04h
  40C1                	SETTBLLP2:
  40C1  73            		ld	(hl),e
  40C2  23            		inc	hl
  40C3  72            		ld	(hl),d
  40C4  23            		inc	hl
  40C5  10FA          		djnz	SETTBLLP2
                      	
                      	;DSKI$-MKS$ -> ?SN Error
  40C7  2123FB        		ld	hl,0fb23h
  40CA  0607          		ld	b,07h
  40CC                	SETTBLLP3:
  40CC  73            		ld	(hl),e
  40CD  23            		inc	hl
  40CE  72            		ld	(hl),d
  40CF  23            		inc	hl
  40D0  10FA          		djnz	SETTBLLP3
  40D2  C9            		ret
                      	
                      	
  40D3                	CNVIL66:
  40D3  78            		ld	a,b
  40D4  FEAB          		cp	CMDLAST+1
  40D6  2810          		jr	z,IL661
  40D8  FEC2          		cp	CLAST66+1
  40DA  2812          		jr	z,IL662
  40DC  FEF2          		cp	FNCLAST+1
  40DE  2816          		jr	z,IL663
  40E0  FEFA          		cp	FLAST66+1
  40E2  DA4B05        		jp	c,ILLP2
  40E5  C38205        		jp	ILNC
                      	
  40E8                	IL661:
  40E8  213A41        		ld	hl,CMDNAME66
  40EB  C34B05        		jp	ILLP2
  40EE                	IL662:
  40EE  21E402        		ld	hl,FNCNAME
  40F1  06C2          		ld	b,TAB
  40F3  C34B05        		jp	ILLP2
  40F6                	IL663:
  40F6  21A241        		ld	hl,FNCNAME66
  40F9  C34B05        		jp	ILLP2
                      	
                      	
  40FC                	CMDLST66:
                      	;ab-af
  40FC  E403724AAC4CC1		dw				C_RENM,	C_CRCL,	C_GET,	C_PUT,	C_BLD
                      	;b0-bf
  4106  E403E403E403E4		dw	C_BSAV,	C_FLS,	C_LFLS,	C_LOAD,	C_MRG,	C_NAME,	C_SAVE,	C_FLD
  4116  E403E403E403E4		dw	C_LSET,	C_RSET,	C_OPEN,	C_CLOS,	C_DSKO,	C_KILL,	C_TALK,	C_MON
                      	;c0-c1
  4126  D073B67E      		dw	C_KANJ,	C_DEL
                      	
                      	
  412A                	FNCLST66:
                      	;f2-f9
  412A  E403E403E403E4		dw			F_PAD,	F_DSKI,	F_LOF,	F_LOC,	F_EOF,	F_DSKF
  4136  E403E403      		dw	F_CVS,	F_MKS
                      	
                      	
  413A                	CMDNAME66:
  413A  D2454E554D    		db							'R'+80h,"ENUM"
  413F  C34952434C45C7		db	'C'+80h,"IRCLE",'G'+80h,"ET",	'P'+80h,"UT",	'B'+80h,"LOAD"
                      	
  4150  C253415645C649		db	'B'+80h,"SAVE",	'F'+80h,"ILES",	'L'+80h,"FILES",'L'+80h,"OAD"
  4164  CD45524745CE41		db	'M'+80h,"ERGE",	'N'+80h,"AME",	'S'+80h,"AVE",	'F'+80h,"IELD"
                      	
  4176  CC534554D25345		db	'L'+80h,"SET",	'R'+80h,"SET",	'O'+80h,"PEN",	'C'+80h,"LOSE"
  4187  C4534B4F24CB49		db	'D'+80h,"SKO$",	'K'+80h,"ILL",	'T'+80h,"ALK",	'M'+80h,"ON"
                      	
  4197  CB414E4A49C445		db	'K'+80h,"ANJI",	'D'+80h,"ELETE"
                      	
                      	
  41A2                	FNCNAME66:
  41A2  D04144C4534B49		db					'P'+80h,"AD",	'D'+80h,"SKI$"
  41AA  CC4F46CC4F43C5		db	'L'+80h,"OF",	'L'+80h,"OC",	'E'+80h,"OF",	'D'+80h,"SKF"
                      	
  41B7  C35653CD4B5324		db	'C'+80h,"VS",	'M'+80h,"KS$",	80h
                      	
                      	
                      	;error ID for extended BASIC
  41BF                	ERRIDEX:
  41BF  464F4945424E  		db	"FO", "IE", "BN"
  41C5  4646424D414F49		db	"FF", "BM", "AO", "IO", "FE", "DF", "EF", "NM"
  41D5  44534154444E54		db	"DS", "AT", "DN", "TS", "RD", "SP", "CF", "FW"
                      	
                      	
  41E5                	FOERR:
  41E5  1E2A          		ld	e,2ah
  41E7  01            		db	01h		;ld bc,****
  41E8                	IEERR:
  41E8  1E2C          		ld	e,2ch
  41EA  01            		db	01h		;ld bc,****
  41EB                	BNERR:
  41EB  1E2E          		ld	e,2eh
  41ED  01            		db	01h		;ld bc,****
  41EE                	FFERR:
  41EE  1E30          		ld	e,30h
  41F0  01            		db	01h		;ld bc,****
  41F1                	BMERR:
  41F1  1E32          		ld	e,32h
  41F3  01            		db	01h		;ld bc,****
  41F4                	AOERR:
  41F4  1E34          		ld	e,34h
  41F6  01            		db	01h		;ld bc,****
  41F7                	IOERR:
  41F7  1E36          		ld	e,36h
  41F9  01            		db	01h		;ld bc,****
  41FA                	FEERR:
  41FA  1E38          		ld	e,38h
  41FC  01            		db	01h		;ld bc,****
  41FD                	DFERR:
  41FD  1E3A          		ld	e,3ah
  41FF  01            		db	01h		;ld bc,****
  4200                	EFERR:
  4200  1E3C          		ld	e,3ch
  4202  01            		db	01h		;ld bc,****
  4203                	NMERR:
  4203  1E3E          		ld	e,3eh
  4205  01            		db	01h		;ld bc,****
  4206                	DSERR:
  4206  1E40          		ld	e,40h
  4208  01            		db	01h		;ld bc,****
  4209                	ATERR:
  4209  1E42          		ld	e,42h
  420B  01            		db	01h		;ld bc,****
  420C                	DNERR:
  420C  1E44          		ld	e,44h
  420E  01            		db	01h		;ld bc,****
  420F                	TSERR:
  420F  1E46          		ld	e,46h
  4211  01            		db	01h		;ld bc,****
  4212                	RDERR:
  4212  1E48          		ld	e,48h
  4214  01            		db	01h		;ld bc,****
  4215                	SPERR:
  4215  1E4A          		ld	e,4ah
  4217  01            		db	01h		;ld bc,****
  4218                	CFERR:
  4218  1E4C          		ld	e,4ch
  421A  01            		db	01h		;ld bc,****
  421B                	FWERR:
  421B  1E4E          		ld	e,4eh
                      	
  421D  C31F04        		jp	ERROR
                      	
                      	
                      	;read/write/check disk
                      	;input:
                      	; a=the number of sector, b=track, c=sector, de=address
                      	; ix=work address, (ix+00h)=drive, (ix+11b)=error count
                      	; c-flag=0,z-flag=0: read
                      	; c-flag=0,z-flag=1: check
                      	; c-flag=1: write
                      	;output: c-flag=1 if error, (de=de+data size)
                      	;destroy: (de)
  4220                	_DISK:	ds	DISK-_DISK
  4274                		org	DISK
  4274  C3F442        		jp	DSKMAIN
                      	
                      	
                      	;initialize FDD
                      	;output: a=ndrive, z-flag=(1:no drive)
                      	;destroy: f,(bc,de,hl)
  4277                	_INIDSK:ds	INIDSK-_INIDSK
  42B9                		org	INIDSK
                      	
  42B9  C5            		push	bc
  42BA  0E00          		ld	c,00h		;ndrive
  42BC  CD1645        		call	FDSTBY
                      	
                      	
                      	;for no FDD
  42BF  AF            		xor	a
  42C0  3275FE        		ld	(DRVBIT),a
                      	
                      	;for emulator?
  42C3  DBDC          		in	a,(FDCSTAT)
  42C5  3C            		inc	a
  42C6  2828          		jr	z,INIDSKEND
                      	
  42C8  CD0D45        		call	MOTORABON
  42CB  CD3A44        		call	SPECIFY
  42CE                	DRIVEA:
  42CE  AF            		xor	a		;drive
  42CF  3275FE        		ld	(DRVBIT),a
  42D2  CD5044        		call	RECALIB
  42D5  3806          		jr	c,DRIVEB
  42D7  3E10          		ld	a,10h
  42D9  3275FE        		ld	(DRVBIT),a
  42DC  0C            		inc	c
  42DD                	DRIVEB:
  42DD  3E01          		ld	a,01h		;drive
  42DF  CD5044        		call	RECALIB
  42E2  CD1B45        		call	FDOFF
  42E5  3A75FE        		ld	a,(DRVBIT)
  42E8  3806          		jr	c,INIDSKEND
  42EA  F620          		or	20h
  42EC  3275FE        		ld	(DRVBIT),a
  42EF  0C            		inc	c
  42F0                	INIDSKEND:
  42F0  79            		ld	a,c
  42F1  B7            		or	a		;z-flag=1 if no FDD
  42F2  C1            		pop	bc
  42F3  C9            		ret
                      	
                      	
                      	;continued from DISK
  42F4                	DSKMAIN:
  42F4  F5            		push	af
  42F5  E5            		push	hl
  42F6  D5            		push	de
  42F7  C5            		push	bc
                      	
  42F8  3271FE        		ld	(RMSECT),a
  42FB  3E02          		ld	a,02h
  42FD  3805          		jr	c,SETRWC	;2=write
  42FF  3E01          		ld	a,01h
  4301  2801          		jr	z,SETRWC	;1=check
  4303  AF            		xor	a		;0=read
  4304                	SETRWC:
  4304  3270FE        		ld	(RDWRCHK),a
  4307  78            		ld	a,b
  4308  FE28          		cp	28h
  430A  305F          		jr	nc,DSKERR	;if track>39
  430C  3272FE        		ld	(TRACK),a
  430F  79            		ld	a,c
  4310  FE11          		cp	11h
  4312  3057          		jr	nc,DSKERR	;if sector>16
  4314  3274FE        		ld	(SECTOR),a
  4317  DD7E00        		ld	a,(ix+00h)
  431A  FE02          		cp	02h
  431C  304D          		jr	nc,DSKERR	;if drive>1
  431E  3273FE        		ld	(DRIVE),a
  4321  CDE944        		call	MOTORON
                      	;	ld	a,(DRIVE)
                      	;	call	RECALIB
                      	;	jr	c,DSKERR
  4324  CD1645        		call	FDSTBY
  4327  CD6444        		call	SEEK
  432A  383F          		jr	c,DSKERR
  432C                	DSKLP:
  432C  3A71FE        		ld	a,(RMSECT)
  432F  FE04          		cp	04h
  4331  3802          		jr	c,LT4SECT
  4333  3E04          		ld	a,04h
  4335                	LT4SECT:
  4335  3278FE        		ld	(NSECT),a
  4338  3A70FE        		ld	a,(RDWRCHK)
  433B  FE02          		cp	02h		;write
  433D  CCAE43        		call	z,WT4SECT	;z-flag is set
  4340  C48843        		call	nz,RD4SECT
  4343  3826          		jr	c,DSKERR
  4345  3A71FE        		ld	a,(RMSECT)
  4348  D605          		sub	05h
  434A  380E          		jr	c,DSKEND
  434C  3C            		inc	a
  434D  3271FE        		ld	(RMSECT),a
  4350  3A74FE        		ld	a,(SECTOR)
  4353  C604          		add	a,04h
  4355  3274FE        		ld	(SECTOR),a
  4358  18D2          		jr	DSKLP
  435A                	DSKEND:
  435A  CD1B45        		call	FDOFF
  435D  C1            		pop	bc
  435E  E1            		pop	hl		;de
  435F  3A70FE        		ld	a,(RDWRCHK)
  4362  FE01          		cp	01h		;1=check
  4364  2001          		jr	nz,NOCHECK	;de changes (read/write)
  4366  EB            		ex	de,hl		;pop de (check)
  4367                	NOCHECK:
  4367  E1            		pop	hl
  4368  F1            		pop	af
  4369  B7            		or	a		;reset c-flag: ok
  436A  C9            		ret
                      	
  436B                	DSKERR:
  436B  CD1B45        		call	FDOFF
  436E  C1            		pop	bc
  436F  D1            		pop	de
  4370  E1            		pop	hl
  4371  DD7E1B        		ld	a,(ix+1bh)
  4374  3C            		inc	a
  4375  DD771B        		ld	(ix+1bh),a
  4378  FE0A          		cp	0ah
  437A  3003          		jr	nc,ERRJMP
  437C  F1            		pop	af
  437D  37            		scf			;set c-flag: error
  437E  C9            		ret
                      	
  437F                	ERRJMP:
  437F  F1            		pop	af
  4380  33            		inc	sp		;return address
  4381  33            		inc	sp		;return address
  4382  E5            		push	hl
  4383  2AE8FF        		ld	hl,(ERRAD)
  4386  E3            		ex	(sp),hl
  4387  C9            		ret
                      	
                      	
                      	;input: de
                      	;output: de=de+data size
                      	;destroy: af,bc,hl
  4388                	RD4SECT:
  4388  CDE044        		call	SETBSIZ
  438B  CDC843        		call	RWDATA
  438E  D8            		ret	c		;error
  438F  EB            		ex	de,hl
  4390  0ED0          		ld	c,FDBUF
  4392  3A78FE        		ld	a,(NSECT)
  4395                	RDATALP:
  4395  F5            		push	af		;
  4396  2B            		dec	hl
  4397  24            		inc	h
  4398  06FF          		ld	b,0ffh
  439A  3A70FE        		ld	a,(RDWRCHK)
  439D  F600          		or	z
  439F  2005          		jr	nz,CHECK
  43A1  EDBA          		indr			;8MSB=ff-01
  43A3  EDAA          		ind			;8MSB=00
  43A5  24            		inc	h
  43A6                	CHECK:
  43A6  23            		inc	hl
  43A7  0C            		inc	c
  43A8  F1            		pop	af		;
  43A9  3D            		dec	a
  43AA  20E9          		jr	nz,RDATALP
  43AC  EB            		ex	de,hl
  43AD  C9            		ret
                      	
                      	
                      	;write 4 sectors
                      	;input: de
                      	;output: de=de+data size
                      	;destroy: af,bc,hl
  43AE                	WT4SECT:
  43AE  CDE044        		call	SETBSIZ
  43B1  EB            		ex	de,hl
  43B2  0ED0          		ld	c,FDBUF
  43B4  3A78FE        		ld	a,(NSECT)
  43B7                	WDATALP:
  43B7  2B            		dec	hl
  43B8  24            		inc	h
  43B9  0600          		ld	b,00h
  43BB  EDBB          		otdr			;8MSB=ff-00!!
  43BD  23            		inc	hl
  43BE  24            		inc	h
  43BF  0C            		inc	c
  43C0  3D            		dec	a
  43C1  20F4          		jr	nz,WDATALP
  43C3  EB            		ex	de,hl
  43C4  CDC843        		call	RWDATA
  43C7  C9            		ret
                      	
                      	
                      	;read data or write data
                      	;destroy: af,b,hl
  43C8                	RWDATA:
  43C8  AF            		xor	a
  43C9  3277FE        		ld	(RETRY),a
  43CC                	RWDTLP:
  43CC  CDA844        		call	FDCRDY
  43CF  CDAF44        		call	DRVRDY
  43D2  3A70FE        		ld	a,(RDWRCHK)
  43D5  FE02          		cp	02h		;0=read,1=check,2=write
  43D7  3E46          		ld	a,46h		;46h=read data command
  43D9  2001          		jr	nz,SETCMD
  43DB  3D            		dec	a		;45h=write data command
  43DC                	SETCMD:
  43DC  CDCE44        		call	WRTFDC
  43DF  F3            		di
  43E0  3A73FE        		ld	a,(DRIVE)	;drvie/head
  43E3  CDCE44        		call	WRTFDC
  43E6  3A72FE        		ld	a,(TRACK)	;track
  43E9  CDCE44        		call	WRTFDC
  43EC  AF            		xor	a		;head
  43ED  CDCE44        		call	WRTFDC
  43F0  3A74FE        		ld	a,(SECTOR)	;sector
  43F3  CDCE44        		call	WRTFDC
  43F6  3E01          		ld	a,01h		;sector length (128*2^n byte/sector)
  43F8  CDCE44        		call	WRTFDC
  43FB  3E10          		ld	a,10h		;EOT (End Of Track)
  43FD  CDCE44        		call	WRTFDC
  4400  3E14          		ld	a,14h		;GPL (GaP Length)
  4402  CDCE44        		call	WRTFDC
  4405  3EFF          		ld	a,0ffh		;DTL (DaTa Length)
  4407  CDCE44        		call	WRTFDC
  440A  3A70FE        		ld	a,(RDWRCHK)
  440D  FE02          		cp	02h		;0=read,1=check,2=write
  440F  3EF2          		ld	a,0f2h		;read
  4411  2002          		jr	nz,SETDMA
  4413  3EF0          		ld	a,0f0h		;write
  4415                	SETDMA:
  4415  D3B1          		out	(FDCNTL),a
  4417  FB            		ei
  4418  CDB644        		call	INTRPT
  441B  CD1645        		call	FDSTBY
  441E  2179FE        		ld	hl,STATBF
  4421  0607          		ld	b,07h
  4423                	STATLP:
  4423  CDC044        		call	REDFDC
  4426  77            		ld	(hl),a
  4427  23            		inc	hl
  4428  10F9          		djnz	STATLP
  442A  3A79FE        		ld	a,(STATBF)
  442D  E6C0          		and	11000000b
  442F  C8            		ret	z		;NT
  4430  2177FE        		ld	hl,RETRY
  4433  34            		inc	(hl)
  4434  7E            		ld	a,(hl)
  4435  C6F6          		add	a,0-0ah
  4437  3093          		jr	nc,RWDTLP	;if retry<10
  4439  C9            		ret			;c-flag=1,z-flag=1
                      	
                      	
                      	;FDC specify command
                      	;destroy: af
  443A                	SPECIFY:
  443A  CDA844        		call	FDCRDY
  443D  CDAF44        		call	DRVRDY
  4440  3E03          		ld	a,03h		;specify
  4442  CDCE44        		call	WRTFDC
  4445  3EBF          		ld	a,0bfh		;step rate time=5ms/10ms,
                      					;head unload time=240ms/480ms
  4447  CDCE44        		call	WRTFDC
  444A  3E26          		ld	a,26h		;head load time=38ms/76ms, DMA mode
  444C  CDCE44        		call	WRTFDC
  444F  C9            		ret
                      	
                      	
                      	;FDC recalibrate command
                      	;input: a=drive
                      	;output: c-flag(1=error)
                      	;destroy: af,b
  4450                	RECALIB:
  4450  F5            		push	af
  4451  CDA844        		call	FDCRDY
  4454  CDAF44        		call	DRVRDY
  4457  3E07          		ld	a,07h		;recalibrate command
  4459  CDCE44        		call	WRTFDC
  445C  F1            		pop	af		;drive/head
  445D  CDCE44        		call	WRTFDC
  4460  0600          		ld	b,00h		;track
  4462  1818          		jr	SENSE
                      	
                      	
                      	;FDC seek command
                      	;output: c-flag(1=error)
                      	;destroy: af,b
  4464                	SEEK:
  4464  CDA844        		call	FDCRDY
  4467  CDAF44        		call	DRVRDY
  446A  3E0F          		ld	a,0fh		;seek command
  446C  CDCE44        		call	WRTFDC
  446F  3A73FE        		ld	a,(DRIVE)	;drive/head
  4472  CDCE44        		call	WRTFDC
  4475  3A72FE        		ld	a,(TRACK)	;track
  4478  CDCE44        		call	WRTFDC
  447B  47            		ld	b,a		;track
                      	;	jr	SENSE
                      	
                      	
                      	;FDC sense command
                      	;input: b=track
                      	;output: c-flag(1=error)
                      	;destroy: af
  447C                	SENSE:
  447C  CDB644        		call	INTRPT
  447F  CDA844        		call	FDCRDY
  4482  3E08          		ld	a,08h		;sense interrupt status command
  4484  CDCE44        		call	WRTFDC
  4487  CDC044        		call	REDFDC		;st0
  448A  3279FE        		ld	(STATBF),a
  448D  CDC044        		call	REDFDC		;track
  4490  327AFE        		ld	(STATBF+1),a
                      	;error check
  4493  3A79FE        		ld	a,(STATBF)
  4496  E6D0          		and	11010000b	;bit6-7:interrupt code, bit4=fault
  4498  200C          		jr	nz,SENSEER
  449A  3A79FE        		ld	a,(STATBF)
  449D  E620          		and	00100000b	;seek End
  449F  28DB          		jr	z,SENSE
  44A1  3A7AFE        		ld	a,(STATBF+1)	;track
  44A4  B8            		cp	b
  44A5  C8            		ret	z
  44A6                	SENSEER:
  44A6  37            		scf
  44A7  C9            		ret
                      	
                      	
                      	;wait for FDC ready
                      	;destroy: af
  44A8                	FDCRDY:
  44A8  DBDC          		in	a,(FDCSTAT)
  44AA  E610          		and	00010000b
  44AC  20FA          		jr	nz,FDCRDY
  44AE  C9            		ret
                      	
                      	
                      	;wait for drives ready
                      	;destroy: af
  44AF                	DRVRDY:
  44AF  DBDC          		in	a,(FDCSTAT)
  44B1  E60F          		and	00001111b
  44B3  20FA          		jr	nz,DRVRDY
  44B5  C9            		ret
                      	
                      	
                      	;wait for FDC interrupt
                      	;destroy: af
  44B6                	INTRPT:
  44B6  3EFE          		ld	a,0feh
  44B8  D3B3          		out	(B2CNTL),a	;use b2-bit0?
  44BA  DBB2          		in	a,(FDCINT)	;bit0=1:interrupt
  44BC  0F            		rrca
  44BD  30F7          		jr	nc,INTRPT
  44BF  C9            		ret
                      	
                      	
                      	;read data from FDC
                      	;destroy: f
                      	;output: a
  44C0                	REDFDC:
  44C0  DBDC          		in	a,(FDCSTAT)
                      	;	and	11000000b
                      	;	cp	11000000b	;RQM=1,DIO=1(output)
                      	;	jr	nz,REDFDC
  44C2  07            		rlca
  44C3  30FB          		jr	nc,REDFDC	;wait for RQM=1
  44C5  07            		rlca
  44C6  3803          		jr	c,READOK	;DIO=1(output)
  44C8  3EFF          		ld	a,0ffh
  44CA  C9            		ret
  44CB                	READOK:
  44CB  DBDD          		in	a,(FDCDATA)
  44CD  C9            		ret
                      	
                      	
                      	;write data to FDC
                      	;destroy: none
  44CE                	WRTFDC:
  44CE  F5            		push	af
  44CF                	WRTFDCLP:
  44CF  DBDC          		in	a,(FDCSTAT)
                      	;	and	11000000b
                      	;	cp	10000000b	;RQM=1,DIO=0(input)
                      	;	jr	nz,WRTFDCLP
  44D1  07            		rlca
  44D2  30FB          		jr	nc,WRTFDCLP	;wait for RQM=1
  44D4  07            		rlca
  44D5  3005          		jr	nc,WRTOK	;DIO=0(input)
  44D7  CDC044        		call	REDFDC
  44DA  18F3          		jr	WRTFDCLP
  44DC                	WRTOK:
  44DC  F1            		pop	af
  44DD  D3DD          		out	(FDCDATA),a
  44DF  C9            		ret
                      	
                      	
                      	;set FD buffer size
                      	;destroy: af
  44E0                	SETBSIZ:
  44E0  3A78FE        		ld	a,(NSECT)
  44E3  D610          		sub	10h
  44E5  2F            		cpl
  44E6  D3DA          		out	(BUFSIZ),a
  44E8  C9            		ret
                      	
                      	
                      	;motor on
                      	;input: a=drive
                      	;destroy: af
  44E9                	MOTORON:
  44E9  B7            		or	a
  44EA  280B          		jr	z,AON
  44EC  3D            		dec	a
  44ED  C0            		ret	nz
  44EE                	BON:
  44EE  DBD4          		in	a,(MOTORST)	;motor status
  44F0  E602          		and	02h
  44F2  C8            		ret	z		;on status
  44F3  E6FD          		and	0fdh		;driveB on (bit1=0)
  44F5  1807          		jr	ABON
  44F7                	AON:
  44F7  DBD4          		in	a,(MOTORST)	;motor status
  44F9  E601          		and	01h
  44FB  C8            		ret	z		;on status
  44FC  E6FE          		and	0feh		;driveA on (bit0=0)
  44FE                	ABON:
  44FE  D3D6          		out	(MOTOR),a	;motor on
                      	
  4500  3E08          		ld	a,08h
  4502  D3DE          		out	(ADJUST),a	;compensation?
                      	
  4504  C5            		push	bc
  4505  010030        		ld	bc,3000h	;about 0.6sec
  4508  CDE825        		call	WAITLP
  450B  C1            		pop	bc
  450C  C9            		ret
                      	
  450D                	MOTORABON:
  450D  DBD4          		in	a,(MOTORST)	;motor status
  450F  E603          		and	03h
  4511  C8            		ret	z		;A,B=on
  4512  E6FC          		and	0fch
  4514  18E8          		jr	ABON
                      	
                      	
                      	;set FDD stand-by mode
                      	;destroy: a
  4516                	FDSTBY:
  4516  3EF3          		ld	a,0f3h
  4518  D3B1          		out	(FDCNTL),a
  451A  C9            		ret
                      	
                      	
                      	;set FDD off
  451B                	FDOFF:
                      	;destroy: a
  451B  3EF7          		ld	a,0f7h
  451D  D3B1          		out	(FDCNTL),a
  451F  C9            		ret
                      	
                      	
                      	;HEX$() function
  4520                	F_HEX:
  4520  CD780B        		call	CHKNUM
  4523  CDB10C        		call	FTOI
                      	
  4526  2172FF        		ld	hl,FAC3
  4529  222FFF        		ld	(STRDSC1+2),hl
  452C  0E00          		ld	c,0		;length
  452E  7A            		ld	a,d
  452F  CD4545        		call	CNVHEX2
  4532  7B            		ld	a,e
  4533  CD4545        		call	CNVHEX2
  4536  2003          		jr	nz,HEXNZ	;if c<>0
  4538  3630          		ld	(hl),'0'
  453A  0C            		inc	c
  453B                	HEXNZ:
  453B  79            		ld	a,c
  453C  322DFF        		ld	(STRDSC1),a
  453F  CD2226        		call	MAKESTR
  4542  C3C227        		jp	INKYEND
                      	
                      	
                      	;input: a=data, c=length, hl=address
                      	;output: c=length, z-flag(1:c=0)
                      	;destroy: af
  4545                	CNVHEX2:
  4545  47            		ld	b,a
  4546  0F            		rrca
  4547  0F            		rrca
  4548  0F            		rrca
  4549  0F            		rrca
  454A  CD4E45        		call	CNVHEX1
  454D  78            		ld	a,b
                      	;	call	CNVHEX1
                      	;	ret
                      	
  454E                	CNVHEX1:
  454E  E60F          		and	0fh
  4550  2003          		jr	nz,CNVHEXNZ
  4552  0C            		inc	c
  4553  0D            		dec	c
  4554  C8            		ret	z
  4555                	CNVHEXNZ:
  4555  FE0A          		cp	0ah
  4557  DE69          		sbc	a,69h
  4559  27            		daa
  455A  77            		ld	(hl),a
  455B  23            		inc	hl
  455C  0C            		inc	c
  455D  C9            		ret
                      	
                      	
                      	;CIRCLE command work area
  FEAD                	XRAD	equ	GRPX2		;x-radius
  FEAF                	YRAD	equ	GRPY2		;y-radius
  FF65                	DEDX	equ	FAC1-1		;de/dx
  FF6C                	DEDY	equ	FAC2-1		;de/dy
  FF72                	ERR	equ	FAC3		;error
                      	
  FF78                	STARTX	equ	0ff78h
  FF7A                	STARTY	equ	0ff7ah
  FF7C                	ENDX	equ	0ff7ch
  FF7E                	ENDY	equ	0ff7eh
  FF81                	CRCLFLG	equ	0ff81h
                      	
                      	
  455E                	CRCLFDATA:
  455E  77FFFFFF      		db	77h, 0ffh, 0ffh, 0ffh	;end quad.-start quad.=4
  4562  6677EEFF      		db	66h, 77h, 0eeh, 0ffh	;end quad.-start quad.=3
  4566  4466CCEE      		db	44h, 66h, 0cch, 0eeh	;end quad.-start quad.=2
  456A  004488CC      		db	00h, 44h, 88h, 0cch	;end quad.-start quad.=1
  456E  00000088      		db	00h, 00h, 00h, 88h	;end quad.-start quad.=0
                      	
  4572                	CRCLMAIN:
  4572  2AADFE        		ld	hl,(XRAD)
  4575  ED5BE6FF      		ld	de,(ASPECT)
  4579  CD6F24        		call	MULINT2
  457C  CD8C4C        		call	ROUNDI2
  457F  22AFFE        		ld	(YRAD),hl	;yrad=r*a
                      	
  4582                	CRCLMAIN2:
  4582  CD3D39        		call	POPF1		;end angle
  4585  CD4C39        		call	POPF2		;start angle
                      	
                      	
  4588  2169FF        		ld	hl,FAC1+3
  458B  7E            		ld	a,(hl)
  458C  F5            		push	af		;sign of end angle
  458D  CBBE          		res	7,(hl)
  458F  2170FF        		ld	hl,FAC2+3
  4592  7E            		ld	a,(hl)
  4593  F5            		push	af		;sign of start angle
  4594  CBBE          		res	7,(hl)
                      	
  4596  CD2E39        		call	PUSHF2		;end angle
  4599  CD1D3F        		call	CMPF
                      	
  459C  9F            		sbc	a,a
  459D  3C            		inc	a		;start<=end?
  459E  F5            		push	af
                      	
  459F  CD6A4B        		call	ANGL2XY
  45A2  227CFF        		ld	(ENDX),hl
  45A5  ED537EFF      		ld	(ENDY),de
                      	
  45A9  F1            		pop	af
  45AA  07            		rlca
  45AB  07            		rlca
  45AC  B0            		or	b
  45AD  57            		ld	d,a		;bit2=start<=end?, bit10=end quad.
                      	
  45AE  CD3D39        		call	POPF1		;start angle
  45B1  D5            		push	de
                      	
  45B2  CD6A4B        		call	ANGL2XY
  45B5  2278FF        		ld	(STARTX),hl
  45B8  ED537AFF      		ld	(STARTY),de
                      	
  45BC  F1            		pop	af
  45BD  07            		rlca
  45BE  07            		rlca
  45BF  B0            		or	b
  45C0  3281FF        		ld	(CRCLFLG),a	;bit4=start<=end?, bit32=end quad., bit10=start quad.
                      	
                      	
  45C3  2AADFE        		ld	hl,(XRAD)
  45C6  54            		ld	d,h
  45C7  5D            		ld	e,l
  45C8  CD6F24        		call	MULINT2		;a*a=aa
  45CB  E5            		push	hl		;aa
  45CC  D5            		push	de
  45CD  29            		add	hl,hl
  45CE  CB13          		rl	e
  45D0  CB12          		rl	d
  45D2  29            		add	hl,hl
  45D3  CB13          		rl	e
  45D5  CB12          		rl	d
  45D7  42            		ld	b,d
  45D8  4B            		ld	c,e
  45D9  EB            		ex	de,hl
  45DA  D9            		exx			;bcde'=4aa
                      	
  45DB  2AAFFE        		ld	hl,(YRAD)
  45DE  54            		ld	d,h
  45DF  5D            		ld	e,l
  45E0  CD6F24        		call	MULINT2		;b*b=bb
  45E3  E5            		push	hl		;bb
  45E4  D5            		push	de
  45E5  29            		add	hl,hl
  45E6  CB13          		rl	e
  45E8  CB12          		rl	d
  45EA  29            		add	hl,hl
  45EB  CB13          		rl	e
  45ED  CB12          		rl	d
  45EF  29            		add	hl,hl
  45F0  CB13          		rl	e
  45F2  CB12          		rl	d
  45F4  E5            		push	hl		;8bb
  45F5  D5            		push	de
                      	
                      	;de/dx_ini=8abb
  45F6  EB            		ex	de,hl
  45F7  2AADFE        		ld	hl,(XRAD)
  45FA  CD6F24        		call	MULINT2		;a*8bb=8abb (low)
  45FD  2265FF        		ld	(DEDX),hl
  4600  ED5367FF      		ld	(DEDX+2),de
  4604  2AADFE        		ld	hl,(XRAD)
  4607  D1            		pop	de		;8bb (high)
  4608  D5            		push	de
  4609  CD6F24        		call	MULINT2		;a*8bb=8abb (high)
  460C  ED4B67FF      		ld	bc,(DEDX+2)
  4610  09            		add	hl,bc
  4611  2267FF        		ld	(DEDX+2),hl
  4614  3001          		jr	nc,CRCLNC1
  4616  13            		inc	de
  4617                	CRCLNC1:
  4617  ED5369FF      		ld	(DEDX+4),de
                      	
                      	;err_ini=bb(1-4a)
  461B  CB3A          		srl	d
  461D  CB1B          		rr	e
  461F  ED5376FF      		ld	(ERR+4),de	;4abb
  4623  2A67FF        		ld	hl,(DEDX+2)
  4626  CB1C          		rr	h
  4628  CB1D          		rr	l
  462A  2274FF        		ld	(ERR+2),hl
  462D  2A65FF        		ld	hl,(DEDX)
  4630  CB1C          		rr	h
  4632  CB1D          		rr	l
  4634  2272FF        		ld	(ERR),hl
                      	
  4637  C1            		pop	bc		;8bb
  4638  E1            		pop	hl
  4639  D1            		pop	de		;bb(high)
  463A  E3            		ex	(sp),hl		;bb(low)
  463B  C5            		push	bc
                      	
  463C  D5            		push	de
  463D  ED5B72FF      		ld	de,(ERR)
                      	;	or	a
  4641  ED52          		sbc	hl,de
  4643  2272FF        		ld	(ERR),hl
  4646  E1            		pop	hl
  4647  ED5B74FF      		ld	de,(ERR+2)
  464B  ED52          		sbc	hl,de
  464D  2274FF        		ld	(ERR+2),hl
  4650  210000        		ld	hl,0000h
  4653  ED5B76FF      		ld	de,(ERR+4)
  4657  ED52          		sbc	hl,de
  4659  2276FF        		ld	(ERR+4),hl
                      	
                      	;de/dy_ini=-4aa
  465C  D9            		exx
  465D  D5            		push	de		;4aa
  465E  C5            		push	bc
  465F  AF            		xor	a
  4660  67            		ld	h,a
  4661  6F            		ld	l,a
  4662  ED52          		sbc	hl,de
  4664  226CFF        		ld	(DEDY),hl
  4667  67            		ld	h,a
  4668  6F            		ld	l,a
  4669  ED42          		sbc	hl,bc
  466B  226EFF        		ld	(DEDY+2),hl
  466E  DE00          		sbc	a,00h
  4670  67            		ld	h,a
  4671  6F            		ld	l,a
  4672  2270FF        		ld	(DEDY+4),hl
  4675  C1            		pop	bc
  4676  E1            		pop	hl
  4677  29            		add	hl,hl
  4678  EB            		ex	de,hl
  4679  CB11          		rl	c
  467B  CB10          		rl	b		;8aa
  467D  D9            		exx
                      	
  467E  2AADFE        		ld	hl,(XRAD)	;x=x-radius
  4681  22B1FE        		ld	(GRPX3),hl
  4684  210000        		ld	hl,0000h	;y=0
  4687  22B3FE        		ld	(GRPY3),hl
                      	
  468A                	CRCLLP1:
  468A  0601          		ld	b,01h
  468C  CD2249        		call	CRCLPSET
  468F  2AB3FE        		ld	hl,(GRPY3)
  4692  23            		inc	hl
  4693  22B3FE        		ld	(GRPY3),hl
                      	
                      	;de/dy+=8aa
  4696  D9            		exx
  4697  2A6CFF        		ld	hl,(DEDY)
  469A  19            		add	hl,de
  469B  226CFF        		ld	(DEDY),hl
  469E  2A6EFF        		ld	hl,(DEDY+2)
  46A1  ED4A          		adc	hl,bc
  46A3  226EFF        		ld	(DEDY+2),hl
  46A6  3007          		jr	nc,CRCLNC2
  46A8  2A70FF        		ld	hl,(DEDY+4)
  46AB  23            		inc	hl
  46AC  2270FF        		ld	(DEDY+4),hl
  46AF                	CRCLNC2:
  46AF  D9            		exx
                      	
                      	;err+=de/dy
  46B0  2A72FF        		ld	hl,(ERR)
  46B3  ED5B6CFF      		ld	de,(DEDY)
  46B7  19            		add	hl,de
  46B8  2272FF        		ld	(ERR),hl
  46BB  2A74FF        		ld	hl,(ERR+2)
  46BE  ED5B6EFF      		ld	de,(DEDY+2)
  46C2  ED5A          		adc	hl,de
  46C4  2274FF        		ld	(ERR+2),hl
  46C7  2A76FF        		ld	hl,(ERR+4)
  46CA  ED5B70FF      		ld	de,(DEDY+4)
  46CE  ED5A          		adc	hl,de
  46D0  2276FF        		ld	(ERR+4),hl
                      	
                      	;if err>=0 and x>0 then x=x-1:de/dx-=8bb:err-=de/dx
  46D3  7C            		ld	a,h
  46D4  07            		rlca
  46D5  384E          		jr	c,CRCLC1
  46D7  2AB1FE        		ld	hl,(GRPX3)
  46DA  7C            		ld	a,h
  46DB  B5            		or	l
  46DC  2847          		jr	z,CRCLC1
  46DE  2B            		dec	hl
  46DF  22B1FE        		ld	(GRPX3),hl
                      	
  46E2  C1            		pop	bc		;8bb
  46E3  D1            		pop	de
                      	
  46E4  2A65FF        		ld	hl,(DEDX)
  46E7  B7            		or	a
  46E8  ED52          		sbc	hl,de
  46EA  2265FF        		ld	(DEDX),hl
  46ED  2A67FF        		ld	hl,(DEDX+2)
  46F0  ED42          		sbc	hl,bc
  46F2  2267FF        		ld	(DEDX+2),hl
  46F5  3007          		jr	nc,CRCLNC3
  46F7  2A69FF        		ld	hl,(DEDX+4),hl
  46FA  2B            		dec	hl
  46FB  2269FF        		ld	(DEDX+4),hl
  46FE                	CRCLNC3:
  46FE  D5            		push	de		;8bb
  46FF  C5            		push	bc
                      	
  4700  2A72FF        		ld	hl,(ERR)
  4703  ED5B65FF      		ld	de,(DEDX)
  4707  B7            		or	a
  4708  ED52          		sbc	hl,de
  470A  2272FF        		ld	(ERR),hl
  470D  2A74FF        		ld	hl,(ERR+2)
  4710  ED5B67FF      		ld	de,(DEDX+2)
  4714  ED52          		sbc	hl,de
  4716  2274FF        		ld	(ERR+2),hl
  4719  2A76FF        		ld	hl,(ERR+4)
  471C  ED5B69FF      		ld	de,(DEDX+4)
  4720  ED52          		sbc	hl,de
  4722  2276FF        		ld	(ERR+4),hl
                      	
  4725                	CRCLC1:
                      	;if de/dx<de/dy or (de/dx=0 and y<b) then loop
  4725  2A6CFF        		ld	hl,(DEDY)
  4728  ED5B65FF      		ld	de,(DEDX)
  472C  B7            		or	a
  472D  ED52          		sbc	hl,de
  472F  2A6EFF        		ld	hl,(DEDY+2)
  4732  ED5B67FF      		ld	de,(DEDX+2)
  4736  ED52          		sbc	hl,de
  4738  2A70FF        		ld	hl,(DEDY+4)
  473B  ED5B69FF      		ld	de,(DEDX+4)
  473F  ED52          		sbc	hl,de
  4741  CB7C          		bit	7,h
  4743  C28A46        		jp	nz,CRCLLP1
                      	
  4746  7A            		ld	a,d
  4747  B3            		or	e
  4748  2A65FF        		ld	hl,(DEDX)
  474B  B4            		or	h
  474C  B5            		or	l
  474D  2A67FF        		ld	hl,(DEDX+2)
  4750  B4            		or	h
  4751  B5            		or	l
  4752  200C          		jr	nz,CRCLNZ1
  4754  2AB3FE        		ld	hl,(GRPY3)
  4757  ED5BAFFE      		ld	de,(YRAD)
                      	;	or	a
  475B  ED52          		sbc	hl,de
  475D  DA8A46        		jp	c,CRCLLP1
                      	
  4760                	CRCLNZ1:
                      	;de/dx_ini=-4bb
  4760  C1            		pop	bc		;8bb
  4761  D1            		pop	de
  4762  D5            		push	de
  4763  C5            		push	bc
  4764  CB38          		srl	b		;4bb
  4766  CB19          		rr	c
  4768  CB1A          		rr	d
  476A  CB1B          		rr	e
  476C  AF            		xor	a
  476D  67            		ld	h,a
  476E  6F            		ld	l,a
  476F  ED52          		sbc	hl,de
  4771  2265FF        		ld	(DEDX),hl
  4774  67            		ld	h,a
  4775  6F            		ld	l,a
  4776  ED42          		sbc	hl,bc
  4778  2267FF        		ld	(DEDX+2),hl
  477B  DE00          		sbc	a,00h
  477D  67            		ld	h,a
  477E  6F            		ld	l,a
  477F  2269FF        		ld	(DEDX+4),hl
  4782  C1            		pop	bc		;8bb
  4783  D1            		pop	de
  4784  D9            		exx
                      	
  4785  D5            		push	de		;8aa
  4786  C5            		push	bc
                      	
                      	
                      	;de/dy_ini=8aab
  4787  2AAFFE        		ld	hl,(YRAD)
  478A  CD6F24        		call	MULINT2		;8aa*b=8aab (low)
  478D  226CFF        		ld	(DEDY),hl
  4790  ED536EFF      		ld	(DEDY+2),de
  4794  2AAFFE        		ld	hl,(YRAD)
  4797  D1            		pop	de		;8aa (high)
  4798  D5            		push	de
  4799  CD6F24        		call	MULINT2		;8aa*b=8aab (high)
  479C  ED4B6EFF      		ld	bc,(DEDY+2)
  47A0  09            		add	hl,bc
  47A1  226EFF        		ld	(DEDY+2),hl
  47A4  3001          		jr	nc,CRCLNC4
  47A6  13            		inc	de
  47A7                	CRCLNC4:
  47A7  ED5370FF      		ld	(DEDY+4),de
                      	
                      	;err_ini=aa(1-4b)
  47AB  CB3A          		srl	d
  47AD  CB1B          		rr	e
  47AF  ED5376FF      		ld	(ERR+4),de	;4aab
  47B3  2A6EFF        		ld	hl,(DEDY+2)
  47B6  CB1C          		rr	h
  47B8  CB1D          		rr	l
  47BA  2274FF        		ld	(ERR+2),hl
  47BD  2A6CFF        		ld	hl,(DEDY)
  47C0  CB1C          		rr	h
  47C2  CB1D          		rr	l
  47C4  2272FF        		ld	(ERR),hl
                      	
  47C7  C1            		pop	bc		;8aa
  47C8  E1            		pop	hl
  47C9  D1            		pop	de		;aa(high)
  47CA  E3            		ex	(sp),hl		;aa(low)
  47CB  C5            		push	bc
                      	
  47CC  D5            		push	de
  47CD  ED5B72FF      		ld	de,(ERR)
                      	;	or	a
  47D1  ED52          		sbc	hl,de
  47D3  2272FF        		ld	(ERR),hl
  47D6  E1            		pop	hl
  47D7  ED5B74FF      		ld	de,(ERR+2)
  47DB  ED52          		sbc	hl,de
  47DD  2274FF        		ld	(ERR+2),hl
  47E0  210000        		ld	hl,0000h
  47E3  ED5B76FF      		ld	de,(ERR+4)
  47E7  ED52          		sbc	hl,de
  47E9  2276FF        		ld	(ERR+4),hl
                      	
  47EC  210000        		ld	hl,0000h	;x=0
  47EF  22B1FE        		ld	(GRPX3),hl
  47F2  2AAFFE        		ld	hl,(YRAD)	;y=y-radius
  47F5  22B3FE        		ld	(GRPY3),hl
                      	
  47F8                	CRCLLP2:
  47F8  0602          		ld	b,02h
  47FA  CD2249        		call	CRCLPSET
  47FD  2AB1FE        		ld	hl,(GRPX3)
  4800  23            		inc	hl
  4801  22B1FE        		ld	(GRPX3),hl
                      	
                      	;de/dx+=8bb
  4804  D9            		exx
  4805  2A65FF        		ld	hl,(DEDX)
  4808  19            		add	hl,de
  4809  2265FF        		ld	(DEDX),hl
  480C  2A67FF        		ld	hl,(DEDX+2)
  480F  ED4A          		adc	hl,bc
  4811  2267FF        		ld	(DEDX+2),hl
  4814  3007          		jr	nc,CRCLNC5
  4816  2A69FF        		ld	hl,(DEDX+4)
  4819  23            		inc	hl
  481A  2269FF        		ld	(DEDX+4),hl
  481D                	CRCLNC5:
  481D  D9            		exx
                      	
                      	;err+=de/dx
  481E  2A72FF        		ld	hl,(ERR)
  4821  ED5B65FF      		ld	de,(DEDX)
  4825  19            		add	hl,de
  4826  2272FF        		ld	(ERR),hl
  4829  2A74FF        		ld	hl,(ERR+2)
  482C  ED5B67FF      		ld	de,(DEDX+2)
  4830  ED5A          		adc	hl,de
  4832  2274FF        		ld	(ERR+2),hl
  4835  2A76FF        		ld	hl,(ERR+4)
  4838  ED5B69FF      		ld	de,(DEDX+4)
  483C  ED5A          		adc	hl,de
  483E  2276FF        		ld	(ERR+4),hl
                      	
                      	;if err>=0 and y>0 then y=y-1:de/dy-=8aa:err-=de/dy
  4841  7C            		ld	a,h
  4842  07            		rlca
  4843  384E          		jr	c,CRCLC2
  4845  2AB3FE        		ld	hl,(GRPY3)
  4848  2B            		dec	hl
  4849  7C            		ld	a,h
  484A  07            		rlca
  484B  3846          		jr	c,CRCLC2
  484D  22B3FE        		ld	(GRPY3),hl	;y=y-1
                      	
  4850  C1            		pop	bc		;8aa
  4851  D1            		pop	de
                      	
  4852  2A6CFF        		ld	hl,(DEDY)
  4855  B7            		or	a
  4856  ED52          		sbc	hl,de
  4858  226CFF        		ld	(DEDY),hl
  485B  2A6EFF        		ld	hl,(DEDY+2)
  485E  ED42          		sbc	hl,bc
  4860  226EFF        		ld	(DEDY+2),hl
  4863  3007          		jr	nc,CRCLNC6
  4865  2A70FF        		ld	hl,(DEDY+4),hl
  4868  2B            		dec	hl
  4869  2270FF        		ld	(DEDY+4),hl
  486C                	CRCLNC6:
  486C  D5            		push	de		;8aa
  486D  C5            		push	bc
                      	
  486E  2A72FF        		ld	hl,(ERR)
  4871  ED5B6CFF      		ld	de,(DEDY)
  4875  B7            		or	a
  4876  ED52          		sbc	hl,de
  4878  2272FF        		ld	(ERR),hl
  487B  2A74FF        		ld	hl,(ERR+2)
  487E  ED5B6EFF      		ld	de,(DEDY+2)
  4882  ED52          		sbc	hl,de
  4884  2274FF        		ld	(ERR+2),hl
  4887  2A76FF        		ld	hl,(ERR+4)
  488A  ED5B70FF      		ld	de,(DEDY+4)
  488E  ED52          		sbc	hl,de
  4890  2276FF        		ld	(ERR+4),hl
                      	
  4893                	CRCLC2:
                      	;if de/dx<de/dy or (de/dy=0 and x<a) then loop
  4893  2A65FF        		ld	hl,(DEDX)
  4896  ED5B6CFF      		ld	de,(DEDY)
  489A  B7            		or	a
  489B  ED52          		sbc	hl,de
  489D  2A67FF        		ld	hl,(DEDX+2)
  48A0  ED5B6EFF      		ld	de,(DEDY+2)
  48A4  ED52          		sbc	hl,de
  48A6  2A69FF        		ld	hl,(DEDX+4)
  48A9  ED5B70FF      		ld	de,(DEDY+4)
  48AD  ED52          		sbc	hl,de
  48AF  CB7C          		bit	7,h
  48B1  C2F847        		jp	nz,CRCLLP2
                      	
  48B4  7A            		ld	a,d
  48B5  B3            		or	e
  48B6  2A6CFF        		ld	hl,(DEDY)
  48B9  B4            		or	h
  48BA  B5            		or	l
  48BB  2A6EFF        		ld	hl,(DEDY+2)
  48BE  B4            		or	h
  48BF  B5            		or	l
  48C0  200C          		jr	nz,CRCLNZ2
  48C2  2AB1FE        		ld	hl,(GRPX3)
  48C5  ED5BADFE      		ld	de,(XRAD)
                      	;	or	a
  48C9  ED52          		sbc	hl,de
  48CB  DAF847        		jp	c,CRCLLP2
                      	
                      	
  48CE                	CRCLNZ2:
  48CE  C1            		pop	bc		;8aa
  48CF  D1            		pop	de
                      	
                      	
  48D0  2A78FF        		ld	hl,(STARTX)
  48D3  ED4BAEFD      		ld	bc,(GRPX1)	;xcenter
  48D7  09            		add	hl,bc
  48D8  22ADFE        		ld	(GRPX2),hl
  48DB  2AB0FD        		ld	hl,(GRPY1)	;ycenter
  48DE  ED5B7AFF      		ld	de,(STARTY)
  48E2  B7            		or	a
  48E3  ED52          		sbc	hl,de
  48E5  22AFFE        		ld	(GRPY2),hl
  48E8  19            		add	hl,de
  48E9  EB            		ex	de,hl
                      	
  48EA  F1            		pop	af		;sign of start angle
  48EB  07            		rlca
  48EC  3808          		jr	c,CRCLC3
  48EE  ED4BADFE      		ld	bc,(GRPX2)
  48F2  ED5BAFFE      		ld	de,(GRPY2)
  48F6                	CRCLC3:
  48F6  CD1F2E        		call	LINE
                      	
  48F9  2A7CFF        		ld	hl,(ENDX)
  48FC  ED4BAEFD      		ld	bc,(GRPX1)	;xcenter
  4900  09            		add	hl,bc
  4901  22ADFE        		ld	(GRPX2),hl
  4904  2AB0FD        		ld	hl,(GRPY1)	;ycenter
  4907  ED5B7EFF      		ld	de,(ENDY)
  490B  B7            		or	a
  490C  ED52          		sbc	hl,de
  490E  22AFFE        		ld	(GRPY2),hl
  4911  19            		add	hl,de
  4912  EB            		ex	de,hl
                      	
  4913  F1            		pop	af		;sign of end angle
  4914  07            		rlca
  4915  3808          		jr	c,CRCLC4
  4917  ED4BADFE      		ld	bc,(GRPX2)
  491B  ED5BAFFE      		ld	de,(GRPY2)
                      	
  491F                	CRCLC4:
  491F  C31F2E        		jp	LINE
                      	
                      	
                      	;input: b(1:condition=y, 2:condition=x)
                      	;destroy: af,bc,de,hl,af'
  4922                	CRCLPSET:
  4922  CD4D27        		call	STOPESC
                      	
  4925  2A7AFF        		ld	hl,(STARTY)
  4928  ED5BB3FE      		ld	de,(GRPY3)
  492C  E5            		push	hl
  492D  D5            		push	de
  492E  2A78FF        		ld	hl,(STARTX)
  4931  ED5BB1FE      		ld	de,(GRPX3)
                      	
  4935  3A81FF        		ld	a,(CRCLFLG)
  4938  E603          		and	03h		;bit10=start quad.(3,2,1.0)
  493A  2828          		jr	z,STARTQ4
  493C  EA7549        		jp	pe,STARTQ1
  493F  0F            		rrca
  4940  3812          		jr	c,STARTQ3
                      	
  4942                	STARTQ2:
  4942  100A          		djnz	STARTQ2X
  4944  D1            		pop	de
  4945  E1            		pop	hl
  4946  B7            		or	a
  4947  ED52          		sbc	hl,de
  4949  CB04          		rlc	h
  494B  3F            		ccf			;y<=STARTY?
  494C  1839          		jr	STARTQEND
  494E                	STARTQ2X:
  494E  19            		add	hl,de
  494F  CB04          		rlc	h
  4951  3F            		ccf			;-x<=STARTX?
  4952  1831          		jr	STARTQ1XEND
                      	
  4954                	STARTQ3:
  4954  1008          		djnz	STARTQ3X
  4956  D1            		pop	de
  4957  E1            		pop	hl
  4958  19            		add	hl,de
  4959  CB04          		rlc	h
  495B  3F            		ccf			;-y<=STARTY?
  495C  1829          		jr	STARTQEND
  495E                	STARTQ3X:
  495E  2B            		dec	hl
  495F  19            		add	hl,de
  4960  CB04          		rlc	h		;-x>=STARTX?
  4962  1821          		jr	STARTQ1XEND
                      	
  4964                	STARTQ4:
  4964  1008          		djnz	STARTQ4X
  4966  D1            		pop	de
  4967  E1            		pop	hl
  4968  2B            		dec	hl
  4969  19            		add	hl,de
  496A  CB04          		rlc	h		;-y>=STARTY?
  496C  1819          		jr	STARTQEND
  496E                	STARTQ4X:
  496E  37            		scf
  496F  ED52          		sbc	hl,de
  4971  CB04          		rlc	h		;x>=STARTX?
  4973  1810          		jr	STARTQ1XEND
                      	
                      	;1st quad.
  4975                	STARTQ1:
  4975  1009          		djnz	STARTQ1X
  4977  D1            		pop	de
  4978  E1            		pop	hl
  4979  37            		scf
  497A  ED52          		sbc	hl,de
  497C  CB04          		rlc	h		;y>=STARTY?
  497E  1807          		jr	STARTQEND
  4980                	STARTQ1X:
                      	;	or	a
  4980  ED52          		sbc	hl,de
  4982  CB04          		rlc	h
  4984  3F            		ccf			;x<=STARTX?
                      	
  4985                	STARTQ1XEND:
  4985  D1            		pop	de
  4986  E1            		pop	hl
                      	
  4987                	STARTQEND:
  4987  CB11          		rl	c		;start ok?
                      	
  4989  2A7CFF        		ld	hl,(ENDX)
  498C  ED5BB1FE      		ld	de,(GRPX3)
  4990  E5            		push	hl
  4991  D5            		push	de
  4992  2A7EFF        		ld	hl,(ENDY)
  4995  ED5BB3FE      		ld	de,(GRPY3)
                      	
  4999  3A81FF        		ld	a,(CRCLFLG)
  499C  E60C          		and	0ch		;bit32=start quad.(3,2,1.0)
  499E  2828          		jr	z,ENDQ4
  49A0  EAD949        		jp	pe,ENDQ1
  49A3  E604          		and	04h
  49A5  2011          		jr	nz,ENDQ3
                      	
  49A7                	ENDQ2:
  49A7  1008          		djnz	ENDQ2Y
  49A9  D1            		pop	de
  49AA  E1            		pop	hl
  49AB  2B            		dec	hl
  49AC  19            		add	hl,de
  49AD  CB04          		rlc	h		;-x>=ENDX?
  49AF  183B          		jr	ENDQEND
  49B1                	ENDQ2Y:
  49B1  37            		scf
  49B2  ED52          		sbc	hl,de
  49B4  CB04          		rlc	h		;y>=ENDY?
  49B6  1832          		jr	ENDQ1YEND
                      	
  49B8                	ENDQ3:
  49B8  1008          		djnz	ENDQ3Y
  49BA  D1            		pop	de
  49BB  E1            		pop	hl
  49BC  19            		add	hl,de
  49BD  CB04          		rlc	h
  49BF  3F            		ccf			;-x<=ENDX?
  49C0  182A          		jr	ENDQEND
  49C2                	ENDQ3Y:
  49C2  2B            		dec	hl
  49C3  19            		add	hl,de
  49C4  CB04          		rlc	h		;-y>=ENDY?
  49C6  1822          		jr	ENDQ1YEND
                      	
  49C8                	ENDQ4:
  49C8  1009          		djnz	ENDQ4Y
  49CA  D1            		pop	de
  49CB  E1            		pop	hl
                      	;	or	a
  49CC  ED52          		sbc	hl,de
  49CE  CB14          		rl	h
  49D0  3F            		ccf			;x<=ENDX?
  49D1  1819          		jr	ENDQEND
  49D3                	ENDQ4Y:
  49D3  19            		add	hl,de
  49D4  CB04          		rlc	h
  49D6  3F            		ccf			;-y<=ENDY?
  49D7  1811          		jr	ENDQ1YEND
                      	
  49D9                	ENDQ1:
  49D9  1009          		djnz	ENDQ1Y
  49DB  D1            		pop	de
  49DC  E1            		pop	hl
  49DD  37            		scf
  49DE  ED52          		sbc	hl,de
  49E0  CB04          		rlc	h		;x>=ENDX?
  49E2  1808          		jr	ENDQEND
  49E4                	ENDQ1Y:
  49E4  B7            		or	a
  49E5  ED52          		sbc	hl,de
  49E7  CB04          		rlc	h
  49E9  3F            		ccf			;y<=ENDY?
  49EA                	ENDQ1YEND:
  49EA  D1            		pop	de
  49EB  E1            		pop	hl
  49EC                	ENDQEND:
  49EC  CB11          		rl	c		;bit1=start ok, bit0=end ok
                      	
  49EE  3A81FF        		ld	a,(CRCLFLG)	;bit4=start<=end?, bit32=end quad., bit10=start quad.
  49F1  47            		ld	b,a
  49F2  0F            		rrca
  49F3  0F            		rrca
  49F4  90            		sub	b
  49F5  E603          		and	03h		;end quadrant-start quadrant
  49F7  87            		add	a,a
  49F8  87            		add	a,a
  49F9  2004          		jr	nz,CRCLPNZ
  49FB  A8            		xor	b
  49FC  E6EF          		and	0efh		;copy b-bit4
  49FE  A8            		xor	b
  49FF                	CRCLPNZ:
  49FF  A9            		xor	c
  4A00  E6FC          		and	0fch		;copy c-bit1,0
  4A02  A9            		xor	c
  4A03  5F            		ld	e,a
  4A04  1600          		ld	d,00h
  4A06  215E45        		ld	hl,CRCLFDATA
  4A09  19            		add	hl,de
                      	
  4A0A  78            		ld	a,b		;(CRCLFLG)
  4A0B  E603          		and	03h		;start quad.
  4A0D  47            		ld	b,a
  4A0E  7E            		ld	a,(hl)
  4A0F  04            		inc	b
  4A10                	CRCLPLP:
  4A10  07            		rlca
  4A11  10FD          		djnz	CRCLPLP
  4A13  08            		ex	af,af'
                      	
  4A14  2AAEFD        		ld	hl,(GRPX1)	;xcenter
  4A17  ED5BB1FE      		ld	de,(GRPX3)	;x
  4A1B  B7            		or	a
  4A1C  ED52          		sbc	hl,de
  4A1E  E5            		push	hl		;xcenter-x
  4A1F  19            		add	hl,de
  4A20  19            		add	hl,de
  4A21  44            		ld	b,h
  4A22  4D            		ld	c,l
                      	
  4A23  2AB0FD        		ld	hl,(GRPY1)	;ycenter
  4A26  ED5BB3FE      		ld	de,(GRPY3)	;y
  4A2A  B7            		or	a
  4A2B  ED52          		sbc	hl,de
  4A2D  E5            		push	hl		;ycenter-y
  4A2E  19            		add	hl,de
  4A2F  19            		add	hl,de
  4A30  EB            		ex	de,hl
                      	
  4A31  D5            		push	de		;ycenter+y
  4A32  C5            		push	bc		;xcenter+x
                      	
  4A33  08            		ex	af,af'
  4A34  67            		ld	h,a
  4A35  08            		ex	af,af'
  4A36  CB64          		bit	4,h
                      	
  4A38  C4472D        		call	nz,PSET		;4th quadrant (xcenter+x,ycenter+y)
                      	
  4A3B  C1            		pop	bc
  4A3C  E1            		pop	hl
  4A3D  D1            		pop	de
  4A3E  E5            		push	hl
  4A3F  D5            		push	de
                      	
  4A40  08            		ex	af,af'
  4A41  67            		ld	h,a
  4A42  08            		ex	af,af'
  4A43  CB7C          		bit	7,h
                      	
  4A45  C4472D        		call	nz,PSET		;1st quadrant (xcenter+x,ycenter-y)
  4A48  D1            		pop	de
  4A49  E1            		pop	hl
  4A4A  C1            		pop	bc
  4A4B  E5            		push	hl
  4A4C  C5            		push	bc
                      	
  4A4D  08            		ex	af,af'
  4A4E  67            		ld	h,a
  4A4F  08            		ex	af,af'
  4A50  CB74          		bit	6,h
                      	
  4A52  C4472D        		call	nz,PSET		;2nd quadrant (xcenter-x,ycenter-y)
  4A55  C1            		pop	bc
  4A56  D1            		pop	de
                      	
  4A57  08            		ex	af,af'
  4A58  67            		ld	h,a
  4A59  08            		ex	af,af'
  4A5A  CB6C          		bit	5,h
                      	
  4A5C  C8            		ret	z
  4A5D  C3472D        		jp	PSET		;3rd quadrant (xcenter-x,ycenter+y)
                      	
                      	
  4A60                	_C_CRCL:ds	C_CRCL-_C_CRCL
  4A72                		org	C_CRCL
                      	
  4A72  3A93FD        		ld	a,(COLOR1)
  4A75  CDC015        		call	SETATT
  4A78  CDEA2C        		call	GETGXY
  4A7B  C2E403        		jp	nz,SNERR
  4A7E  23            		inc	hl
  4A7F  CD1A0E        		call	INT2ARG		;radius
  4A82  7A            		ld	a,d
  4A83  07            		rlca
  4A84  DAED03        		jp	c,FCERR
  4A87  ED53ADFE      		ld	(XRAD),de
                      	
  4A8B  21D700        		ld	hl,00d7h	;default aspect ratio=215/256
  4A8E  22E6FF        		ld	(ASPECT),hl
  4A91  CD070C        		call	SETZERO		;default start angle=0
  4A94  CD1F39        		call	PUSHF1
  4A97  21153E        		ld	hl,PI2		;default end angle=2pi
  4A9A  CD0A0C        		call	SETF1
  4A9D  CD1F39        		call	PUSHF1
                      	
  4AA0  2A4EFF        		ld	hl,(PROGAD)
  4AA3  CD7C3F        		call	CHKCLCM
  4AA6  CA7245        		jp	z,CRCLMAIN
  4AA9  CD6C3F        		call	CHKCMM
  4AAC  280C          		jr	z,CRCLPAR3
  4AAE  CDE40D        		call	INT1ARG		;color
  4AB1  CDC015        		call	SETATT
                      	
  4AB4  CD7C3F        		call	CHKCLCM
  4AB7  CA7245        		jp	z,CRCLMAIN
                      	
  4ABA                	CRCLPAR3:
  4ABA  CD6C3F        		call	CHKCMM
  4ABD  2826          		jr	z,CRCLPAR4
  4ABF  CD750B        		call	NUMARG		;start angle
                      	
  4AC2  CD4C39        		call	POPF2		;default end angle
  4AC5  F1            		pop	af		;cancel default start angle
  4AC6  F1            		pop	af
  4AC7  F1            		pop	af
  4AC8  CD1F39        		call	PUSHF1		;new start angle
  4ACB  CD2E39        		call	PUSHF2		;default end angle
                      	
  4ACE  2169FF        		ld	hl,FAC1+3
  4AD1  CBBE          		res	7,(hl)
  4AD3  21153E        		ld	hl,PI2
  4AD6  CD1A3F        		call	SETCMPF
  4AD9  D2ED03        		jp	nc,FCERR	;if angle>=|2pi| error
                      	
  4ADC  2A4EFF        		ld	hl,(PROGAD)
  4ADF  CD7C3F        		call	CHKCLCM
  4AE2  CA7245        		jp	z,CRCLMAIN
                      	
  4AE5                	CRCLPAR4:
  4AE5  CD6C3F        		call	CHKCMM
  4AE8  2817          		jr	z,CRCLPAR5
  4AEA  CD750B        		call	NUMARG		;end angle
  4AED  CD4C39        		call	POPF2		;default end angle
  4AF0  CD1F39        		call	PUSHF1		;new end angle
                      	
  4AF3  2169FF        		ld	hl,FAC1+3
  4AF6  CBBE          		res	7,(hl)
                      	
  4AF8  2A4EFF        		ld	hl,(PROGAD)
  4AFB  CD7C3F        		call	CHKCLCM
  4AFE  CA7245        		jp	z,CRCLMAIN
                      	
  4B01                	CRCLPAR5:
  4B01  CD750B        		call	NUMARG		;aspect ratio
  4B04  2A69FF        		ld	hl,(FAC1+3)
  4B07  7D            		ld	a,l		;(FAC1+3)
  4B08  07            		rlca
  4B09  7C            		ld	a,h		;(FAC1+4)
  4B0A  3016          		jr	nc,ASPPOS
                      	
                      	;aspect ratio < 0
  4B0C                	ASPNEG:
  4B0C  FE89          		cp	89h
  4B0E  D2ED03        		jp	nc,FCERR	;aspect ratio <= -256
  4B11  CD5B39        		call	CPYFAC
  4B14  CDE20C        		call	GETINT
  4B17  CD8836        		call	SUBF
  4B1A  CD260D        		call	NEGABS
  4B1D  CD7D36        		call	INCF1
  4B20  1842          		jr	ASPSMALL
                      	
                      	;aspect ratio >= 0
  4B22                	ASPPOS:
  4B22  FE81          		cp	81h
  4B24  383E          		jr	c,ASPSMALL
                      	
                      	;aspect ratio >= 1
  4B26                	ASPLARGE:
  4B26  CD5B39        		call	CPYFAC
  4B29  2AADFE        		ld	hl,(XRAD)
  4B2C  22AFFE        		ld	(YRAD),hl
  4B2F  CD5C0C        		call	I2TOF
  4B32  CD1F39        		call	PUSHF1		;y-radius(=r)
  4B35  CD5E38        		call	DIVF		;r/asp
  4B38  CDB10C        		call	FTOI
  4B3B  EB            		ex	de,hl
  4B3C  22ADFE        		ld	(XRAD),hl	;xrad=r/asp
  4B3F  CD5C0C        		call	I2TOF
  4B42  CD4C39        		call	POPF2		;y-radius
  4B45  CD5E38        		call	DIVF		;1/asp
  4B48  CD4E4B        		call	SETASP		;replace aspect ratio by 256/asp
  4B4B  C38245        		jp	CRCLMAIN2
                      	
                      	;set aspect ratio
                      	;input: FAC1=aspect ratio
                      	;output: de=aspect ratio*256 (round)
  4B4E                	SETASP:
  4B4E  216AFF        		ld	hl,FAC1+4
  4B51  7E            		ld	a,(hl)
  4B52  C609          		add	a,09h
  4B54  77            		ld	(hl),a		;*512
  4B55  CDB10C        		call	FTOI
  4B58  CB3A          		srl	d		;/2
  4B5A  CB1B          		rr	e
  4B5C  3001          		jr	nc,SETASPNC
  4B5E  13            		inc	de
  4B5F                	SETASPNC:
  4B5F  ED53E6FF      		ld	(ASPECT),de
  4B63  C9            		ret
                      	
                      	
                      	;0 <= aspect ratio < 1
  4B64                	ASPSMALL:
  4B64  CD4E4B        		call	SETASP
  4B67  C37245        		jp	CRCLMAIN
                      	
                      	
                      	;input: FAC1=angle
                      	;output: hl=x=r*cos (signed), de=y=r*sin (signed), b=quadrant(3,2,1,0)
                      	;destroy: af,c,af',bc',de',hl'
  4B6A                	ANGL2XY:
  4B6A  2AADFE        		ld	hl,(XRAD)
  4B6D  ED5BAFFE      		ld	de,(YRAD)
  4B71  B7            		or	a
  4B72  ED52          		sbc	hl,de
  4B74  F5            		push	af		;YRAD>XRAD?
  4B75  3802          		jr	c,ANGL2XYC1
  4B77  19            		add	hl,de
  4B78  EB            		ex	de,hl
  4B79                	ANGL2XYC1:
  4B79  D5            		push	de		;radius
  4B7A  CDA84B        		call	CORDIC		;hl=cos, de=sin
  4B7D  E3            		ex	(sp),hl		;push cos, pop radius
  4B7E  F1            		pop	af		;cos
  4B7F  C5            		push	bc		;b=quadrant(4,3,2,1)
  4B80  F5            		push	af		;cos
                      	
  4B81  E5            		push	hl		;radius
  4B82  CD774C        		call	MULRCS		;de=r*sin
  4B85  E1            		pop	hl		;radius
  4B86  EB            		ex	de,hl
  4B87  E3            		ex	(sp),hl		;push r*sin, pop cos
  4B88  CD774C        		call	MULRCS		;de=r*cos
  4B8B  E1            		pop	hl		;r*sin
                      	
  4B8C  C1            		pop	bc		;b=quadrant(4,3,2,1)
  4B8D  F1            		pop	af		;YRAD>XRAD?
  4B8E  C5            		push	bc		;b=quadrant(4,3,2,1)
  4B8F  380C          		jr	c,ANGL2XYC2
                      	
                      	;aspect ratio<=1
  4B91  D5            		push	de		;r*cos
  4B92  ED5BE6FF      		ld	de,(ASPECT)
  4B96  CD894C        		call	MULINT2SR	;hl=r*sin*aspect ratio
  4B99  EB            		ex	de,hl		;de=r*sin*aspect ratio
  4B9A  E1            		pop	hl		;r*cos
  4B9B  1808          		jr	ANGL2XYEND
                      	
                      	;aspect ratio>1
  4B9D                	ANGL2XYC2:
  4B9D  E5            		push	hl		;r*sin
  4B9E  2AE6FF        		ld	hl,(ASPECT)
  4BA1  CD894C        		call	MULINT2SR	;hl=r*cos*(1/aspect ratio)
  4BA4  D1            		pop	de		;r*sin
                      	
  4BA5                	ANGL2XYEND:
  4BA5  C1            		pop	bc		;b=quadrant(4,3,2,1)
  4BA6  05            		dec	b		;3,2,1,0
  4BA7  C9            		ret
                      	
                      	
                      	;CORDIC correction factor
                      	;9949/16384=0.6073=cos(atan(1))*cos(atan(1/2))*cos(atan(1/4))*...
  26DD                	CORR	equ	9949
                      	
                      	;CORDIC algorithm
                      	;input: FAC1=angle
                      	;output: hl=cos, de=sin (2bit.14bit), b=quardrant(4,3,2,1)
                      	;destroy: af,c,af',bc',de',hl'
  4BA8                	CORDIC:
  4BA8  CD1939        		call	ABS
  4BAB  0604          		ld	b,04h
  4BAD                	CRDCLP1:
  4BAD  D9            		exx
  4BAE  21833D        		ld	hl,PIDIV2
  4BB1  CD1A3F        		call	SETCMPF
  4BB4  3816          		jr	c,CRDCC1
  4BB6  CD8836        		call	SUBF
  4BB9  D9            		exx
  4BBA  10F1          		djnz	CRDCLP1
                      	
  4BBC  3A6AFF        		ld	a,(FAC1+4)
  4BBF  FE66          		cp	66h
  4BC1  D2ED03        		jp	nc,FCERR
  4BC4  04            		inc	b		;4th quadrant
  4BC5  D9            		exx
  4BC6  21833D        		ld	hl,PIDIV2
  4BC9  CD0A0C        		call	SETF1
                      	
  4BCC                	CRDCC1:
  4BCC  D9            		exx
  4BCD  21DD26        		ld	hl,CORR		;initial cos (2bit.14bit)
  4BD0  54            		ld	d,h		;initial sin (2bit.14bit)
  4BD1  5D            		ld	e,l
                      	
  4BD2  C5            		push	bc		;b=quadrant(4,3,2,1)
  4BD3  78            		ld	a,b
  4BD4  FE03          		cp	03h
  4BD6  2808          		jr	z,QUAD2		;2nd quadrant
  4BD8  3009          		jr	nc,QUAD1	;1st quadrant
  4BDA  1123D9        		ld	de,0-CORR
  4BDD  3D            		dec	a
  4BDE  2803          		jr	z,QUAD4		;4th quadrant
                      	;	jr	nz,QUAD3	;3rd quadrant
                      	
  4BE0                	QUAD3:
  4BE0                	QUAD2:
  4BE0  2123D9        		ld	hl,0-CORR
  4BE3                	QUAD4:
  4BE3                	QUAD1:
  4BE3  D9            		exx
                      	
                      	
  4BE4  216AFF        		ld	hl,FAC1+4
  4BE7  7E            		ld	a,(hl)
  4BE8  B7            		or	a
  4BE9  2803          		jr	z,CRDCZ1
  4BEB  C60F          		add	a,0fh		;*32768
  4BED  77            		ld	(hl),a
                      	
  4BEE                	CRDCZ1:
  4BEE  CDB10C        		call	FTOI
  4BF1  21574C        		ld	hl,ATAN
  4BF4  D9            		exx
                      	
  4BF5  AF            		xor	a
  4BF6  08            		ex	af,af'		;sign of residual angle
                      	
  4BF7  010010        		ld	bc,1000h
  4BFA                	CRDCLP2:
                      	
                      	;residual angle (1bit.15bit)
  4BFA  D9            		exx
  4BFB  4E            		ld	c,(hl)
  4BFC  23            		inc	hl
  4BFD  46            		ld	b,(hl)
  4BFE  23            		inc	hl
  4BFF  EB            		ex	de,hl
  4C00  08            		ex	af,af'		;sign of residual angle
  4C01  2004          		jr	nz,CRDCNZ
  4C03  B7            		or	a
  4C04  ED42          		sbc	hl,bc
  4C06  3E            		db	3eh		;ld a,
  4C07                	CRDCNZ:
  4C07  09            		add	hl,bc
  4C08  CB7C          		bit	7,h
  4C0A  08            		ex	af,af'		;sign of residual angle
  4C0B  EB            		ex	de,hl
  4C0C  D9            		exx
                      	
  4C0D  0C            		inc	c
  4C0E  C5            		push	bc
  4C0F  D5            		push	de		;sin
  4C10  E5            		push	hl		;cos
  4C11  41            		ld	b,c
  4C12                	CRDCLP3:
  4C12  CB2C          		sra	h
  4C14  CB1D          		rr	l
  4C16  1F            		rra
  4C17  CB2A          		sra	d
  4C19  CB1B          		rr	e
  4C1B  10F5          		djnz	CRDCLP3
                      	
  4C1D  3001          		jr	nc,CRDCNC1
  4C1F  13            		inc	de
  4C20                	CRDCNC1:
  4C20  07            		rlca
  4C21  3001          		jr	nc,CRDCNC2
  4C23  23            		inc	hl
  4C24                	CRDCNC2:
                      	
  4C24  E3            		ex	(sp),hl
  4C25  08            		ex	af,af'		;sign of residual angle
  4C26  280A          		jr	z,CRDCZ2
                      	
                      	;residual<0
  4C28  08            		ex	af,af'		;sign of residual angle
  4C29  19            		add	hl,de		;cos=cos+(sin>>c)
  4C2A  EB            		ex	de,hl
  4C2B  C1            		pop	bc		;cos>>c
  4C2C  E1            		pop	hl		;sin
  4C2D  B7            		or	a
  4C2E  ED42          		sbc	hl,bc		;sin=sin-(cos>>c)
  4C30  1808          		jr	CRDCLP2END
                      	
  4C32                	CRDCZ2:
                      	;residual>0
  4C32  08            		ex	af,af'		;sign of residual angle
  4C33  B7            		or	a
  4C34  ED52          		sbc	hl,de		;cos=cos-(sin>>c)
  4C36  EB            		ex	de,hl
  4C37  C1            		pop	bc		;cos>>c
  4C38  E1            		pop	hl		;sin
  4C39  09            		add	hl,bc		;sin=sin+(cos>>c)
                      	
  4C3A                	CRDCLP2END:
  4C3A  EB            		ex	de,hl
  4C3B  C1            		pop	bc
  4C3C  10BC          		djnz	CRDCLP2
                      	
                      	;round hl
  4C3E  7D            		ld	a,l
  4C3F  FE03          		cp	03h
  4C41  3805          		jr	c,CRDCC2
  4C43  FEFE          		cp	0feh
  4C45  3803          		jr	c,CRDCC3
  4C47  24            		inc	h
  4C48                	CRDCC2:
  4C48  2E00          		ld	l,00h
  4C4A                	CRDCC3:
                      	
  4C4A  C1            		pop	bc		;b=quadrant(4,3,2,1)
                      	;round de
  4C4B  7B            		ld	a,e
  4C4C  FE03          		cp	03h
  4C4E  3804          		jr	c,CRDCC4
  4C50  FEFE          		cp	0feh
  4C52  D8            		ret	c
  4C53  14            		inc	d
  4C54                	CRDCC4:
  4C54  1E00          		ld	e,00h
  4C56  C9            		ret
                      	
                      	
  4C57                	ATAN:
  4C57  8864          		dw	25736	;atan(1)*32768
  4C59  593B          		dw	15193	;atan(1/2)*32768
  4C5B  5B1F          		dw	8027	;atan(1/4)*32768
  4C5D  EB0F          		dw	4075	;atan(1/8)*32768
  4C5F  FD07          		dw	2045	;atan(1/16)*32768
  4C61  0004          		dw	1024	;atan(1/32)*32768
  4C63  0002          		dw	512	;atan(1/64)*32768
  4C65  0001          		dw	256	;atan(1/128)*32768
  4C67  8000          		dw	128	;atan(1/256)*32768
  4C69  4000          		dw	64	;atan(1/512)*32768
  4C6B  2000          		dw	32	;atan(1/1024)*32768
  4C6D  1000          		dw	16	;atan(1/2048)*32768
  4C6F  0800          		dw	8	;atan(1/4096)*32768
  4C71  0400          		dw	4	;atan(1/8192)*32768
  4C73  0200          		dw	2	;atan(1/16384)*32768
  4C75  0100          		dw	1	;atan(1/32768)*32768
                      	
                      	
                      	;radius * (cos or sin)
                      	;de=(de*hl)>>18 (round)
                      	;input: de,hl
                      	;output: de
                      	;destroy: af,bc,hl
  4C77                	MULRCS:
  4C77  CD934C        		call	MULINT2S	;dehl=radius*(cos or sin)
  4C7A  29            		add	hl,hl
  4C7B  CB13          		rl	e
  4C7D  CB12          		rl	d
  4C7F  29            		add	hl,hl
  4C80  CB13          		rl	e
  4C82  CB12          		rl	d
                      	
  4C84  CB04          		rlc	h
  4C86  D0            		ret	nc
  4C87  13            		inc	de
  4C88  C9            		ret
                      	
                      	
                      	;hl=(de*hl)>>8 (signed, round)
                      	;input: de,hl
                      	;output: hl
                      	;destroy: af,bc,de
  4C89                	MULINT2SR:
  4C89  CD934C        		call	MULINT2S
                      	
                      	;hl=(dehl)>>8 (round)
  4C8C                	ROUNDI2:
  4C8C  CB05          		rlc	l
  4C8E  6C            		ld	l,h
  4C8F  63            		ld	h,e
  4C90  D0            		ret	nc
  4C91  23            		inc	hl
  4C92  C9            		ret
                      	
                      	
                      	;dehl=de*hl (signed)
                      	;input: de,hl
                      	;output: dehl
                      	;destroy: af,bc
  4C93                	MULINT2S:
  4C93  E5            		push	hl
  4C94  D5            		push	de
  4C95  CD6F24        		call	MULINT2
  4C98  C1            		pop	bc
  4C99  E3            		ex	(sp),hl
  4C9A  EB            		ex	de,hl
  4C9B  CB78          		bit	7,b
  4C9D  2803          		jr	z,MULI2SNC1
  4C9F  B7            		or	a
  4CA0  ED52          		sbc	hl,de
  4CA2                	MULI2SNC1:
  4CA2  CB7A          		bit	7,d
  4CA4  2803          		jr	z,MULI2SNC2
  4CA6  B7            		or	a
  4CA7  ED42          		sbc	hl,bc
  4CA9                	MULI2SNC2:
  4CA9  EB            		ex	de,hl
  4CAA  E1            		pop	hl
  4CAB  C9            		ret
                      	
                      	
                      	;GET command
  4CAC                	C_GET:
  4CAC  CD5A3F        		call	SKIPSP
  4CAF  FE40          		cp	'@'
  4CB1  2801          		jr	z,GETAT
                      	
                      	;FDD command
                      	;not implemented
                      	
  4CB3  C9            		ret
                      	
                      	
                      	;GET@ command
  4CB4                	GETAT:
  4CB4  23            		inc	hl
  4CB5  CDEA2C        		call	GETGXY
  4CB8  FECB          		cp	MINUS
  4CBA  C2E403        		jp	nz,SNERR
  4CBD  C5            		push	bc
  4CBE  D5            		push	de
  4CBF  23            		inc	hl
  4CC0  CDEA2C        		call	GETGXY
  4CC3  C2E403        		jp	nz,SNERR
  4CC6  D1            		pop	de
  4CC7  C1            		pop	bc
  4CC8  E5            		push	hl
  4CC9  CD6C2B        		call	SORTXY
  4CCC  E1            		pop	hl
  4CCD  23            		inc	hl
  4CCE  CD8433        		call	CHKVAR
  4CD1  224EFF        		ld	(PROGAD),hl
  4CD4  CD2F34        		call	SRCHARR
  4CD7  DAED03        		jp	c,FCERR
  4CDA  CB79          		bit	7,c
  4CDC  C2AF4D        		jp	nz,GETATFILE
                      	
  4CDF  CDB24D        		call	GETARR0
  4CE2  0B            		dec	bc
  4CE3  0B            		dec	bc
  4CE4  0B            		dec	bc
  4CE5  0B            		dec	bc
  4CE6  C5            		push	bc		;array data size
                      	
  4CE7  EB            		ex	de,hl		;
  4CE8  2AADFE        		ld	hl,(GRPX2)
  4CEB  ED4BB1FE      		ld	bc,(GRPX3)
  4CEF  ED4350FF      		ld	(TMP),bc	;smaller x
                      	
  4CF3  3A92FD        		ld	a,(SCREEN1)
  4CF6  B7            		or	a
  4CF7  CAED03        		jp	z,FCERR		;screen mode 1
                      	;	or	a
  4CFA  ED42          		sbc	hl,bc
  4CFC  FE02          		cp	02h
  4CFE  2F            		cpl
  4CFF  CE05          		adc	a,05h		;1,2,3->4,2,1
  4D01  47            		ld	b,a		;x dot size
                      	
  4D02  85            		add	a,l
  4D03  6F            		ld	l,a
  4D04  3001          		jr	nc,GETATNC1
  4D06  24            		inc	h
  4D07                	GETATNC1:
                      	
  4D07  CD9539        		call	CHKMOD
  4D0A  78            		ld	a,b		;x dot size
  4D0B  2005          		jr	nz,GETATNZ1
                      	;mode5
  4D0D  FE04          		cp	04h
  4D0F  3001          		jr	nc,GETATNZ1
  4D11  87            		add	a,a		;2,1->4,2
                      	
  4D12                	GETATNZ1:
  4D12  F5            		push	af		;x bit size
                      	
  4D13  EB            		ex	de,hl		;
  4D14  23            		inc	hl
  4D15  73            		ld	(hl),e
  4D16  23            		inc	hl
  4D17  72            		ld	(hl),d
  4D18  23            		inc	hl
                      	
  4D19  EB            		ex	de,hl		;
  4D1A  2AAFFE        		ld	hl,(GRPY2)
  4D1D  ED4BB3FE      		ld	bc,(GRPY3)
  4D21  B7            		or	a
  4D22  ED42          		sbc	hl,bc
  4D24  EB            		ex	de,hl		;
                      	
  4D25  3A92FD        		ld	a,(SCREEN1)
  4D28  3D            		dec	a
  4D29  2014          		jr	nz,GETATNZ2
  4D2B  CD9539        		call	CHKMOD
  4D2E  280A          		jr	z,GETATZ2
                      	
                      	;60 screen mode 2
  4D30  CB3A          		srl	d
  4D32  CB1B          		rr	e
  4D34  CB3A          		srl	d
  4D36  CB1B          		rr	e
  4D38  1805          		jr	GETATNZ2
                      	
                      	;66 screen mode 2
  4D3A                	GETATZ2:
  4D3A  E5            		push	hl
  4D3B  CDA46C        		call	DIV5
  4D3E  E1            		pop	hl
                      	
                      	;y size
  4D3F                	GETATNZ2:
  4D3F  13            		inc	de
  4D40  73            		ld	(hl),e
  4D41  23            		inc	hl
  4D42  72            		ld	(hl),d
                      	
  4D43  F1            		pop	af		;x bit size
  4D44  5F            		ld	e,a
  4D45  1600          		ld	d,00h		;x counter initial value
                      	
  4D47  E5            		push	hl		;array address
  4D48  D5            		push	de		;d=x counter, e=x bit size
                      	
  4D49                	GETATLP1:
  4D49  ED4BB1FE      		ld	bc,(GRPX3)
  4D4D  ED5BB3FE      		ld	de,(GRPY3)
  4D51  CD6E3E        		call	POINT
  4D54  4F            		ld	c,a
  4D55  CD9539        		call	CHKMOD
  4D58  2808          		jr	z,GETATZ1
  4D5A  3A92FD        		ld	a,(SCREEN1)
  4D5D  FE02          		cp	02h
  4D5F  2801          		jr	z,GETATZ1
  4D61  0C            		inc	c
  4D62                	GETATZ1:
  4D62  79            		ld	a,c
  4D63  3D            		dec	a
  4D64  D1            		pop	de
  4D65  E1            		pop	hl
                      	
  4D66  4F            		ld	c,a		;data
  4D67  7A            		ld	a,d
  4D68  93            		sub	e		;counter -= x bit size
  4D69  57            		ld	d,a
  4D6A  3010          		jr	nc,GETATNC2
                      	
  4D6C  C608          		add	a,08h
  4D6E  57            		ld	d,a
  4D6F  D9            		exx
  4D70  C1            		pop	bc
  4D71  0B            		dec	bc
  4D72  78            		ld	a,b
  4D73  B1            		or	c
  4D74  CAED03        		jp	z,FCERR
  4D77  C5            		push	bc
  4D78  D9            		exx
                      	
  4D79  23            		inc	hl
  4D7A  3600          		ld	(hl),0
                      	
  4D7C                	GETATNC2:
  4D7C  79            		ld	a,c		;data
  4D7D  2804          		jr	z,GETATZ3
  4D7F  42            		ld	b,d
  4D80                	GETATLP2:
  4D80  07            		rlca
  4D81  10FD          		djnz	GETATLP2
  4D83                	GETATZ3:
  4D83  B6            		or	(hl)
  4D84  77            		ld	(hl),a
                      	
  4D85  E5            		push	hl
  4D86  D5            		push	de
                      	
  4D87  2AB1FE        		ld	hl,(GRPX3)
  4D8A  ED5BADFE      		ld	de,(GRPX2)
  4D8E  E7            		rst	CPHLDE
  4D8F  3007          		jr	nc,GETATNC3
  4D91  0600          		ld	b,00h
  4D93  CD252B        		call	INCGX
  4D96  18B1          		jr	GETATLP1
                      	
  4D98                	GETATNC3:
  4D98  D1            		pop	de
  4D99  1600          		ld	d,00h		;x counter initial value
  4D9B  D5            		push	de
  4D9C  2A50FF        		ld	hl,(TMP)	;smaller x
  4D9F  22B1FE        		ld	(GRPX3),hl
  4DA2  CD412B        		call	INCGY
  4DA5  2AAFFE        		ld	hl,(GRPY2)
                      	;	ld	de,(GRPY3)
  4DA8  E7            		rst	CPHLDE
  4DA9  309E          		jr	nc,GETATLP1
                      	
  4DAB                	GETATEND:
  4DAB  D1            		pop	de
  4DAC  E1            		pop	hl
  4DAD  C1            		pop	bc
  4DAE  C9            		ret
                      	
                      	
  4DAF                	GETATFILE:
                      	;save to FDD file
                      	;not implemented
  4DAF  C3E403        		jp	SNERR
                      	
                      	
                      	
                      	
                      	;get array(0) address and last size
                      	;input: de=array address
                      	;output: bc=size, hl=array(0) address-1
                      	;destroy: af,de
  4DB2                	GETARR0:
  4DB2  EB            		ex	de,hl
  4DB3  4E            		ld	c,(hl)		;bc=bytes
  4DB4  23            		inc	hl
  4DB5  46            		ld	b,(hl)
  4DB6  23            		inc	hl
  4DB7  7E            		ld	a,(hl)		;dimensions
                      	
  4DB8  0B            		dec	bc
  4DB9                	GETARR0LP:
  4DB9  23            		inc	hl
  4DBA  23            		inc	hl
  4DBB  0B            		dec	bc
  4DBC  0B            		dec	bc
  4DBD  3D            		dec	a
  4DBE  20F9          		jr	nz,GETARR0LP
  4DC0  C9            		ret
                      	
                      	
                      	;PUT command
  4DC1                	C_PUT:
  4DC1  CD5A3F        		call	SKIPSP
  4DC4  FE40          		cp	'@'
  4DC6  2801          		jr	z,PUTAT
                      	
                      	;FDD command
                      	;not implemented
                      	
  4DC8  C9            		ret
                      	
                      	
                      	;PUT@ command
  4DC9                	PUTAT:
  4DC9  23            		inc	hl
  4DCA  CDEA2C        		call	GETGXY
  4DCD  C2E403        		jp	nz,SNERR
  4DD0  23            		inc	hl
  4DD1  CD8433        		call	CHKVAR
  4DD4  224EFF        		ld	(PROGAD),hl
                      	
                      	;	or,and,xor,pset,preset
  4DD7  CD5A3F        		call	SKIPSP
  4DDA  FE2C          		cp	','
  4DDC  2011          		jr	nz,PUTATNZ1
  4DDE  CD593F        		call	SKIPSPINC
  4DE1  23            		inc	hl
  4DE2  FE58          		cp	'X'
  4DE4  200B          		jr	nz,PUTATNZ2
  4DE6  CD5A3F        		call	SKIPSP
  4DE9  23            		inc	hl
  4DEA  FED0          		cp	OR_
  4DEC  C2E403        		jp	nz,SNERR
  4DEF                	PUTATNZ1:
  4DEF  3E58          		ld	a,'X'
  4DF1                	PUTATNZ2:
  4DF1  224EFF        		ld	(PROGAD),hl
  4DF4  08            		ex	af,af'		;put@ condition
                      	
  4DF5  CD2F34        		call	SRCHARR
  4DF8  DAED03        		jp	c,FCERR
  4DFB  CB79          		bit	7,c
  4DFD  C2D04E        		jp	nz,PUTATFILE
                      	
  4E00  CDB24D        		call	GETARR0
  4E03  23            		inc	hl
  4E04  4E            		ld	c,(hl)
  4E05  23            		inc	hl
  4E06  46            		ld	b,(hl)		;bc=x dot size
  4E07  23            		inc	hl
  4E08  5E            		ld	e,(hl)
  4E09  23            		inc	hl
  4E0A  56            		ld	d,(hl)		;de=y dot size
  4E0B  E5            		push	hl		;array address
                      	
  4E0C  D9            		exx
  4E0D  21C64E        		ld	hl,TBL-2
  4E10  CD9539        		call	CHKMOD
  4E13  3A92FD        		ld	a,(SCREEN1)
  4E16  2802          		jr	z,PUTATZ1
  4E18  23            		inc	hl
  4E19  23            		inc	hl
  4E1A                	PUTATZ1:
  4E1A  B7            		or	a
  4E1B  CAED03        		jp	z,FCERR
  4E1E  4F            		ld	c,a		;(SCREEN1)
  4E1F  1600          		ld	d,00h
  4E21  87            		add	a,a
  4E22  5F            		ld	e,a
  4E23  19            		add	hl,de
  4E24  56            		ld	d,(hl)		;x bit size
  4E25  23            		inc	hl
  4E26  5E            		ld	e,(hl)		;mask
  4E27  E1            		pop	hl		;array address
                      	
  4E28  0600          		ld	b,00h
  4E2A  CD9539        		call	CHKMOD
  4E2D  2804          		jr	z,PUTATZ2	;mode5: 1-origin
  4E2F  79            		ld	a,c		;(SCREEN1)
  4E30  0F            		rrca
  4E31  3801          		jr	c,PUTATNZ3	;mode1-4,screen2,4: 0-origin
  4E33                	PUTATZ2:
  4E33  04            		inc	b		;0=0-origin, 1=1-origin
  4E34                	PUTATNZ3:
  4E34  D9            		exx
                      	
  4E35  2AB0FD        		ld	hl,(GRPY1)
  4E38  22B3FE        		ld	(GRPY3),hl
  4E3B  19            		add	hl,de
  4E3C  EB            		ex	de,hl
  4E3D  2AAEFD        		ld	hl,(GRPX1)
  4E40  09            		add	hl,bc
  4E41  44            		ld	b,h
  4E42  4D            		ld	c,l
                      	
  4E43                	PUTATLP1:
  4E43  D9            		exx
  4E44  0E00          		ld	c,0		;shift count
  4E46  D9            		exx
                      	
  4E47  D5            		push	de		;y-end
  4E48  2AAEFD        		ld	hl,(GRPX1)	;x-start
  4E4B  22B1FE        		ld	(GRPX3),hl
                      	
  4E4E                	PUTATLP2:
  4E4E  C5            		push	bc		;x-end
                      	
  4E4F  ED4BB1FE      		ld	bc,(GRPX3)
  4E53  ED5BB3FE      		ld	de,(GRPY3)
  4E57  C5            		push	bc		;x
  4E58  D5            		push	de		;y
  4E59  CD6E3E        		call	POINT
                      	
  4E5C  D9            		exx
  4E5D  90            		sub	b		;0- or 1-origin
  4E5E  D9            		exx
  4E5F  47            		ld	b,a		;;
                      	
  4E60  D9            		exx
  4E61  79            		ld	a,c
  4E62  92            		sub	d
  4E63  4F            		ld	c,a
  4E64  7E            		ld	a,(hl)
  4E65  280E          		jr	z,PUTATZ3
  4E67  3006          		jr	nc,PUTATNC
  4E69  23            		inc	hl
  4E6A  79            		ld	a,c
  4E6B  E607          		and	07h
  4E6D  4F            		ld	c,a
  4E6E  7E            		ld	a,(hl)
  4E6F                	PUTATNC:
  4E6F  C5            		push	bc
  4E70  41            		ld	b,c
  4E71                	PUTATLP3:
  4E71  0F            		rrca
  4E72  10FD          		djnz	PUTATLP3
  4E74  C1            		pop	bc
  4E75                	PUTATZ3:
  4E75  A3            		and	e
  4E76  D9            		exx
                      	
  4E77  08            		ex	af,af'		;put@ condition
  4E78  FE58          		cp	'X'
  4E7A  281B          		jr	z,PUTATXOR
  4E7C  FE9B          		cp	PSET_		;9bh
  4E7E  280C          		jr	z,PUTATPSET
  4E80  FECF          		cp	AND_		;cfh
  4E82  280B          		jr	z,PUTATAND
  4E84  FED0          		cp	OR_		;d0h
  4E86  280B          		jr	z,PUTATOR
                      	
  4E88                	PUTATPRESET:
  4E88  08            		ex	af,af'
  4E89  2F            		cpl
  4E8A  180D          		jr	PUTATSET
                      	
  4E8C                	PUTATPSET:
  4E8C  08            		ex	af,af'
  4E8D  180A          		jr	PUTATSET
                      	
  4E8F                	PUTATAND:
  4E8F  08            		ex	af,af'
  4E90  A0            		and	b		;;
  4E91  1806          		jr	PUTATSET
                      	
  4E93                	PUTATOR:
  4E93  08            		ex	af,af'
  4E94  B0            		or	b		;;
  4E95  1802          		jr	PUTATSET
                      	
  4E97                	PUTATXOR:
  4E97  08            		ex	af,af'
  4E98  A8            		xor	b		;;
                      	;	jr	PUTATSET
                      	
  4E99                	PUTATSET:
  4E99  D9            		exx
  4E9A  80            		add	a,b		;0- or 1-origin
  4E9B  D9            		exx
  4E9C  CDC015        		call	SETATT
  4E9F  D1            		pop	de		;y
  4EA0  C1            		pop	bc		;x
  4EA1  CD472D        		call	PSET
                      	
                      	;	ld	b,00h
                      	;	call	INCGX
  4EA4  3A92FD        		ld	a,(SCREEN1)
  4EA7  FE02          		cp	02h
  4EA9  2F            		cpl
  4EAA  CE05          		adc	a,05h		;1,2,3 -> 4,2,1
  4EAC  1600          		ld	d,00h
  4EAE  5F            		ld	e,a
  4EAF  2AB1FE        		ld	hl,(GRPX3)
  4EB2  19            		add	hl,de
  4EB3  22B1FE        		ld	(GRPX3),hl
                      	
  4EB6  C1            		pop	bc		;x-end
  4EB7  B7            		or	a
  4EB8  ED42          		sbc	hl,bc
  4EBA  3892          		jr	c,PUTATLP2
                      	
  4EBC  CD412B        		call	INCGY
  4EBF  EB            		ex	de,hl
  4EC0  D1            		pop	de		;y-end
  4EC1  B7            		or	a
  4EC2  ED52          		sbc	hl,de
  4EC4  DA434E        		jp	c,PUTATLP1
                      	
  4EC7  C9            		ret
                      	
                      	
                      	;bit size and mask
  4EC8                	TBL:
  4EC8  040F          		db	04h, 0fh	;mode5,screen2
  4ECA  040F          		db	04h, 0fh	;mode5,screen3	mode1-4,screen2
  4ECC  0203          		db	02h, 03h	;mode5,screen4	mode1-4,screen3
  4ECE  0101          		db	01h, 01h	;		mode1-4,screen4
                      	
                      	
  4ED0                	PUTATFILE:
                      	;load from FDD file
                      	;not implemented
  4ED0  C3E403        		jp	SNERR
                      	
                      	
                      	
                      	;CSAVE command (extended)
  4ED3                	C_CSVEX:
  4ED3  CD5A3F        		call	SKIPSP
  4ED6  FECC          		cp	ASTRSK		;cch
  4ED8  C21823        		jp	nz,C_CSV
  4EDB  23            		inc	hl
  4EDC  CD8433        		call	CHKVAR
  4EDF  224EFF        		ld	(PROGAD),hl
  4EE2  CD2F34        		call	SRCHARR
  4EE5  DAED03        		jp	c,FCERR
  4EE8  CDB24D        		call	GETARR0
                      	
  4EEB  C5            		push	bc
  4EEC  CDA825        		call	PRTOPN
  4EEF  C1            		pop	bc
  4EF0                	CSVEXLP:
  4EF0  23            		inc	hl
  4EF1  7E            		ld	a,(hl)
  4EF2  CDCC1A        		call	PUTCMT
  4EF5  0B            		dec	bc
  4EF6  78            		ld	a,b
  4EF7  B1            		or	c
  4EF8  20F6          		jr	nz,CSVEXLP
  4EFA  C3061B        		jp	WCLOSE
                      	
                      	
                      	;CLOAD command (extended)
  4EFD                	C_CLDEX:
  4EFD  CD5A3F        		call	SKIPSP
  4F00  FECC          		cp	ASTRSK		;cch
  4F02  C25A23        		jp	nz,C_CLD
  4F05  23            		inc	hl
  4F06  CD8433        		call	CHKVAR
  4F09  224EFF        		ld	(PROGAD),hl
  4F0C  CD2F34        		call	SRCHARR
  4F0F  DAED03        		jp	c,FCERR
  4F12  CDB24D        		call	GETARR0
                      	
  4F15  C5            		push	bc
  4F16  CD9A25        		call	INPOPN
  4F19  C1            		pop	bc
  4F1A                	CLDEXLP:
  4F1A  CD701A        		call	GETCMT
  4F1D  C21704        		jp	nz,TRERR
  4F20  23            		inc	hl
  4F21  77            		ld	(hl),a
  4F22  0B            		dec	bc
  4F23  78            		ld	a,b
  4F24  B1            		or	c
  4F25  20F3          		jr	nz,CLDEXLP
  4F27  C3AA1A        		jp	RCLOSE
                      	
                      	
                      	
                      	;set FAT pointer
                      	;input: ix, a=drive
                      	;output: (ix+00h)=drive, (0fb33h)=pointer, a,de,hl?
                      	;destroy: f
  4F2A                	_SETFATP:ds	SETFATP-_SETFATP
  51F2                		org	SETFATP
                      	
  51F2  DD7700        		ld	(ix+00h),a
  51F5  C9            		ret
                      	
                      	
                      	;read/write disk
                      	;input:
                      	; a=the number of sector, b=track, c=sector, hl=address
                      	; ix=work address, (ix+00h)=drive
                      	; c-flag=0,z-flag=0: read
                      	; c-flag=0,z-flag=1: check
                      	; c-flag=1: write
                      	;output:
                      	; c-flag=1 if error
  51F6                	_DISK2:	ds	DISK2-_DISK2
  5CFD                		org	DISK2
                      	
  5CFD  F5            		push	af
  5CFE  AF            		xor	a
  5CFF  DD771B        		ld	(ix+1bh),a
  5D02  F1            		pop	af
  5D03  F5            		push	af
  5D04  E5            		push	hl
  5D05  D5            		push	de
  5D06  C5            		push	bc
  5D07  EB            		ex	de,hl
  5D08  CD7442        		call	DISK
  5D0B  C1            		pop	bc
  5D0C  D1            		pop	de
  5D0D  E1            		pop	hl
  5D0E  3803          		jr	c,DISK2ERR
  5D10  F1            		pop	af
  5D11  B7            		or	a		;reset c-flag: ok
  5D12  C9            		ret
                      	
  5D13                	DISK2ERR:
  5D13  F1            		pop	af
  5D14  37            		scf			;set c-flag: error
  5D15  C9            		ret
                      	
                      	
                      	;60EX ROM end
  5D16                	_6000H:	ds	6000h-_6000H
                      	
                      	
                      	
  6000                	_CALLINI:ds	CALLINI-_CALLINI
  601C                		org	CALLINI
                      	
  601C  CDB942        		call	INIDSK
  601F  C9            		ret
                      	
                      	
                      	;print menu and select mode
                      	;output: z(1=mode 5), a=mode-1(if z=0)
  6020                	SELMOD:
  6020  3A4EFF        		ld	a,(PROGAD)
  6023  FE05          		cp	05h
  6025  DAB260        		jp	c,SELECTED
                      	
                      	;FD auto start
  6028  CDB942        		call	INIDSK
  602B  323BFB        		ld	(DRIVES),a
  602E  283D          		jr	z,SKIPFD
                      	
  6030  3E02          		ld	a,02h
  6032  3265FE        		ld	(MODE),a
  6035  328CFD        		ld	(PAGES),a
                      	
  6038  216D60        		ld	hl,SKIPFD
  603B  22E8FF        		ld	(ERRAD),hl
  603E  DD2100C4      		ld	ix,0c400h
  6042  AF            		xor	a
  6043  DD7700        		ld	(ix+00h),a	;drive
  6046  DD7711        		ld	(ix+11h),a	;error count
  6049  010100        		ld	bc,0001h	;track=0, sector=1
  604C  1100F9        		ld	de,0f900h	;load address
  604F  79            		ld	a,c		;1 sector
  6050                	BOOTSECT:
  6050  B7            		or	a		;reset z- and c-flag for reading
  6051  CD7442        		call	DISK
  6054  38FA          		jr	c,BOOTSECT
                      	
  6056  3A00F9        		ld	a,(0f900h)
  6059  115953        		ld	de,"SY"
  605C  BA            		cp	d		;'S'
  605D  200E          		jr	nz,SKIPFD
  605F  2A01F9        		ld	hl,(0f901h)
  6062  E7            		rst	CPHLDE
  6063  CC03F9        		call	z,0f903h
                      	
  6066  3A4EFF        		ld	a,(PROGAD)
  6069  FE05          		cp	05h
  606B  3845          		jr	c,SELECTED
                      	
                      	;select mode
  606D                	SKIPFD:
  606D  214204        		ld	hl,EDIT
  6070  22E8FF        		ld	(ERRAD),hl
  6073  AF            		xor	a
  6074  3265FE        		ld	(MODE),a
                      	
  6077  CDFB1D        		call	CLS
  607A  211001        		ld	hl,0110h
  607D  CD6D11        		call	SETCSR
  6080  3E20          		ld	a,' '
  6082  061F          		ld	b,1fh
  6084                	SLMDLP1:
  6084  CD7510        		call	PUTC
  6087  10FB          		djnz	SLMDLP1
                      	
  6089  21C961        		ld	hl,MENU
  608C  0609          		ld	b,09h
  608E                	SLMDLP2:
  608E  E5            		push	hl
  608F  2602          		ld	h,02h
  6091  3E0D          		ld	a,0dh
  6093  90            		sub	b
  6094  6F            		ld	l,a
  6095  CD6D11        		call	SETCSR
  6098  E1            		pop	hl
  6099  E5            		push	hl
  609A  C5            		push	bc
  609B  CDCF30        		call	PUTS
  609E  C1            		pop	bc
  609F  E1            		pop	hl
                      	
  60A0                	SLMDLP3:
  60A0  7E            		ld	a,(hl)
  60A1  23            		inc	hl
  60A2  B7            		or	a
  60A3  20FB          		jr	nz,SLMDLP3
  60A5  10E7          		djnz	SLMDLP2
                      	
  60A7                	SLMDLP4:
  60A7  CD3A10        		call	GETKBF
  60AA  28FB          		jr	z,SLMDLP4
  60AC  D631          		sub	'1'
  60AE  FE05          		cp	05h
  60B0  30F5          		jr	nc,SLMDLP4
                      	
  60B2                	SELECTED:
  60B2  FE04          		cp	04h
  60B4  F5            		push	af		;mode 5?
  60B5  3801          		jr	c,SETMOD
  60B7  3D            		dec	a		;mode 5->4 for "How Many..."
  60B8                	SETMOD:
  60B8  3265FE        		ld	(MODE),a
                      	
  60BB  E601          		and	01h
  60BD  3E04          		ld	a,04h
  60BF  210080        		ld	hl,8000h
  60C2  2003          		jr	nz,RAM32K
  60C4  26C0          		ld	h,0c0h
  60C6  1F            		rra			;c-flag=0
  60C7                	RAM32K:
  60C7  328CFD        		ld	(PAGES),a
  60CA  47            		ld	b,a		;;
                      	
  60CB  7C            		ld	a,h
  60CC  3291FD        		ld	(VRAM),a
  60CF  CBD4          		set	2,h		;h=h+40h
  60D1  2229FF        		ld	(BASICAD),hl	;l=0
  60D4  2C            		inc	l		;inc hl
  60D5  225FFA        		ld	(STARTAD),hl
                      	
  60D8                	SLMDLP5:
  60D8  78            		ld	a,b		;;
  60D9  3D            		dec	a
  60DA  CD0C14        		call	CHGACT
  60DD  CDFB1D        		call	CLS
  60E0  10F6          		djnz	SLMDLP5
                      	
  60E2  AF            		xor	a
  60E3  CDED13        		call	CHGDSP
                      	
  60E6  F1            		pop	af
  60E7  C9            		ret
                      	
                      	
  60E8                	REGDATA:
  60E8  FFAACCBBEEDD34		dw	0aaffh, 0bbcch, 0ddeeh, 1234h
                      	
  60F0                	MODE5:
  60F0  AF            		xor	a
  60F1  3291FD        		ld	(VRAM),a
  60F4  3C            		inc	a
  60F5  3294FD        		ld	(COLOR2),a
  60F8  3297FD        		ld	(M1COLOR+1),a
  60FB  329AFD        		ld	(M2COLOR+1),a
  60FE  329DFD        		ld	(M3COLOR+1),a
  6101  32A0FD        		ld	(M4COLOR+1),a
  6104  3C            		inc	a
  6105  3295FD        		ld	(COLOR3),a
  6108  3298FD        		ld	(M1COLOR+2),a
  610B  329BFD        		ld	(M2COLOR+2),a
  610E  329EFD        		ld	(M3COLOR+2),a
  6111  32A1FD        		ld	(M4COLOR+2),a
  6114  3E10          		ld	a,10h
  6116  3293FD        		ld	(COLOR1),a
  6119  3296FD        		ld	(M1COLOR),a
  611C  3299FD        		ld	(M2COLOR),a
  611F  329CFD        		ld	(M3COLOR),a
                      	
  6122  3E28          		ld	a,CLMN66
  6124  32ACFD        		ld	(WIDTH),a
  6127  3E14          		ld	a,ROWS66
  6129  3220FA        		ld	(HEIGHT),a
  612C  32A3FD        		ld	(CONSOL2),a
  612F  3D            		dec	a
  6130  32A5FD        		ld	(LASTLIN),a
  6133  3E06          		ld	a,06h
  6135  32C7FE        		ld	(FKEYLEN),a
  6138  3E04          		ld	a,04h
  613A  3265FE        		ld	(MODE),a
  613D  329FFD        		ld	(M4COLOR),a
                      	
                      	;	ld	a,04h
  6140  2191FD        		ld	hl,VRAM
  6143  11B9FD        		ld	de,PAGE1
  6146                	MODE5LP1:
  6146  012800        		ld	bc,PAGE1-VRAM
  6149  EDB0          		ldir
  614B  3D            		dec	a
  614C  20F8          		jr	nz,MODE5LP1
                      	
  614E  6F            		ld	l,a		;=0
  614F  57            		ld	d,a		;=0
  6150  3A8CFD        		ld	a,(PAGES)
                      	
  6153  2680          		ld	h,80h
  6155  FE03          		cp	03h
  6157  3806          		jr	c,SETAD
  6159  2688          		ld	h,88h
  615B  2802          		jr	z,SETAD
  615D  26C8          		ld	h,0c8h
  615F                	SETAD:
  615F  2229FF        		ld	(BASICAD),hl
  6162  2C            		inc	l
  6163  225FFA        		ld	(STARTAD),hl
                      	
  6166  21D1F9        		ld	hl,0fa00h-47	;no fdd
  6169  228DFD        		ld	(USREND),hl
  616C  2227FF        		ld	(STREND),hl
  616F  223DFF        		ld	(STRAD),hl
  6172  21A5F8        		ld	hl,0fa00h-47-300
  6175  225BFA        		ld	(STACK),hl
                      	
  6178  21156A        		ld	hl,C_COLR66
  617B  2295FA        		ld	(0fa95h),hl	;COLOR command
  617E  21C970        		ld	hl,C_LIN66
  6181  229BFA        		ld	(0fa9bh),hl	;LINE command
  6184  212571        		ld	hl,C_PAIN66
  6187  229DFA        		ld	(0fa9dh),hl	;PAINT command
  618A  21AD62        		ld	hl,F_PEEK66
  618D  2203FB        		ld	(0fb03h),hl	;PEEK() function
                      	
  6190  F5            		push	af		;a=(PAGES)
  6191  57            		ld	d,a
  6192  1E00          		ld	e,00h
  6194                	MODE5LP2:
  6194  7A            		ld	a,d
  6195  3D            		dec	a
  6196  CD3314        		call	GETPGAD
                      	
  6199  73            		ld	(hl),e
  619A  7B            		ld	a,e
  619B  3291FD        		ld	(VRAM),a
  619E  C640          		add	a,40h
  61A0  5F            		ld	e,a
  61A1  15            		dec	d
  61A2  20F0          		jr	nz,MODE5LP2
  61A4  C1            		pop	bc		;b=(PAGES)
                      	
  61A5                	MODE5LP3:
  61A5  78            		ld	a,b
  61A6  3D            		dec	a
  61A7  CD0C14        		call	CHGACT
  61AA  CDFB1D        		call	CLS
  61AD  10F6          		djnz	MODE5LP3
                      	
  61AF  3E04          		ld	a,04h		;40x20 text mode
  61B1  D3C1          		out	(0c1h),a	;bit3: 0=320x200, 1=160x200
                      					;bit2: 0=graphic, 1=text
                      					;bit1: 0=40x20,   1=32x16
                      	;	ld	a,04h		;relay off,timer on, VRAM=0000h
                      	;	out	(0b0h),a	;bit3=CMT relay: 0=off, 1=on
                      					;bit21=VRAM address:
                      					; 00=c000h(60)/8000h(60m)
                      					; 01=e000h(60)/c000h(60m)
                      					; 10=8000h(60)/0000h(60m)*
                      					; 11=a000h(60)/4000h(60m)
                      					;bit0=timer: 0=on, 1=off
                      	
  61B3  0F            		rrca			;2
  61B4  D3C0          		out	(0c0h),a	;CSS2=1
                      	
  61B6  AF            		xor	a
  61B7  CDED13        		call	CHGDSP
                      	
  61BA  CDD834        		call	NEWRESSTK
  61BD  CDF934        		call	RESSTK
                      	
  61C0  CD7F40        		call	SETTBL
                      	
  61C3  219762        		ld	hl,SYSNAME66
  61C6  C3CB00        		jp	START
                      	
                      	
  61C9                	MENU:
  61C9  20202A2A2A2050		db	"  *** PC-6601 ",9ah, 0deh, 96h, 0fdh, "BASIC ***",00h
  61E5  0A00          		db	0ah,00h
  61E7  313A3630204241		db	"1:60 BASIC          (RAM-16K)",00h
  6205  323A3630204241		db	"2:60 BASIC          (RAM-32K)",00h
  6223  333A3630204558		db	"3:60 EXTENDED BASIC (RAM-16K)",00h
  6241  343A3630204558		db	"4:60 EXTENDED BASIC (RAM-32K)",00h
  625F  353A3636204241		db	"5:66 BASIC          (RAM-64K)",00h
  627D  0A00          		db	0ah,00h
  627F  20202020202053		db	"      SELECT BASIC MODE",00h
                      	
                      	
  6297                	SYSNAME66:
  6297  36369ADE96FD42		db	"66", 9ah, 0deh, 96h, 0fdh, "BASIC Ver.0.2", 0dh, 0ah, 00h
                      	
                      	
                      	;PEEK() function
  62AD                	F_PEEK66:
  62AD  CD780B        		call	CHKNUM
  62B0  CDB10C        		call	FTOI
  62B3  EB            		ex	de,hl
  62B4  CD8DFE        		call	READRAM
  62B7  C3590C        		jp	I1TOFA
                      	
                      	
                      	;continued from F_SCRN
  62BA                	F_SCRN66:
  62BA  CD8DFE        		call	READRAM
  62BD  CD590C        		call	I1TOFA
  62C0  C3B118        		jp	FNCRTN
                      	
                      	
                      	;input: bc=X, de=Y
                      	;output: a=color
                      	;destroy: f,bc,de,hl
  62C3                	POINT66:
  62C3  3A92FD        		ld	a,(SCREEN1)
  62C6  3D            		dec	a
  62C7  282E          		jr	z,POINT662
  62C9  F2DA62        		jp	p,POINT66G
                      	
                      	;screen mode 1
  62CC                	POINT661:
  62CC  CD2E66        		call	GXY2AD66
  62CF  CD8DFE        		call	READRAM
  62D2  0F            		rrca
  62D3  0F            		rrca
  62D4  0F            		rrca
  62D5  0F            		rrca
  62D6  E607          		and	07h
  62D8  3C            		inc	a
  62D9  C9            		ret
                      	
                      	;graphic mode (screen mode 3,4)
  62DA                	POINT66G:
  62DA  F5            		push	af		;
  62DB  CD1566        		call	GXY2GAD66
  62DE  CD8DFE        		call	READRAM
  62E1  A2            		and	d
  62E2  07            		rlca
  62E3  C1            		pop	bc		;
                      	;	dec	b
                      	;	jr	nz,POINT664
  62E4  1001          		djnz	POINT664
  62E6  07            		rlca
  62E7                	POINT664:
  62E7  5F            		ld	e,a
  62E8  CBAC          		res	5,h
  62EA  CD8DFE        		call	READRAM
  62ED  A2            		and	d
  62EE  B3            		or	e
  62EF  07            		rlca
  62F0                	POINT66LP:
  62F0  0F            		rrca
  62F1  CB0A          		rrc	d
  62F3  30FB          		jr	nc,POINT66LP
  62F5  3C            		inc	a
  62F6  C9            		ret
                      	
                      	;screen mode 2
  62F7                	POINT662:
  62F7  C5            		push	bc		;x
  62F8  CD2E66        		call	GXY2AD66
  62FB  C1            		pop	bc		;x
  62FC  CD0B6C        		call	MASK266
  62FF  57            		ld	d,a
  6300  CD8DFE        		call	READRAM
  6303  47            		ld	b,a
  6304  07            		rlca			;
  6305  24            		inc	h
  6306  24            		inc	h
  6307  24            		inc	h
  6308  24            		inc	h
  6309  CD8DFE        		call	READRAM
  630C  3001          		jr	nc,POINT662C	;
  630E  A2            		and	d		;;
  630F                	POINT662C:
  630F  78            		ld	a,b
  6310  2006          		jr	nz,POINT662NZ	;;
  6312  E670          		and	70h
  6314  0F            		rrca
  6315  0F            		rrca
  6316  0F            		rrca
  6317  0F            		rrca
  6318                	POINT662NZ:
  6318  E60F          		and	0fh
  631A  3C            		inc	a
  631B  C9            		ret
                      	
                      	
                      	;scroll up
                      	;input: h=first line+1, l=last line+1
                      	;destroy: af
  631C                	_SCRLU66:ds	SCRLU66-_SCRLU66
  63E2                		org	SCRLU66
                      	
  63E2  7D            		ld	a,l
  63E3  94            		sub	h		;a=(LASTLIN)-(CONSOL1) < 16
                      	;	ret	z
                      	;	ret	c
                      	
                      	;z=0:scroll up, z=1:scroll down
  63E4                	SCRLUD66:
  63E4  D5            		push	de
  63E5  E5            		push	hl
  63E6  C5            		push	bc
  63E7  F5            		push	af		;up/down
                      	
                      	
                      	;line connection status
  63E8  47            		ld	b,a
  63E9  04            		inc	b
  63EA  50            		ld	d,b		;>0
  63EB                	SCRLUD66LP:
  63EB  CD7615        		call	CHKLINE4
  63EE  4F            		ld	c,a
  63EF  7A            		ld	a,d
  63F0  E5            		push	hl
  63F1  CD8215        		call	SETLINE
  63F4  E1            		pop	hl
  63F5  51            		ld	d,c
  63F6  2D            		dec	l
  63F7  F1            		pop	af		;up/down
  63F8  F5            		push	af
  63F9  2002          		jr	nz,SCRLUD66NZ
  63FB  2C            		inc	l
  63FC  2C            		inc	l
  63FD                	SCRLUD66NZ:
  63FD  10EC          		djnz	SCRLUD66LP
                      	
  63FF  6C            		ld	l,h
  6400  3A92FD        		ld	a,(SCREEN1)
  6403  FE02          		cp	02h
  6405  D1            		pop	de		;d=a
  6406  D5            		push	de
  6407  7A            		ld	a,d
  6408  302A          		jr	nc,SCRLG66	;screen mode 3 4
                      	
  640A  CD8964        		call	MUL40
  640D  CDB811        		call	Y2AD
  6410  212800        		ld	hl,CLMN66
  6413  19            		add	hl,de
  6414  F1            		pop	af		;up/down
  6415  2003          		jr	nz,SCRL2NZ
  6417  EB            		ex	de,hl
  6418  1B            		dec	de
  6419  2B            		dec	hl
                      	
  641A                	SCRL2NZ:
  641A  E5            		push	hl
  641B  D5            		push	de
  641C  C5            		push	bc
  641D  CD8364        		call	LDIDRRAM
  6420  C1            		pop	bc
  6421  D1            		pop	de
  6422  E1            		pop	hl
                      	
                      	;attribute
  6423  CB94          		res	2,h
  6425  CB92          		res	2,d
  6427  C36664        		jp	SCRLATT66
                      	
                      	
                      	;scroll down
                      	;input: h=last line+1, l=first line+1
                      	;destroy: af
  642A                	_SCRLD66:ds	SCRLD66-_SCRLD66
  642F                		org	SCRLD66
                      	
  642F  7C            		ld	a,h
  6430  95            		sub	l
                      	;	ret	z
                      	;	ret	c
  6431  BF            		cp	a		;set z-flag
  6432  18B0          		jr	SCRLUD66
                      	
                      	
                      	;for graphic mode (screen mode 3,4) for mode 5
  6434                	SCRLG66:
                      	;bc=a*40*10=a*(256+128+16)
                      	
  6434  67            		ld	h,a
  6435  48            		ld	c,b		;b=0
  6436  47            		ld	b,a
  6437  1F            		rra			;c-flag=0
  6438  CB19          		rr	c
  643A  80            		add	a,b
  643B  47            		ld	b,a
                      	
  643C  7C            		ld	a,h
  643D  87            		add	a,a
  643E  87            		add	a,a
  643F  87            		add	a,a
  6440  87            		add	a,a
  6441  3001          		jr	nc,SCRLG66NC1
  6443  04            		inc	b
  6444                	SCRLG66NC1:
  6444  81            		add	a,c
  6445  4F            		ld	c,a
  6446  3001          		jr	nc,SCRLG66NC2
  6448  04            		inc	b
  6449                	SCRLG66NC2:
                      	
  6449  2601          		ld	h,1
  644B  CDD565        		call	XY2GAD66
  644E  EB            		ex	de,hl
  644F  219001        		ld	hl,CLMN66*10
  6452  19            		add	hl,de
  6453  F1            		pop	af		;up/down
  6454  2003          		jr	nz,SCRLG66NZ
  6456  EB            		ex	de,hl
  6457  1B            		dec	de
  6458  2B            		dec	hl
                      	
  6459                	SCRLG66NZ:
  6459  E5            		push	hl
  645A  D5            		push	de
  645B  C5            		push	bc
  645C  CD8364        		call	LDIDRRAM
  645F  C1            		pop	bc
  6460  D1            		pop	de
  6461  E1            		pop	hl
  6462  CBAC          		res	5,h
  6464  CBAA          		res	5,d
                      	
  6466                	SCRLATT66:
  6466  CD8364        		call	LDIDRRAM
  6469  C32512        		jp	SCRLATT2
                      	
                      	
                      	;continued from DELLIN
  646C                	DELLIN66:
  646C  3009          		jr	nc,DEL6634
  646E  E5            		push	hl
  646F  CB94          		res	2,h
                      	;	ld	bc,CLMN66
  6471  010128        		ld	bc,2801h
  6474  C3F111        		jp	DELLATT
                      	
  6477                	DEL6634:
  6477  CDCC65        		call	AD2GAD2
  647A  E5            		push	hl
  647B  CBAC          		res	5,h
                      	;	ld	bc,CLMN66*10
  647D  010290        		ld	bc,9002h
  6480  C3F111        		jp	DELLATT
                      	
                      	
                      	;ldir or lddr in RAM
                      	;input: bc,de,hl,z(0=ldir,1=lddr)
                      	;output: bc=0, de, hl
                      	;destroy: f
  6483                	LDIDRRAM:
  6483  C293FE        		jp	nz,LDIRRAM
  6486  C3A5FE        		jp	LDDRRAM
                      	
                      	
                      	;bc=a*40
                      	;input: a(<=20)
                      	;output: bc
                      	;destory: af,h
  6489                	MUL40:
  6489  47            		ld	b,a
  648A  87            		add	a,a		;*2
  648B  87            		add	a,a		;*4
  648C  80            		add	a,b		;*5
  648D  87            		add	a,a		;*10
  648E  45            		ld	b,l		;;
  648F  2600          		ld	h,0
  6491  6F            		ld	l,a
  6492  29            		add	hl,hl		;*20
  6493  29            		add	hl,hl		;*40
  6494  4D            		ld	c,l
  6495  68            		ld	l,b		;;
  6496  44            		ld	b,h
  6497  C9            		ret
                      	
                      	
                      	;continued from PRTFKEY for mode 5
  6498                	PFK66:
  6498  CD4B66        		call	CHRREV66
                      	
  649B  3A5AFA        		ld	a,(KEYFLG)
  649E  CB57          		bit	2,a
  64A0  280E          		jr	z,PFK_ALP
  64A2  E602          		and	02h
  64A4  2005          		jr	nz,PFK_KATA
  64A6  11CD64        		ld	de,MODE_HIRAGANA
  64A9  1810          		jr	PFK66END
                      	
                      	;katakana
  64AB                	PFK_KATA:
  64AB  11D064        		ld	de,MODE_KATAKANA
  64AE  180B          		jr	PFK66END
                      	
                      	;alphabet
  64B0                	PFK_ALP:
  64B0  0F            		rrca
  64B1  3805          		jr	c,PFK_CAPS
  64B3  11C764        		ld	de,MODE_LOWER
  64B6  1803          		jr	PFK66END
                      	
                      	;upper case
  64B8                	PFK_CAPS:
  64B8  11CA64        		ld	de,MODE_UPPER
                      	
  64BB                	PFK66END:
  64BB  0603          		ld	b,03h
  64BD                	PFK66LP:
  64BD  1A            		ld	a,(de)
  64BE  CDCA14        		call	PUT12
  64C1  13            		inc	de
  64C2  10F9          		djnz	PFK66LP
  64C4  C34B66        		jp	CHRREV66
                      	
  64C7                	MODE_LOWER:
  64C7  616263        		db	"abc"
  64CA                	MODE_UPPER:
  64CA  414243        		db	"ABC"
  64CD                	MODE_HIRAGANA:
  64CD  96E520        		db	96h, 0e5h, ' '
  64D0                	MODE_KATAKANA:
  64D0  B6C520        		db	0b6h, 0c5h, ' '
                      	
                      	
                      	;continued from GETSP for mode 5
  64D3                	GETSP66:
  64D3  3D            		dec	a
  64D4  C8            		ret	z
  64D5  3D            		dec	a
  64D6  3E20          		ld	a,' '
  64D8  F8            		ret	m
  64D9  3A94FD        		ld	a,(COLOR2)
  64DC  2809          		jr	z,GETSP663
                      	
                      	;screen mode 4
  64DE  B7            		or	a
  64DF  C8            		ret	z
  64E0  3D            		dec	a
  64E1  0F            		rrca
  64E2  E601          		and	01h
  64E4  C3CF15        		jp	CNVATT
                      	
                      	;screen mode 3
  64E7                	GETSP663:
  64E7  B7            		or	a
  64E8  C8            		ret	z
  64E9  3D            		dec	a
  64EA  0F            		rrca
  64EB  0F            		rrca
  64EC  E603          		and	03h
  64EE  3C            		inc	a
  64EF  C3CF15        		jp	CNVATT
                      	
                      	
                      	;continued from GETSPA for mode 5
  64F2                	GETSPA66:
  64F2  3D            		dec	a
  64F3  FAF915        		jp	m,CNVATT1
  64F6  2817          		jr	z,GETSPA662
  64F8  3D            		dec	a
  64F9  3A94FD        		ld	a,(COLOR2)
  64FC  2808          		jr	z,GETSPA663
                      	
                      	;screen mode 4
  64FE  B7            		or	a
  64FF  C8            		ret	z
  6500  3D            		dec	a
  6501  E601          		and	01h
  6503  C3CF15        		jp	CNVATT
                      	
                      	;screen mode 3
  6506                	GETSPA663:
  6506  B7            		or	a
  6507  C8            		ret	z
  6508  3D            		dec	a
  6509  E603          		and	03h
  650B  3C            		inc	a
  650C  C3CF15        		jp	CNVATT
                      	
  650F                	GETSPA662:
  650F  CD1565        		call	ATT662
  6512  F680          		or	80h
  6514  C9            		ret
                      	
                      	
                      	;continued from CNVATT1
  6515                	ATT662:
  6515  F5            		push	af
  6516                	ATT66:
  6516  F1            		pop	af
  6517  E5            		push	hl
  6518  B7            		or	a
  6519  2803          		jr	z,ATT66Z
  651B  3D            		dec	a
  651C  E60F          		and	0fh
  651E                	ATT66Z:
  651E  6F            		ld	l,a
  651F  3A94FD        		ld	a,(COLOR2)
  6522  3D            		dec	a
  6523  E607          		and	07h
  6525  07            		rlca
  6526  07            		rlca
  6527  07            		rlca
  6528  07            		rlca
  6529  B5            		or	l
  652A  E1            		pop	hl
  652B  C9            		ret
                      	
                      	
                      	;continued from SETATT
  652C                	SETATT66:
  652C  3A92FD        		ld	a,(SCREEN1)
  652F  3D            		dec	a
  6530  283B          		jr	z,SETATT662	;screen mode 2
  6532  FAC715        		jp	m,SETATT661	;screen mode 1
  6535  3D            		dec	a
  6536  2812          		jr	z,SETATT663	;screen mode 3
                      	
                      	;screen mode 4
  6538  F1            		pop	af
  6539  D601          		sub	01h
  653B  CE00          		adc	a,00h		;if a<>0 then a=a-1
  653D  0F            		rrca
  653E  F5            		push	af
  653F  0F            		rrca
  6540  9F            		sbc	a,a		;bit1=0:00h, =1:ffh
  6541  3260FE        		ld	(ATTDAT2),a
  6544  F1            		pop	af
  6545  9F            		sbc	a,a		;bit0=0:00h, =1:ffh
  6546  32ACFE        		ld	(ATTDAT),a
  6549  C9            		ret
                      	
                      	
                      	;screen mode 3
  654A                	SETATT663:
  654A  F1            		pop	af
  654B  D601          		sub	01h
  654D  CE00          		adc	a,00h		;if a<>0 then a=a-1
                      	
                      	;	push	af
                      	;	rrca
                      	;	rrca
                      	;	and	03h
                      	;	inc	a
                      	;	call	CNVATT
                      	;	ld	(ATTDAT2),a
                      	;	pop	af
                      	;	and	03h
                      	;	inc	a
                      	;	call	CNVATT
                      	;	ld	(ATTDAT),a
                      	;	ret
                      	
  654F  C5            		push	bc
  6550  E60F          		and	0fh
  6552  47            		ld	b,a
  6553  0F            		rrca
  6554  0F            		rrca
  6555  0F            		rrca
  6556  0F            		rrca
  6557  B0            		or	b
  6558  47            		ld	b,a
  6559  E633          		and	33h
  655B  4F            		ld	c,a
  655C  A8            		xor	b
  655D  47            		ld	b,a
  655E  0F            		rrca
  655F  0F            		rrca
  6560  B0            		or	b
  6561  3260FE        		ld	(ATTDAT2),a
  6564  79            		ld	a,c
  6565  0F            		rrca
  6566  0F            		rrca
  6567  B1            		or	c
  6568  32ACFE        		ld	(ATTDAT),a
  656B  C1            		pop	bc
  656C  C9            		ret
                      	
                      	
  656D                	SETATT662:
  656D  F1            		pop	af
  656E  3D            		dec	a
  656F  E60F          		and	0fh
  6571  3C            		inc	a
  6572  32ACFE        		ld	(ATTDAT),a
  6575  C9            		ret
                      	
                      	
                      	;convert character VRAM address to graphic VRAM address for mode 5
                      	;(screen mode 1,2 -> screen mode 3,4)
                      	;input: hl=character VRAM address
                      	;output: hl=graphic VRAM address
                      	;destroy: none
  6576                	_AD2GAD2:ds	AD2GAD2-_AD2GAD2
  65CC                		org	AD2GAD2
                      	
  65CC  F5            		push	af
  65CD  CD4911        		call	AD2XY
  65D0  F1            		pop	af
  65D1  CDD565        		call	XY2GAD66
  65D4  C9            		ret
                      	
                      	
                      	;get VRAM address (screen mode 3,4) for mode 5
                      	;input: h=x+1, l=y+1
                      	;output: hl=graphic VRAM address =(VRAM+4000h)+y*400+x
                      	;destroy: none
  65D5                	XY2GAD66:
  65D5  F5            		push	af
  65D6  D5            		push	de
  65D7  C5            		push	bc
                      	
  65D8  25            		dec	h
  65D9  2D            		dec	l
  65DA  3A92FD        		ld	a,(SCREEN1)
  65DD  FE02          		cp	02h
  65DF  7C            		ld	a,h
  65E0  2001          		jr	nz,XY2GAD66C
  65E2  87            		add	a,a		;screen mode 3
  65E3                	XY2GAD66C:
  65E3  2600          		ld	h,0
  65E5  29            		add	hl,hl		;*2
  65E6  29            		add	hl,hl		;*4
  65E7  29            		add	hl,hl		;*8
  65E8  29            		add	hl,hl		;*16
  65E9  54            		ld	d,h
  65EA  5D            		ld	e,l
  65EB  29            		add	hl,hl		:*32
  65EC  29            		add	hl,hl		:*64
  65ED  29            		add	hl,hl		:*128
  65EE  44            		ld	b,h
  65EF  4D            		ld	c,l
  65F0  29            		add	hl,hl		:*256
  65F1  09            		add	hl,bc
  65F2  19            		add	hl,de
                      	
  65F3  85            		add	a,l		;c-flag
  65F4  6F            		ld	l,a
                      	
  65F5  3A91FD        		ld	a,(VRAM)
  65F8  CE20          		adc	a,20h		;c-flag
  65FA  84            		add	a,h
  65FB  67            		ld	h,a
                      	
  65FC  C1            		pop	bc
  65FD  D1            		pop	de
  65FE  F1            		pop	af
  65FF  C9            		ret
                      	
                      	
  6600                	Y2AD66:
  6600  E5            		push	hl
  6601  7D            		ld	a,l
  6602  112800        		ld	de,CLMN66
  6605  2A90FD        		ld	hl,(VRAM-1)	;h=(VRAM)
  6608  CBD4          		set	2,h
  660A  6A            		ld	l,d		;=0
  660B                	Y2AD66LP:
  660B  19            		add	hl,de
  660C  3D            		dec	a
  660D  20FC          		jr	nz,Y2AD66LP
                      	
                      	;	or	a
  660F  ED52          		sbc	hl,de
  6611  EB            		ex	de,hl
  6612  E1            		pop	hl
  6613  F1            		pop	af
  6614  C9            		ret
                      	
                      	
                      	;get VRAM dot pattern address (screen mode 3,4) for mode 5
                      	;input: bc=graphic X, de=graphic Y
                      	;output: hl=VRAM address, d=bit
                      	;destroy: af,bc,e
                      	;hl=(VRAM+2000h)+(X/8)+Y*40
  6615                	GXY2GAD66:
  6615  CD426C        		call	CHKGXY66
  6618                	GXY2GAD662:
  6618  62            		ld	h,d
  6619  6B            		ld	l,e
  661A  29            		add	hl,hl		;*2
  661B  29            		add	hl,hl		;*4
  661C  19            		add	hl,de		;*5
  661D  29            		add	hl,hl		;*10
  661E  29            		add	hl,hl		;*20
  661F  29            		add	hl,hl		;*40
                      	
  6620  3A91FD        		ld	a,(VRAM)
  6623  F620          		or	20h
  6625  CB38          		srl	b
  6627  47            		ld	b,a
  6628  79            		ld	a,c
  6629  CB19          		rr	c
                      	
  662B  C35714        		jp	GXY2GADEND
                      	
                      	
                      	;get VRAM attirbute address (screen mode 1,2) for mode 5
                      	;hl=(VRAM)+X/8+Y/10*40
                      	;input: bc=graphic X, de=graphic Y
                      	;output: hl=VRAM address, d=Y mod 10
                      	;destroy: af,bc,e
  662E                	GXY2AD66:
  662E  CD426C        		call	CHKGXY66
  6631  CDA86C        		call	DIV10
  6634  62            		ld	h,d
  6635  6B            		ld	l,e
  6636  29            		add	hl,hl		;*2
  6637  29            		add	hl,hl		;*4
  6638  19            		add	hl,de		;*5
  6639  29            		add	hl,hl		;*10
  663A  29            		add	hl,hl		;*20
  663B  29            		add	hl,hl		;*40
  663C  57            		ld	d,a
  663D  CB38          		srl	b
  663F  CB19          		rr	c
  6641  CB39          		srl	c
  6643  CB39          		srl	c
  6645  3A91FD        		ld	a,(VRAM)
  6648  47            		ld	b,a
  6649  09            		add	hl,bc
  664A  C9            		ret
                      	
                      	
  664B                	CHRREV66:
  664B  E5            		push	hl
  664C  2A93FD        		ld	hl,(COLOR1)	;l=(COLOR1), h=(COLOR2)
  664F  7C            		ld	a,h
  6650  65            		ld	h,l
  6651  6F            		ld	l,a
  6652  2293FD        		ld	(COLOR1),hl
  6655  E1            		pop	hl
  6656  C9            		ret
                      	
                      	
                      	;continued from CSRREV
  6657                	CSRREV66:
  6657  CB94          		res	2,h
  6659  CD8DFE        		call	READRAM
  665C  2F            		cpl
  665D  EE80          		xor	80h
  665F  77            		ld	(hl),a
  6660  C9            		ret
                      	
                      	
  6661                	GETSCRC66:
  6661  E5            		push	hl
  6662  CD520E        		call	CHR2ATT
  6665  CD8DFE        		call	READRAM
  6668  E1            		pop	hl
  6669  07            		rlca
  666A  D28DFE        		jp	nc,READRAM
  666D  3E20          		ld	a,' '
  666F  C9            		ret
                      	
                      	
  6670                	PUTG66:
                      	;	push	de
                      	;	push	bc
                      	;
                      	;	call	CGROM
                      	;	ld	a,(COLOR1)
                      	;	call	SETATT
                      	
  6670  CDD565        		call	XY2GAD66	;no change in c-flag
                      	
  6673  060A          		ld	b,0ah
  6675                	PUTG66LP:
  6675  D5            		push	de
  6676  CD2915        		call	READCGROM
                      	
  6679  3A92FD        		ld	a,(SCREEN1)
  667C  0F            		rrca
  667D  3005          		jr	nc,CALL366
                      	
  667F  CDA566        		call	PUT466
  6682  1804          		jr	CALL3466END
  6684                	CALL366:
  6684  CD9366        		call	PUT366
  6687  2B            		dec	hl
                      	
  6688                	CALL3466END:
  6688  112800        		ld	de,CLMN66
  668B  19            		add	hl,de
  668C  D1            		pop	de
  668D  1C            		inc	e		;inc de
  668E  10E5          		djnz	PUTG66LP
                      	
  6690  C1            		pop	bc
  6691  D1            		pop	de
  6692  C9            		ret
                      	
                      	
  6693                	PUT366:
  6693  CD9866        		call	PUTHALF66
  6696  23            		inc	hl
  6697  51            		ld	d,c
                      	
  6698                	PUTHALF66:
  6698  1E04          		ld	e,04h
  669A                	PUT366LP:
  669A  CB02          		rlc	d
  669C  17            		rla
  669D  0F            		rrca
  669E  07            		rlca
  669F  17            		rla
  66A0  1D            		dec	e
  66A1  20F7          		jr	nz,PUT366LP
  66A3  4A            		ld	c,d
  66A4  57            		ld	d,a
                      	
                      	
                      	;input: hl=address, d=bit
                      	;destroy: af,e
  66A5                	PUT466:
  66A5  CD8DFE        		call	READRAM
  66A8  5F            		ld	e,a
  66A9  3A60FE        		ld	a,(ATTDAT2)
  66AC  AB            		xor	e
  66AD  A2            		and	d
  66AE  AB            		xor	e
  66AF  77            		ld	(hl),a
                      	
  66B0  CBAC          		res	5,h
  66B2  CD8DFE        		call	READRAM
  66B5  5F            		ld	e,a
  66B6  3AACFE        		ld	a,(ATTDAT)
  66B9  AB            		xor	e
  66BA  A2            		and	d
  66BB  AB            		xor	e
  66BC  77            		ld	(hl),a
  66BD  CBEC          		set	5,h
                      	
  66BF  C9            		ret
                      	
                      	
                      	;set border attribute used by HURRY FOX
                      	;input: a=color code
                      	;destroy: af,bc
  66C0                	_SETBO66:ds	SETBO66-_SETBO66
  69F3                		org	SETBO66
                      	
  69F3  47            		ld	b,a
                      	
  69F4  3AACFE        		ld	a,(ATTDAT)
  69F7  F5            		push	af
  69F8  3A60FE        		ld	a,(ATTDAT2)
  69FB  F5            		push	af
                      	
  69FC  78            		ld	a,b
  69FD  CDC015        		call	SETATT
  6A00  3AACFE        		ld	a,(ATTDAT)
  6A03  32C5FE        		ld	(BORDERA),a
  6A06  3A60FE        		ld	a,(ATTDAT2)
  6A09  3261FE        		ld	(BORDERA2),a
                      	
  6A0C  F1            		pop	af
  6A0D  3260FE        		ld	(ATTDAT2),a
  6A10  F1            		pop	af
  6A11  32ACFE        		ld	(ATTDAT),a
                      	
  6A14  C9            		ret
                      	
                      	
                      	
                      	;COLOR command
  6A15                	C_COLR66:
  6A15  1193FD        		ld	de,COLOR1
  6A18  0602          		ld	b,02h
  6A1A                	COLR66LP:
  6A1A  CD6C3F        		call	CHKCMM
  6A1D  2810          		jr	z,COLR66Z
  6A1F  C5            		push	bc
  6A20  D5            		push	de
  6A21  CDE40D        		call	INT1ARG
  6A24  D1            		pop	de
  6A25  C1            		pop	bc
  6A26  12            		ld	(de),a
  6A27  CD613F        		call	CHKCLN		;a=(hl)
  6A2A  C8            		ret	z
  6A2B  FE2C          		cp	','
  6A2D  C0            		ret	nz
  6A2E  23            		inc	hl
  6A2F                	COLR66Z:
  6A2F  13            		inc	de
  6A30  10E8          		djnz	COLR66LP
                      	
  6A32  CDE40D        		call	INT1ARG
  6A35  3A92FD        		ld	a,(SCREEN1)
  6A38  4F            		ld	c,a
  6A39  7B            		ld	a,e
  6A3A  3D            		dec	a
  6A3B  C37A6B        		jp	SETC366
                      	
                      	
                      	
                      	;set color 3rd parameter for mode 5
                      	;input: a=3rd color parameter-1, c=screen mode-1
                      	;destroy: af
  6A3E                	_SETC366:ds	SETC366-_SETC366
  6B7A                		org	SETC366
                      	
  6B7A  F5            		push	af
  6B7B  79            		ld	a,c
  6B7C  FE02          		cp	02h
  6B7E  3805          		jr	c,C366TXT
  6B80  2807          		jr	z,C3663
                      	
                      	
                      	;screen mode 4
  6B82                	C3664:
  6B82  F1            		pop	af		;0,1,2,3,4,5
                      	;	xor	02h		;2,3,0,1,6,7
  6B83  1807          		jr	C366END
                      	
                      	;screen mode 1,2
  6B85                	C366TXT:
  6B85  F1            		pop	af		;0,1
  6B86  87            		add	a,a
                      	;	xor	02h		;2,0
  6B87  1803          		jr	C366END
                      	
                      	;screen mode 3
  6B89                	C3663:
  6B89  F1            		pop	af		;0,1
  6B8A  87            		add	a,a
  6B8B  87            		add	a,a
                      	;	xor	02h		;2,6
  6B8C                	C366END:
  6B8C  EE02          		xor	02h
  6B8E  D3C0          		out	(0c0h),a
  6B90  3295FD        		ld	(COLOR3),a
  6B93  C9            		ret
                      	
                      	
                      	;SCREEN command
                      	;used by PROGRESS
                      	;input: hl=parameter string address
  6B94                	_SCRN66:ds	SCRN66-_SCRN66
  6B9E                		org	SCRN66
                      	
  6B9E  C3041E        		jp	C_SCRN
                      	
                      	
                      	;continued from PSET
  6BA1                	PSET66:
  6BA1  3A92FD        		ld	a,(SCREEN1)
  6BA4  3D            		dec	a
  6BA5  2819          		jr	z,PSET662
  6BA7  F21A6C        		jp	p,PSET66G
                      	
                      	;screen mode 1
  6BAA                	PSET661:
  6BAA  CD2E66        		call	GXY2AD66
  6BAD  CD8DFE        		call	READRAM
  6BB0  E68F          		and	8fh
  6BB2  5F            		ld	e,a
  6BB3  3AACFE        		ld	a,(ATTDAT)
  6BB6  E607          		and	07h
  6BB8  07            		rlca
  6BB9  07            		rlca
  6BBA  07            		rlca
  6BBB  07            		rlca
  6BBC  B3            		or	e
  6BBD  77            		ld	(hl),a
  6BBE  E1            		pop	hl
  6BBF  C9            		ret
                      	
                      	
                      	;screen mode 2
  6BC0                	PSET662:
  6BC0  C5            		push	bc		;X
  6BC1  CD2E66        		call	GXY2AD66
                      	
  6BC4  CD8DFE        		call	READRAM
  6BC7  5F            		ld	e,a		;
  6BC8  3AACFE        		ld	a,(ATTDAT)
  6BCB  B7            		or	a
  6BCC  2004          		jr	nz,PS662NZ1
  6BCE  CB7B          		bit	7,e
  6BD0  2012          		jr	nz,PS662NZ2
  6BD2                	PS662NZ1:
  6BD2  CD0F65        		call	GETSPA662
  6BD5  47            		ld	b,a
  6BD6  3A94FD        		ld	a,(COLOR2)
  6BD9  CD0F65        		call	GETSPA662
  6BDC  E607          		and	07h
  6BDE  07            		rlca
  6BDF  07            		rlca
  6BE0  07            		rlca
  6BE1  07            		rlca
  6BE2  B0            		or	b
  6BE3  77            		ld	(hl),a
  6BE4                	PS662NZ2:
  6BE4  CBD4          		set	2,h
  6BE6  CB7B          		bit	7,e
  6BE8  2004          		jr	nz,PS662SEMI
  6BEA  CD1316        		call	GETSP
  6BED  77            		ld	(hl),a
                      	
  6BEE                	PS662SEMI:
  6BEE  C1            		pop	bc		;X
  6BEF  CD0B6C        		call	MASK266
  6BF2  47            		ld	b,a
                      	
  6BF3  CD8DFE        		call	READRAM
                      	;	and	0fh
  6BF6  B0            		or	b
  6BF7  4F            		ld	c,a
                      	
  6BF8  3AACFE        		ld	a,(ATTDAT)
  6BFB  B7            		or	a
  6BFC  2803          		jr	z,PSET662C0
  6BFE  71            		ld	(hl),c
  6BFF  E1            		pop	hl
  6C00  C9            		ret
                      	
                      	
  6C01                	PSET662C0:
  6C01  78            		ld	a,b
  6C02  2F            		cpl
  6C03  47            		ld	b,a
  6C04  CD8DFE        		call	READRAM
  6C07  A0            		and	b
  6C08  77            		ld	(hl),a
  6C09  E1            		pop	hl
  6C0A  C9            		ret
                      	
                      	
                      	;screen mode 2 dot bit mask
                      	;input: c=X, d=Y mod 10
                      	;output: a
                      	; bit3 bit2
                      	; bit1 bit0
                      	;destroy: f,bc
  6C0B                	MASK266:
  6C0B  79            		ld	a,c
  6C0C  2F            		cpl
  6C0D  E604          		and	04h
  6C0F  C604          		add	a,04h
  6C11  47            		ld	b,a
  6C12  7A            		ld	a,d
  6C13  FE05          		cp	05h
  6C15  78            		ld	a,b
  6C16  D8            		ret	c	;0<=d<=4
  6C17  0F            		rrca
  6C18  0F            		rrca
  6C19  C9            		ret		;5<=d<=9
                      	
                      	
                      	;screen mode 3,4
  6C1A                	PSET66G:
  6C1A  CD1566        		call	GXY2GAD66
  6C1D  CDA566        		call	PUT466
  6C20  E1            		pop	hl
  6C21  C9            		ret
                      	
                      	
                      	;continued from LINE
  6C22                	LINE66:
  6C22  FE02          		cp	02h
  6C24  2803          		jr	z,LINE663
  6C26  3002          		jr	nc,SKIPY66
  6C28  29            		add	hl,hl		;screen mode 1,2: dy=dy*4
  6C29                	LINE663:
  6C29  29            		add	hl,hl		;screen mode 3: dy=dy*2
                      	
  6C2A                	SKIPY66:
  6C2A  EB            		ex	de,hl
  6C2B  ED4BB1FE      		ld	bc,(GRPX3)	;start (x)
  6C2F  2AADFE        		ld	hl,(GRPX2)	;end (x)
  6C32  B7            		or	a
  6C33  ED42          		sbc	hl,bc		;dx
  6C35  FE02          		cp	02h
  6C37  D2882E        		jp	nc,SKIPX
  6C3A  44            		ld	b,h
  6C3B  4D            		ld	c,l
  6C3C  29            		add	hl,hl
  6C3D  29            		add	hl,hl
  6C3E  09            		add	hl,bc		;screen mode 1,2: dx=dx*5
  6C3F  C3882E        		jp	SKIPX
                      	
                      	
                      	;check and round graphic coordinates (x,y) for mode 5
                      	;input: bc=x, de=y
                      	;output: bc=x, de=y
                      	;destroy: af,hl
  6C42                	CHKGXY66:
  6C42  78            		ld	a,b
  6C43  B2            		or	d
  6C44  FAED03        		jp	m,FCERR
  6C47  213F01        		ld	hl,319
                      	;	or	a
  6C4A  ED42          		sbc	hl,bc
  6C4C  3003          		jr	nc,CHKXOK66
  6C4E  013F01        		ld	bc,319
                      	
  6C51                	CHKXOK66:
  6C51  3A92FD        		ld	a,(SCREEN1)
  6C54  0F            		rrca
  6C55  2F            		cpl
  6C56  21A6FD        		ld	hl,CONSOL3
  6C59  A6            		and	(hl)
  6C5A  0F            		rrca
  6C5B  21C700        		ld	hl,199
  6C5E  3003          		jr	nc,NOFKEY66
  6C60  21BD00        		ld	hl,199-10
  6C63                	NOFKEY66:
  6C63  E7            		rst	CPHLDE
  6C64  3001          		jr	nc,CHKYOK66
  6C66  EB            		ex	de,hl
  6C67                	CHKYOK66:
  6C67  3A92FD        		ld	a,(SCREEN1)
  6C6A  3D            		dec	a
  6C6B  280D          		jr	z,ROUNDY662
  6C6D  F2826C        		jp	p,ROUNDX66	;screen mode 3,4
                      	
                      	;round off y for screen mode 1
  6C70                	ROUNDY661:
  6C70  CDA86C        		call	DIV10
  6C73  7B            		ld	a,e
  6C74  87            		add	a,a		;*2
  6C75  87            		add	a,a		;*4
  6C76  83            		add	a,e		;*5
  6C77  87            		add	a,a		;*10
  6C78  1807          		jr	ROUNDY662END
                      	
                      	;round off y for screen mode 2
  6C7A                	ROUNDY662:
  6C7A  CDA46C        		call	DIV5
                      	
  6C7D  7B            		ld	a,e
  6C7E  87            		add	a,a		;*2
  6C7F  87            		add	a,a		;*4
  6C80  83            		add	a,e		;*5
                      	
  6C81                	ROUNDY662END:
  6C81  5F            		ld	e,a
                      	
  6C82                	ROUNDX66:
  6C82  3A92FD        		ld	a,(SCREEN1)
  6C85  57            		ld	d,a
  6C86  14            		inc	d
  6C87  3EF0          		ld	a,0f0h
  6C89                	ROUNDX66LP:
  6C89  37            		scf
  6C8A  1F            		rra			;f8,fc,fe,ff
  6C8B  15            		dec	d
  6C8C  20FB          		jr	nz,ROUNDX66LP
                      	
  6C8E  A1            		and	c
  6C8F  4F            		ld	c,a
  6C90  C9            		ret			;d=0
                      	
                      	
                      	;continued from INCGY
  6C91                	INCGY66:
  6C91  3A92FD        		ld	a,(SCREEN1)
  6C94  3D            		dec	a
  6C95  3E05          		ld	a,05h		;BASIC mode 5, screen mode 2
  6C97  CA562B        		jp	z,INCGYZ
  6C9A  3E01          		ld	a,01h		;BASIC mode 5, screen mode 3,4
  6C9C  F2562B        		jp	p,INCGYZ
  6C9F  3E0A          		ld	a,0ah		;BASIC mode 5, screen mode 1
  6CA1  C3562B        		jp	INCGYZ
                      	
                      	
                      	;e=e/10 (or e/5)
                      	;input: e
                      	;output: e=int(e/10), a=e mod 10
                      	;destroy: f,hl
  6CA4                	DIV5:
  6CA4  2606          		ld	h,6
  6CA6  1802          		jr	DIV10OR5
  6CA8                	DIV10:
  6CA8  2605          		ld	h,5
  6CAA                	DIV10OR5:
  6CAA  7B            		ld	a,e
  6CAB  1E00          		ld	e,00h
  6CAD  2EA0          		ld	l,10100000b
  6CAF                	DIV10LP:
  6CAF  BD            		cp	l
  6CB0  3801          		jr	c,DIV10C
  6CB2  95            		sub	l
  6CB3                	DIV10C:
  6CB3  3F            		ccf
  6CB4  CB13          		rl	e
  6CB6  CB3D          		srl	l
  6CB8  25            		dec	h
  6CB9  20F4          		jr	nz,DIV10LP
  6CBB  C9            		ret
                      	
                      	
  6CBC                	BFG662:
  6CBC  EB            		ex	de,hl
  6CBD  2AADFE        		ld	hl,(GRPX2)	;larger x
  6CC0  ED4BB1FE      		ld	bc,(GRPX3)	;smaller x
  6CC4  79            		ld	a,c
  6CC5  E6F8          		and	0f8h
  6CC7  4F            		ld	c,a
                      	;	or	a
  6CC8  ED42          		sbc	hl,bc
                      	
  6CCA  7D            		ld	a,l
  6CCB  CB3C          		srl	h
  6CCD  1F            		rra
  6CCE  CB3F          		srl	a
  6CD0  CB3F          		srl	a		;int(larger/8)-int(smaller/8)
                      	
  6CD2  EB            		ex	de,hl		;hl=VRAM address
  6CD3  D1            		pop	de		;d=left part mask, e=right part mask
  6CD4  C1            		pop	bc		;c=lines
                      	
  6CD5  47            		ld	b,a
                      	;	or	a
  6CD6  2003          		jr	nz,BFG66LP3
                      	
  6CD8  7A            		ld	a,d
  6CD9  A3            		and	e
  6CDA  57            		ld	d,a
                      	
  6CDB                	BFG66LP3:
                      	;left part
  6CDB  C5            		push	bc
  6CDC  D5            		push	de
  6CDD  4B            		ld	c,e		;;
  6CDE  CDA566        		call	PUT466
                      	
  6CE1  05            		dec	b		;
  6CE2  FAFD6C        		jp	m,BFGNEXT66	;
                      	
                      	;middle part
  6CE5  E5            		push	hl		;VRAM address
  6CE6  280F          		jr	z,BFGRHT66	;
                      	
  6CE8                	BFG66LP4:
  6CE8  23            		inc	hl
  6CE9  3A60FE        		ld	a,(ATTDAT2)
  6CEC  77            		ld	(hl),a
  6CED  3AACFE        		ld	a,(ATTDAT)
  6CF0  CBAC          		res	5,h
  6CF2  77            		ld	(hl),a
  6CF3  CBEC          		set	5,h
  6CF5  10F1          		djnz	BFG66LP4
                      	
                      	;right part
  6CF7                	BFGRHT66:
  6CF7  23            		inc	hl
  6CF8  51            		ld	d,c		;;
  6CF9  CDA566        		call	PUT466
  6CFC  E1            		pop	hl		;VRAM address
                      	
  6CFD                	BFGNEXT66:
  6CFD  012800        		ld	bc,0028h
  6D00  09            		add	hl,bc
  6D01  D1            		pop	de
  6D02  C1            		pop	bc
  6D03  0D            		dec	c
  6D04  20D5          		jr	nz,BFG66LP3
  6D06  C3C62E        		jp	LINEEND2
                      	
                      	
                      	;LINE command for mode 5
  6D09                	_C_LIN66:ds	C_LIN66-_C_LIN66
  70C9                		org	C_LIN66
                      	
  70C9  CD7F2D        		call	PRELINE
  70CC  D21F2E        		jp	nc,LINE
  70CF  2051          		jr	nz,LINEB66
  70D1  1814          		jr	LINBF66
                      	
                      	
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2,
                      	; (ATTDAT)=attribute, (ATTDAT2)=attribute2
                      	;destroy: af,bc,de
  70D3                	_LINBF66:ds	LINBF66-_LINBF66
  70E7                		org	LINBF66
                      	
  70E7  E5            		push	hl
  70E8  CDB12B        		call	PUSHGXY
  70EB  CDA22B        		call	SORTXY2
                      	
  70EE  3A92FD        		ld	a,(SCREEN1)
  70F1  FE02          		cp	02h
  70F3  DA5A2E        		jp	c,BF12
                      	
                      	;line bf (graphic mdoe)
  70F6                	BFG66:
  70F6  3AADFE        		ld	a,(GRPX2)	;larger x lower byte
  70F9  2001          		jr	nz,BF664
  70FB  3C            		inc	a		;screen mode 3
  70FC                	BF664:
  70FC  E607          		and	07h
  70FE  3C            		inc	a
  70FF  47            		ld	b,a
  7100  AF            		xor	a
  7101                	BFG66LP1:
  7101  37            		scf
  7102  1F            		rra			;right part mask
  7103  10FC          		djnz	BFG66LP1
                      	
                      	;	or	a
  7105  ED52          		sbc	hl,de
  7107  2C            		inc	l
  7108  E5            		push	hl		;l=lines
                      	
  7109  6F            		ld	l,a		;right part mask
                      	
  710A  79            		ld	a,c		;smaller x
  710B  E607          		and	07h
  710D  47            		ld	b,a
  710E  3EFF          		ld	a,0ffh
  7110  2804          		jr	z,BFG66Z
  7112                	BFG66LP2:
  7112  CB3F          		srl	a
  7114  10FC          		djnz	BFG66LP2
  7116                	BFG66Z:
  7116  67            		ld	h,a		;left part mask
  7117  ED4BB1FE      		ld	bc,(GRPX3)	;smaller x
                      	
  711B  E5            		push	hl
  711C  CD1566        		call	GXY2GAD66
                      	
  711F  C3BC6C        		jp	BFG662
                      	
                      	
                      	;input: bc=x1, de=y1, (GRPX2)=x2, (GRPY2)=y2,
                      	; (ATTDAT)=attribute1, (ATTDAT2)=attribute2
                      	;destroy: af,bc,de
  7122                	_LINEB66:ds	LINEB66-_LINEB66
  7122                		org	LINEB66
                      	
  7122  C3352E        		jp	LINEB
                      	
                      	
                      	
                      	;PAINT command for mode 5
                      	;C_PAIN66	equ	714ch
                      	;_C_PAIN66:ds	C_PAIN66-_C_PAIN66
                      	;	org	C_PAIN66
                      	
  7125                	C_PAIN66:
  7125  CDEA2C        		call	GETGXY
  7128  C5            		push	bc		;X
  7129  D5            		push	de		;Y
  712A  3A93FD        		ld	a,(COLOR1)
  712D  2004          		jr	nz,PASETATT66
  712F  23            		inc	hl
  7130  CDE40D        		call	INT1ARG
  7133                	PASETATT66:
  7133  CDC015        		call	SETATT
  7136  7E            		ld	a,(hl)
  7137  FE2C          		cp	','
  7139  3AC6FE        		ld	a,(BORDERC)
  713C  2007          		jr	nz,PA66NZ
  713E  23            		inc	hl
  713F  CDE40D        		call	INT1ARG
  7142  32C6FE        		ld	(BORDERC),a
  7145                	PA66NZ:
  7145  CDF369        		call	SETBO66
                      	
  7148  D1            		pop	de		;Y
  7149  C1            		pop	bc		;X
                      	
                      	
                      	;input: bc=x, de=y, (ATTDAT)=attribute1, (ATTDAT2)=attribute2
                      	; (BORDERA)=attribute, (BORDERA2)=attribute2, (BORDERC)=color
                      	;destroy: af,bc,de
  714A                	_PAINT66:ds	PAINT66-_PAINT66
  716A                		org	PAINT66
                      	
  716A  CD426C        		call	CHKGXY66
  716D  3A92FD        		ld	a,(SCREEN1)
  7170  3D            		dec	a
  7171  C8            		ret	z		;screen mode 2
  7172  ED43B1FE      		ld	(GRPX3),bc
  7176  ED53B3FE      		ld	(GRPY3),de
  717A  E5            		push	hl
  717B  FA8671        		jp	m,PAINT661	;screen mode 1
  717E  CD1566        		call	GXY2GAD66
  7181                	PAMAIN66:
  7181  CD8D71        		call	PADWN66
  7184  E1            		pop	hl
  7185  C9            		ret
                      	
  7186                	PAINT661:
  7186  CD2E66        		call	GXY2AD66
  7189  16FF          		ld	d,0ffh
  718B  18F4          		jr	PAMAIN66
                      	
                      	
  718D                	PADWN66:
  718D  CD8072        		call	PALINE66
  7190  C8            		ret	z
                      	
  7191  E5            		push	hl		;address
  7192  D5            		push	de		;bit
  7193  ED4BB5FE      		ld	bc,(PAWRK)
  7197  C5            		push	bc
  7198  ED4BB1FE      		ld	bc,(GRPX3)
  719C  C5            		push	bc
  719D  3AB3FE        		ld	a,(GRPY3)
  71A0  F5            		push	af
                      	
  71A1  CD2A72        		call	PAUP662
                      	
  71A4  F1            		pop	af
  71A5  32B3FE        		ld	(GRPY3),a
  71A8  E1            		pop	hl
  71A9  22B1FE        		ld	(GRPX3),hl
  71AC  E1            		pop	hl
  71AD  22B5FE        		ld	(PAWRK),hl
  71B0  D1            		pop	de		;bit
  71B1  E1            		pop	hl		;address
                      	
  71B2                	PADWN662:
  71B2  D5            		push	de
  71B3  CD916C        		call	INCGY66
  71B6  7B            		ld	a,e
  71B7  D1            		pop	de
  71B8  FEC8          		cp	200
  71BA  D0            		ret	nc
                      	
  71BB  012800        		ld	bc,CLMN66
  71BE  09            		add	hl,bc
  71BF  CDCE72        		call	READVRAM
                      	
  71C2  AF            		xor	a
  71C3  32B7FE        		ld	(PACNT),a
                      	
  71C6                	PADWN66LP1:
  71C6  CD5373        		call	SRCHOK66
  71C9  381C          		jr	c,CALLDWN66
                      	
  71CB  ED4BB1FE      		ld	bc,(GRPX3)
  71CF  C5            		push	bc
  71D0  ED4BB3FE      		ld	bc,(GRPY3)
  71D4  C5            		push	bc
                      	
  71D5  E5            		push	hl
  71D6  D5            		push	de
  71D7  21B7FE        		ld	hl,PACNT
  71DA  34            		inc	(hl)
  71DB  CDEA34        		call	CHKFRE
  71DE  D1            		pop	de
  71DF  E1            		pop	hl
                      	
  71E0  E5            		push	hl		;address
  71E1  D5            		push	de		;bit
                      	
  71E2  CD6273        		call	SRCHNG66
  71E5  30DF          		jr	nc,PADWN66LP1
                      	
  71E7                	CALLDWN66:
  71E7  3AB7FE        		ld	a,(PACNT)
  71EA  B7            		or	a
  71EB  C8            		ret	z
                      	
  71EC                	PADWN66LP2:
  71EC  D1            		pop	de		;bit
  71ED  E1            		pop	hl		;address
  71EE  C1            		pop	bc
  71EF  ED43B3FE      		ld	(GRPY3),bc
  71F3  C1            		pop	bc
  71F4  ED43B1FE      		ld	(GRPX3),bc
                      	
  71F8  3D            		dec	a
  71F9  32B7FE        		ld	(PACNT),a
  71FC  288F          		jr	z,PADWN66
  71FE  F5            		push	af
  71FF  CD8D71        		call	PADWN66
  7202  F1            		pop	af
  7203  18E7          		jr	PADWN66LP2
                      	
                      	
  7205                	PAUP66:
  7205  CD8072        		call	PALINE66
  7208  C8            		ret	z
                      	
  7209  E5            		push	hl		;address
  720A  D5            		push	de		;bit
  720B  ED4BB5FE      		ld	bc,(PAWRK)
  720F  C5            		push	bc
  7210  ED4BB1FE      		ld	bc,(GRPX3)
  7214  C5            		push	bc
  7215  3AB3FE        		ld	a,(GRPY3)
  7218  F5            		push	af
                      	
  7219  CDB271        		call	PADWN662
                      	
  721C  F1            		pop	af
  721D  32B3FE        		ld	(GRPY3),a
  7220  E1            		pop	hl
  7221  22B1FE        		ld	(GRPX3),hl
  7224  E1            		pop	hl
  7225  22B5FE        		ld	(PAWRK),hl
  7228  D1            		pop	de		;bit
  7229  E1            		pop	hl		;address
                      	
  722A                	PAUP662:
                      	;	ld	a,(GRPY3)
  722A  B7            		or	a
  722B  C8            		ret	z
                      	
  722C  CB6C          		bit	5,h
  722E  2002          		jr	nz,PAUP66NZ
  7230  D609          		sub	09h
  7232                	PAUP66NZ:
  7232  3D            		dec	a
  7233  32B3FE        		ld	(GRPY3),a
  7236  01D8FF        		ld	bc,0-CLMN66
  7239  09            		add	hl,bc
  723A  CDCE72        		call	READVRAM
                      	
  723D  AF            		xor	a
  723E  32B7FE        		ld	(PACNT),a
                      	
  7241                	PAUP66LP1:
  7241  CD5373        		call	SRCHOK66
  7244  381C          		jr	c,CALLUP66
                      	
  7246  ED4BB1FE      		ld	bc,(GRPX3)
  724A  C5            		push	bc
  724B  ED4BB3FE      		ld	bc,(GRPY3)
  724F  C5            		push	bc
                      	
  7250  E5            		push	hl
  7251  D5            		push	de
  7252  21B7FE        		ld	hl,PACNT
  7255  34            		inc	(hl)
  7256  CDEA34        		call	CHKFRE
  7259  D1            		pop	de
  725A  E1            		pop	hl
                      	
  725B  E5            		push	hl		;address
  725C  D5            		push	de		;bit
                      	
  725D  CD6273        		call	SRCHNG66
  7260  30DF          		jr	nc,PAUP66LP1
                      	
  7262                	CALLUP66:
  7262  3AB7FE        		ld	a,(PACNT)
  7265  B7            		or	a
  7266  C8            		ret	z
                      	
  7267                	PAUP66LP2:
  7267  D1            		pop	de		;bit
  7268  E1            		pop	hl		;address
  7269  C1            		pop	bc
  726A  ED43B3FE      		ld	(GRPY3),bc
  726E  C1            		pop	bc
  726F  ED43B1FE      		ld	(GRPX3),bc
                      	
  7273  3D            		dec	a
  7274  32B7FE        		ld	(PACNT),a
  7277  288C          		jr	z,PAUP66
  7279  F5            		push	af
  727A  CD0572        		call	PAUP66
  727D  F1            		pop	af
  727E  18E7          		jr	PAUP66LP2
                      	
                      	
  7280                	PALINE66:
  7280  CDCE72        		call	READVRAM
                      	
  7283  CD4D27        		call	STOPESC
  7286  CD1F73        		call	CHKPA66
  7289  C8            		ret	z
                      	
  728A  E5            		push	hl		;address
  728B  D5            		push	de		;bit
  728C  ED4BB1FE      		ld	bc,(GRPX3)
  7290  C5            		push	bc
                      	
  7291  CDEF72        		call	PAINTR66
  7294  2AB1FE        		ld	hl,(GRPX3)
  7297  22B5FE        		ld	(PAWRK),hl	;X_right
                      	
  729A  E1            		pop	hl
  729B  22B1FE        		ld	(GRPX3),hl
  729E  D1            		pop	de		;bit
  729F  E1            		pop	hl		;address
                      	
  72A0  CDCE72        		call	READVRAM
  72A3  CDA872        		call	PAINTL66
                      	
  72A6  B2            		or	d		;d>0, reset z-flag
  72A7  C9            		ret
                      	
                      	
                      	;paint to left direction for mode 5
                      	;input: hl=address, d=bit
                      	;output: hl,d
                      	;destroy: af,bc
  72A8                	PAINTL66:
  72A8  ED4BB1FE      		ld	bc,(GRPX3)
  72AC  78            		ld	a,b
  72AD  B1            		or	c
  72AE  C8            		ret	z
  72AF  CDF972        		call	DECGXPA66
  72B2  CD1F73        		call	CHKPA66
  72B5  20F1          		jr	nz,PAINTL66
                      	;	jp	INCGXPA66
                      	
                      	
                      	;increment x for paint for mode 5
                      	;input: hl=address, d=bit
                      	;output: hl, d, bc=(GRPX3)
                      	;destroy: af,bc
  72B7                	INCGXPA66:
  72B7  ED4BB1FE      		ld	bc,(GRPX3)
  72BB  CB6C          		bit	5,h
  72BD  2823          		jr	z,INCGXPA661	;screen mode 1
  72BF  03            		inc	bc
  72C0  CB0A          		rrc	d
  72C2  E2C872        		jp	po,INCGXPA664	;screen mode 4
  72C5  03            		inc	bc		;screen mode 3
  72C6  CB0A          		rrc	d
  72C8                	INCGXPA664:
  72C8  ED43B1FE      		ld	(GRPX3),bc
  72CC  D0            		ret	nc
                      	
  72CD  23            		inc	hl
                      	;	jr	READVRAM
                      	
                      	
                      	;read VRAM
                      	;input: hl=address
                      	;output: (PAWRK2),(PAWRK2+1)
                      	;destroy: af
  72CE                	READVRAM:
  72CE  CB6C          		bit	5,h
  72D0  C8            		ret	z
  72D1  CD8DFE        		call	READRAM
  72D4  32B8FE        		ld	(PAWRK2),a
  72D7  CBAC          		res	5,h
  72D9  CD8DFE        		call	READRAM
  72DC  CBEC          		set	5,h
  72DE  32B9FE        		ld	(PAWRK2+1),a
  72E1  C9            		ret
                      	
                      	
  72E2                	INCGXPA661:
  72E2  79            		ld	a,c
  72E3  C608          		add	a,08h
  72E5  4F            		ld	c,a
  72E6  3001          		jr	nc,INCGXPA661NC
  72E8  04            		inc	b
  72E9                	INCGXPA661NC:
  72E9  ED43B1FE      		ld	(GRPX3),bc
  72ED  23            		inc	hl
  72EE  C9            		ret
                      	
                      	
                      	;paint to right direction for mode 5
                      	;input: hl=address, d=bit
                      	;output: hl,d
                      	;destroy: af,bc
  72EF                	PAINTR66:
  72EF  CD7173        		call	GXLARGE66
  72F2  2805          		jr	z,DECGXPA66
  72F4  CD1F73        		call	CHKPA66
  72F7  20F6          		jr	nz,PAINTR66
                      	;	jp	DECGXPA66
                      	
                      	
                      	;decrement x for paint for mode 5
                      	;input: hl=address, d=bit
                      	;output: hl, d, bc=(GRPX3)
                      	;destroy: af
  72F9                	DECGXPA66:
  72F9  ED4BB1FE      		ld	bc,(GRPX3)
  72FD  CB6C          		bit	5,h
  72FF  2811          		jr	z,DECGXPA661	;screen mode 1
  7301  0B            		dec	bc
  7302  CB02          		rlc	d
  7304  E20A73        		jp	po,DECGXPA664	;screen mode 4
  7307  0D            		dec	c		;dec bc, screen mode3
  7308  CB02          		rlc	d
  730A                	DECGXPA664:
  730A  ED43B1FE      		ld	(GRPX3),bc
  730E  D0            		ret	nc
                      	
  730F  2B            		dec	hl
  7310  18BC          		jr	READVRAM
                      	
                      	
  7312                	DECGXPA661:
  7312  79            		ld	a,c
  7313  D608          		sub	08h
  7315  4F            		ld	c,a
  7316  3001          		jr	nc,DECGXPA661NC
  7318  05            		dec	b
  7319                	DECGXPA661NC:
  7319  ED43B1FE      		ld	(GRPX3),bc
  731D  2B            		dec	hl
  731E  C9            		ret
                      	
                      	
                      	;check and paint for mode 5
                      	;input: hl=address, d=bit
                      	;output: z(1=not painted)
                      	;destroy: af,e
  731F                	CHKPA66:
  731F  CDBC73        		call	CMPBOR66
  7322  C8            		ret	z
                      	
                      	;	ld	bc,(PAWRK2)
                      	
  7323  CB6C          		bit	5,h
  7325  281A          		jr	z,CHKPA661
                      	
  7327  3A60FE        		ld	a,(ATTDAT2)
  732A  A9            		xor	c
  732B  A2            		and	d
  732C  A9            		xor	c
  732D  32B8FE        		ld	(PAWRK2),a
  7330  77            		ld	(hl),a
                      	
  7331  3AACFE        		ld	a,(ATTDAT)
  7334  A8            		xor	b
  7335  A2            		and	d
  7336  A8            		xor	b
  7337  32B9FE        		ld	(PAWRK2+1),a
  733A  CBAC          		res	5,h
  733C  77            		ld	(hl),a
  733D  CBEC          		set	5,h
                      	
  733F  B2            		or	d		;d>0, reset z-flag
  7340  C9            		ret
                      	
                      	;screen mode 1
  7341                	CHKPA661:
  7341  CD8DFE        		call	READRAM
  7344  5F            		ld	e,a
  7345  3AACFE        		ld	a,(ATTDAT)
  7348  07            		rlca
  7349  07            		rlca
  734A  07            		rlca
  734B  07            		rlca
  734C  AB            		xor	e
  734D  E670          		and	70h
  734F  AB            		xor	e
  7350  77            		ld	(hl),a
  7351  B2            		or	d		;d>0, reset z-flag
  7352  C9            		ret
                      	
                      	
                      	;search for paintable area for mode 5
                      	;input: hl=address, d=bit
                      	;output: hl,d,c-flag(1=over,0=OK)
                      	;destroy: af,bc,e
  7353                	SRCHOK66:
  7353  CD7A73        		call	CMPPAX66
  7356  D8            		ret	c
  7357  CD8773        		call	CMPATT66
  735A  C0            		ret	nz
  735B  CD7173        		call	GXLARGE66
  735E  20F3          		jr	nz,SRCHOK66
  7360  37            		scf
  7361  C9            		ret
                      	
                      	
                      	;search for unpaintable area for mode 5
                      	;get unpaintable area
                      	;input: hl=address, d=bit
                      	;output: hl,d,c-flag(1=over,0=NG)
                      	;destroy: af,bc
  7362                	SRCHNG66:
  7362  CD7A73        		call	CMPPAX66
  7365  D8            		ret	c
  7366  CDBC73        		call	CMPBOR66
  7369  C8            		ret	z
  736A  CD7173        		call	GXLARGE66
  736D  20F3          		jr	nz,SRCHNG66
  736F  37            		scf
  7370  C9            		ret
                      	
                      	
                      	;increment x and compare graphic width (=320)
                      	;input: hl=address, d=bit
                      	;output: hl, d, bc=(GRPX3), z-flag(1=over)
                      	;destroy: af,bc
  7371                	GXLARGE66:
  7371  CDB772        		call	INCGXPA66
                      	;	ld	bc,(GRPX3)
  7374  05            		dec	b
  7375  C0            		ret	nz
  7376  79            		ld	a,c
  7377  FE40          		cp	320-256
  7379  C9            		ret
                      	
                      	
                      	;compare (GRPX3) to (PAWRK)
                      	;output: f
                      	;destroy: f,bc
  737A                	CMPPAX66:
  737A  E5            		push	hl
  737B  2AB5FE        		ld	hl,(PAWRK)
  737E  ED4BB1FE      		ld	bc,(GRPX3)
  7382  B7            		or	a
  7383  ED42          		sbc	hl,bc
  7385  E1            		pop	hl
  7386  C9            		ret
                      	
                      	
                      	;compare attribute and border color to VRAM
                      	;output: bc=(PAWRK2), z-flag(1=same), c-flag=0
  7387                	CMPATT66:
  7387  CB6C          		bit	5,h
  7389  2813          		jr	z,CMPATT661
  738B  ED4BB8FE      		ld	bc,(PAWRK2)
  738F  3A60FE        		ld	a,(ATTDAT2)
  7392  A9            		xor	c
  7393  A2            		and	d
  7394  202E          		jr	nz,CMPBOR662
  7396  3AACFE        		ld	a,(ATTDAT)
  7399  A8            		xor	b
  739A  A2            		and	d
  739B  C8            		ret	z
  739C  1826          		jr	CMPBOR662
                      	
                      	;screen mode 1
  739E                	CMPATT661:
  739E  CD8DFE        		call	READRAM
  73A1  5F            		ld	e,a
  73A2  3AACFE        		ld	a,(ATTDAT)
  73A5  07            		rlca
  73A6  07            		rlca
  73A7  07            		rlca
  73A8  07            		rlca
  73A9  AB            		xor	e
  73AA  E670          		and	70h
  73AC  C8            		ret	z
                      	
  73AD                	CMPBOR661:
  73AD  CD8DFE        		call	READRAM
  73B0  5F            		ld	e,a
  73B1  3AC5FE        		ld	a,(BORDERA)
  73B4  07            		rlca
  73B5  07            		rlca
  73B6  07            		rlca
  73B7  07            		rlca
  73B8  AB            		xor	e
  73B9  E670          		and	70h
  73BB  C9            		ret
                      	
                      	
                      	;compare border color to VRAM
                      	;output: bc=(PAWRK2), z-flag(1=same), c-flag=0
  73BC                	CMPBOR66:
  73BC  CB6C          		bit	5,h
  73BE  28ED          		jr	z,CMPBOR661
  73C0  ED4BB8FE      		ld	bc,(PAWRK2)
  73C4                	CMPBOR662:
  73C4  3A61FE        		ld	a,(BORDERA2)
  73C7  A9            		xor	c
  73C8  A2            		and	d
  73C9  C0            		ret	nz
                      	
  73CA  3AC5FE        		ld	a,(BORDERA)
  73CD  A8            		xor	b
  73CE  A2            		and	d
  73CF  C9            		ret
                      	
                      	
  73D0                	C_KANJ:
  73D0  3A92FD        		ld	a,(SCREEN1)
  73D3  FE02          		cp	02h
  73D5  DAED03        		jp	c,FCERR
                      	
  73D8  CDEA2C        		call	GETGXY
  73DB  C0            		ret	nz
                      	
  73DC  ED43ADFE      		ld	(GRPX2),bc
  73E0  ED53AFFE      		ld	(GRPY2),de
                      	
  73E4  3A93FD        		ld	a,(COLOR1)
  73E7  CDC015        		call	SETATT
                      	
  73EA  CD593F        		call	SKIPSPINC
  73ED  224EFF        		ld	(PROGAD),hl
  73F0  FE2C          		cp	','
  73F2  280A          		jr	z,KANJLP1
                      	
  73F4  CDE40D        		call	INT1ARG
  73F7  CDC015        		call	SETATT
  73FA  7E            		ld	a,(hl)
  73FB  FE2C          		cp	','
  73FD  C0            		ret	nz
                      	
  73FE                	KANJLP1:
  73FE  CD593F        		call	SKIPSPINC
  7401  224EFF        		ld	(PROGAD),hl
  7404  FE2C          		cp	','
  7406  28F6          		jr	z,KANJLP1
                      	
  7408  CD613F        		call	CHKCLN
  740B  C8            		ret	z
                      	
  740C  CD6617        		call	ARG
  740F  3A25FF        		ld	a,(ARGTYP)
  7412  3D            		dec	a
  7413  284D          		jr	z,KANJSTR
  7415  F2E403        		jp	p,SNERR
                      	
  7418                	KANJNUM:
  7418  CDB10C        		call	FTOI
                      	
                      	;check extkanji
  741B  210000        		ld	hl,0000h
  741E  CD6775        		call	READEKROM
  7421  7C            		ld	a,h
  7422  B5            		or	l
  7423  CABE74        		jp	z,KANJEXT
                      	
  7426  1B            		dec	de
  7427  EB            		ex	de,hl
  7428  010004        		ld	bc,0400h
  742B  B7            		or	a
  742C  ED42          		sbc	hl,bc
  742E  D2ED03        		jp	nc,FCERR
  7431  09            		add	hl,bc
                      	
  7432  29            		add	hl,hl		;*2
  7433  29            		add	hl,hl		;*4
  7434  29            		add	hl,hl		;*8
  7435  29            		add	hl,hl		;*16
                      	
  7436  0610          		ld	b,10h
  7438                	KANJLP2:
  7438  C5            		push	bc
  7439  E5            		push	hl		;kanji ROM address
  743A  CD4975        		call	READKROM
  743D  CD7D75        		call	CALLPUTHL
  7440  E1            		pop	hl
  7441  23            		inc	hl		;kanji ROM address
  7442  C1            		pop	bc
  7443  10F3          		djnz	KANJLP2
                      	
  7445                	KLP2END:
  7445  2AADFE        		ld	hl,(GRPX2)
  7448  111000        		ld	de,0010h
  744B  19            		add	hl,de
  744C  3A92FD        		ld	a,(SCREEN1)
  744F  0F            		rrca
  7450  3801          		jr	c,KNUMC		;screen mode 4
  7452  19            		add	hl,de		;screen mode 3
  7453                	KNUMC:
  7453  22ADFE        		ld	(GRPX2),hl
                      	
  7456                	KNEXT:
  7456  2AB0FD        		ld	hl,(GRPY1)
  7459  22AFFE        		ld	(GRPY2),hl
                      	
  745C  2A4EFF        		ld	hl,(PROGAD)
  745F  2B            		dec	hl
  7460  189C          		jr	KANJLP1
                      	
                      	;string
  7462                	KANJSTR:
  7462  2AAFFE        		ld	hl,(GRPY2)
  7465  110600        		ld	de,0006h
  7468  19            		add	hl,de
  7469  22AFFE        		ld	(GRPY2),hl
                      	
  746C  2A67FF        		ld	hl,(FAC1+1)
  746F  4E            		ld	c,(hl)
                      	
  7470  23            		inc	hl
  7471  23            		inc	hl
  7472  46            		ld	b,(hl)
  7473  23            		inc	hl
  7474  66            		ld	h,(hl)
  7475  68            		ld	l,b
                      	
  7476                	KANJLP3:
  7476  79            		ld	a,c
  7477  B7            		or	a
  7478  28DC          		jr	z,KNEXT
                      	
  747A  7E            		ld	a,(hl)
  747B  FE14          		cp	14h
  747D  2007          		jr	nz,KSTRNZ
  747F  0D            		dec	c
  7480  28D4          		jr	z,KNEXT
  7482  23            		inc	hl
  7483  7E            		ld	a,(hl)
  7484  D630          		sub	30h
  7486                	KSTRNZ:
  7486  E5            		push	hl		;string address
  7487  CDA014        		call	CGROM
                      	
  748A  060A          		ld	b,0ah
  748C                	KANJLP4:
  748C  C5            		push	bc
  748D  D5            		push	de		;CGROM address
  748E  CD2915        		call	READCGROM
                      	
  7491  62            		ld	h,d
  7492  2E00          		ld	l,00h
  7494  CD7D75        		call	CALLPUTHL
  7497  D1            		pop	de
  7498  13            		inc	de
  7499  C1            		pop	bc
  749A  10F0          		djnz	KANJLP4
                      	
  749C                	KLP4END:
  749C  2AADFE        		ld	hl,(GRPX2)
  749F  110800        		ld	de,0008h
  74A2  19            		add	hl,de
  74A3  3A92FD        		ld	a,(SCREEN1)
  74A6  0F            		rrca
  74A7  3E08          		ld	a,08h
  74A9  3801          		jr	c,KSTRC		;screen mode 4
  74AB  19            		add	hl,de		;screen mode 3
  74AC                	KSTRC:
  74AC  22ADFE        		ld	(GRPX2),hl
  74AF  2AB0FD        		ld	hl,(GRPY1)
  74B2  110600        		ld	de,0006h
  74B5  19            		add	hl,de
  74B6  22AFFE        		ld	(GRPY2),hl
                      	
  74B9  E1            		pop	hl		;string address
  74BA  23            		inc	hl
  74BB  0D            		dec	c
  74BC  18B8          		jr	KANJLP3
                      	
                      	
                      	;extended kanji ROM
  74BE                	KANJEXT:
  74BE  EB            		ex	de,hl
                      	
  74BF  112000        		ld	de,0020h
  74C2  E7            		rst	CPHLDE
  74C3  DAED03        		jp	c,FCERR
  74C6  110001        		ld	de,00ffh+1
  74C9  E7            		rst	CPHLDE
  74CA  385E          		jr	c,KEXT816
                      	
  74CC  110002        		ld	de,01ffh+1
  74CF  E7            		rst	CPHLDE
  74D0  3846          		jr	c,KEXT88
                      	
  74D2  112121        		ld	de,2121h
  74D5  E7            		rst	CPHLDE
  74D6  DAED03        		jp	c,FCERR
  74D9  117F27        		ld	de,277eh+1
  74DC  E7            		rst	CPHLDE
  74DD  3815          		jr	c,KEXT1616
                      	
  74DF  112130        		ld	de,3021h
  74E2  E7            		rst	CPHLDE
  74E3  DAED03        		jp	c,FCERR
  74E6  117F4F        		ld	de,4f7eh+1
  74E9  E7            		rst	CPHLDE
  74EA  D2ED03        		jp	nc,FCERR
                      	
                      	
                      	;hl=3021h-4f7eh
                      	;16x16 character
                      	;JIS level-1 kanji set
                      	;JIS    =0xxaaaaa 0bbccccc
                      	;address=bbaaaaac cccc0000
  74ED  7D            		ld	a,l
  74EE  AC            		xor	h
  74EF  E660          		and	60h
  74F1  AC            		xor	h
  74F2  1808          		jr	KEXT16162
                      	
                      	
                      	;hl=2120h-277eh
                      	;16x16 character
                      	;JIS    =00100aaa 0bbccccc
                      	;address=00bbaaac cccc0000
  74F4                	KEXT1616:
  74F4  CBAC          		res	5,h
  74F6  7D            		ld	a,l
  74F7  E660          		and	60h
  74F9  0F            		rrca
  74FA  0F            		rrca
  74FB  B4            		or	h
  74FC                	KEXT16162:
  74FC  67            		ld	h,a
                      	
  74FD  7D            		ld	a,l
  74FE  87            		add	a,a
  74FF  87            		add	a,a
  7500  87            		add	a,a
  7501  87            		add	a,a
  7502  6F            		ld	l,a
                      	
  7503  7C            		ld	a,h
  7504  8F            		adc	a,a
  7505  67            		ld	h,a
                      	
  7506  0610          		ld	b,10h
  7508                	KANJLP5:
  7508  C5            		push	bc
  7509  E5            		push	hl		;kanji ROM address
  750A  CD6775        		call	READEKROM
  750D  CD7D75        		call	CALLPUTHL
  7510  E1            		pop	hl
  7511  23            		inc	hl		;kanji ROM address
  7512  C1            		pop	bc
  7513  10F3          		djnz	KANJLP5
  7515  C34574        		jp	KLP2END
                      	
                      	
                      	;hl=100h-1ffh
                      	;8x8 character
  7518                	KEXT88:
  7518  7D            		ld	a,l
  7519  2AAFFE        		ld	hl,(GRPY2)
  751C  010800        		ld	bc,0008h
  751F  09            		add	hl,bc
  7520  22AFFE        		ld	(GRPY2),hl
  7523  6F            		ld	l,a
  7524  2602          		ld	h,02h
                      	
  7526  0604          		ld	b,04h
  7528  1803          		jr	KEXT8162
                      	
                      	;hl=20h-ffh
                      	;8x16 character
  752A                	KEXT816:
  752A  0608          		ld	b,08h
  752C  29            		add	hl,hl		;*2
  752D                	KEXT8162:
  752D  29            		add	hl,hl		;*4
  752E  29            		add	hl,hl		;*8
  752F                	KANJLP6:
  752F  C5            		push	bc
  7530  E5            		push	hl		;address
  7531  CD6775        		call	READEKROM
  7534  E5            		push	hl
  7535  2E00          		ld	l,00h
  7537  CD7D75        		call	CALLPUTHL
  753A  E1            		pop	hl
  753B  65            		ld	h,l
  753C  2E00          		ld	l,00h
  753E  CD7D75        		call	CALLPUTHL
  7541  E1            		pop	hl
  7542  23            		inc	hl		;kanji ROM address
  7543  C1            		pop	bc
  7544  10E9          		djnz	KANJLP6
  7546  C34574        		jp	KLP2END
                      	
                      	
                      	;read kanji ROM data
                      	;input: hl=address
                      	;output: h=left data, l=right data
                      	;destroy: none
  7549                	READKROM:
  7549  F5            		push	af
  754A  C5            		push	bc
  754B  3E03          		ld	a,03h
  754D  D3C3          		out	(0c3h),a	;port c2h direction: bit0,1=output
  754F  3E12          		ld	a,12h
  7551  F3            		di
  7552  D3F0          		out	(0f0h),a	;0000-3fff:voice/kanji ROM
  7554  3E01          		ld	a,01h
  7556  D3C2          		out	(0c2h),a	;kanji left
  7558  46            		ld	b,(hl)
  7559  3E03          		ld	a,03h
  755B  D3C2          		out	(0c2h),a	;kanji right
  755D  6E            		ld	l,(hl)
  755E  3E11          		ld	a,11h
  7560  D3F0          		out	(0f0h),a	;0000-7fff:BASIC ROM
  7562  FB            		ei
  7563  60            		ld	h,b
  7564  C1            		pop	bc
  7565  F1            		pop	af
  7566  C9            		ret
                      	
                      	
                      	;read extended kanji ROM data
                      	;input: hl=address
                      	;output: h=left data, l=right data
                      	;destroy: none
  7567                	READEKROM:
  7567  F5            		push	af
  7568  C5            		push	bc
  7569  45            		ld	b,l
  756A  0EFC          		ld	c,0fch
  756C  ED61          		out	(c),h
  756E  AF            		xor	a
  756F  D3FF          		out	(0ffh),a
  7571  0C            		inc	c
  7572  ED60          		in	h,(c)		;c=fdh
  7574  0C            		inc	c
  7575  ED68          		in	l,(c)		;c=feh
  7577  3D            		dec	a
  7578  D3FF          		out	(0ffh),a	;a=ffh
  757A  C1            		pop	bc
  757B  F1            		pop	af
  757C  C9            		ret
                      	
                      	
                      	;check Y, call PUTHL, increment Y
                      	;input: h,l=data, (GRPX2),(GRPY2),(ATTDAT),(ATTDAT2)
                      	;destroy: af,bc,de,hl
  757D                	CALLPUTHL:
  757D  E5            		push	hl
  757E  21C700        		ld	hl,199
  7581  ED5BAFFE      		ld	de,(GRPY2)
  7585  E7            		rst	CPHLDE
  7586  E1            		pop	hl
  7587  D8            		ret	c
  7588  ED4BADFE      		ld	bc,(GRPX2)
  758C  CD9575        		call	PUTHL
  758F  13            		inc	de
  7590  ED53AFFE      		ld	(GRPY2),de
  7594  C9            		ret
                      	
                      	
                      	;put 2-byte data in graphic mode (screen mode 3,4)
                      	;input: bc=x, de=y,h,l=data, (ATTDAT),(ATTDAT2)
                      	;output: bc=bc+16or32
                      	;destroy: af,hl
  7595                	PUTHL:
  7595  ED43B1FE      		ld	(GRPX3),bc
  7599  ED53B3FE      		ld	(GRPY3),de
                      	
  759D  E5            		push	hl		;
                      	
                      	;check y range
  759E  CB7A          		bit	7,d
  75A0  C2ED03        		jp	nz,FCERR
  75A3  21C700        		ld	hl,199
  75A6  E7            		rst	CPHLDE
  75A7  3001          		jr	nc,PUTHLYOK
  75A9  EB            		ex	de,hl
  75AA                	PUTHLYOK:
                      	
                      	;check x range
  75AA  CB78          		bit	7,b
  75AC  2806          		jr	z,PUTHLXOK
  75AE  0600          		ld	b,00h
  75B0  79            		ld	a,c
  75B1  E607          		and	07h
  75B3  4F            		ld	c,a
                      	
  75B4                	PUTHLXOK:
  75B4  CD1866        		call	GXY2GAD662
  75B7  44            		ld	b,h
  75B8  4D            		ld	c,l
  75B9  E1            		pop	hl		;
                      	
                      	;h-l -> d-h-l (left justified)
  75BA  3A92FD        		ld	a,(SCREEN1)
  75BD  0F            		rrca
  75BE  7A            		ld	a,d
  75BF  1600          		ld	d,00h
  75C1  3037          		jr	nc,PUTHL3
                      	
  75C3                	PUTHLLP1:
  75C3  29            		add	hl,hl
  75C4  CB12          		rl	d
  75C6  0F            		rrca
  75C7  30FA          		jr	nc,PUTHLLP1
                      	
  75C9  7D            		ld	a,l
  75CA  F5            		push	af
  75CB  E5            		push	hl
  75CC  D5            		push	de
                      	
  75CD  60            		ld	h,b
  75CE  69            		ld	l,c
                      	
  75CF  0603          		ld	b,03h
  75D1                	PUTHLLP2:
  75D1  E5            		push	hl
  75D2  2AB1FE        		ld	hl,(GRPX3)	;start x
  75D5  114001        		ld	de,320
  75D8  E7            		rst	CPHLDE
  75D9  110800        		ld	de,0008h
  75DC  F5            		push	af
  75DD  19            		add	hl,de
  75DE  F1            		pop	af
  75DF  22B1FE        		ld	(GRPX3),hl
  75E2  E1            		pop	hl
                      	
  75E3  D1            		pop	de
                      	
  75E4  3004          		jr	nc,PUTHLNC
  75E6  CDA566        		call	PUT466
  75E9  23            		inc	hl
  75EA                	PUTHLNC:
  75EA  10E5          		djnz	PUTHLLP2
                      	
  75EC  2AB1FE        		ld	hl,(GRPX3)
  75EF  11F8FF        		ld	de,0-0008h
  75F2  19            		add	hl,de
  75F3  44            		ld	b,h
  75F4  4D            		ld	c,l
  75F5  ED5BB3FE      		ld	de,(GRPY3)
  75F9  C9            		ret
                      	
                      	
                      	;for screen mode 3
  75FA                	PUTHL3:
                      	;h-l -> d-h-l (left justified)
  75FA                	PUTHLLP3:
  75FA  29            		add	hl,hl
  75FB  CB12          		rl	d
  75FD  0F            		rrca
  75FE  0F            		rrca
  75FF  30F9          		jr	nc,PUTHLLP3
                      	
  7601  7D            		ld	a,l
  7602  CD2876        		call	STRETCH
  7605  F5            		push	af
  7606  7D            		ld	a,l
  7607  0F            		rrca
  7608  0F            		rrca
  7609  0F            		rrca
  760A  0F            		rrca
  760B  CD2876        		call	STRETCH
  760E  F5            		push	af
                      	
  760F  7C            		ld	a,h
  7610  CD2876        		call	STRETCH
  7613  F5            		push	af
  7614  7C            		ld	a,h
  7615  0F            		rrca
  7616  0F            		rrca
  7617  0F            		rrca
  7618  0F            		rrca
  7619  CD2876        		call	STRETCH
  761C  F5            		push	af
                      	
  761D  7A            		ld	a,d
  761E  CD2876        		call	STRETCH
  7621  F5            		push	af
                      	
  7622  60            		ld	h,b
  7623  69            		ld	l,c
                      	
  7624  0605          		ld	b,05h
  7626  18A9          		jr	PUTHLLP2
                      	
  7628                	STRETCH:
  7628  D5            		push	de
  7629  57            		ld	d,a
  762A  1E04          		ld	e,04h
  762C                	STRETCHLP:
  762C  CB0A          		rrc	d
  762E  1F            		rra
  762F  07            		rlca
  7630  0F            		rrca
  7631  1F            		rra
  7632  1D            		dec	e
  7633  20F7          		jr	nz,STRETCHLP
  7635  D1            		pop	de
  7636  C9            		ret
                      	
                      	
                      	;TALK command
  7637                	C_TALK:
                      	
                      	;for N66 voicerom
  7637  3EC9          		ld	a,0c9h
  7639  3266FE        		ld	(0fe66h),a
                      	
                      	;	call	STRARG
                      	
  763C  CD613F        		call	CHKCLN
  763F  C8            		ret	z
  7640  CD8F26        		call	STRARG3
                      	
  7643  216176        		ld	hl,TALKRET
  7646  E5            		push	hl
  7647  2198FE        		ld	hl,CHGROM
  764A  E5            		push	hl
  764B  210040        		ld	hl,TALK
  764E  E5            		push	hl
  764F  EB            		ex	de,hl		;hl=string address
  7650  5F            		ld	e,a		;e=length
  7651  F5            		push	af		;dummy for OUTF0H
                      	
  7652  3E03          		ld	a,03h
  7654  D3C3          		out	(0c3h),a	;port c2h direction: bit0,1=output
  7656  AF            		xor	a
  7657  D3C2          		out	(0c2h),a	;bit0=0:VOICE ROM
  7659  3E21          		ld	a,21h		;0000-3fff:BASIC ROM, 4000-7fff:VOICE ROM
                      	
                      	;for N66 voicerom
  765B  3264FE        		ld	(PORTF0H),a
                      	
  765E  C3A1FE        		jp	OUTF0H
                      	
  7661                	TALKRET:
  7661  FE20          		cp	20h
  7663  C2ED03        		jp	nz,FCERR
                      	
  7666  C9            		ret
                      	
                      	
  7667                	C_MON:
  7667  ED7B5BFA      		ld	sp,(STACK)
                      	
  766B  F5            		push	af		;for Dezeni Land
  766C  F5            		push	af		;for Dezeni Land
                      	
  766D  3E41          		ld	a,41h
  766F  320EFD        		ld	(MONFLG),a
  7672  210000        		ld	hl,0000h
  7675  39            		add	hl,sp
  7676  2204FD        		ld	(REGSP),hl
                      	
  7679  3EC3          		ld	a,0c3h
  767B  32E1FF        		ld	(HOOK38H),a
  767E  219377        		ld	hl,MONBRK
  7681  22E2FF        		ld	(HOOK38H+1),hl
  7684  21E860        		ld	hl,REGDATA
  7687  11F9FC        		ld	de,REGF
  768A  010800        		ld	bc,0008h
  768D  EDB0          		ldir
                      	
  768F                	MONLP1:
  768F  21FF76        		ld	hl,READY
  7692  CD787E        		call	MPUTS
  7695                	MONLP2:
  7695  CD427E        		call	GETPUTC
  7698  21B476        		ld	hl,MONTBL1
  769B  11C476        		ld	de,MONTBL2
  769E  0610          		ld	b,10h
  76A0                	MONLP3:
  76A0  BE            		cp	(hl)
  76A1  2807          		jr	z,MONCALL
  76A3  23            		inc	hl
  76A4  13            		inc	de
  76A5  13            		inc	de
  76A6  10F8          		djnz	MONLP3
  76A8  1841          		jr	MONERR
                      	
  76AA                	MONCALL:
  76AA  EB            		ex	de,hl
  76AB  5E            		ld	e,(hl)
  76AC  23            		inc	hl
  76AD  56            		ld	d,(hl)
  76AE  EB            		ex	de,hl
  76AF  CDA507        		call	JPHL
  76B2  18DB          		jr	MONLP1
                      	
  76B4                	MONTBL1:
  76B4  4243444546474C		db	'B',  'C',  'D',  'E',  'F',  'G',  'L',  'M'
  76BC  5051525357583F		db	'P',  'Q',  'R',  'S',  'W',  'X',  '?',  03h
  76C4                	MONTBL2:
  76C4  0977DF77247857		dw	MONB, MONC, MOND, MONE, MONF, MONG, MONL, MONM
  76D4  707BEC7BCB7823		dw	MONP, MONQ, MONR, MONS, MONW, MONX, MONQMARK, MONSTOP
                      	
  76E4                	MONQMARK:
  76E4  210EFD        		ld	hl,MONFLG
  76E7  7E            		ld	a,(hl)
  76E8  EE40          		xor	40h
  76EA  77            		ld	(hl),a
                      	;	jr	MONERR
                      	
  76EB                	MONERR:
  76EB  21F876        		ld	hl,MONERRSTR
  76EE  CD787E        		call	MPUTS
  76F1  2A04FD        		ld	hl,(REGSP)
  76F4  F9            		ld	sp,hl
  76F5  C39576        		jp	MONLP2
                      	
  76F8                	MONERRSTR:
  76F8  4552524F52213F		db	"ERROR!?"
                      	
  76FF                	READY:
  76FF  0D0A5245414459		db	0dh, 0ah, "READY", 0dh, 0ah, 00h
                      	
                      	
                      	;MON B command
  7709                	MONB:
  7709  3E2D          		ld	a,'-'
  770B  CD887E        		call	MPUTC
  770E  CD427E        		call	GETPUTC
  7711  282A          		jr	z,MONBASIC
  7713  FE52          		cp	'R'
  7715  2806          		jr	z,MONBR
  7717  FE47          		cp	'G'
  7719  2829          		jr	z,MONBG
  771B  18CE          		jr	MONERR
                      	
  771D                	MONBR:
  771D  2A5FFA        		ld	hl,(STARTAD)
  7720  54            		ld	d,h
  7721  5D            		ld	e,l
  7722  13            		inc	de
  7723  13            		inc	de
  7724  13            		inc	de
  7725                	MONBRLP1:
  7725  13            		inc	de
  7726  1A            		ld	a,(de)
  7727  B7            		or	a
  7728  20FB          		jr	nz,MONBRLP1
  772A  13            		inc	de
  772B  73            		ld	(hl),e
  772C  23            		inc	hl
  772D  72            		ld	(hl),d
  772E                	MONBRLP2:
  772E  EB            		ex	de,hl		;hl=link pointer address
  772F  5E            		ld	e,(hl)
  7730  23            		inc	hl
  7731  56            		ld	d,(hl)
  7732  7A            		ld	a,d
  7733  B3            		or	e
  7734  20F8          		jr	nz,MONBRLP2
  7736  23            		inc	hl
  7737  2256FF        		ld	(VARAD),hl
  773A  CDF934        		call	RESSTK
                      	
  773D                	MONBASIC:
  773D  ED7B5BFA      		ld	sp,(STACK)
  7741  C34204        		jp	edit
                      	
  7744                	MONBG:
  7744  210000        		ld	hl,0000h
  7747  2206FD        		ld	(BRKADR1),hl
  774A  2209FD        		ld	(BRKADR2),hl
  774D  CD427E        		call	GETPUTC
  7750  FE0D          		cp	0dh
  7752  2836          		jr	z,MONBGRUN
  7754  FE2C          		cp	','
  7756  2805          		jr	z,MONBGZ1
  7758  FE20          		cp	' '
  775A  C2EB76        		jp	nz,MONERR
  775D                	MONBGZ1:
  775D  3E2D          		ld	a,'-'
  775F  CD887E        		call	MPUTC
  7762  CD0F7E        		call	GETHEX
  7765  EB            		ex	de,hl		;
  7766  FE0D          		cp	0dh
  7768  2816          		jr	z,MONBGZ
                      	
  776A  3E2D          		ld	a,'-'
  776C  CD887E        		call	MPUTC
  776F  CD0F7E        		call	GETHEX
  7772  FE0D          		cp	0dh
  7774  C2EB76        		jp	nz,MONERR
  7777  2209FD        		ld	(BRKADR2),hl
  777A  7E            		ld	a,(hl)
  777B  320BFD        		ld	(BRKSAV2),a
  777E  36FF          		ld	(hl),0ffh
  7780                	MONBGZ:
  7780  EB            		ex	de,hl		;
  7781  2206FD        		ld	(BRKADR1),hl
  7784  7E            		ld	a,(hl)
  7785  3208FD        		ld	(BRKSAV1),a
  7788  36FF          		ld	(hl),0ffh
                      	
  778A                	MONBGRUN:
  778A  CDF934        		call	RESSTK
  778D  2A5FFA        		ld	hl,(STARTAD)
  7790  C3FB06        		jp	RUNLP
                      	
  7793                	MONBRK:
  7793  ED7304FD      		ld	(REGSP),sp
  7797  F3            		di
  7798  3102FD        		ld	sp,REGPC
  779B  E5            		push	hl
  779C  D5            		push	de
  779D  C5            		push	bc
  779E  F5            		push	af
  779F  ED7B04FD      		ld	sp,(REGSP)
  77A3  FB            		ei
                      	
  77A4  21D177        		ld	hl,BRKSTR
  77A7  CD787E        		call	MPUTS
  77AA  E1            		pop	hl
  77AB  2B            		dec	hl
  77AC  2202FD        		ld	(REGPC),hl
  77AF  CDE07D        		call	PUTHEX4
  77B2  CD817E        		call	MPUTNL
                      	
  77B5  2A06FD        		ld	hl,(BRKADR1)
  77B8  7C            		ld	a,h
  77B9  B5            		or	l
  77BA  2804          		jr	z,NOBRK1
  77BC  3A08FD        		ld	a,(BRKSAV1)
  77BF  77            		ld	(hl),a
  77C0                	NOBRK1:
  77C0  2A09FD        		ld	hl,(BRKADR2)
  77C3  7C            		ld	a,h
  77C4  B5            		or	l
  77C5  2804          		jr	z,NOBRK2
  77C7  3A0BFD        		ld	a,(BRKSAV2)
  77CA  77            		ld	(hl),a
  77CB                	NOBRK2:
  77CB  CDF934        		call	RESSTK
  77CE  C39576        		jp	MONLP2
                      	
  77D1                	BRKSTR:
  77D1  425245414B2121		db	"BREAK!! ADDR=", 00h
                      	
                      	
                      	;MON C command
  77DF                	MONC:
  77DF  CD817E        		call	MPUTNL
  77E2  210EFD        		ld	hl,MONFLG
  77E5  7E            		ld	a,(hl)
  77E6  CB6F          		bit	5,a
  77E8  2009          		jr	nz,MONCNZ		;printer on?
  77EA  F620          		or	20h
  77EC  77            		ld	(hl),a
  77ED  210C78        		ld	hl,PRTON
  77F0  C3787E        		jp	MPUTS
                      	
  77F3                	MONCNZ:
  77F3  0F            		rrca
  77F4  300C          		jr	nc,MONCNC		;printer only?
  77F6  3F            		ccf
  77F7  17            		rla
  77F8  77            		ld	(hl),a
  77F9  CD8111        		call	CSROFF
  77FC  211378        		ld	hl,PRTONLY
  77FF  C3787E        		jp	MPUTS
                      	
  7802                	MONCNC:
  7802  07            		rlca
  7803  EE21          		xor	21h
  7805  77            		ld	(hl),a
  7806  211C78        		ld	hl,PRTOFF
  7809  C3787E        		jp	MPUTS
                      	
  780C                	PRTON:
  780C  505254204F4E00		db	'PRT ON', 00h
  7813                	PRTONLY:
  7813  505254204F4E4C		db	'PRT ONLY', 00h
  781C                	PRTOFF:
  781C  505254204F4646		db	'PRT OFF', 00h
                      	
                      	
                      	;MON D command
  7824                	MOND:
  7824  CDF87D        		call	GETHEX2
  7827  EB            		ex	de,hl
                      	
                      	;hl...de
  7828                	MONDLP1:
  7828  3E20          		ld	a,' '
  782A  CD887E        		call	MPUTC
  782D  CDE07D        		call	PUTHEX4
  7830  3E3A          		ld	a,':'
  7832  CD887E        		call	MPUTC
                      	
  7835                	MONDLP2:
  7835  3E20          		ld	a,' '
  7837  CD887E        		call	MPUTC
  783A  3A0EFD        		ld	a,(MONFLG)
  783D  E640          		and	40h
  783F  7E            		ld	a,(hl)
  7840  C48DFE        		call	nz,READRAM
  7843  CDE57D        		call	PUTHEX2
  7846  E7            		rst	CPHLDE
  7847  300B          		jr	nc,MONDEND
  7849  23            		inc	hl
  784A  7D            		ld	a,l
  784B  E607          		and	07h
  784D  20E6          		jr	nz,MONDLP2
  784F  CD817E        		call	MPUTNL
  7852  18D4          		jr	MONDLP1
                      	
  7854                	MONDEND:
  7854  C3817E        		jp	MPUTNL
                      	
                      	
                      	;MON E command
  7857                	MONE:
  7857  CD817E        		call	MPUTNL
  785A  210EFD        		ld	hl,MONFLG
  785D  7E            		ld	a,(hl)
  785E  EE10          		xor	10h
  7860  77            		ld	(hl),a
  7861  E610          		and	10h
  7863  216E78        		ld	hl,ECHOON
  7866  2003          		jr	nz,MONENZ
  7868  217678        		ld	hl,ECHOOFF
  786B                	MONENZ:
  786B  C3787E        		jp	MPUTS
                      	
  786E                	ECHOON:
  786E  4543484F204F4E		db	"ECHO ON", 00h
  7876                	ECHOOFF:
  7876  4543484F204F46		db	"ECHO OFF", 00h
                      	
                      	
                      	;MON F command
  787F                	MONF:
  787F  CD067E        		call	GETHEX1
  7882  CAEB76        		jp	z,MONERR
  7885  E5            		push	hl		;hl=start
                      	
  7886  CDF87D        		call	GETHEX2
  7889  4D            		ld	c,l		;c=data
  788A  E1            		pop	hl
  788B                	MONFLP:
  788B  71            		ld	(hl),c
  788C  E7            		rst	CPHLDE
  788D  D0            		ret	nc
  788E  23            		inc	hl
  788F  18FA          		jr	MONFLP
                      	
                      	
                      	;MON G command
  7891                	MONG:
  7891  210000        		ld	hl,0000h
  7894  2206FD        		ld	(BRKADR1),hl
  7897  2209FD        		ld	(BRKADR2),hl
  789A  CD0F7E        		call	GETHEX
  789D  EB            		ex	de,hl		;
  789E  FE0D          		cp	0dh
  78A0  2827          		jr	z,MONGZ
  78A2  3E2D          		ld	a,'-'
  78A4  CD887E        		call	MPUTC
  78A7  CD067E        		call	GETHEX1
  78AA  2206FD        		ld	(BRKADR1),hl
  78AD  7E            		ld	a,(hl)
  78AE  3208FD        		ld	(BRKSAV1),a
  78B1  36FF          		ld	(hl),0ffh
  78B3  2814          		jr	z,MONGZ
  78B5  3E2D          		ld	a,'-'
  78B7  CD887E        		call	MPUTC
  78BA  CD067E        		call	GETHEX1
  78BD  C2EB76        		jp	nz,MONERR
  78C0  2209FD        		ld	(BRKADR2),hl
  78C3  7E            		ld	a,(hl)
  78C4  320BFD        		ld	(BRKSAV2),a
  78C7  36FF          		ld	(hl),0ffh
                      	
  78C9                	MONGZ:
  78C9  EB            		ex	de,hl		;
  78CA  E9            		jp	(hl)
                      	
                      	
                      	;MON L/R command
  78CB                	MONL:
  78CB                	MONR:
  78CB  2F            		cpl
  78CC  210EFD        		ld	hl,MONFLG
  78CF  AE            		xor	(hl)
  78D0  E608          		and	08h		;'L'->00h, 'R'->08h
  78D2  AE            		xor	(hl)
  78D3  77            		ld	(hl),a
                      	
  78D4  EB            		ex	de,hl
  78D5  3E2D          		ld	a,'-'
  78D7  CD887E        		call	MPUTC
  78DA  CD067E        		call	GETHEX1
  78DD  C2EB76        		jp	nz,MONERR
  78E0  EB            		ex	de,hl
  78E1  D5            		push	de		;offset address
  78E2  C3F97A        		jp	LOADHEX
                      	
                      	
                      	;load Intel HEX data
                      	;used by CORRIDOR
                      	;input: (sp)=offset, (sp+2)=return address, (MONFLG)-b3(1:CMT,0:RS-232C)
  78E5                	_LOADHEX:ds	LOADHEX-_LOADHEX
  7AF9                		org	LOADHEX
                      	
  7AF9  CDB67D        		call	DUMMY		;just return
  7AFC  D1            		pop	de
  7AFD  CB5E          		bit	3,(hl)		;(MONFLG)
  7AFF  C49A25        		call	nz,INPOPN
  7B02                	MONRLP1:
  7B02  CD8D7D        		call	MGETDEV
  7B05  FE0D          		cp	0dh
  7B07  2040          		jr	nz,MONRERR
  7B09  CD8D7D        		call	MGETDEV
  7B0C  FE0A          		cp	0ah
  7B0E  2039          		jr	nz,MONRERR
  7B10  CD8D7D        		call	MGETDEV
  7B13  FE3A          		cp	':'
  7B15  2032          		jr	nz,MONRERR
  7B17  CD6C7D        		call	MDEVHEX2
  7B1A  2823          		jr	z,MONREND
  7B1C  47            		ld	b,a		;length
  7B1D  CD6C7D        		call	MDEVHEX2	;address (high)
  7B20  67            		ld	h,a
  7B21  CD6C7D        		call	MDEVHEX2	;address (low)
  7B24  6F            		ld	l,a
  7B25  19            		add	hl,de
  7B26  80            		add	a,b
  7B27  84            		add	a,h
  7B28  4F            		ld	c,a		;check sum=b+h+l+...
  7B29  CD6C7D        		call	MDEVHEX2	;record type
  7B2C  201B          		jr	nz,MONRERR
  7B2E                	MONRLP2:
  7B2E  CD6C7D        		call	MDEVHEX2
  7B31  77            		ld	(hl),a
  7B32  81            		add	a,c		;check sum
  7B33  4F            		ld	c,a
  7B34  23            		inc	hl
  7B35  10F7          		djnz	MONRLP2
                      	
  7B37  CD6C7D        		call	MDEVHEX2	;check sum
  7B3A  81            		add	a,c
  7B3B  200C          		jr	nz,MONRERR
  7B3D  18C3          		jr	MONRLP1
                      	
  7B3F                	MONREND:
  7B3F  CD8D7D        		call	MGETDEV
  7B42  FE1A          		cp	1ah
  7B44  20F9          		jr	nz,MONREND
  7B46  C3AA1A        		jp	RCLOSE
                      	
                      	;error for MON-R
  7B49                	MONRERR:
  7B49  CDAA1A        		call	RCLOSE
  7B4C  C3EB76        		jp	MONERR
                      	
                      	
                      	;MON M command
  7B4F                	MONM:
  7B4F  CD067E        		call	GETHEX1
  7B52  CAEB76        		jp	z,MONERR
                      	
  7B55  E5            		push	hl
  7B56  CDF87D        		call	GETHEX2
  7B59  44            		ld	b,h
  7B5A  4D            		ld	c,l
  7B5B  E1            		pop	hl
                      	
  7B5C  E7            		rst	CPHLDE
  7B5D  3801          		jr	c,MONMLP
  7B5F  EB            		ex	de,hl
                      	
  7B60                	MONMLP:
  7B60  3A0EFD        		ld	a,(MONFLG)
  7B63  E640          		and	40h
  7B65  7E            		ld	a,(hl)
  7B66  C48DFE        		call	nz,READRAM
  7B69  02            		ld	(bc),a
  7B6A  E7            		rst	CPHLDE
  7B6B  23            		inc	hl
  7B6C  03            		inc	bc
  7B6D  38F1          		jr	c,MONMLP
  7B6F  C9            		ret
                      	
                      	
                      	;MON P/W command
  7B70                	MONP:
  7B70                	MONW:
  7B70  D604          		sub	04h		;'P'->4ch, 'W'->53h
  7B72  E605          		and	05h		;04h, 01h
  7B74  0F            		rrca			;02h,80h
  7B75  F5            		push	af
                      	
  7B76  CDF87D        		call	GETHEX2
  7B79  E7            		rst	CPHLDE
  7B7A  DAEB76        		jp	c,MONERR
  7B7D  EB            		ex	de,hl		;hl=start address
                      	
  7B7E  F1            		pop	af		;'P'->02h, 'W'->80h
  7B7F  3258FA        		ld	(DEVICE),a
  7B82  DCA825        		call	c,PRTOPN
  7B85                	MONWLP1:
  7B85  3E0D          		ld	a,0dh
  7B87  CDC726        		call	PUTDEV
  7B8A  3E0A          		ld	a,0ah
  7B8C  CDC726        		call	PUTDEV
  7B8F  3E3A          		ld	a,':'
                      	
  7B91  0610          		ld	b,10h		;16 bytes
  7B93  CDC726        		call	PUTDEV
  7B96  78            		ld	a,b		;length
  7B97  CDCC7D        		call	PUTDEVHEX2
  7B9A  7C            		ld	a,h		;address (high)
  7B9B  CDCC7D        		call	PUTDEVHEX2
  7B9E  7D            		ld	a,l		;address (low)
  7B9F  CDCC7D        		call	PUTDEVHEX2
  7BA2  AF            		xor	a		;record type
  7BA3  CDCC7D        		call	PUTDEVHEX2
                      	
  7BA6  AF            		xor	a
  7BA7  90            		sub	b
  7BA8  94            		sub	h
  7BA9  95            		sub	l
  7BAA  4F            		ld	c,a		;check sum
  7BAB                	MONWLP2:
  7BAB  7E            		ld	a,(hl)
  7BAC  CDCC7D        		call	PUTDEVHEX2
  7BAF  79            		ld	a,c
  7BB0  96            		sub	(hl)
  7BB1  4F            		ld	c,a		;check sum
  7BB2  E7            		rst	CPHLDE
  7BB3  300D          		jr	nc,MONWEND
  7BB5  23            		inc	hl
  7BB6  10F3          		djnz	MONWLP2
  7BB8  79            		ld	a,c
  7BB9  CDCC7D        		call	PUTDEVHEX2
  7BBC  18C7          		jr	MONWLP1
                      	
  7BBE                	MONWLP3:
  7BBE  AF            		xor	a
  7BBF  CDCC7D        		call	PUTDEVHEX2
  7BC2                	MONWEND:
  7BC2  10FA          		djnz	MONWLP3
                      	
  7BC4  79            		ld	a,c
  7BC5  CDCC7D        		call	PUTDEVHEX2
  7BC8  3E0D          		ld	a,0dh
  7BCA  CDC726        		call	PUTDEV
  7BCD  3E0A          		ld	a,0ah
  7BCF  CDC726        		call	PUTDEV
  7BD2  3E3A          		ld	a,':'
  7BD4  CDC726        		call	PUTDEV
  7BD7  0608          		ld	b,08h
  7BD9                	MONWLP4:
  7BD9  AF            		xor	a
  7BDA  CDCC7D        		call	PUTDEVHEX2
  7BDD  10FA          		djnz	MONWLP4
  7BDF  3E1A          		ld	a,1ah
  7BE1  CDC726        		call	PUTDEV
  7BE4  CD061B        		call	WCLOSE
  7BE7  AF            		xor	a
  7BE8  3258FA        		ld	(DEVICE),a
  7BEB  C9            		ret
                      	
                      	
                      	;MON Q command
  7BEC                	MONQ:
  7BEC  CDF87D        		call	GETHEX2
  7BEF  EB            		ex	de,hl
                      	
                      	;hl...de
  7BF0                	MONQLP1:
  7BF0  3E20          		ld	a,' '
  7BF2  CD887E        		call	MPUTC
  7BF5  CDE07D        		call	PUTHEX4
  7BF8  3E3A          		ld	a,':'
  7BFA  CD887E        		call	MPUTC
  7BFD  3E20          		ld	a,' '
  7BFF  CD887E        		call	MPUTC
                      	
  7C02                	MONQLP2:
  7C02  3A0EFD        		ld	a,(MONFLG)
  7C05  E640          		and	40h
  7C07  7E            		ld	a,(hl)
  7C08  C48DFE        		call	nz,READRAM
                      	
  7C0B  FE20          		cp	20h
  7C0D  3002          		jr	nc,MONQNC
  7C0F  3E2E          		ld	a,'.'
  7C11                	MONQNC:
  7C11  CD887E        		call	MPUTC
  7C14  E7            		rst	CPHLDE
  7C15  D2817E        		jp	nc,MPUTNL
  7C18  23            		inc	hl
  7C19  7D            		ld	a,l
  7C1A  E60F          		and	0fh
  7C1C  20E4          		jr	nz,MONQLP2
  7C1E  CD817E        		call	MPUTNL
  7C21  18CD          		jr	MONQLP1
                      	
                      	
                      	;MON S command
  7C23                	MONS:
  7C23  CD067E        		call	GETHEX1
  7C26  C8            		ret	z
  7C27                	MONSLP:
  7C27  3A0EFD        		ld	a,(MONFLG)
  7C2A  E640          		and	40h
  7C2C  7E            		ld	a,(hl)
  7C2D  C48DFE        		call	nz,READRAM
  7C30  CDE57D        		call	PUTHEX2
  7C33  3E2D          		ld	a,'-'
  7C35  CD887E        		call	MPUTC
  7C38  EB            		ex	de,hl
  7C39  CD0F7E        		call	GETHEX
  7C3C  EB            		ex	de,hl
  7C3D  2001          		jr	nz,MONSNZ
  7C3F  73            		ld	(hl),e
  7C40                	MONSNZ:
  7C40  FE0D          		cp	0dh
  7C42  C8            		ret	z
  7C43  23            		inc	hl
  7C44  7D            		ld	a,l
  7C45  E60F          		and	0fh
  7C47  20DE          		jr	nz,MONSLP
  7C49  CD817E        		call	MPUTNL
  7C4C  CDE07D        		call	PUTHEX4
  7C4F  3E3A          		ld	a,':'
  7C51  CD887E        		call	MPUTC
  7C54  3E20          		ld	a,' '
  7C56  CD887E        		call	MPUTC
  7C59  18CC          		jr	MONSLP
                      	
                      	
                      	;MON X command
  7C5B                	MONX:
  7C5B  CD427E        		call	GETPUTC
  7C5E  012E7D        		ld	bc,REGWKTBL
  7C61  283E          		jr	z,PRTREG
  7C63  D641          		sub	'A'
  7C65  CAEE7C        		jp	z,SETREG
  7C68  03            		inc	bc
  7C69  03            		inc	bc
  7C6A  3D            		dec	a		;B
  7C6B  CAEE7C        		jp	z,SETREG
  7C6E  03            		inc	bc
  7C6F  03            		inc	bc
  7C70  3D            		dec	a		;C
  7C71  CAEE7C        		jp	z,SETREG
  7C74  03            		inc	bc
  7C75  03            		inc	bc
  7C76  3D            		dec	a		;D
  7C77  2875          		jr	z,SETREG
  7C79  03            		inc	bc
  7C7A  03            		inc	bc
  7C7B  3D            		dec	a		;E
  7C7C  2870          		jr	z,SETREG
  7C7E  03            		inc	bc
  7C7F  03            		inc	bc
  7C80  3D            		dec	a		;F
  7C81  286B          		jr	z,SETREG
  7C83  03            		inc	bc
  7C84  03            		inc	bc
  7C85  FE02          		cp	'H'-'F'
  7C87  2865          		jr	z,SETREG
  7C89  03            		inc	bc
  7C8A  03            		inc	bc
  7C8B  FE06          		cp	'L'-'F'
  7C8D  285F          		jr	z,SETREG
                      	
  7C8F  FE4D          		cp	'M'
  7C91  CA1D7D        		jp	z,SETREGM
  7C94  FE50          		cp	'P'
  7C96  CA1D7D        		jp	z,SETREGP
  7C99  FE53          		cp	'S'
  7C9B  CA1D7D        		jp	z,SETREGS
  7C9E  C3EB76        		jp	MONERR
                      	
  7CA1                	PRTREG:
  7CA1  111E7D        		ld	de,REGEQTBL
                      	
  7CA4  2E08          		ld	l,08h
                      	
  7CA6                	PRTREGLP1:
  7CA6  E5            		push	hl
  7CA7  1A            		ld	a,(de)
  7CA8  6F            		ld	l,a
  7CA9  13            		inc	de
  7CAA  1A            		ld	a,(de)
  7CAB  67            		ld	h,a
  7CAC  13            		inc	de
  7CAD                	PRTREGLP2:
  7CAD  7E            		ld	a,(hl)
  7CAE  B7            		or	a
  7CAF  2806          		jr	z,PRTREGZ
  7CB1  CD887E        		call	MPUTC
  7CB4  23            		inc	hl
  7CB5  18F6          		jr	PRTREGLP2
  7CB7                	PRTREGZ:
  7CB7  0A            		ld	a,(bc)
  7CB8  6F            		ld	l,a
  7CB9  03            		inc	bc
  7CBA  0A            		ld	a,(bc)
  7CBB  67            		ld	h,a
  7CBC  03            		inc	bc
  7CBD  7E            		ld	a,(hl)
  7CBE  C5            		push	bc
  7CBF  CDE57D        		call	PUTHEX2
  7CC2  C1            		pop	bc
  7CC3  E1            		pop	hl
  7CC4  2D            		dec	l
  7CC5  20DF          		jr	nz,PRTREGLP1
                      	
  7CC7  21607D        		ld	hl,REGMEQ
  7CCA  CD787E        		call	MPUTS
  7CCD  2AFFFC        		ld	hl,(REGL)
  7CD0  CD8DFE        		call	READRAM
  7CD3  CDE57D        		call	PUTHEX2
                      	
  7CD6  21647D        		ld	hl,REGPEQ
  7CD9  CD787E        		call	MPUTS
  7CDC  2A02FD        		ld	hl,(REGPC)
  7CDF  CDE07D        		call	PUTHEX4
                      	
  7CE2  21687D        		ld	hl,REGSEQ
  7CE5  CD787E        		call	MPUTS
  7CE8  2A04FD        		ld	hl,(REGSP)
  7CEB  C3E07D        		jp	PUTHEX4
                      	
  7CEE                	SETREG:
  7CEE  3E20          		ld	a,' '
  7CF0  CD887E        		call	MPUTC
  7CF3                	SETREGLP:
  7CF3  FE0D          		cp	0dh
  7CF5  C8            		ret	z
                      	
  7CF6  213D7D        		ld	hl,REGWKTBLEND-1
  7CF9  B7            		or	a
  7CFA  ED42          		sbc	hl,bc
  7CFC  DA1D7D        		jp	c,SETREGM
                      	
  7CFF  0A            		ld	a,(bc)
  7D00  6F            		ld	l,a
  7D01  03            		inc	bc
  7D02  0A            		ld	a,(bc)
  7D03  67            		ld	h,a
  7D04  03            		inc	bc
  7D05  7E            		ld	a,(hl)
  7D06  EB            		ex	de,hl		;
  7D07  C5            		push	bc
  7D08  CDE57D        		call	PUTHEX2
  7D0B  3E2D          		ld	a,'-'
  7D0D  CD887E        		call	MPUTC
  7D10  CD0F7E        		call	GETHEX
  7D13  C1            		pop	bc
  7D14  20DD          		jr	nz,SETREGLP
  7D16  EB            		ex	de,hl		;
  7D17  73            		ld	(hl),e
  7D18  FE2C          		cp	','
  7D1A  28D7          		jr	z,SETREGLP
  7D1C  C9            		ret
                      	
  7D1D                	SETREGM:
  7D1D                	SETREGP
  7D1D                	SETREGS:
  7D1D  C9            		ret
                      	
  7D1E                	REGEQTBL:
  7D1E  3E7D427D467D4A		dw	REGAEQ, REGBEQ, REGCEQ, REGDEQ, REGEEQ, REGFEQ,
  7D2A  567D5C7D      		dw	REGHEQ, REGLEQ
                      	
  7D2E                	REGWKTBL:
  7D2E  FAFCFCFCFBFCFE		dw	REGA, REGB, REGC, REGD, REGE, REGF, REGH, REGL
  7D3E                	REGWKTBLEND:
  7D3E                	REGAEQ:
  7D3E  20413D00      		db	" A=", 00h
  7D42                	REGBEQ:
  7D42  20423D00      		db	" B=", 00h
  7D46                	REGCEQ:
  7D46  20433D00      		db	" C=", 00h
  7D4A                	REGDEQ:
  7D4A  20443D00      		db	" D=", 00h
  7D4E                	REGEEQ:
  7D4E  20453D00      		db	" E=", 00h
  7D52                	REGFEQ:
  7D52  20463D00      		db	" F=", 00h
  7D56                	REGHEQ:
  7D56  0D0A20483D00  		db	0dh, 0ah, " H=", 00h
  7D5C                	REGLEQ:
  7D5C  204C3D00      		db	" L=", 00h
  7D60                	REGMEQ:
  7D60  204D3D00      		db	" M=", 00h
  7D64                	REGPEQ:
  7D64  20503D00      		db	" P=", 00h
  7D68                	REGSEQ:
  7D68  20533D00      		db	" S=", 00h
                      	
                      	
                      	;output: a,z-flag
                      	;destroy: f
  7D6C                	MDEVHEX2:
  7D6C  C5            		push	bc
  7D6D  CD7B7D        		call	MDEVAN
  7D70  07            		rlca
  7D71  07            		rlca
  7D72  07            		rlca
  7D73  07            		rlca
  7D74  47            		ld	b,a
  7D75  CD7B7D        		call	MDEVAN
  7D78  B0            		or	b
  7D79  C1            		pop	bc
  7D7A  C9            		ret
                      	
                      	;alphabet or numeric
                      	;output: a
                      	;destroy: f
  7D7B                	MDEVAN:
  7D7B  CD8D7D        		call	MGETDEV
  7D7E  D630          		sub	'0'
  7D80  FE0A          		cp	'9'-'0'+1
  7D82  D8            		ret	c
  7D83  D611          		sub	'A'-'0'
  7D85  FE06          		cp	'F'-'A'+1
  7D87  D2497B        		jp	nc,MONRERR
  7D8A  C60A          		add	a,0ah
  7D8C  C9            		ret
                      	
                      	;output: a
                      	;destroy: none
  7D8D                	MGETDEV:
  7D8D  3A0EFD        		ld	a,(MONFLG)
  7D90  E608          		and	08h
  7D92  2808          		jr	z,MGETDEVLP	;RS-232C
  7D94  CD701A        		call	GETCMT
  7D97  C2497B        		jp	nz,MONRERR
  7D9A  180D          		jr	MGETDEVEND
                      	
  7D9C                	MGETDEVLP:
  7D9C  3A18FA        		ld	a,(STOPFLG)
  7D9F  FE03          		cp	03h
  7DA1  CAB77D        		jp	z,MONSTOP2
  7DA4  CD4310        		call	GETRSBF
  7DA7  28F3          		jr	z,MGETDEVLP
                      	
  7DA9                	MGETDEVEND:
  7DA9  F5            		push	af
  7DAA  3A0EFD        		ld	a,(MONFLG)
  7DAD  E610          		and	10h
  7DAF  2804          		jr	z,MGETDEVZ
  7DB1  F1            		pop	af
  7DB2  C3977E        		jp	MPUTC2
                      	
  7DB5                	MGETDEVZ:
  7DB5  F1            		pop	af
  7DB6                	DUMMY:
  7DB6  C9            		ret
                      	
  7DB7                	MONSTOP2:
  7DB7  CDBC0F        		call	GETCH
  7DBA                	MONSTOP:
  7DBA  2A04FD        		ld	hl,(REGSP)
  7DBD  F9            		ld	sp,hl
  7DBE  F5            		push	af		;for Dezeni Land
  7DBF  F5            		push	af		;for Dezeni Land
  7DC0  CDCD1B        		call	BELL
  7DC3  215F35        		ld	hl,BREAK+1
  7DC6  CD787E        		call	MPUTS
  7DC9  C38F76        		jp	MONLP1
                      	
                      	
                      	;destroy: af
  7DCC                	PUTDEVHEX2:
  7DCC  F5            		push	af
  7DCD  07            		rlca
  7DCE  07            		rlca
  7DCF  07            		rlca
  7DD0  07            		rlca
  7DD1  CDD57D        		call	PUTDEVHEX1
  7DD4  F1            		pop	af
                      	
  7DD5                	PUTDEVHEX1:
  7DD5  E60F          		and	0fh
  7DD7  FE0A          		cp	0ah
  7DD9  DE69          		sbc	a,69h
  7DDB  27            		daa
  7DDC  CDC726        		call	PUTDEV
  7DDF  C9            		ret
                      	
                      	
                      	;input: hl
                      	;destroy: af,b
  7DE0                	PUTHEX4:
  7DE0  7C            		ld	a,h
  7DE1  CDE57D        		call	PUTHEX2
  7DE4  7D            		ld	a,l
                      	;	jr	PUTHEX2
                      	
                      	;input: a
                      	;destroy: af,b
  7DE5                	PUTHEX2:
  7DE5  47            		ld	b,a
  7DE6  0F            		rrca
  7DE7  0F            		rrca
  7DE8  0F            		rrca
  7DE9  0F            		rrca
  7DEA  CDEE7D        		call	PUTHEX1
  7DED  78            		ld	a,b
                      	;	jr	PUTHEX1
                      	
                      	;input: a
                      	;destroy: af
  7DEE                	PUTHEX1:
  7DEE  E60F          		and	0fh
  7DF0  FE0A          		cp	0ah
  7DF2  DE69          		sbc	a,69h
  7DF4  27            		daa
  7DF5  C3887E        		jp	MPUTC
                      	
                      	
                      	;output: de=start address, hl=end address
  7DF8                	GETHEX2:
  7DF8  CD067E        		call	GETHEX1
  7DFB  CAEB76        		jp	z,MONERR
  7DFE  EB            		ex	de,hl
  7DFF  CD067E        		call	GETHEX1
  7E02  C2EB76        		jp	nz,MONERR
  7E05  C9            		ret
                      	
                      	;output: hl=address, z(terminator=0dh?)
  7E06                	GETHEX1:
  7E06  CD0F7E        		call	GETHEX
  7E09  C2EB76        		jp	nz,MONERR
  7E0C  FE0D          		cp	0dh
  7E0E  C9            		ret
                      	
                      	
                      	;get hex value keyboard input
                      	;output: hl, a(0dh or ',' or ' ' if no error), z-flag(0=no input)
                      	;destroy: af
  7E0F                	GETHEX:
  7E0F  210000        		ld	hl,0000h
  7E12  CD427E        		call	GETPUTC
  7E15  2808          		jr	z,GETHEXZ
  7E17  FE20          		cp	' '
  7E19  2804          		jr	z,GETHEXZ
  7E1B  FE2C          		cp	','
  7E1D  200C          		jr	nz,GETHEXNZ
  7E1F                	GETHEXZ:
  7E1F  B7            		or	a
  7E20  C9            		ret
                      	
  7E21                	GETHEXLP:
  7E21  CD427E        		call	GETPUTC
  7E24  C8            		ret	z
  7E25  FE2C          		cp	','
  7E27  C8            		ret	z
  7E28  FE20          		cp	' '
  7E2A  C8            		ret	z
  7E2B                	GETHEXNZ:
  7E2B  D630          		sub	'0'
  7E2D  FE0A          		cp	'9'-'0'+1
  7E2F  3809          		jr	c,GETHEX0F
  7E31  D611          		sub	'A'-'0'
  7E33  FE06          		cp	'F'-'A'+1
  7E35  D2EB76        		jp	nc,MONERR
  7E38  C60A          		add	a,0ah
  7E3A                	GETHEX0F:
  7E3A  29            		add	hl,hl		;*2
  7E3B  29            		add	hl,hl		;*4
  7E3C  29            		add	hl,hl		;*8
  7E3D  29            		add	hl,hl		;*16
  7E3E  85            		add	a,l
  7E3F  6F            		ld	l,a
  7E40  18DF          		jr	GETHEXLP
                      	
                      	;output: a,z-flag(1=return)
                      	;destroy: f
  7E42                	GETPUTC:
                      	;	call	GETC
  7E42  CD637E        		call	MGETC
  7E45  FE0D          		cp	0dh
  7E47  2814          		jr	z,GETPUTCRET
  7E49  FEFE          		cp	0feh		;page switching key
  7E4B  203B          		jr	nz,MPUTC
  7E4D  3A8FFD        		ld	a,(SCREEN2)
  7E50  3C            		inc	a
  7E51  218CFD        		ld	hl,PAGES
  7E54  BE            		cp	(hl)
  7E55  3801          		jr	c,GETPUTCC
  7E57  AF            		xor	a
  7E58                	GETPUTCC:
  7E58  CD7A13        		call	CHGSCR
  7E5B  18E5          		jr	GETPUTC
                      	
  7E5D                	GETPUTCRET:
  7E5D  F5            		push	af
  7E5E  CD817E        		call	MPUTNL
  7E61  F1            		pop	af
  7E62  C9            		ret
                      	
                      	
                      	;get a character for MON
                      	;output: a,z-flag(1=return)
                      	;destroy: f
  7E63                	MGETC:
  7E63  3A0EFD        		ld	a,(MONFLG)
  7E66  0F            		rrca
  7E67  DC7911        		call	c,CSRON
  7E6A                	MGETCLP:
  7E6A  CDBC0F        		call	GETCH
  7E6D  28FB          		jr	z,MGETCLP
  7E6F  E5            		push	hl
  7E70  CD8111        		call	CSROFF
  7E73  E1            		pop	hl
  7E74  CDAC0B        		call	TOUPPER
  7E77  C9            		ret
                      	
                      	;put string for MON
  7E78                	MPUTS:
  7E78  7E            		ld	a,(hl)
  7E79  B7            		or	a
  7E7A  C8            		ret	z
  7E7B  CD887E        		call	MPUTC
  7E7E  23            		inc	hl
  7E7F  18F7          		jr	MPUTS
                      	
                      	
                      	;destroy:  a
                      	;put new line for MON
  7E81                	MPUTNL:
  7E81  3E0D          		ld	a,0dh
  7E83  CD887E        		call	MPUTC
  7E86  3E0A          		ld	a,0ah
                      	;	jr	MPUTC
                      	
                      	;put a character for MON
                      	;input: a
                      	;destroy: none
  7E88                	MPUTC:
  7E88  F5            		push	af
  7E89  CDBC0F        		call	GETCH
  7E8C  2808          		jr	z,MPUTCZ
  7E8E  CD637E        		call	MGETC
  7E91  FE03          		cp	03h
  7E93  CABA7D        		jp	z,MONSTOP
  7E96                	MPUTCZ:
  7E96  F1            		pop	af
                      	
                      	;no stop check
                      	;destroy: none
  7E97                	MPUTC2:
  7E97  F5            		push	af
  7E98  C5            		push	bc
  7E99  47            		ld	b,a		;
  7E9A  3A0EFD        		ld	a,(MONFLG)
  7E9D  4F            		ld	c,a		;;
  7E9E  0F            		rrca
  7E9F  78            		ld	a,b		;
  7EA0  DC7510        		call	c,PUTC
  7EA3  79            		ld	a,c		;;
  7EA4  E620          		and	20h
  7EA6  3E01          		ld	a,01h
  7EA8  3258FA        		ld	(DEVICE),a
  7EAB  78            		ld	a,b		;
  7EAC  C4C726        		call	nz,PUTDEV
  7EAF  AF            		xor	a
  7EB0  3258FA        		ld	(DEVICE),a
  7EB3  C1            		pop	bc
  7EB4  F1            		pop	af
  7EB5  C9            		ret
                      	
                      	
                      	;DELETE command
  7EB6                	C_DEL:
  7EB6  F1            		pop	af		;cancel return address
  7EB7  CD613F        		call	CHKCLN
  7EBA  CAED03        		jp	z,FCERR
                      	
  7EBD  CD5F07        		call	GETLN
  7EC0  D5            		push	de		;start line number
  7EC1  CD613F        		call	CHKCLN
  7EC4  281D          		jr	z,DELSTRT
                      	
  7EC6  FECB          		cp	MINUS
  7EC8  C2E403        		jp	nz,SNERR
  7ECB  CD603F        		call	CHKCLNINC
  7ECE  2007          		jr	nz,DELNZ
  7ED0  D1            		pop	de
  7ED1  01FAFF        		ld	bc,65530
  7ED4  C5            		push	bc
  7ED5  180C          		jr	DELSTRT
                      	
  7ED7                	DELNZ:
  7ED7  CD5F07        		call	GETLN
  7EDA  CD613F        		call	CHKCLN
  7EDD  C2E403        		jp	nz,SNERR
                      	
  7EE0  E1            		pop	hl
  7EE1  D5            		push	de		;push end line number
  7EE2  EB            		ex	de,hl		;de <- start line number
                      	
                      	;de=start line number, (sp)=end line number
  7EE3                	DELSTRT:
  7EE3  CDF304        		call	SRCHLN
  7EE6  D1            		pop	de		;end line number
  7EE7  C5            		push	bc		;start address
  7EE8  CDF304        		call	SRCHLN
  7EEB  3802          		jr	c,DELC
  7EED  60            		ld	h,b		;end address
  7EEE  69            		ld	l,c
  7EEF                	DELC:
  7EEF  D1            		pop	de		;start address
                      	
  7EF0  EB            		ex	de,hl
  7EF1  E7            		rst	CPHLDE		;start-end
  7EF2  D24204        		jp	nc,EDIT
  7EF5  EB            		ex	de,hl
                      	
  7EF6  42            		ld	b,d
  7EF7  4B            		ld	c,e
  7EF8  C5            		push	bc		;dummy,(bc)=0
  7EF9  CDC204        		call	DELPRG
  7EFC  CDF934        		call	RESSTK
  7EFF  CDD804        		call	CHGLKP
  7F02  C34204        		jp	EDIT
                      	
                      	
                      	;66 ROM end
  7F05                	_8000H:	ds	8000h-_8000H
                      	
  8000                		end
